//# sourceMappingURL=/home/olivier/git/earl-grey/src/run.js.map
'use strict';require('earlgrey-runtime');let $targ$14;let eg$0;let $1$0;let __lt____gt__$0;let $2$0;let Source$0;let format_error$0;let highlight_locations$0;let fs$0;let path$0;let $3$0;let smsupport$0;let usage$0;let display_error$0;let usage_error$0;let extract_options$0;let walk$0;let copy$0;let _gen$0;let interactive$0;let compile_path$0;let run$0;let _run$0;eg$0=require("./earl-grey");$1$0=require("./pp");__lt____gt__$0=$1$0["<>"];$2$0=require("./location");Source$0=$2$0.Source;format_error$0=$2$0.format_error;highlight_locations$0=$2$0.highlight_locations;fs$0=require("fs");path$0=require("path");$3$0=require("earlgrey-runtime");smsupport$0=require("source-map-support");smsupport$0.install();usage$0="Usage: earl [global options] command [options] [arguments...]\n\nearl run [options] [file] [arguments...]\n  Run the specified file as a script. The arguments are available in\n  process.argv.slice{2} of the script.\n  Options:\n    -e  --eval <code>  Run the provided code instead of reading from a file.\n    -p  --print        Print the result of the evaluation to standard out.\n    -i  --interactive  Start an interactive interpreter after execution\n                       in the global environment of the script.\n\nearl compile [options] [file... | dir]\n  Compile the specified source files into .js files. The files will be\n  placed next to the originals.\n  If a directory is given, all .eg files in the directory hierarchy\n  will be compiled. The -o option can be used to compile the files\n  into a different directory (all non-eg files will be copied over).\n  Options:\n    -o  --output <dir>  Output in given directory.\n    -p  --print         Print the compiled JavaScript to standard out.\n                        No files are created.\n    -e  --eval <code>   Compile the provided code instead of reading from a file.\n    -n  --noboil        Don't produce boilerplate code (useful with -p)\n    -v  --verbose       Print information about the operations performed\n    -5  --es5           Generate EcmaScript v5\n    -6  --es6           Generate EcmaScript v6\n\nearl\n  Start an interactive session.\n\nGlobal options:\n  -h  --help      Print this message.\n  -v  --version   Print the version\n";display_error$0=(function display_error(temp$0$0){let t0$0;let m$0;let acc$0;let temp$1;let pr$0;let hls$0;let locs$0;let accum$0;let args$0;let t0$1;let t1$0;let t2$0;let e$0;let ph$0$0;t0$0=temp$0$0;e$0=t0$0;ph$0$0=t0$0;t0$1=ph$0$0;if((getChecker(ErrorFactory(["syntax"]))(t0$1)&&(___hasprop(t0$1,"args")&&((t1$0=t0$1.args),((t1$0 instanceof Array)&&((t2$0=t1$0.length),(t2$0===1))))))){args$0=t1$0[0];console.error(String(e$0));hls$0=["hl1","hl2","hl3","hl4"];acc$0=[];temp$1=null;m$0=null;$5:for(m$0 of enumerate(items(args$0))){let i$0;let key$0;let arg$0;let t0$2;let t1$1;let t2$1;let t3$0;t0$2=m$0;if(((t0$2 instanceof Array)&&((t1$1=t0$2.length),((t1$1===2)&&((i$0=t0$2[0]),(t2$1=t0$2[1]),((t2$1 instanceof Array)&&((t3$0=t2$1.length),((t3$0===2)&&((key$0=t2$1[0]),(arg$0=t2$1[1]),(arg$0&&arg$0.location)))))))))){temp$1=[arg$0.location,send(hls$0,(i$0%4))];acc$0.push(temp$1);}else{false;}}locs$0=acc$0;accum$0="\n";pr$0=(function pr(ph$1$0){let l$0;let m$1$0;let t0$4;let t1$2;let m$2;let $targ$0;let pre$0;let post$0;let m$3;let acc$1;let temp$2;let other$0;let a$0;let n$0;let s$0;let $$22646$0;let t0$3;t0$3=ph$1$0;if((typeof(t0$3)==="string")){s$0=t0$3;return (accum$0=(accum$0+s$0));}else{if(getChecker(Node)(t0$3)){n$0=t0$3;m$1$0=n$0;if(getChecker(Node([".hl1"],({}),[]))(m$1$0)){$targ$0=["[1;32m","[0m"];}else{if(getChecker(Node([".hl2"],({}),[]))(m$1$0)){$targ$0=["[1;33m","[0m"];}else{if(getChecker(Node([".hl3"],({}),[]))(m$1$0)){$targ$0=["[1;36m","[0m"];}else{if(getChecker(Node([".hl4"],({}),[]))(m$1$0)){$targ$0=["[1;35m","[0m"];}else{if(getChecker(Node([".lineno"],({}),[]))(m$1$0)){l$0=Math.floor((Math.log(n$0.children[0])/Math.log(10)));$targ$0=[("[1m"+Array((3-l$0)).join(" ")),":[0m "];}else{$targ$0=["",""];}}}}}t0$4=$targ$0;if(((t0$4 instanceof Array)&&((t1$2=t0$4.length),(t1$2===2)))){pre$0=t0$4[0];post$0=t0$4[1];}else{___match_error($targ$0);}[pre$0,post$0];if(getChecker(Node([".sourcepos"],({}),[]))(n$0)){pre$0=(pre$0+" ");}accum$0=(accum$0+pre$0);m$2=null;$6:for(m$2 of n$0.children){let child$0;child$0=m$2;pr$0(child$0);}accum$0=(accum$0+post$0);if((getChecker(Node(["div"],({}),[]))(n$0)&&nequal(send(accum$0,(accum$0.length-1)),"\n"))){return (accum$0=(accum$0+"\n"));}}else{if(getChecker(Array)(t0$3)){a$0=t0$3;acc$1=[];temp$2=null;m$3=null;$7:for(m$3 of a$0){let child$1;child$1=m$3;temp$2=pr$0(child$1);acc$1.push(temp$2);}return acc$1;}else{other$0=ph$1$0;return (accum$0=(accum$0+String(other$0)));}}}});pr$0(highlight_locations$0(locs$0,0));return console.error(accum$0);}else{return console.error((e$0.stack||String(e$0)));}});usage_error$0=(function usage_error(message$0){console.error(usage$0);console.error(message$0);return process.exit(1);});extract_options$0=(function extract_options(temp$3$0,opttable$0,optmessage$0){let t0$5;let results$0;let associate$0;let process_option$0;let argv$0;t0$5=getProjector(clone)(temp$3$0);if(t0$5[0]){argv$0=t0$5[1];}else{___match_error(temp$3$0);}results$0=({});associate$0=null;process_option$0=(function process_option(original$0,opt$0,last$0){let $targ$1;let $targ$2;let name$2;let name$1;let name$0;let $$22795$0;let $$22796$0;let $$22797$0;let $$22798$0;let t0$6;let m$4$0;m$4$0=send(opttable$0,opt$0);if((m$4$0===(void 0))){return usage_error$0(((("Unrecognized "+optmessage$0)+": ")+original$0));}else{if((($$22795$0=(m$4$0 instanceof Array))&&((t0$6=m$4$0.length),(($$22797$0=(t0$6===2))&&(m$4$0[0]==="flag"))))){name$0=m$4$0[1];$targ$1=true;(results$0[name$0]=$targ$1);return [];}else{if(($$22797$0&&(($$22798$0=(m$4$0[0]==="value"))&&((name$1=m$4$0[1]),last$0)))){associate$0=name$1;return associate$0;}else{if($$22798$0){name$2=m$4$0[1];$targ$2=true;(results$0[name$2]=$targ$2);return [];}else{return ___match_error(m$4$0);}}}}});$8:while(argv$0.length){let $targ$3;let m$6;let acc$2;let temp$4;let $targ$4;let other$2;let other$1;let opts$0;let opt$2;let opt$1;let value$0;let t0$7;let t1$3;let t2$2;let m$5$0;let arg$1;arg$1=argv$0.shift();m$5$0=arg$1;t0$7=getProjector(RegExp("^--([a-zA-Z_0-9\\-]+)=(.*)",""))(m$5$0);if((t0$7[0]&&((t1$3=t0$7[1]),(t2$2=t1$3.length),(t2$2===3)))){t1$3[0];opt$1=t1$3[1];value$0=t1$3[2];process_option$0(arg$1,opt$1,true);$targ$3=value$0;(results$0[associate$0]=$targ$3);[];associate$0=null;associate$0;}else{t0$7=getProjector(RegExp("^--([a-zA-Z_\\-0-9]+)",""))(m$5$0);if((t0$7[0]&&((t1$3=t0$7[1]),(t2$2=t1$3.length),(t2$2===2)))){t1$3[0];opt$2=t1$3[1];process_option$0(arg$1,opt$2,true);}else{t0$7=getProjector(RegExp("^-([a-zA-Z_0-9]+)",""))(m$5$0);if((t0$7[0]&&((t1$3=t0$7[1]),(t2$2=t1$3.length),(t2$2===2)))){t1$3[0];opts$0=t1$3[1];acc$2=[];temp$4=null;m$6=null;$9:for(m$6 of enumerate(opts$0)){let i$1;let ch$0;let t0$8;let t1$4;t0$8=m$6;if(((t0$8 instanceof Array)&&((t1$4=t0$8.length),(t1$4===2)))){i$1=t0$8[0];ch$0=t0$8[1];temp$4=process_option$0(arg$1,ch$0,equal(i$1,(opts$0.length-1)));acc$2.push(temp$4);}else{___match_error(m$6,"/home/olivier/git/earl-grey/src/run.eg",4118,4221);}}acc$2;}else{other$1=m$5$0;if(associate$0){$targ$4=other$1;(results$0[associate$0]=$targ$4);[];associate$0=null;associate$0;}else{other$2=m$5$0;argv$0.unshift(other$2);break $8;}}}}}return [results$0,argv$0];});walk$0=(function walk(dir$0,partial$0,f$0){let m$7;let acc$3;let temp$5;let stats$0;stats$0=fs$0.statSync(dir$0);if(stats$0.isDirectory()){f$0("dir",partial$0);acc$3=[];temp$5=null;m$7=null;$10:for(m$7 of fs$0.readdirSync(dir$0)){let newdir$0;let newpartial$0;let file$0;file$0=m$7;newdir$0=path$0.join(dir$0,file$0);newpartial$0=path$0.join(partial$0,file$0);temp$5=walk$0(newdir$0,newpartial$0,f$0);acc$3.push(temp$5);}return acc$3;}else{return f$0("file",partial$0);}});copy$0=(function copy(src$0,dest$0){let data$0;data$0=fs$0.readFileSync(src$0,"binary");return fs$0.writeFileSync(dest$0,data$0,"binary");});_gen$0=(function _gen(text$0,file$1,opts$1){let g$0;g$0=eg$0.Generator();return g$0.generate(Source$0(text$0,path$0.resolve(file$1)),({"noboil":opts$1.noboil,"to5":opts$1["es5"],"sourceMap":opts$1.sourceMap}));});interactive$0=(function interactive(g$1,e$1){let accum$1;let repl$0;let $targ$5;let settings$0;let runner$0;repl$0=require("repl");$targ$5=true;(g$1["interactive"]=$targ$5);[];settings$0=__amp____colon__(({"prompt":"<> ","ignoreUndefined":true}),((accum$1=({})),(accum$1["eval"]=(function(input$0,context$0,filename$0,callback$0){let rval$0;let execute$0;let handle$0;let result$0;execute$0=(function execute(){let inp$0;let text$1;if(input$0.match(RegExp("^\\(.*\\n\\)$",""))){inp$0=input$0.slice(1,-1);}else{inp$0=input$0;}if(equal(inp$0.trim(),"")){return undefined;}text$1=g$1.generate(Source$0(inp$0,"<interactive>"));return e$1(text$1);});handle$0=(function handle(e$2){display_error$0(e$2);return undefined;});rval$0=false;try{rval$0=execute$0();rval$0;}catch(excv$0){let e$3;e$3=excv$0;rval$0=handle$0(e$3);rval$0;}result$0=rval$0;return callback$0(null,result$0);})),accum$1));runner$0=repl$0.start(settings$0);return runner$0.on("exit",(function(){return runner$0.outputStream.write("\n");}));});compile_path$0=(function compile_path(p$0,opts$2){let out$0;let t0$14;let $11$0;let beaut$0;let name$5;let name$4;let t0$15;let t1$7;let t2$3;let m$11$0;let noext$0;let $$23303$0;let m$10$0;let data$2;let $targ$8;let code$1;let map$1;let $$23135$0;let m$8$0;let stats$1;stats$1=fs$0.statSync(p$0);m$8$0=null;if(stats$1.isDirectory()){if(opts$2.print){usage_error$0("Cannot use --print when compiling a directory");}out$0=(opts$2.output||p$0);return walk$0(p$0,"/",(function(){let rval$1;let to$0;let from$0;let t0$12;let t1$6;let t0$13;let $targ$6;let x$0;let name$3;let from$1;let to$1;let data$1;let $targ$7;let code$0;let map$0;let from$2;let to$2;let f$1;let results$1;let t0$11;let ph$4$0;let d$0;let $$23163$0;let $$23164$0;let $$23165$0;let t0$10;let t1$5;let ph$3$0;let t0$9;let m$9$0;m$9$0=arguments;t0$9=m$9$0.length;if((t0$9>=0)){ph$3$0=Array.prototype.slice.call(m$9$0,0);t0$10=ph$3$0;t1$5=t0$10.length;if((($$23165$0=(t1$5===2))&&(t0$10[0]==="dir"))){d$0=t0$10[1];from$0=path$0.join(p$0,d$0);if(opts$2.output){to$0=path$0.join(out$0,d$0);rval$1=false;try{rval$1=fs$0.mkdirSync(to$0);rval$1;}catch(excv$1){let e$4;e$4=excv$1;rval$1="ignore error";rval$1;}return rval$1;}}else{if(($$23165$0&&(t0$10[0]==="file"))){ph$4$0=t0$10[1];t0$11=getProjector(RegExp("(?:^((?:.*))\\.eg$)",""))(ph$4$0);if((t0$11[0]&&((results$1=t0$11[1]),results$1))){$targ$6=results$1;t0$12=$targ$6;if(((t0$12 instanceof Array)&&((t1$6=t0$12.length),(t1$6===2)))){x$0=t0$12[0];name$3=t0$12[1];}else{___match_error($targ$6);}[x$0,name$3];from$1=path$0.join(p$0,x$0);to$1=path$0.join(out$0,(name$3+".js"));data$1=fs$0.readFileSync(from$1,"utf8");if(opts$2.verbose){console.log("Compiling:",from$1);}$targ$7=_gen$0(data$1,from$1,__amp__(opts$2,({"sourceMap":true})));t0$13=$targ$7;if((___hasprop(t0$13,"code")&&((code$0=t0$13.code),___hasprop(t0$13,"map")))){map$0=t0$13.map;}else{___match_error($targ$7);}[code$0,map$0];fs$0.writeFileSync(to$1,(code$0+"\n"));return fs$0.writeFileSync((to$1+".map"),map$0);}else{if((!opts$2.output)){return null;}else{f$1=ph$4$0;from$2=path$0.join(p$0,f$1);to$2=path$0.join(out$0,f$1);return copy$0(from$2,to$2);}}}else{return ___match_error(ph$3$0);}}}else{return ___match_error(m$9$0);}}));}else{data$2=fs$0.readFileSync(p$0,"utf8");$targ$8=_gen$0(data$2,p$0,__amp__(opts$2,({"sourceMap":true})));t0$14=$targ$8;if((___hasprop(t0$14,"code")&&((code$1=t0$14.code),___hasprop(t0$14,"map")))){map$1=t0$14.map;}else{___match_error($targ$8);}[code$1,map$1];m$10$0=null;if(opts$2.print){$11$0=require("js-beautify");beaut$0=$11$0.js;return console.log(beaut$0(code$1));}else{if(opts$2.output){fs$0.writeFileSync((opts$2.output+".map"),map$1);return fs$0.writeFileSync(opts$2.output,(code$1+"\n"));}else{m$11$0=p$0;t0$15=getProjector(RegExp("^(.*).eg$",""))(m$11$0);if((t0$15[0]&&((t1$7=t0$15[1]),(t2$3=t1$7.length),(t2$3===2)))){t1$7[0];name$4=t1$7[1];noext$0=name$4;}else{name$5=m$11$0;noext$0=name$5;}fs$0.writeFileSync((noext$0+".js.map"),map$1);return fs$0.writeFileSync((noext$0+".js"),(code$1+"\n"));}}}});run$0=(function run(argv$1){let t0$16;let t1$8;let rval$2;let $targ$9;let opts$3;let cmd$0;$targ$9=extract_options$0(argv$1,({"h":["flag","help"],"help":["flag","help"],"v":["flag","version"],"version":["flag","version"]}),"global option");t0$16=$targ$9;if(((t0$16 instanceof Array)&&((t1$8=t0$16.length),(t1$8===2)))){opts$3=t0$16[0];cmd$0=t0$16[1];}else{___match_error($targ$9);}[opts$3,cmd$0];rval$2=false;try{rval$2=_run$0(cmd$0,opts$3);rval$2;}catch(excv$2){let e$5;e$5=excv$2;display_error$0(e$5);rval$2=process.exit(1);rval$2;}return rval$2;});_run$0=(function _run(ph$5$0,opts$4){let t0$18;let t0$19;let t0$20;let t1$10;let data$4;let file$3;let t0$21;let m$12$0;let t0$22;let t1$11;let $targ$10;let o$0;let rest$0;let $targ$11;let file$2;let wd$0;let data$3;let args$1;let $targ$12;let e$6;let g$2;let result$1;let t0$23;let t1$12;let $$23589$0;let m$14$0;let code$2;let m$15;let acc$4;let temp$6;let paths$0;let p$1;let $$23560$0;let $$23561$0;let t0$24;let m$13$0;let $targ$13;let o$1;let rest$1;let stuff$0;let rawargs$1;let rawargs$0;let $$23430$0;let $$23431$0;let $$23432$0;let bridge$$23426$0;let t0$17;let t1$9;if(opts$4.help){return console.log(usage$0);}else{if(opts$4.version){return console.log("Earl Grey version",eg$0.version);}else{bridge$$23426$0=ph$5$0;if((((bridge$$23426$0 instanceof Array)&&((t0$18=bridge$$23426$0.length),(t0$18===0)))||((bridge$$23426$0 instanceof Array)&&((t0$19=bridge$$23426$0.length),((t0$19===1)&&(bridge$$23426$0[0]==="run")))))){return _run$0(["run","-i"],opts$4);}else{t0$17=ph$5$0;t1$9=t0$17.length;if((($$23432$0=(t1$9>=1))&&(t0$17[0]==="run"))){rawargs$0=Array.prototype.slice.call(t0$17,1);$targ$10=extract_options$0(rawargs$0,({"e":["value","evaluate"],"eval":["value","evaluate"],"p":["flag","print"],"print":["flag","print"],"i":["flag","interactive"],"interactive":["flag","interactive"]}),"option for run");t0$20=$targ$10;if(((t0$20 instanceof Array)&&((t1$10=t0$20.length),(t1$10===2)))){o$0=t0$20[0];rest$0=t0$20[1];}else{___match_error($targ$10);}[o$0,rest$0];if(o$0.evaluate){$targ$11=["<repl>",process.cwd(),o$0.evaluate,rest$0];}else{m$12$0=rest$0.shift();if(((m$12$0===(void 0))&&o$0.interactive)){$targ$11=["<repl>",process.cwd(),"",rest$0];}else{if((m$12$0===(void 0))){$targ$11=usage_error$0("No filename specified.");}else{t0$21=getProjector(path$0.resolve)(m$12$0);if(t0$21[0]){file$3=t0$21[1];data$4=fs$0.readFileSync(file$3,"utf8");$targ$11=[file$3,file$3,data$4,rest$0];}else{$targ$11=___match_error(m$12$0);}}}}t0$22=$targ$11;if(((t0$22 instanceof Array)&&((t1$11=t0$22.length),(t1$11===4)))){file$2=t0$22[0];wd$0=t0$22[1];data$3=t0$22[2];args$1=t0$22[3];}else{___match_error($targ$11);}[file$2,wd$0,data$3,args$1];$targ$12=["earl-run",file$2].concat(rest$0);(process["argv"]=$targ$12);[];e$6=eg$0.evaluator(({"filename":file$2,"showname":file$2,"cwd":file$2}));g$2=eg$0.Generator(o$0.interactive);result$1=e$6(g$2.generate(Source$0(data$3,file$2)));if(o$0.print){console.log(result$1);}if(o$0.interactive){return interactive$0(g$2,e$6);}}else{if(($$23432$0&&(t0$17[0]==="compile"))){rawargs$1=Array.prototype.slice.call(t0$17,1);$targ$13=extract_options$0(rawargs$1,({"o":["value","output"],"output":["value","output"],"p":["flag","print"],"print":["flag","print"],"e":["value","evaluate"],"eval":["value","evaluate"],"n":["flag","noboil"],"noboil":["flag","noboil"],"6":["flag","es6"],"es6":["flag","es6"],"5":["flag","es5"],"es5":["flag","es5"],"v":["flag","verbose"],"verbose":["flag","verbose"]}),"option for compile");t0$23=$targ$13;if(((t0$23 instanceof Array)&&((t1$12=t0$23.length),(t1$12===2)))){o$1=t0$23[0];rest$1=t0$23[1];}else{___match_error($targ$13);}[o$1,rest$1];m$13$0=rest$1;if(o$1.evaluate){code$2=_gen$0(o$1.evaluate,"<cli>",o$1);m$14$0=null;if(o$1.output){return fs$0.writeFileSync(o$1.output,(code$2+"\n"));}else{return console.log(code$2);}}else{if((($$23560$0=(m$13$0 instanceof Array))&&((t0$24=m$13$0.length),(t0$24===0)))){return usage_error$0("Must provide at least one file or directory to compile.");}else{if(($$23560$0&&(t0$24===1))){p$1=m$13$0[0];return compile_path$0(p$1,o$1);}else{if(o$1.output){return usage_error$0("The -o option cannot be used if more than one file or directory is compiled.");}else{if(((m$13$0 instanceof Array)&&((t0$24=m$13$0.length),(t0$24>=0)))){paths$0=Array.prototype.slice.call(m$13$0,0);acc$4=[];temp$6=null;m$15=null;$12:for(m$15 of paths$0){let p$2;p$2=m$15;temp$6=compile_path$0(p$2,o$1);acc$4.push(temp$6);}return acc$4;}else{return ___match_error(m$13$0);}}}}}}else{stuff$0=ph$5$0;return usage_error$0(("Invalid use. Did you mean: earl run "+stuff$0.join(" ")));}}}}}});$targ$14=run$0;(exports["run"]=$targ$14);[];
