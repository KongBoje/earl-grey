//# sourceMappingURL=/home/olivier/git/earl-grey/src/location.js.map
'use strict';require('earlgrey-runtime');let $targ$9;let $targ$10;let $targ$11;let $targ$12;let $targ$13;let $targ$14;let $targ$15;let $targ$16;let $targ$17;let $0$0;let binsearch$0;let $1$0;let __lt____gt__$0;let repr$0;let fs$0;let opg$0;let Source$0;let Location$0;let $targ$0;let $targ$1;let highlight$0;let highlight_lines$0;let clamp$0;let morsel$0;let highlight_locations$0;let highlight_locations_same_source$0;let merge_locations$0;let __lt____lt____colon__$0;let __plus____plus____colon__$0;let format_error$0;let display_error$0;$0$0=require("./util");binsearch$0=$0$0.binsearch;$1$0=require("./pp");__lt____gt__$0=$1$0["<>"];repr$0=$1$0.repr;fs$0=require("fs");opg$0=require("opg");Source$0=opg$0.Source;Location$0=opg$0.Location;$targ$0=(function(l1$0,l2$0,spans$0){return highlight_lines$0(this.text,this.counts,[(l1$0-1),(l2$0-1)],spans$0);});(Source$0.prototype["highlight_lines"]=$targ$0);[];$targ$1=(function(){let cls$0;let context$0;let t0$0;let m$0$0;m$0$0=arguments;t0$0=m$0$0.length;if(((t0$0>=0)&&(t0$0<=2))){if((0>=t0$0)){cls$0="hl1";}else{cls$0=m$0$0[0];}if((1>=t0$0)){context$0=0;}else{context$0=m$0$0[1];}return highlight_locations$0([[this,cls$0]],context$0);}else{return ___match_error(m$0$0);}});(Location$0.prototype["highlight"]=$targ$1);[];highlight$0=(function highlight(){let m$2;let acc$0;let temp$0;let text$0;let spans$1;let offset$0;let t0$1;let m$1$0;m$1$0=arguments;t0$1=m$1$0.length;if(((t0$1>=2)&&(t0$1<=3))){text$0=m$1$0[0];spans$1=m$1$0[1];if((2>=t0$1)){offset$0=0;}else{offset$0=m$1$0[2];}return Node([],({}),((acc$0=[]),(temp$0=null),(m$2=null),(function(){$2:for(m$2 of morsel$0(spans$1)){let xstart$0;let xend$0;let start$0;let end$0;let attributes$0;let t0$2;let t1$0;t0$2=m$2;if(((t0$2 instanceof Array)&&((t1$0=t0$2.length),(t1$0===3)))){start$0=t0$2[0];end$0=t0$2[1];attributes$0=t0$2[2];xstart$0=Math.max((start$0-offset$0),0);xend$0=Math.min((end$0-offset$0),text$0.length);temp$0=Node([("."+attributes$0.slice(0,1))],({}),text$0.slice(xstart$0,xend$0));acc$0.push(temp$0);}else{___match_error(m$2,"/home/olivier/git/earl-grey/src/location.eg",565,855);}}})(),acc$0));}else{return ___match_error(m$1$0);}});highlight_lines$0=(function highlight_lines(text$1,linelocs$0,temp$1$0,spans$2){let t0$3;let t1$1;let m$3;let acc$1;let temp$2;let l1$1;let l2$1;t0$3=temp$1$0;if(((t0$3 instanceof Array)&&((t1$1=t0$3.length),(t1$1===2)))){l1$1=t0$3[0];l2$1=t0$3[1];}else{___match_error(temp$1$0);}return Node(["span"],({}),((acc$1=[]),(temp$2=null),(m$3=null),(function(){$3:for(m$3 of range(l1$1,l2$1)){let start$1;let end$1;let lineno$0;lineno$0=m$3;start$1=send(linelocs$0,lineno$0);end$1=send(linelocs$0,(lineno$0+1));temp$2=Node(["span"],({}),[Node([".lineno"],({}),(lineno$0+1)),Node([".source"],({}),highlight$0(text$1,[[start$1,end$1,[]]].concat(clamp$0(spans$2,start$1,end$1))))]);acc$1.push(temp$2);}})(),acc$1));});clamp$0=(function clamp(spans$3,bot$0,top$0){let m$4;let acc$2;let temp$3;acc$2=[];temp$3=null;m$4=null;$4:for(m$4 of spans$3){let start$2;let end$2;let attr$0;let t0$4;let t1$2;t0$4=m$4;if(((t0$4 instanceof Array)&&((t1$2=t0$4.length),((t1$2===3)&&((start$2=t0$4[0]),(end$2=t0$4[1]),(attr$0=t0$4[2]),((end$2>=bot$0)&&(start$2<=top$0))))))){temp$3=[Math.max(start$2,bot$0),Math.min(end$2,top$0),attr$0];acc$2.push(temp$3);}else{false;}}return acc$2;});morsel$0=(function morsel(spans$4){let jump$0;let jumptill$0;let process_elements$0;let thespans$0;jump$0=(function jump(active$0,bot$1,top$1){let m$5;let acc$3;let temp$4;let m$6;let e$0;let attributes$1;e$0=send(Math.min,[top$1].concat(((acc$3=[]),(temp$4=null),(m$5=null),(function(){$6:for(m$5 of active$0){let x$0;let t0$5;let t1$3;t0$5=m$5;if(((t0$5 instanceof Array)&&((t1$3=t0$5.length),(t1$3===3)))){t0$5[0];x$0=t0$5[1];t0$5[2];temp$4=x$0;acc$3.push(temp$4);}else{___match_error(m$5,"/home/olivier/git/earl-grey/src/location.eg",2187,2220);}}})(),acc$3)));attributes$1=[];m$6=null;$5:for(m$6 of active$0){let X$0;let t0$6;let t1$4;t0$6=m$6;if(((t0$6 instanceof Array)&&((t1$4=t0$6.length),(t1$4===3)))){t0$6[0];t0$6[1];X$0=t0$6[2];attributes$1=attributes$1.concat(X$0);}else{___match_error(m$6,"/home/olivier/git/earl-grey/src/location.eg",2246,2287);}}return [e$0,[bot$1,e$0,attributes$1]];});jumptill$0=(function jumptill(active$1,bot$2,top$2){let t0$7;let t1$5;let m$7;let acc$4;let temp$5;let t0$9;let t1$7;let $targ$2;let newbot$0;let span$0;let newactive$0;let $targ$3;let spans$5;let remainder$0;if((bot$2===top$2)){return [[],active$1];}else{$targ$2=jump$0(active$1,bot$2,top$2);t0$7=$targ$2;if(((t0$7 instanceof Array)&&((t1$5=t0$7.length),(t1$5===2)))){newbot$0=t0$7[0];span$0=t0$7[1];}else{___match_error($targ$2);}[newbot$0,span$0];acc$4=[];temp$5=null;m$7=null;$7:for(m$7 of active$1){let x$1;let e$1;let attr$1;let t0$8;let t1$6;t0$8=m$7;x$1=t0$8;if(((t0$8 instanceof Array)&&((t1$6=t0$8.length),((t1$6===3)&&(t0$8[0],(e$1=t0$8[1]),(attr$1=t0$8[2]),(e$1>newbot$0)))))){temp$5=x$1;acc$4.push(temp$5);}else{false;}}newactive$0=acc$4;$targ$3=jumptill$0(newactive$0,newbot$0,top$2);t0$9=$targ$3;if(((t0$9 instanceof Array)&&((t1$7=t0$9.length),(t1$7===2)))){spans$5=t0$9[0];remainder$0=t0$9[1];}else{___match_error($targ$3);}[spans$5,remainder$0];return [[span$0].concat(spans$5),remainder$0];}});process_elements$0=(function process_elements(start$3,active$2,rem$0){let m$9;let acc$5;let temp$6;let t0$12;let t1$10;let top$3;let bot$3;let $targ$4;let spans$6;let t0$13;let t1$11;let $targ$5;let spans$7;let newactive$1;let start$5;let active$4;let next$0;let target$0;let end$3;let attr$2;let rest$0;let start$4;let active$3;let $$5021$0;let $$5022$0;let $$5023$0;let t0$10;let t1$8;let t2$0;let t3$0;let t4$0;let m$8$0;m$8$0=[start$3,active$2,rem$0];if((($$5021$0=(m$8$0 instanceof Array))&&((t0$10=m$8$0.length),(($$5023$0=(t0$10===3))&&(m$8$0[0],(t1$8=m$8$0[1]),((t1$8 instanceof Array)&&((t2$0=t1$8.length),((t2$0===0)&&((t3$0=m$8$0[2]),((t3$0 instanceof Array)&&((t4$0=t3$0.length),(t4$0===0)))))))))))){return [];}else{if(($$5023$0&&((start$4=m$8$0[0]),(active$3=m$8$0[1]),(t1$8=m$8$0[2]),((t1$8 instanceof Array)&&((t2$0=t1$8.length),(t2$0===0)))))){top$3=send(Math.max,((acc$5=[]),(temp$6=null),(m$9=null),(function(){$8:for(m$9 of active$3){let e$2;let t0$11;let t1$9;t0$11=m$9;if(((t0$11 instanceof Array)&&((t1$9=t0$11.length),(t1$9===3)))){t0$11[0];e$2=t0$11[1];t0$11[2];temp$6=e$2;acc$5.push(temp$6);}else{___match_error(m$9,"/home/olivier/git/earl-grey/src/location.eg",2900,2928);}}})(),acc$5));bot$3=Math.min(start$4,top$3);$targ$4=jumptill$0(active$3,start$4,top$3);t0$12=$targ$4;if(((t0$12 instanceof Array)&&((t1$10=t0$12.length),(t1$10===2)))){spans$6=t0$12[0];t0$12[1];}else{___match_error($targ$4);}return spans$6;}else{if(($$5023$0&&((start$5=m$8$0[0]),(active$4=m$8$0[1]),(t1$8=m$8$0[2]),((t1$8 instanceof Array)&&((t2$0=t1$8.length),((t2$0>=1)&&((t3$0=t1$8[0]),(next$0=t3$0),((t3$0 instanceof Array)&&((t4$0=t3$0.length),(t4$0===3)))))))))){target$0=t3$0[0];end$3=t3$0[1];attr$2=t3$0[2];rest$0=Array.prototype.slice.call(t1$8,1);$targ$5=jumptill$0(active$4,start$5,target$0);t0$13=$targ$5;if(((t0$13 instanceof Array)&&((t1$11=t0$13.length),(t1$11===2)))){spans$7=t0$13[0];newactive$1=t0$13[1];}else{___match_error($targ$5);}[spans$7,newactive$1];return spans$7.concat(process_elements$0(target$0,[next$0].concat(newactive$1),rest$0));}else{return ___match_error(m$8$0);}}}});thespans$0=spans$4.sort((function(temp$7$0,temp$8$0){let t0$14;let t1$12;let t0$15;let t1$13;let s1$0;let e1$0;let s2$0;let e2$0;t0$14=temp$7$0;if(((t0$14 instanceof Array)&&((t1$12=t0$14.length),(t1$12===3)))){s1$0=t0$14[0];e1$0=t0$14[1];t0$14[2];}else{___match_error(temp$7$0);}t0$15=temp$8$0;if(((t0$15 instanceof Array)&&((t1$13=t0$15.length),(t1$13===3)))){s2$0=t0$15[0];e2$0=t0$15[1];t0$15[2];}else{___match_error(temp$8$0);}if((s1$0===s2$0)){return (e1$0-e2$0);}else{return (s1$0-s2$0);}}));return process_elements$0(thespans$0[0][0],[],thespans$0);});highlight_locations$0=(function highlight_locations(){let m$11;let m$12;let acc$6;let temp$9;let srcs$0;let locations$0;let context$1;let t0$16;let m$10$0;m$10$0=arguments;t0$16=m$10$0.length;if(((t0$16>=1)&&(t0$16<=2))){locations$0=m$10$0[0];if((1>=t0$16)){context$1=0;}else{context$1=m$10$0[1];}srcs$0=({});m$11=null;$9:for(m$11 of locations$0){let $targ$6;let key$0;let loc$0;let cls$1;let t0$17;let t1$14;t0$17=m$11;if(((t0$17 instanceof Array)&&((t1$14=t0$17.length),(t1$14===2)))){loc$0=t0$17[0];cls$1=t0$17[1];key$0=String((loc$0.source&&loc$0.source.url));if((!send(srcs$0,key$0))){$targ$6=[];(srcs$0[key$0]=$targ$6);[];}send(srcs$0,key$0).push([loc$0,cls$1]);}else{___match_error(m$11,"/home/olivier/git/earl-grey/src/location.eg",3520,3689);}}return Node(["div"],({}),((acc$6=[]),(temp$9=null),(m$12=null),(function(){$10:for(m$12 of items(srcs$0)){let locs$0;let t0$18;let t1$15;t0$18=m$12;if(((t0$18 instanceof Array)&&((t1$15=t0$18.length),(t1$15===2)))){t0$18[0];locs$0=t0$18[1];temp$9=highlight_locations_same_source$0(locs$0,context$1);acc$6.push(temp$9);}else{___match_error(m$12,"/home/olivier/git/earl-grey/src/location.eg",3701,3788);}}})(),acc$6));}else{return ___match_error(m$10$0);}});highlight_locations_same_source$0=(function highlight_locations_same_source(){let m$14;let acc$7;let temp$10;let t0$21;let t1$17;let m$15;let acc$8;let temp$11;let m$16;let acc$9;let temp$12;let loc$1;let src$0;let $targ$7;let l1$2;let l2$2;let first$0;let last$0;let locations$1;let context$2;let t0$19;let m$13$0;m$13$0=arguments;t0$19=m$13$0.length;if(((t0$19>=1)&&(t0$19<=2))){locations$1=m$13$0[0];if((1>=t0$19)){context$2=0;}else{context$2=m$13$0[1];}loc$1=merge_locations$0(((acc$7=[]),(temp$10=null),(m$14=null),(function(){$11:for(m$14 of locations$1){let x$2;let cls$2;let t0$20;let t1$16;t0$20=m$14;if(((t0$20 instanceof Array)&&((t1$16=t0$20.length),(t1$16===2)))){x$2=t0$20[0];cls$2=t0$20[1];temp$10=x$2;acc$7.push(temp$10);}else{___match_error(m$14,"/home/olivier/git/earl-grey/src/location.eg",3871,3899);}}})(),acc$7));src$0=loc$1.source;$targ$7=loc$1.linerange();t0$21=$targ$7;if(((t0$21 instanceof Array)&&((t1$17=t0$21.length),(t1$17===2)))){l1$2=t0$21[0];l2$2=t0$21[1];}else{___match_error($targ$7);}[l1$2,l2$2];first$0=Math.max(1,(l1$2-context$2));last$0=Math.min(src$0.nlines,(l2$2+context$2));return Node(["div",".location"],({}),[Node(["div",".source"],({}),[Node([".sourcefile"],({}),(src$0.url||"???")),((acc$8=[]),(temp$11=null),(m$15=null),(function(){$12:for(m$15 of locations$1){let loc$2;let cls$3;let t0$22;let t1$18;t0$22=m$15;if(((t0$22 instanceof Array)&&((t1$18=t0$22.length),(t1$18===2)))){loc$2=t0$22[0];cls$3=t0$22[1];temp$11=Node([("."+cls$3),".sourcepos"],({}),loc$2.ref());acc$8.push(temp$11);}else{___match_error(m$15,"/home/olivier/git/earl-grey/src/location.eg",4119,4265);}}})(),acc$8)]),src$0.highlight_lines(first$0,last$0,((acc$9=[]),(temp$12=null),(m$16=null),(function(){$13:for(m$16 of locations$1){let loc$3;let cls$4;let t0$23;let t1$19;t0$23=m$16;if(((t0$23 instanceof Array)&&((t1$19=t0$23.length),(t1$19===2)))){loc$3=t0$23[0];cls$4=t0$23[1];temp$12=[loc$3.start,loc$3.end,[cls$4]];acc$9.push(temp$12);}else{___match_error(m$16,"/home/olivier/git/earl-grey/src/location.eg",4320,4376);}}})(),acc$9))]);}else{return ___match_error(m$13$0);}});merge_locations$0=(function merge_locations(ph$0$0){let m$17;let acc$10;let temp$13;let m$18;let acc$11;let temp$14;let start$6;let end$4;let locs$1;let loc$4;let $$5473$0;let $$5474$0;let t0$24;let t1$20;t0$24=ph$0$0;t1$20=t0$24.length;if((t1$20===0)){return Location$0(null,0,0);}else{if((t1$20===1)){loc$4=t0$24[0];return loc$4;}else{if((t1$20>=0)){locs$1=Array.prototype.slice.call(t0$24,0);start$6=send(Math.min,((acc$10=[]),(temp$13=null),(m$17=null),(function(){$14:for(m$17 of locs$1){let loc$5;loc$5=m$17;temp$13=loc$5.start;acc$10.push(temp$13);}})(),acc$10));end$4=send(Math.max,((acc$11=[]),(temp$14=null),(m$18=null),(function(){$15:for(m$18 of locs$1){let loc$6;loc$6=m$18;temp$14=loc$6.end;acc$11.push(temp$14);}})(),acc$11));return Location$0(locs$1[0].source,start$6,end$4);}else{return ___match_error(ph$0$0);}}}});__lt____lt____colon__$0=(function(x$3,y$0){let $targ$8;if((!getChecker(Location$0)(x$3.location))){if(((!y$0)||getChecker(Location$0)(y$0))){$targ$8=y$0;}else{$targ$8=y$0.location;}(x$3["location"]=$targ$8);[];}return x$3;});__plus____plus____colon__$0=(function(x$4,y$1){let rval$0;let x2$0;let y2$0;if(((!x$4)||getChecker(Location$0)(x$4))){x2$0=x$4;}else{x2$0=x$4.location;}if(((!y$1)||getChecker(Location$0)(y$1))){y2$0=y$1;}else{y2$0=y$1.location;}rval$0=false;try{rval$0=merge_locations$0([x2$0,y2$0]);rval$0;}catch(excv$0){let e$3;e$3=excv$0;rval$0=undefined;rval$0;}return rval$0;});format_error$0=(function format_error(){let m$20;let acc$12;let temp$15;let hls$0;let locs$2;let rval$1;let loc$8;let data$0;let other$0;let url$0;let start$7;let end$5;let loc$7;let args$0;let fmt_args$0;let $$5615$0;let $$5616$0;let $$5617$0;let t0$26;let t1$22;let t2$1;let e$4;let ph$2$0;let context$3;let t0$25;let t1$21;let m$19$0;m$19$0=arguments;t0$25=m$19$0.length;if(((t0$25>=1)&&(t0$25<=2))){t1$21=m$19$0[0];e$4=t1$21;ph$2$0=t1$21;if((1>=t0$25)){context$3=0;}else{context$3=m$19$0[1];}fmt_args$0=(function fmt_args(e$5){if((e$5.args&&e$5.args.length)){return Node([".error_args"],({}),repr$0(e$5.args));}else{return "";}});t0$26=ph$2$0;if((getChecker(ErrorFactory(["syntax"]))(t0$26)&&(___hasprop(t0$26,"args")&&((t1$22=t0$26.args),((t1$22 instanceof Array)&&((t2$1=t1$22.length),(t2$1===1))))))){args$0=t1$22[0];hls$0=["hl1","hl2","hl3","hl4"];acc$12=[];temp$15=null;m$20=null;$16:for(m$20 of enumerate(items(args$0))){let i$0;let key$1;let arg$0;let t0$27;let t1$23;let t2$2;let t3$1;t0$27=m$20;if(((t0$27 instanceof Array)&&((t1$23=t0$27.length),((t1$23===2)&&((i$0=t0$27[0]),(t2$2=t0$27[1]),((t2$2 instanceof Array)&&((t3$1=t2$2.length),((t3$1===2)&&((key$1=t2$2[0]),(arg$0=t2$2[1]),(arg$0&&arg$0.location)))))))))){temp$15=[arg$0.location,send(hls$0,(i$0%4))];acc$12.push(temp$15);}else{false;}}locs$2=acc$12;return Node(["div"],({}),[Node([".error"],({}),[Node([".error_type"],({}),e$4.name),Node([".error_message"],({}),e$4.message)]),Node([".error_args",".syntax"],({}),repr$0(args$0)),highlight_locations$0(locs$2,context$3)]);}else{if((($$5616$0=___hasprop(t0$26,"location"))&&((t1$22=t0$26.location),getChecker(Location$0)(t1$22)))){loc$7=t1$22;return Node(["div"],({}),[Node([".error"],({}),[Node([".error_type"],({}),e$4.name),Node([".error_message"],({}),e$4.message)]),fmt_args$0(e$4),highlight_locations$0([[loc$7,"hl1"]],context$3),Node([".traceback"],({}),(e$4.stack||""))]);}else{if(($$5616$0&&((t1$22 instanceof Array)&&((t2$1=t1$22.length),((t2$1===4)&&(t1$22[0]==="location")))))){url$0=t1$22[1];start$7=t1$22[2];end$5=t1$22[3];rval$1=false;try{rval$1=fs$0.readFileSync(url$0,"utf8");rval$1;}catch(excv$1){let e$6;e$6=excv$1;rval$1=null;rval$1;}data$0=rval$1;if(data$0){loc$8=Location$0(Source$0(data$0,url$0),start$7,end$5);return Node(["div"],({}),[Node([".error"],({}),[Node([".error_type"],({}),e$4.name),Node([".error_message"],({}),e$4.message)]),fmt_args$0(e$4),highlight_locations$0([[loc$8,"hl1"]],context$3),Node([".traceback"],({}),(Node([],({}),e$4.stack)||""))]);}else{return Node(["div"],({}),[Node([".error"],({}),[Node([".error_type"],({}),e$4.name),Node([".error_message"],({}),e$4.message)]),fmt_args$0(e$4),Node([".traceback"],({}),(Node([],({}),e$4.stack)||e$4))]);}}else{other$0=ph$2$0;return Node(["div"],({}),[Node([".error"],({}),[Node([".error_type"],({}),e$4.name),Node([".error_message"],({}),e$4.message)]),fmt_args$0(e$4),Node([".traceback"],({}),Node([],({}),e$4.stack))]);}}}}else{return ___match_error(m$19$0);}});display_error$0=(function display_error(e$7){return __lt____gt__$0(null,format_error$0(e$7));});$targ$9=Source$0;(exports["Source"]=$targ$9);[];$targ$10=Location$0;(exports["Location"]=$targ$10);[];$targ$11=highlight$0;(exports["highlight"]=$targ$11);[];$targ$12=highlight_locations$0;(exports["highlight_locations"]=$targ$12);[];$targ$13=merge_locations$0;(exports["merge_locations"]=$targ$13);[];$targ$14=__lt____lt____colon__$0;(exports["<<:"]=$targ$14);[];$targ$15=__plus____plus____colon__$0;(exports["++:"]=$targ$15);[];$targ$16=format_error$0;(exports["format_error"]=$targ$16);[];$targ$17=display_error$0;(exports["display_error"]=$targ$17);[];
