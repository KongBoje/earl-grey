
'use strict';require('earlgrey-runtime/6');let accum$0;let $targ$1;let accum$1;let $targ$2;let accum$2;let accum$3;let $targ$3;let accum$4;let $targ$4;let accum$5;let $targ$29;let accum$6;let $targ$30;let accum$7;let $targ$35;let accum$8;let $targ$36;let accum$9;let $targ$42;let $targ$43;let $0$0;let __lt____lt____colon__$0;let util$0;let GenSym$0;let gensym$0;let classify$0;let classify_contiguous$0;let identity$0;let Body$0;let camelCase$0;let checker_db$0;let PatternInfo$0;let PatternCompiler$0;let PatternProcessor$0;let $targ$0;let assemble_conditions$0;let assemble_pattern$0;let inject_below_uses$0;let checkall$0;let same_block$0;let parse_clauses$0;let opt_clauses$0;let weave_clauses$0;$0$0=require("./location");__lt____lt____colon__$0=getProperty($0$0,"<<:","./location");util$0=require("./util");GenSym$0=getProperty(util$0,"GenSym","util");gensym$0=getProperty(util$0,"gensym","util");classify$0=getProperty(util$0,"classify","util");classify_contiguous$0=getProperty(util$0,"classify_contiguous","util");identity$0=getProperty(util$0,"identity","util");Body$0=getProperty(util$0,"Body","util");camelCase$0=getProperty(util$0,"camelCase","util");checker_db$0=getProperty(util$0,"checker_db","util");PatternInfo$0=(function PatternInfo(){let t0$0;let m$0$0;let $it$0;if((!getChecker(PatternInfo$0)(this))){$it$0=Object.create(PatternInfo$0.prototype);}else{$it$0=this;}m$0$0=arguments;t0$0=m$0$0.length;if(((t0$0>=0)&&(t0$0<=3))){($it$0["handlers"]=((0>=t0$0)?[]:m$0$0[0]));($it$0["vars"]=((1>=t0$0)?[]:m$0$0[1]));($it$0["arguments"]=((2>=t0$0)?[]:m$0$0[2]));undefined;}else{___match_error(m$0$0,"{@handlers = {}, @vars = {}, @arguments = {}}");}return $it$0;});__amp____colon__(((accum$0=({})),(accum$0["mergeAll"]=(function mergeAll(pinfos$0){let f$0;let rval$0;rval$0=PatternInfo$0();f$0=(function f(acc$0,pinfo$0){return acc$0.merge((pinfo$0.pinfo||pinfo$0));});return pinfos$0.reduce(f$0,rval$0);})),accum$0),__amp____colon__((($targ$1="PatternInfo"),(accum$1=({})),(accum$1["::name"]=$targ$1),accum$1),(($targ$2=true),(accum$2=({})),(accum$2["::egclass"]=$targ$2),accum$2)));(PatternInfo$0.prototype["merge"]=(function merge(pinfo$1){let $it$1;let self$0;$it$1=this;self$0=this;($it$1["handlers"]=$it$1.handlers.concat(pinfo$1.handlers));($it$1["vars"]=$it$1.vars.concat(pinfo$1.vars));($it$1["arguments"]=$it$1.arguments.concat(pinfo$1.arguments));return $it$1;}));__amp____colon__(PatternInfo$0,__amp____colon__(((accum$3=({})),(accum$3["mergeAll"]=(function mergeAll(pinfos$1){let f$1;let rval$1;rval$1=PatternInfo$0();f$1=(function f(acc$1,pinfo$2){return acc$1.merge((pinfo$2.pinfo||pinfo$2));});return pinfos$1.reduce(f$1,rval$1);})),accum$3),__amp____colon__((($targ$3="PatternInfo"),(accum$4=({})),(accum$4["::name"]=$targ$3),accum$4),(($targ$4=true),(accum$5=({})),(accum$5["::egclass"]=$targ$4),accum$5))));PatternCompiler$0=(function PatternCompiler(temp$0$0,temp$1$0,temp$2$0){let $it$2;if((!getChecker(PatternCompiler$0)(this))){$it$2=Object.create(PatternCompiler$0.prototype);}else{$it$2=this;}($it$2["pattern"]=temp$0$0);($it$2["info"]=temp$1$0);($it$2["opt"]=temp$2$0);return $it$2;});(PatternCompiler$0.prototype["compile"]=(function compile(){let tags$0;let $targ$5;let $targ$6;let $targ$7;let $targ$8;let $targ$9;let $targ$10;let $it$3;let self$1;$it$3=this;self$1=this;if($it$3.compiled){return $it$3.compiled;}tags$0=clone(($it$3.opt.tags||({})));(tags$0["group_id"]=(tags$0.group_id||gensym$0("group")));$targ$5=$it$3.expand($it$3.pattern,tags$0,true,$it$3.opt.indexable);($it$3["compiled"]=$targ$5);$targ$6=$it$3.info;($it$3.compiled.pinfo["info"]=$targ$6);$targ$7=$it$3.opt;($it$3.compiled.pinfo["opt"]=$targ$7);$targ$8=$it$3.compiled.pinfo.vars;($it$3["vars"]=$targ$8);$targ$9=$it$3.compiled.pinfo.handlers;($it$3["handlers"]=$targ$9);$targ$10=$it$3.compiled.pinfo.arguments;($it$3["arguments"]=$targ$10);return $it$3.compiled;}));(PatternCompiler$0.prototype["fork"]=(function fork(pattern$0){let pc$0;let $targ$11;let $targ$12;let $targ$13;let $targ$14;let $it$4;let self$2;$it$4=this;self$2=this;pc$0=PatternCompiler$0(null,$it$4.info,$it$4.opt);$targ$11=pattern$0;(pc$0["compiled"]=$targ$11);$targ$12=$it$4.vars;(pc$0["vars"]=$targ$12);$targ$13=$it$4.arguments;(pc$0["arguments"]=$targ$13);$targ$14=$it$4.handlers;(pc$0["handlers"]=$targ$14);__amp____colon__(pc$0,pattern$0.pinfo);return pc$0;}));(PatternCompiler$0.prototype["parse_specs"]=(function parse_specs(specs$0,tags$1){let m$2;let acc$2;let temp$3;let rest$0;let has_defaults$0;let curidx$0;let insidx$0;let setInsidx$0;let rval$2;let $targ$15;let $targ$16;let $it$5;let self$3;$it$5=this;self$3=this;rest$0=undefined;has_defaults$0=false;curidx$0=0;insidx$0=null;setInsidx$0=(function setInsidx(spec$0){let msg$0;let x$0;let m$1$0;if(equal(insidx$0,null)){m$1$0=curidx$0;if((m$1$0===null)){msg$0="Object patterns cannot be after rest/default arguments.";throw ErrorFactory(["syntax","pattern"]).create(msg$0,({"expr":spec$0}));}else{x$0=m$1$0;insidx$0=x$0;return insidx$0;}}});rval$2=classify$0("fw","bw","keys","defaults",((acc$2=[]),(temp$3=null),(m$2=null),(function(){$2:for(m$2 of $it$5.info.step_all(["pattern"],specs$0)){let t0$3;let t0$4;let msg$1;let res$0;let v$0;let t0$11;let t1$5;let t2$1;let m$5$0;let m$3$0;let esubp$0;let wrap$0;let finalize$0;let v$2;let v$1;let variable$1;let value$2;let key$0;let subp$0;let variable$0;let t0$2;let t1$0;let bridge$$21154$0;let spec$1;let ph$0$0;let t0$1;t0$1=m$2;spec$1=t0$1;ph$0$0=t0$1;t0$2=ph$0$0;if((Array.isArray(t0$2)&&((t1$0=t0$2.length),((t1$0===2)&&(t0$2[0]==="dynsplice"))))){variable$0=t0$2[1];curidx$0=null;rest$0=$it$5.expand(variable$0,tags$1);temp$3=["ignore"];}else{bridge$$21154$0=ph$0$0;if(((Array.isArray(bridge$$21154$0)&&((t0$3=bridge$$21154$0.length),((t0$3===3)&&((bridge$$21154$0[0]==="assoc")&&((key$0=bridge$$21154$0[1]),(subp$0=bridge$$21154$0[2]),true)))))||(Array.isArray(bridge$$21154$0)&&((t0$4=bridge$$21154$0.length),((t0$4===2)&&((bridge$$21154$0[0]==="assoc")&&((subp$0=bridge$$21154$0[1]),(key$0=null),true))))))){setInsidx$0(spec$1);esubp$0=$it$5.expand(subp$0,tags$1);wrap$0=(function wrap(){let p2$0;let t0$7;let t1$3;let t0$8;let field$0;let x$1;let y$0;let kexpr$0;let $$21248$0;let $$21249$0;let $$21250$0;let $$21251$0;let t0$6;let t1$2;let t2$0;let t3$0;let t4$0;let t5$0;let t6$0;let t7$0;let bridge$$21246$0;let key$1;let ph$2$0;let value$0;let default$1;let t0$5;let t1$1;let m$4$0;m$4$0=arguments;t0$5=m$4$0.length;if(((t0$5>=2)&&(t0$5<=3))){t1$1=m$4$0[0];key$1=t1$1;ph$2$0=t1$1;value$0=m$4$0[1];if((2>=t0$5)){default$1=[];}else{default$1=m$4$0[2];}t0$6=ph$2$0;t1$2=t0$6.length;if((($$21250$0=(t1$2===3))&&(($$21251$0=(t0$6[0]==="send"))&&((t2$0=t0$6[1]),(Array.isArray(t2$0)&&((t3$0=t2$0.length),((t3$0===2)&&((t2$0[0]==="symbol")&&((t2$0[1]==="^")&&((t4$0=t0$6[2]),(Array.isArray(t4$0)&&((t5$0=t4$0.length),((t5$0===3)&&((t4$0[0]==="data")&&((t6$0=t4$0[1]),(Array.isArray(t6$0)&&((t7$0=t6$0.length),((t7$0===1)&&(t6$0[0]==="void"))))))))))))))))))){kexpr$0=t4$0[2];return [kexpr$0,value$0].concat(default$1);}else{if($$21251$0){x$1=t0$6[1];y$0=t0$6[2];p2$0=__amp____colon__(["object_pattern",[y$0,value$0].concat(default$1)],({"pinfo":value$0.pinfo,"::objinsert":2}));return wrap$0(x$1,p2$0,default$1);}else{bridge$$21246$0=ph$2$0;if(((Array.isArray(bridge$$21246$0)&&((t0$7=bridge$$21246$0.length),((t0$7===2)&&((bridge$$21246$0[0]==="symbol")&&((t1$3=getProjector(camelCase$0)(bridge$$21246$0[1])),(t1$3[0]&&((field$0=t1$3[1]),true)))))))||(Array.isArray(bridge$$21246$0)&&((t0$8=bridge$$21246$0.length),((t0$8===2)&&((bridge$$21246$0[0]==="value")&&((field$0=bridge$$21246$0[1]),true))))))){return [__lt____lt____colon__$0(["value",field$0],key$1),value$0].concat(default$1);}else{throw send(send(ErrorFactory(["syntax","invalid_key"]),"create", true),__amp____colon__(["Invalid key."],({"expr":key$1,"::objinsert":1})));}}}}else{return ___match_error(m$4$0,"{match key, value, default = {}}");}});finalize$0=(function finalize(key$2,temp$4$0){let t0$9;let pattern$1;let default$2;let t0$10;let t1$4;let value$1;let ph$3$0;t0$9=temp$4$0;value$1=t0$9;ph$3$0=t0$9;t0$10=ph$3$0;t1$4=t0$10.length;if(((t1$4===3)&&(t0$10[0]==="default"))){pattern$1=t0$10[1];default$2=t0$10[2];return ["keys",wrap$0(key$2,pattern$1,[default$2])];}else{return ["keys",wrap$0(key$2,value$1)];}});m$3$0=key$0;if((m$3$0===null)){m$5$0=esubp$0;res$0=m$5$0;if((___hasprop(m$5$0,"pinfo")&&((t0$11=m$5$0.pinfo),(___hasprop(t0$11,"vars")&&((t1$5=t0$11.vars),(Array.isArray(t1$5)&&((t2$1=t1$5.length),(t2$1===1)))))))){v$0=t1$5[0];temp$3=finalize$0(v$0,esubp$0);}else{msg$1=ENode([],({}),["Could not identify the name of the field to extract"]).toString();throw send(send(ErrorFactory(["syntax","no_field"]),"create", true),__amp____colon__([msg$1],({"expr":spec$1,"::objinsert":1})));}}else{temp$3=finalize$0(key$0,esubp$0);}}else{t0$2=ph$0$0;if((Array.isArray(t0$2)&&((t1$0=t0$2.length),((t1$0===3)&&(t0$2[0]==="default"))))){variable$1=t0$2[1];value$2=t0$2[2];curidx$0=null;has_defaults$0=true;if(rest$0){throw ErrorFactory(["syntax","pattern"]).create("No default arguments after rest arg.");}else{temp$3=["defaults",[$it$5.expand(variable$1,tags$1),value$2]];}}else{v$1=ph$0$0;if(((rest$0===undefined)&&(!has_defaults$0))){curidx$0=(curidx$0+1);temp$3=["fw",$it$5.expand(v$1,tags$1)];}else{v$2=ph$0$0;curidx$0=null;temp$3=["bw",$it$5.expand(v$2,tags$1)];}}}}acc$2.push(temp$3);}})(),acc$2));$targ$15=rest$0;(rval$2["rest"]=$targ$15);$targ$16=insidx$0;(rval$2["insertion_index"]=$targ$16);return rval$2;}));(PatternCompiler$0.prototype["expand"]=(function expand(){let x$2;let x$3;let p$0;let x$4;let x$5;let variable$2;let variable$3;let csubp$0;let csubp$1;let csubp$2;let csubp$3;let x$8;let fn$0;let $targ$17;let msg$2;let msg$3;let cx$0;let m$8;let acc$3;let temp$5;let cxs$0;let m$10;let acc$5;let temp$7;let m$11;let canon$0;let normalize$0;let pps$0;let m$13;let acc$6;let temp$8;let m$14;let acc$7;let temp$9;let m$15;let acc$8;let temp$10;let m$16;let acc$9;let temp$11;let patt$0;let keys$1;let fw$1;let bw$1;let defaults$1;let rest$2;let keys$0;let fw$0;let bw$0;let defaults$0;let rest$1;let $$21853$0;let t0$20;let t1$11;let t2$4;let t3$1;let t4$1;let t5$1;let m$12$0;let specs$1;let pinfos$2;let pinfo$3;let r$0;let other$0;let subp$6;let expr$1;let mode$0;let subp$5;let args$1;let xs$1;let xs$0;let x$9;let f$3;let arg$0;let f$2;let args$0;let checker$0;let subp$4;let projector$0;let subp$3;let unconditional$0;let condition$0;let subp$2;let subp$1;let value$3;let x$7;let x$6;let v$4;let v$3;let handler$0;let $$21527$0;let $$21528$0;let $$21529$0;let $$21530$0;let t0$13;let bridge$$21508$0;let t1$6;let m$7$0;let $targ$18;let expr$0;let rval$3;let pattern$2;let tags$2;let toplevel$0;let checked$0;let t0$12;let m$6$0;let $it$6;let self$4;$it$6=this;self$4=this;m$6$0=arguments;t0$12=m$6$0.length;if(((t0$12>=2)&&(t0$12<=4))){pattern$2=m$6$0[0];tags$2=m$6$0[1];if((2>=t0$12)){toplevel$0=false;}else{toplevel$0=m$6$0[2];}if((3>=t0$12)){checked$0=false;}else{checked$0=m$6$0[3];}expr$0=$it$6.info.step(["pattern"],pattern$2);m$7$0=expr$0;if(((x$2=m$7$0),((x$2 instanceof Array)&&(x$2[0]==="void")))){rval$3=["ignore"];}else{if(((x$3=m$7$0),((x$3 instanceof Array)&&(x$3[0]==="ignore")))){rval$3=expr$0;}else{if((Array.isArray(m$7$0)&&((t0$13=m$7$0.length),((t0$13===2)&&(m$7$0[0]==="special"))))){handler$0=m$7$0[1];p$0=$it$6.expand(handler$0.expand($it$6.info),tags$2,toplevel$0,false);p$0.pinfo.handlers.push(handler$0);rval$3=p$0;}else{bridge$$21508$0=m$7$0;if((((x$4=bridge$$21508$0),((x$4 instanceof Array)&&(x$4[0]==="symbol")))||((x$5=bridge$$21508$0),((x$5 instanceof Array)&&(x$5[0]==="variable"))))){variable$2=__amp__(expr$0,tags$2);rval$3=__amp____colon__(["assign",variable$2],({"pinfo":PatternInfo$0([],[variable$2])}));}else{if((($$21527$0=Array.isArray(m$7$0))&&((t0$13=m$7$0.length),(($$21529$0=(t0$13===2))&&(($$21530$0=(m$7$0[0]==="value"))&&((v$3=m$7$0[1]),$it$6.opt.strings_as_variables)))))){variable$3=__lt____lt____colon__$0(__amp__(["value",v$3],tags$2),expr$0);rval$3=__amp____colon__(["assign",variable$3],({"pinfo":PatternInfo$0([],[variable$3])}));}else{if($$21530$0){v$4=m$7$0[1];rval$3=["check",checker_db$0(v$4),["ignore"]];}else{if(($$21529$0&&(($$21530$0=(m$7$0[0]==="calc"))&&((x$6=m$7$0[1]),$it$6.opt.strings_as_variables)))){rval$3=["assign",["multi",x$6]];}else{if($$21530$0){x$7=m$7$0[1];throw send(send(ErrorFactory(["syntax","pattern"]),"create", true),__amp____colon__([ENode([],({}),["Computed properties are not allowed here"]).toString()],({"expr":expr$0,"::objinsert":1})));}else{if(($$21527$0&&(($$21529$0=(t0$13===3))&&(m$7$0[0]==="replace")))){subp$1=m$7$0[1];value$3=m$7$0[2];csubp$0=$it$6.expand(subp$1,tags$2,toplevel$0,false);rval$3=__amp____colon__(["replace",csubp$0,value$3],({"pinfo":csubp$0.pinfo}));}else{if(($$21529$0&&(m$7$0[0]==="test"))){condition$0=m$7$0[1];subp$2=m$7$0[2];csubp$1=$it$6.expand(subp$2,tags$2,toplevel$0,false);rval$3=__amp____colon__(["test",condition$0,csubp$1],({"pinfo":csubp$1.pinfo}));}else{if(($$21527$0&&(((t0$13>=3)&&(t0$13<=4))&&(m$7$0[0]==="project")))){projector$0=m$7$0[1];subp$3=m$7$0[2];if((3>=t0$13)){unconditional$0=false;}else{unconditional$0=m$7$0[3];}csubp$2=$it$6.expand(subp$3,tags$2,toplevel$0,true);rval$3=__amp____colon__(["project",projector$0,csubp$2,unconditional$0],({"pinfo":csubp$2.pinfo}));}else{if(($$21527$0&&(($$21529$0=(t0$13===3))&&(m$7$0[0]==="check")))){checker$0=m$7$0[1];subp$4=m$7$0[2];csubp$3=$it$6.expand(subp$4,tags$2,toplevel$0,true);rval$3=__amp____colon__(["check",checker$0,csubp$3],({"pinfo":csubp$3.pinfo}));}else{if(($$21529$0&&(($$21530$0=(m$7$0[0]==="send"))&&((f$2=m$7$0[1]),(t1$6=m$7$0[2]),(x$8=t1$6),((x$8 instanceof Array)&&(x$8[0]==="data")))))){args$0=t1$6;if(toplevel$0){fn$0=$it$6.expand(f$2,tags$2,true,false);$targ$17=PatternInfo$0.mergeAll([fn$0.pinfo,PatternInfo$0([],[],[args$0])]);(fn$0["pinfo"]=$targ$17);rval$3=fn$0;}else{msg$2="Function arguments can only be declared as a top level pattern.";throw ErrorFactory(["syntax","pattern"]).create(msg$2,({"node":expr$0,"arg":args$0}));}}else{if($$21530$0){f$3=m$7$0[1];arg$0=m$7$0[2];rval$3=["assign",expr$0];}else{if((!$it$6.opt.allow_nested)){msg$3="Nested patterns are not allowed here.";throw ErrorFactory(["syntax","pattern"]).create(msg$3,({"node":expr$0}));}else{if((($$21527$0=Array.isArray(m$7$0))&&((t0$13=m$7$0.length),((t0$13===2)&&(m$7$0[0]==="neg"))))){x$9=m$7$0[1];cx$0=$it$6.expand(x$9,tags$2);rval$3=__amp____colon__(["neg",cx$0],({"pinfo":cx$0.pinfo}));}else{if(($$21527$0&&(($$21529$0=(t0$13>=1))&&(m$7$0[0]==="all")))){xs$0=Array.prototype.slice.call(m$7$0,1);acc$3=[];temp$5=null;m$8=null;$3:for(m$8 of xs$0){let x$10;x$10=m$8;temp$5=$it$6.expand(x$10,tags$2);acc$3.push(temp$5);}cxs$0=acc$3;rval$3=__amp____colon__(["all"].concat(cxs$0),({"pinfo":PatternInfo$0.mergeAll(cxs$0)}));}else{if(($$21529$0&&(m$7$0[0]==="any"))){xs$1=Array.prototype.slice.call(m$7$0,1);canon$0=(function canon(all$0){return all$0.sort().join(",");});normalize$0=(function normalize(vars$0){let m$9;let acc$4;let temp$6;return canon$0(((acc$4=[]),(temp$6=null),(m$9=null),(function(){$5:for(m$9 of vars$0){let v$5;let t0$14;let t1$7;t0$14=m$9;if((Array.isArray(t0$14)&&((t1$7=t0$14.length),((t1$7===2)&&(t0$14[0]==="symbol"))))){v$5=t0$14[1];temp$6=v$5;acc$4.push(temp$6);}else{___match_error(m$9);}}})(),acc$4));});acc$5=[];temp$7=null;m$10=null;$6:for(m$10 of xs$1){let x$11;x$11=m$10;temp$7=$it$6.expand(x$11,tags$2);acc$5.push(temp$7);}pps$0=acc$5;m$11=null;$4:for(m$11 of neighbours(pps$0)){let v1$0;let v2$0;let pp1$0;let pp2$0;let t0$15;let t1$8;t0$15=m$11;if((Array.isArray(t0$15)&&((t1$8=t0$15.length),(t1$8===2)))){pp1$0=t0$15[0];pp2$0=t0$15[1];v1$0=pp1$0.pinfo.vars;v2$0=pp2$0.pinfo.vars;if((normalize$0(v1$0)!==normalize$0(v2$0))){throw ErrorFactory(["syntax","pattern"]).create("Both branches of 'or' must contain the same variables",({"vars1":__lt____lt____colon__$0(v1$0.sort(),pp1$0),"vars2":__lt____lt____colon__$0(v2$0.sort(),pp2$0)}));}}else{___match_error(m$11);}}rval$3=__amp____colon__(["any"].concat(pps$0),({"pinfo":(pps$0[0]&&pps$0[0].pinfo)}));}else{if(($$21529$0&&(m$7$0[0]==="data"))){args$1=Array.prototype.slice.call(m$7$0,1);specs$1=$it$6.parse_specs(args$1,tags$2);pinfos$2=[];pinfos$2=pinfos$2.concat(((acc$6=[]),(temp$8=null),(m$13=null),(function(){$7:for(m$13 of specs$1.keys){let pinfo$4;let t0$16;let t1$9;let t2$2;t0$16=m$13;if((Array.isArray(t0$16)&&((t1$9=t0$16.length),(((t1$9>=2)&&(t1$9<=3))&&(t0$16[0],(t2$2=t0$16[1]),___hasprop(t2$2,"pinfo")))))){pinfo$4=t2$2.pinfo;if((2>=t1$9)){null;}else{t0$16[2];}temp$8=pinfo$4;acc$6.push(temp$8);}else{___match_error(m$13);}}})(),acc$6));pinfos$2=pinfos$2.concat(((acc$7=[]),(temp$9=null),(m$14=null),(function(){$8:for(m$14 of specs$1.fw){let pinfo$5;let t0$17;t0$17=m$14;if(___hasprop(t0$17,"pinfo")){pinfo$5=t0$17.pinfo;temp$9=pinfo$5;acc$7.push(temp$9);}else{___match_error(m$14);}}})(),acc$7));pinfos$2=pinfos$2.concat(((acc$8=[]),(temp$10=null),(m$15=null),(function(){$9:for(m$15 of specs$1.bw){let pinfo$6;let t0$18;t0$18=m$15;if(___hasprop(t0$18,"pinfo")){pinfo$6=t0$18.pinfo;temp$10=pinfo$6;acc$8.push(temp$10);}else{___match_error(m$15);}}})(),acc$8));pinfos$2=pinfos$2.concat(((acc$9=[]),(temp$11=null),(m$16=null),(function(){$10:for(m$16 of specs$1.defaults){let pinfo$7;let t0$19;let t1$10;let t2$3;t0$19=m$16;if((Array.isArray(t0$19)&&((t1$10=t0$19.length),((t1$10===2)&&((t2$3=t0$19[0]),___hasprop(t2$3,"pinfo")))))){pinfo$7=t2$3.pinfo;t0$19[1];temp$11=pinfo$7;acc$9.push(temp$11);}else{___match_error(m$16);}}})(),acc$9));if(specs$1.rest){pinfos$2.push(specs$1.rest.pinfo);}pinfo$3=PatternInfo$0.mergeAll(pinfos$2);m$12$0=specs$1;if((($$21853$0=___hasprop(m$12$0,"keys"))&&((t0$20=m$12$0.keys),(Array.isArray(t0$20)&&((t1$11=t0$20.length),((t1$11===0)&&(___hasprop(m$12$0,"fw")&&((fw$0=m$12$0.fw),(___hasprop(m$12$0,"bw")&&((bw$0=m$12$0.bw),(___hasprop(m$12$0,"defaults")&&((defaults$0=m$12$0.defaults),___hasprop(m$12$0,"rest"))))))))))))){rest$1=m$12$0.rest;patt$0=__amp____colon__(__lt____lt____colon__$0(["array_pattern",fw$0,bw$0,defaults$0,rest$1],pattern$2),({"pinfo":pinfo$3}));if(checked$0){rval$3=patt$0;}else{rval$3=__amp____colon__(["check",checker_db$0.Array,patt$0],({"pinfo":pinfo$3}));}}else{if(($$21853$0&&((keys$0=m$12$0.keys),(___hasprop(m$12$0,"fw")&&((t0$20=m$12$0.fw),(Array.isArray(t0$20)&&((t1$11=t0$20.length),((t1$11===0)&&(___hasprop(m$12$0,"bw")&&((t2$4=m$12$0.bw),(Array.isArray(t2$4)&&((t3$1=t2$4.length),((t3$1===0)&&(___hasprop(m$12$0,"defaults")&&((t4$1=m$12$0.defaults),(Array.isArray(t4$1)&&((t5$1=t4$1.length),((t5$1===0)&&(___hasprop(m$12$0,"rest")&&(m$12$0.rest===(void 0))))))))))))))))))))){rval$3=__amp____colon__(["object_pattern"].concat(keys$0),({"pinfo":pinfo$3}));}else{if(($$21853$0&&((keys$1=m$12$0.keys),(___hasprop(m$12$0,"fw")&&((fw$1=m$12$0.fw),(___hasprop(m$12$0,"bw")&&((bw$1=m$12$0.bw),(___hasprop(m$12$0,"defaults")&&((defaults$1=m$12$0.defaults),___hasprop(m$12$0,"rest")))))))))){rest$2=m$12$0.rest;rval$3=__amp____colon__(["all",["array_pattern",fw$1,bw$1,defaults$1,rest$2],["object_pattern"].concat(keys$1)],({"pinfo":pinfo$3,"insertion_index":specs$1.insertion_index}));}else{rval$3=___match_error(m$12$0,"{=> keys, => fw, => bw, => defaults, => rest}");}}}}else{if(($$21527$0&&(($$21529$0=(t0$13===3))&&(m$7$0[0]==="mode")))){mode$0=m$7$0[1];subp$5=m$7$0[2];rval$3=$it$6.expand(subp$5,__amp__(tags$2,({"declare_mode":mode$0})),toplevel$0,checked$0);}else{if(($$21529$0&&(m$7$0[0]==="default"))){subp$6=m$7$0[1];expr$1=m$7$0[2];r$0=$it$6.expand(subp$6,tags$2,toplevel$0,checked$0);rval$3=__amp____colon__(["default",r$0,expr$1],({"pinfo":r$0.pinfo,"::objinsert":3}));}else{other$0=m$7$0;throw ErrorFactory(["syntax","pattern"]).create(("Illegal pattern: "+other$0),({"node":other$0}));}}}}}}}}}}}}}}}}}}}}}if((!rval$3.pinfo)){$targ$18=PatternInfo$0();(rval$3["pinfo"]=$targ$18);(void 0);}return ($it$6.opt.wrap_pattern||identity$0)(__lt____lt____colon__$0(rval$3,pattern$2),toplevel$0);}else{return ___match_error(m$6$0,"{pattern, tags, toplevel = false, checked = false}");}}));(PatternCompiler$0.prototype["shift_rhs"]=(function shift_rhs(temp$12$0,rhs$0){let t0$21;let projector$1;let subp$7;let t0$22;let t1$12;let pattern$3;let ph$4$0;let $it$7;let self$5;$it$7=this;self$5=this;t0$21=temp$12$0;pattern$3=t0$21;ph$4$0=t0$21;t0$22=ph$4$0;t1$12=t0$22.length;if(((t1$12===4)&&((t0$22[0]==="project")&&((projector$1=t0$22[1]),(subp$7=t0$22[2]),(t0$22[3]===true))))){return $it$7.shift_rhs(subp$7,["send",projector$1,["data",rhs$0]]);}else{return [pattern$3,rhs$0];}}));(PatternCompiler$0.prototype["process_for_rhs"]=(function process_for_rhs(rhs$1){let t0$23;let t0$24;let t1$13;let x$13;let x$14;let t0$26;let t0$27;let $targ$25;let t0$28;let t1$15;let $targ$26;let name$0;let t0$25;let t1$14;let bridge$$22163$0;let ph$5$0;let bridge$$22160$0;let m$17$0;let t0$29;let $targ$19;let real_rhs$0;let $targ$20;let cpattern$0;let target$0;let expr$2;let proc$0;let $targ$21;let $targ$22;let $targ$23;let $targ$24;let $it$8;let self$6;$it$8=this;self$6=this;if((!$it$8.compiled)){$it$8.compile();}if(((!$it$8.opt.allow_arguments)&&$it$8.arguments.length)){throw ErrorFactory(["syntax","pattern","arguments"]).create("Arguments cannot be declared in this pattern",({"args":$it$8.arguments[0],"rhs":rhs$1}));}if($it$8.arguments.length){$targ$19=inject_below_uses$0(rhs$1,(function(x$12){return util$0.construct($it$8.arguments.concat([x$12]),(function(args$2,rest$3){return ["send",["symbol","->"],["data",args$2,rest$3]];}));}));}else{$targ$19=rhs$1;}t0$23=getProjector(($it$8.opt.wrap_target||identity$0))($targ$19);if(t0$23[0]){real_rhs$0=t0$23[1];}else{___match_error($targ$19,"[@opt.wrap_target or identity]! real_rhs");}$targ$20=$it$8.shift_rhs($it$8.compiled,real_rhs$0);t0$24=$targ$20;if((Array.isArray(t0$24)&&((t1$13=t0$24.length),(t1$13===2)))){cpattern$0=t0$24[0];target$0=t0$24[1];}else{___match_error($targ$20,"{cpattern, var target}");}[cpattern$0,target$0];__lt____lt____colon__$0(target$0,rhs$1);expr$2=null;m$17$0=target$0;bridge$$22160$0=m$17$0;if((((x$13=bridge$$22160$0),((x$13 instanceof Array)&&(x$13[0]==="symbol")))||((x$14=bridge$$22160$0),((x$14 instanceof Array)&&(x$14[0]==="variable"))))){undefined;}else{ph$5$0=cpattern$0;t0$25=ph$5$0;if((Array.isArray(t0$25)&&((t1$14=t0$25.length),((t1$14===2)&&((t0$25[0]==="assign")&&((bridge$$22163$0=t0$25[1]),((Array.isArray(bridge$$22163$0)&&((t0$26=bridge$$22163$0.length),((t0$26===2)&&((bridge$$22163$0[0]==="symbol")&&((name$0=bridge$$22163$0[1]),true)))))||(Array.isArray(bridge$$22163$0)&&((t0$27=bridge$$22163$0.length),((t0$27===2)&&((bridge$$22163$0[0]==="variable")&&((name$0=bridge$$22163$0[1]),true)))))))))))){$targ$25=name$0;(target$0["name"]=$targ$25);(void 0);}else{$targ$26=[__lt____lt____colon__$0(["variable",$it$8.info.gensym("$targ")],target$0),target$0];t0$28=$targ$26;if((Array.isArray(t0$28)&&((t1$15=t0$28.length),(t1$15===2)))){target$0=t0$28[0];expr$2=t0$28[1];}else{___match_error($targ$26,"{target, expr}");}[target$0,expr$2];}}proc$0=PatternProcessor$0();proc$0.process(cpattern$0,target$0,$it$8.opt);$targ$21=proc$0;t0$29=$targ$21;if((___hasprop(t0$29,"temps")&&(($it$8["temps"]=t0$29.temps),___hasprop(t0$29,"parts")))){($it$8["parts"]=t0$29.parts);}else{___match_error($targ$21,"{temps => @temps, parts => @parts}");}$targ$22=true;($it$8["processed"]=$targ$22);$targ$23=target$0;($it$8["target"]=$targ$23);$targ$24=expr$2;($it$8["expr"]=$targ$24);return [$it$8.temps,$it$8.parts];}));(PatternCompiler$0.prototype["extract_from_rhs"]=(function extract_from_rhs(rhs$2){let m$18;let acc$10;let temp$13;let succ$0;let fail$0;let assembly$0;let $it$9;let self$7;$it$9=this;self$7=this;if((!$it$9.processed)){$it$9.process_for_rhs(rhs$2);}succ$0=$it$9.opt.success($it$9.target);fail$0=$it$9.opt.failure($it$9.target,$it$9.pattern);assembly$0=assemble_pattern$0($it$9.parts,succ$0,fail$0);return ["splice",(($it$9.expr===null)?["splice"]:["splice",["declare",$it$9.target],["assign",$it$9.target,$it$9.expr]])].concat($it$9.opt.declare($it$9.info,$it$9.vars)).concat([["multi"].concat(((acc$10=[]),(temp$13=null),(m$18=null),(function(){$11:for(m$18 of $it$9.temps){let t$0;t$0=m$18;temp$13=["declare",t$0];acc$10.push(temp$13);}})(),acc$10)).concat([assembly$0])]);}));(PatternCompiler$0.prototype["wrapBody"]=(function wrapBody(body$0){let m$19;let m$20;let x$15;let $it$10;let self$8;$it$10=this;self$8=this;m$19=null;$12:for(m$19 of enumerate($it$10.handlers)){let $targ$27;let i$0;let h$0;let t0$30;let t1$16;t0$30=m$19;if((Array.isArray(t0$30)&&((t1$16=t0$30.length),(t1$16===2)))){i$0=t0$30[0];h$0=t0$30[1];$targ$27=(h$0.wrapOrder+(i$0/1000000));(h$0["__ord"]=$targ$27);(void 0);}else{___match_error(m$19);}}$it$10.handlers.sort((function(x$16,y$1){return (x$16.__ord<y$1.__ord);}));x$15=body$0;m$20=null;$13:for(m$20 of $it$10.handlers){let handler$1;handler$1=m$20;x$15=handler$1.wrap(x$15,$it$10.info,$it$10.opt);x$15;}return x$15;}));(PatternCompiler$0.prototype["wrapAssignment"]=(function wrapAssignment(expr$3){let m$21;let m$22;let x$17;let $it$11;let self$9;$it$11=this;self$9=this;m$21=null;$14:for(m$21 of enumerate($it$11.handlers)){let $targ$28;let i$1;let h$1;let t0$31;let t1$17;t0$31=m$21;if((Array.isArray(t0$31)&&((t1$17=t0$31.length),(t1$17===2)))){i$1=t0$31[0];h$1=t0$31[1];$targ$28=(h$1.wrapBodyOrder+(i$1/1000000));(h$1["__ord"]=$targ$28);(void 0);}else{___match_error(m$21);}}$it$11.handlers.sort((function(x$18,y$2){return (x$18.__ord<y$2.__ord);}));x$17=expr$3;m$22=null;$15:for(m$22 of $it$11.handlers){let handler$2;handler$2=m$22;x$17=handler$2.wrapAssignment(x$17,$it$11.info,$it$11.opt);x$17;}return x$17;}));__amp____colon__(PatternCompiler$0,__amp____colon__((($targ$29="PatternCompiler"),(accum$6=({})),(accum$6["::name"]=$targ$29),accum$6),(($targ$30=true),(accum$7=({})),(accum$7["::egclass"]=$targ$30),accum$7)));PatternProcessor$0=(function PatternProcessor(){let $targ$31;let $targ$32;let $targ$33;let $it$12;if((!getChecker(PatternProcessor$0)(this))){$it$12=Object.create(PatternProcessor$0.prototype);}else{$it$12=this;}$targ$31=[];($it$12["temps"]=$targ$31);$targ$32=[];($it$12["parts"]=$targ$32);$targ$33=GenSym$0("t");($it$12["gen"]=$targ$33);return $it$12;});$targ$0=(function(part$0){let $it$13;let self$10;$it$13=this;self$10=this;return $it$13.parts.push(["do",part$0]);});(PatternProcessor$0.prototype["do"]=$targ$0);(PatternProcessor$0.prototype["check"]=(function check(){let part$1;let tags$3;let t0$32;let m$23$0;let $it$14;let self$11;$it$14=this;self$11=this;m$23$0=arguments;t0$32=m$23$0.length;if(((t0$32>=1)&&(t0$32<=2))){part$1=m$23$0[0];if((1>=t0$32)){tags$3=({});}else{tags$3=m$23$0[1];}return $it$14.parts.push(__amp__(["check",part$1],tags$3));}else{return ___match_error(m$23$0,"{part, tags = {=}}");}}));(PatternProcessor$0.prototype["temp"]=(function temp(){let x$20;let x$21;let x$22;let $targ$34;let init$0;let t0$34;let bridge$$22564$0;let x$19;let ph$7$0;let v$6;let t0$33;let t1$18;let m$24$0;let $it$15;let self$12;$it$15=this;self$12=this;m$24$0=arguments;t0$33=m$24$0.length;if(((t0$33>=1)&&(t0$33<=2))){t1$18=m$24$0[0];x$19=t1$18;ph$7$0=t1$18;if((1>=t0$33)){v$6=null;}else{v$6=m$24$0[1];}t0$34=ph$7$0;bridge$$22564$0=t0$34;if(((((x$20=bridge$$22564$0),((x$20 instanceof Array)&&(x$20[0]==="variable")))||((x$21=bridge$$22564$0),((x$21 instanceof Array)&&(x$21[0]==="symbol"))))&&(___hasprop(t0$34,"single_assignment")&&((t0$34.single_assignment?true:false)&&(!v$6))))){return x$19;}else{if(((x$22=ph$7$0),((x$22 instanceof Array)&&(x$22[0]==="value")))){return x$19;}else{init$0=ph$7$0;v$6=(v$6||["symbol",$it$15.gen()]);$targ$34=true;(v$6["single_assignment"]=$targ$34);$it$15.temps.push(v$6);$it$15.do(["send",["symbol","="],["data",["send",["symbol","set-var"],v$6],init$0]]);return v$6;}}}else{return ___match_error(m$24$0,"{match x, var v = null}");}}));(PatternProcessor$0.prototype["process"]=(function process(pattern$4,rhs$3,fns$0){let x$23;let x$24;let t$1;let t$2;let t$3;let pp$0;let x$25;let m$26;let t$4;let m$27;let acc$11;let temp$14;let fn$1;let parts$0;let t$5;let m$28;let acc$12;let temp$15;let t$6;let otherwise$0;let m$29$0;let m$30;let m$32;let end$0;let pos$0;let m$33;let acc$13;let temp$16;let nfw$0;let nbw$0;let ndflt$0;let extract_length$0;let check_length$0;let lo$0;let hi$0;let t$7;let len$0;let x$29;let fw$2;let bw$2;let dflt$0;let rest$5;let subp$12;let xs$3;let xs$2;let patt$1;let projector$2;let subp$11;let unconditional$1;let ph$8$0;let checker$2;let subp$10;let checker$1;let condition$1;let subp$9;let subp$8;let value$4;let sym$0;let $$22668$0;let $$22669$0;let $$22670$0;let $$22671$0;let t0$35;let t1$19;let m$25$0;let rval$4;let $it$16;let self$13;$it$16=this;self$13=this;m$25$0=pattern$4;if(((x$23=m$25$0),((x$23 instanceof Array)&&(x$23[0]==="ignore")))){rval$4=$it$16.do(rhs$3);}else{if((($$22668$0=Array.isArray(m$25$0))&&((t0$35=m$25$0.length),((t0$35===2)&&(m$25$0[0]==="assign"))))){sym$0=m$25$0[1];rval$4=$it$16.parts.push(fns$0.assign(sym$0,rhs$3));}else{if(($$22668$0&&(($$22670$0=(t0$35===3))&&(m$25$0[0]==="replace")))){subp$8=m$25$0[1];value$4=m$25$0[2];rval$4=$it$16.process(subp$8,value$4,fns$0);}else{if(($$22670$0&&(m$25$0[0]==="test"))){condition$1=m$25$0[1];subp$9=m$25$0[2];$it$16.process(subp$9,rhs$3,fns$0);rval$4=$it$16.check(condition$1,({"test":true}));}else{if(($$22670$0&&(($$22671$0=(m$25$0[0]==="check"))&&((checker$1=m$25$0[1]),(x$24=m$25$0[2]),((x$24 instanceof Array)&&(x$24[0]==="ignore")))))){rval$4=$it$16.check(["send",checker$1,["data",rhs$3]]);}else{if($$22671$0){checker$2=m$25$0[1];subp$10=m$25$0[2];t$1=$it$16.temp(rhs$3);$it$16.check(["send",checker$2,["data",t$1]]);rval$4=$it$16.process(subp$10,t$1,fns$0);}else{if(($$22668$0&&((t0$35===4)&&(m$25$0[0]==="project")))){projector$2=m$25$0[1];subp$11=m$25$0[2];t1$19=m$25$0[3];unconditional$1=t1$19;ph$8$0=t1$19;if((ph$8$0?true:false)){t$2=$it$16.temp(["send",projector$2,["data",rhs$3]]);rval$4=$it$16.process(subp$11,t$2,fns$0);}else{t$3=$it$16.temp(["send",projector$2,["data",rhs$3]]);$it$16.check(["send",t$3,["value",0]]);rval$4=$it$16.process(subp$11,["send",t$3,["value",1]],fns$0);}}else{if(($$22668$0&&((t0$35===2)&&(m$25$0[0]==="neg")))){patt$1=m$25$0[1];pp$0=PatternProcessor$0();pp$0.process(patt$1,rhs$3,fns$0);x$25=assemble_conditions$0(pp$0);rval$4=$it$16.check(["send",["symbol","not"],["data",["void"],x$25]]);}else{if(($$22668$0&&(($$22670$0=(t0$35>=1))&&(m$25$0[0]==="all")))){xs$2=Array.prototype.slice.call(m$25$0,1);t$4=$it$16.temp(rhs$3);m$26=null;$16:for(m$26 of xs$2){let x$26;x$26=m$26;$it$16.process(x$26,t$4,fns$0);}rval$4=null;}else{if(($$22670$0&&(m$25$0[0]==="any"))){xs$3=Array.prototype.slice.call(m$25$0,1);t$5=$it$16.temp(rhs$3,["symbol",gensym$0("bridge")]);rval$4=$it$16.check(((fn$1=(function fn(x$27,rest$4){return ["send",["symbol","or"],["data",x$27,rest$4]];})),(parts$0=((acc$11=[]),(temp$14=null),(m$27=null),(function(){$17:for(m$27 of xs$3){let pp$1;let x$28;x$28=m$27;pp$1=PatternProcessor$0();pp$1.process(x$28,t$5,fns$0);temp$14=assemble_conditions$0(pp$1);acc$11.push(temp$14);}})(),acc$11)),util$0.construct(parts$0,fn$1,["symbol","false"])));}else{if(($$22670$0&&(m$25$0[0]==="object_pattern"))){subp$12=Array.prototype.slice.call(m$25$0,1);t$6=$it$16.temp(rhs$3);acc$12=[];temp$15=null;m$28=null;$18:for(m$28 of subp$12){let t2$5;let t2$6;let k$1;let v$8;let default$3;let k$0;let v$7;let $$22831$0;let $$22832$0;let $$22833$0;let t0$36;let t1$20;t0$36=m$28;if((($$22832$0=Array.isArray(t0$36))&&((t1$20=t0$36.length),(t1$20===2)))){k$0=t0$36[0];v$7=t0$36[1];t2$5=$it$16.temp(k$0);$it$16.check(["send",["symbol","___hasprop"],["data",t$6,t2$5]]);temp$15=$it$16.process(v$7,["send",t$6,t2$5],fns$0);acc$12.push(temp$15);}else{if(($$22832$0&&(t1$20===3))){k$1=t0$36[0];v$8=t0$36[1];default$3=t0$36[2];t2$6=$it$16.temp(k$1);temp$15=$it$16.process(v$8,["send",["symbol","if"],["data",["send",["symbol","___hasprop"],["data",t$6,t2$6]],["send",t$6,t2$6],default$3]],fns$0);acc$12.push(temp$15);}else{___match_error(m$28);}}}rval$4=acc$12;}else{if(($$22668$0&&((t0$35===5)&&(m$25$0[0]==="array_pattern")))){fw$2=m$25$0[1];bw$2=m$25$0[2];dflt$0=m$25$0[3];rest$5=m$25$0[4];nfw$0=fw$2.length;nbw$0=bw$2.length;ndflt$0=dflt$0.length;extract_length$0=true;check_length$0=true;lo$0=(nfw$0+nbw$0);hi$0=(lo$0+ndflt$0);t$7=$it$16.temp(rhs$3);len$0=$it$16.temp(["send",t$7,["send",["symbol","."],["data",["void"],["symbol","length"]]]]);$it$16.check(((m$29$0=rest$5),((m$29$0?true:false)?["send",["symbol",">="],["data",len$0,["value",lo$0]]]:((lo$0===hi$0)?["send",["symbol","==="],["data",len$0,["value",lo$0]]]:((otherwise$0=m$29$0),["send",["symbol","and"],["data",["send",["symbol",">="],["data",len$0,["value",lo$0]]],["send",["symbol","<="],["data",len$0,["value",hi$0]]]]])))));m$30=null;$19:for(m$30 of enumerate(fw$2)){let i$2;let m$31;let t0$37;let t1$21;t0$37=m$30;if((Array.isArray(t0$37)&&((t1$21=t0$37.length),(t1$21===2)))){i$2=t0$37[0];m$31=t0$37[1];$it$16.process(m$31,["send",t$7,["value",i$2]],fns$0);}else{___match_error(m$30);}}m$32=null;$20:for(m$32 of enumerate(dflt$0)){let idx$0;let i$3;let patt$2;let value$5;let t0$38;let t1$22;let t2$7;let t3$2;t0$38=m$32;if((Array.isArray(t0$38)&&((t1$22=t0$38.length),((t1$22===2)&&((i$3=t0$38[0]),(t2$7=t0$38[1]),(Array.isArray(t2$7)&&((t3$2=t2$7.length),(t3$2===2)))))))){patt$2=t2$7[0];value$5=t2$7[1];idx$0=(i$3+nfw$0);$it$16.process(patt$2,["send",["symbol","if"],["data",["send",["symbol",">="],["data",["value",(idx$0+nbw$0)],len$0]],value$5,["send",t$7,["value",idx$0]]]],fns$0);}else{___match_error(m$32);}}if((rest$5!==undefined)){pos$0=(nfw$0+ndflt$0);if((nbw$0>0)){end$0=[["value",(-nbw$0)]];}else{end$0=[];}$it$16.process(rest$5,["send",["send",["send",["send",["symbol","Array"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]],["send",["symbol","."],["data",["void"],["symbol","slice"]]]],["send",["symbol","."],["data",["void"],["symbol","call"]]]],["data",t$7,["value",pos$0]].concat(end$0)],fns$0);}else{[];}acc$13=[];temp$16=null;m$33=null;$21:for(m$33 of enumerate(bw$2)){let i$4;let m$34;let t0$39;let t1$23;t0$39=m$33;if((Array.isArray(t0$39)&&((t1$23=t0$39.length),(t1$23===2)))){i$4=t0$39[0];m$34=t0$39[1];temp$16=$it$16.process(m$34,["send",["symbol","___js_fetch"],["data",t$7,["send",["symbol","-"],["data",len$0,["value",(nbw$0-i$4)]]]]],fns$0);acc$13.push(temp$16);}else{___match_error(m$33);}}rval$4=acc$13;}else{if(((x$29=m$25$0),((x$29 instanceof Array)&&(x$29[0]==="default")))){throw send(send(ErrorFactory(["syntax","pattern"]),"create", true),__amp____colon__([ENode([],({}),["Cannot declare default value here"]).toString()],({"expr":pattern$4,"::objinsert":1})));}else{rval$4=___match_error(m$25$0,"#default");}}}}}}}}}}}}}return rval$4;}));__amp____colon__(PatternProcessor$0,__amp____colon__((($targ$35="PatternProcessor"),(accum$8=({})),(accum$8["::name"]=$targ$35),accum$8),(($targ$36=true),(accum$9=({})),(accum$9["::egclass"]=$targ$36),accum$9)));assemble_conditions$0=(function assemble_conditions(pp$2){let m$35;let acc$14;let temp$17;let decls$0;let construct$0;construct$0=(function construct(ph$9$0){let x$32;let rest$7;let x$31;let x$30;let rest$6;let $$23087$0;let $$23088$0;let t0$40;let t1$24;let t2$8;let t3$3;t0$40=ph$9$0;t1$24=t0$40.length;if((t1$24===0)){return ["value",true];}else{if(((t1$24>=1)&&((t2$8=t0$40[0]),(Array.isArray(t2$8)&&((t3$3=t2$8.length),((t3$3===2)&&(t2$8[0]==="do"))))))){x$30=t2$8[1];rest$6=Array.prototype.slice.call(t0$40,1);return ["multi",x$30,construct$0(rest$6)];}else{if(((t1$24===1)&&((t2$8=t0$40[0]),(Array.isArray(t2$8)&&((t3$3=t2$8.length),((t3$3===2)&&(t2$8[0]==="check"))))))){x$31=t2$8[1];return x$31;}else{if(((t1$24>=1)&&((t2$8=t0$40[0]),(Array.isArray(t2$8)&&((t3$3=t2$8.length),((t3$3===2)&&(t2$8[0]==="check"))))))){x$32=t2$8[1];rest$7=Array.prototype.slice.call(t0$40,1);return ["send",["symbol","and"],["data",x$32,construct$0(rest$7)]];}else{return ___match_error(ph$9$0,"{#check{x}, *rest}");}}}}});if(pp$2.temps.length){acc$14=[];temp$17=null;m$35=null;$22:for(m$35 of pp$2.temps){let t$8;t$8=m$35;temp$17=["declare",t$8];acc$14.push(temp$17);}decls$0=acc$14;return ["multi"].concat(decls$0).concat([construct$0(pp$2.parts)]);}else{return construct$0(pp$2.parts);}});assemble_pattern$0=(function assemble_pattern(){let m$37;let m$38;let x$40;let test$0;let lead$0;let trail$0;let construct$1;let parts$1;let t$9;let f$4;let t0$41;let m$36$0;m$36$0=arguments;t0$41=m$36$0.length;if(((t0$41>=2)&&(t0$41<=3))){parts$1=m$36$0[0];t$9=m$36$0[1];if((2>=t0$41)){f$4=null;}else{f$4=m$36$0[2];}lead$0=[];m$37=null;$23:for(m$37 of parts$1.slice(0)){let x$34;let x$33;let $$23202$0;let $$23203$0;let $$23204$0;let $$23205$0;let t0$42;let t1$25;t0$42=m$37;if((($$23203$0=Array.isArray(t0$42))&&((t1$25=t0$42.length),(($$23205$0=(t1$25===2))&&(t0$42[0]==="do"))))){x$33=t0$42[1];lead$0.push(x$33);parts$1.shift();}else{if(($$23205$0&&(t0$42[0]==="check"))){x$34=t0$42[1];break $23;}else{___match_error(m$37);}}}trail$0=[];m$38=null;$24:for(m$38 of parts$1.slice(0).reverse()){let x$36;let x$35;let $$23209$0;let $$23210$0;let $$23211$0;let $$23212$0;let t0$43;let t1$26;t0$43=m$38;if((($$23210$0=Array.isArray(t0$43))&&((t1$26=t0$43.length),(($$23212$0=(t1$26===2))&&(t0$43[0]==="do"))))){x$35=t0$43[1];trail$0.unshift(x$35);parts$1.pop();}else{if(($$23212$0&&(t0$43[0]==="check"))){x$36=t0$43[1];break $24;}else{___match_error(m$38);}}}construct$1=(function construct(ph$10$0){let other$1;let x$39;let rest$9;let x$38;let x$37;let rest$8;let $$23275$0;let $$23276$0;let t0$44;let t1$27;let t2$9;let t3$4;t0$44=ph$10$0;t1$27=t0$44.length;if((t1$27===0)){return ["value",true];}else{if(((t1$27>=1)&&((t2$9=t0$44[0]),(Array.isArray(t2$9)&&((t3$4=t2$9.length),((t3$4===2)&&(t2$9[0]==="do"))))))){x$37=t2$9[1];rest$8=Array.prototype.slice.call(t0$44,1);return ["multi",x$37,construct$1(rest$8)];}else{if(((t1$27===1)&&((t2$9=t0$44[0]),(Array.isArray(t2$9)&&((t3$4=t2$9.length),((t3$4===2)&&(t2$9[0]==="check"))))))){x$38=t2$9[1];return x$38;}else{if(((t1$27>=1)&&((t2$9=t0$44[0]),(Array.isArray(t2$9)&&((t3$4=t2$9.length),((t3$4===2)&&(t2$9[0]==="check"))))))){x$39=t2$9[1];rest$9=Array.prototype.slice.call(t0$44,1);return ["send",["symbol","and"],["data",x$39,construct$1(rest$9)]];}else{other$1=ph$10$0;throw ErrorFactory(["oops"]).create("?!?",other$1);}}}}});if(parts$1.length){test$0=construct$1(parts$1);if(f$4){x$40=["send",["symbol","if"],["data",test$0,["multi"].concat(trail$0).concat([t$9]),f$4]];}else{x$40=["send",["symbol","if"],["data",test$0,["multi"].concat(trail$0).concat([t$9])]];}return ["multi"].concat(lead$0).concat([x$40]);}else{return ["multi"].concat(lead$0).concat(trail$0).concat([t$9]);}}else{return ___match_error(m$36$0,"{parts, t, f = null}");}});inject_below_uses$0=(function inject_below_uses(ph$11$0,fn$2){let other$2;let scope$0;let x$41;let t0$45;let t1$28;t0$45=ph$11$0;t1$28=t0$45.length;if(((t1$28===3)&&(t0$45[0]==="use"))){scope$0=t0$45[1];x$41=t0$45[2];return ["use",scope$0,inject_below_uses$0(x$41,fn$2)];}else{other$2=ph$11$0;return fn$2(other$2);}});checkall$0=["send","data","multi","assign","void","check","do"];same_block$0=(function same_block(ph$12$0,ban1$0,ban2$0){let m$39;let other$3;let type1$0;let args1$0;let type2$0;let args2$0;let m1$0;let m2$0;let v1$2;let v2$2;let s1$0;let s2$0;let v1$1;let v2$1;let $$23382$0;let $$23383$0;let $$23384$0;let $$23385$0;let $$23386$0;let $$23387$0;let $$23388$0;let t0$46;let t1$29;let t2$10;let t3$5;let t4$2;let t5$2;t0$46=ph$12$0;t1$29=t0$46.length;if((($$23384$0=(t1$29===2))&&((t2$10=t0$46[0]),(($$23386$0=Array.isArray(t2$10))&&((t3$5=t2$10.length),(($$23388$0=(t3$5===2))&&((t2$10[0]==="variable")&&((v1$1=t2$10[1]),(t4$2=t0$46[1]),(Array.isArray(t4$2)&&((t5$2=t4$2.length),((t5$2===2)&&(t4$2[0]==="variable")))))))))))){v2$1=t4$2[1];return (v1$1===v2$1);}else{if(($$23388$0&&((t2$10[0]==="symbol")&&((s1$0=t2$10[1]),(t4$2=t0$46[1]),(Array.isArray(t4$2)&&((t5$2=t4$2.length),((t5$2===2)&&(t4$2[0]==="symbol")))))))){s2$0=t4$2[1];return (((!send(ban1$0,s1$0))&&(!send(ban2$0,s2$0)))&&(s1$0===s2$0));}else{if(($$23388$0&&((t2$10[0]==="value")&&((v1$2=t2$10[1]),(t4$2=t0$46[1]),(Array.isArray(t4$2)&&((t5$2=t4$2.length),((t5$2===2)&&(t4$2[0]==="value")))))))){v2$2=t4$2[1];return (v1$2===v2$2);}else{if(($$23388$0&&((t2$10[0]==="macro")&&((m1$0=t2$10[1]),(t4$2=t0$46[1]),(Array.isArray(t4$2)&&((t5$2=t4$2.length),((t5$2===2)&&(t4$2[0]==="macro")))))))){m2$0=t4$2[1];return (m1$0===m2$0);}else{if((Array.isArray(t0$46)&&((t1$29=t0$46.length),((t1$29===2)&&((t2$10=t0$46[0]),(Array.isArray(t2$10)&&((t3$5=t2$10.length),((t3$5>=1)&&((type1$0=t2$10[0]),(args1$0=Array.prototype.slice.call(t2$10,1)),(t4$2=t0$46[1]),(Array.isArray(t4$2)&&((t5$2=t4$2.length),((t5$2>=1)&&((type2$0=t4$2[0]),(args2$0=Array.prototype.slice.call(t4$2,1)),(checkall$0.indexOf(type1$0)!==-1)))))))))))))){if(((type1$0===type2$0)&&(args1$0.length===args2$0.length))){m$39=null;$25:for(m$39 of zip(args1$0,args2$0)){let pair$0;pair$0=m$39;if((!same_block$0(pair$0,ban1$0,ban2$0))){return false;}}return true;}else{return false;}}else{other$3=ph$12$0;return false;}}}}}});parse_clauses$0=(function parse_clauses(info$0,target$1,stmts$0,opt$0){let m$40;let acc$15;let temp$18;let m$42;let acc$16;let temp$19;let m$43;let acc$17;let temp$20;let decls$1;let all_temps$0;let last_clause$0;let the_parts$0;let unique_temps$0;all_temps$0=[];last_clause$0=null;acc$15=[];temp$18=null;m$40=null;$26:for(m$40 of info$0.step_all(["clause"],stmts$0)){let accum$10;let t0$48;let m$41;let pc$1;let $targ$37;let vars$1;let temps$0;let blocks$0;let vars2$0;let x$42;let other$5;let b$0;let pattern$5;let body$1;let $$23536$0;let t0$47;let t1$30;t0$47=m$40;if((Array.isArray(t0$47)&&((t1$30=t0$47.length),((t1$30===3)&&(t0$47[0]==="clause"))))){pattern$5=t0$47[1];body$1=t0$47[2];last_clause$0=pattern$5;pc$1=PatternCompiler$0(pattern$5,info$0,__amp__(opt$0,__amp____colon__(({"allow_arguments":false,"allow_nested":true}),((accum$10=({})),(accum$10["assign"]=(function assign(v$9,value$6){return ["do",__lt____lt____colon__$0(["assign",v$9,value$6],v$9)];})),accum$10))));pc$1.process_for_rhs(target$1);$targ$37=pc$1;t0$48=$targ$37;if((___hasprop(t0$48,"vars")&&((vars$1=t0$48.vars),(___hasprop(t0$48,"temps")&&((temps$0=t0$48.temps),___hasprop(t0$48,"parts")))))){blocks$0=t0$48.parts;}else{___match_error($targ$37,"{=> vars, => temps, parts => blocks}");}[vars$1,temps$0,blocks$0];all_temps$0=all_temps$0.concat(temps$0);vars2$0=({});m$41=null;$27:for(m$41 of vars$1){let $targ$38;let other$4;let xxx$0;let t0$49;let t1$31;t0$49=m$41;if((Array.isArray(t0$49)&&((t1$31=t0$49.length),((t1$31===2)&&(t0$49[0]==="symbol"))))){xxx$0=t0$49[1];$targ$38=true;(vars2$0[xxx$0]=$targ$38);(void 0);}else{other$4=m$41;throw ErrorFactory(["syntax","unexpected"]).create("Huh",({"expr":other$4}));}}if(opt$0.wrap){pc$1.handlers.push(opt$0);}temp$18=["clause",vars$1,vars2$0,blocks$0,pc$1.wrapBody(body$1)];acc$15.push(temp$18);}else{if(((x$42=t0$47),((x$42 instanceof Array)&&(x$42[0]==="block")))){b$0=t0$47;temp$18=b$0;acc$15.push(temp$18);}else{other$5=m$40;throw ErrorFactory(["syntax","clause"]).create("Illegal clause",({"clause":other$5}));acc$15.push(temp$18);}}}the_parts$0=acc$15;if(opt$0.fallback){the_parts$0.push(["block",opt$0.fallback(target$1,last_clause$0)]);}unique_temps$0=keys(util$0.mkset(((acc$16=[]),(temp$19=null),(m$42=null),(function(){$28:for(m$42 of all_temps$0){let t$10;let t0$50;let t1$32;t0$50=m$42;if((Array.isArray(t0$50)&&((t1$32=t0$50.length),((t1$32===2)&&(t0$50[0]==="symbol"))))){t$10=t0$50[1];temp$19=t$10;acc$16.push(temp$19);}else{___match_error(m$42);}}})(),acc$16)));acc$17=[];temp$20=null;m$43=null;$29:for(m$43 of unique_temps$0){let t$11;t$11=m$43;temp$20=["declare",__amp____colon__(["symbol",t$11],({"mutable":true}))];acc$17.push(temp$20);}decls$1=acc$17;return ["multi"].concat(decls$1).concat([weave_clauses$0(the_parts$0)]);});opt_clauses$0=(function opt_clauses(clauses$0){let m$44;let acc$18;let temp$21;let m$47;let acc$19;let temp$22;let m$48;let acc$20;let temp$23;let m$49;let acc$21;let temp$24;let shares$0;let max$0;let temps$1;let shared_last$0;let idx_last$0;let new_clauses$0;acc$18=[];temp$21=null;m$44=null;$30:for(m$44 of enumerate(clauses$0.slice(1))){let t0$52;let t1$34;let m$45;let $targ$39;let varsd0$0;let blocks0$0;let share$0;let idx$1;let i$5;let vars$2;let varsd$0;let blocks$1;let body$2;let t0$51;let t1$33;let t2$11;let t3$6;t0$51=m$44;if((Array.isArray(t0$51)&&((t1$33=t0$51.length),((t1$33===2)&&((i$5=t0$51[0]),(t2$11=t0$51[1]),(Array.isArray(t2$11)&&((t3$6=t2$11.length),((t3$6===5)&&(t2$11[0]==="clause"))))))))){vars$2=t2$11[1];varsd$0=t2$11[2];blocks$1=t2$11[3];body$2=t2$11[4];$targ$39=send(clauses$0,i$5);t0$52=$targ$39;if((Array.isArray(t0$52)&&((t1$34=t0$52.length),((t1$34===5)&&(t0$52[0]==="clause"))))){t0$52[1];varsd0$0=t0$52[2];blocks0$0=t0$52[3];t0$52[4];}else{___match_error($targ$39,"#clause{_, varsd0, blocks0, _}");}[varsd0$0,blocks0$0];share$0=0;idx$1=0;m$45=null;$31:for(m$45 of blocks$1){let x$43;let x$44;let t$12;let other$6;let m$46$0;let b$1;b$1=m$45;if(same_block$0([send(blocks0$0,share$0),b$1],varsd0$0,varsd$0)){(share$0++);m$46$0=b$1;if(((x$43=m$46$0),((x$43 instanceof Array)&&(x$43[0]==="do")))){null;}else{if(((x$44=m$46$0),((x$44 instanceof Array)&&(x$44[0]==="check")))){idx$1=share$0;idx$1;}else{other$6=m$46$0;t$12=other$6;console.log(t$12);t$12;}}}else{break $31;}}temp$21=[share$0,idx$1];acc$18.push(temp$21);}else{___match_error(m$44);}}shares$0=acc$18;max$0=send(send(Math,"max", true),((acc$19=[]),(temp$22=null),(m$47=null),(function(){$32:for(m$47 of shares$0){let x$45;let t0$53;let t1$35;t0$53=m$47;if((Array.isArray(t0$53)&&((t1$35=t0$53.length),(t1$35===2)))){x$45=t0$53[0];t0$53[1];temp$22=x$45;acc$19.push(temp$22);}else{___match_error(m$47);}}})(),acc$19));shares$0.push([0,0]);acc$20=[];temp$23=null;m$48=null;$33:for(m$48 of range(1,max$0)){temp$23=["symbol",gensym$0()];acc$20.push(temp$23);}temps$1=acc$20;shared_last$0=0;idx_last$0=0;acc$21=[];temp$24=null;m$49=null;$34:for(m$49 of enumerate(clauses$0)){let t0$55;let t1$37;let m$50;let acc$22;let temp$25;let rest$10;let newblocks$0;let $targ$40;let share$1;let idx$2;let shared$0;let n_to_share$0;let to_share$0;let other$7;let i$6;let vars$3;let varsd$1;let blocks$2;let body$3;let t0$54;let t1$36;let t2$12;let t3$7;t0$54=m$49;if((Array.isArray(t0$54)&&((t1$36=t0$54.length),((t1$36===2)&&((i$6=t0$54[0]),(t2$12=t0$54[1]),(Array.isArray(t2$12)&&((t3$7=t2$12.length),((t3$7===5)&&(t2$12[0]==="clause"))))))))){vars$3=t2$12[1];varsd$1=t2$12[2];blocks$2=t2$12[3];body$3=t2$12[4];$targ$40=send(shares$0,i$6);t0$55=$targ$40;if((Array.isArray(t0$55)&&((t1$37=t0$55.length),(t1$37===2)))){share$1=t0$55[0];idx$2=t0$55[1];}else{___match_error($targ$40,"{share, idx}");}[share$1,idx$2];if(idx_last$0){shared$0=[["check",send(temps$1,(idx_last$0-1))]];}else{shared$0=[];}n_to_share$0=Math.max(shared_last$0,share$1);acc$22=[];temp$25=null;m$50=null;$35:for(m$50 of enumerate(blocks$2.slice(shared_last$0,n_to_share$0))){let j$1;let x$47;let j$0;let x$46;let $$24004$0;let $$24005$0;let $$24006$0;let $$24007$0;let t0$56;let t1$38;let t2$13;let t3$8;t0$56=m$50;if((($$24005$0=Array.isArray(t0$56))&&((t1$38=t0$56.length),(($$24007$0=(t1$38===2))&&((j$0=t0$56[0]),(t2$13=t0$56[1]),(Array.isArray(t2$13)&&((t3$8=t2$13.length),((t3$8===2)&&(t2$13[0]==="check"))))))))){x$46=t2$13[1];temp$25=["check",["assign",send(temps$1,(shared_last$0+j$0)),x$46]];acc$22.push(temp$25);}else{if(($$24007$0&&((j$1=t0$56[0]),(t2$13=t0$56[1]),(Array.isArray(t2$13)&&((t3$8=t2$13.length),((t3$8===2)&&(t2$13[0]==="do"))))))){x$47=t2$13[1];temp$25=["do",x$47];acc$22.push(temp$25);}else{___match_error(m$50);}}}to_share$0=acc$22;shared_last$0=share$1;idx_last$0=idx$2;rest$10=blocks$2.slice(n_to_share$0);newblocks$0=shared$0.concat(to_share$0).concat(rest$10);temp$24=["clause",vars$3,varsd$1,newblocks$0,body$3];acc$21.push(temp$24);}else{other$7=m$49;throw ErrorFactory(["oops"]).create("what",({"value":other$7}));acc$21.push(temp$24);}}new_clauses$0=acc$21;return [temps$1,new_clauses$0];});weave_clauses$0=(function weave_clauses(parts$2){let m$51;let m$54;let acc$24;let temp$28;let groups$0;let reassemble$0;let new_temps$0;let helper$0;groups$0=classify_contiguous$0(parts$2,(function(temp$26$0){let t0$57;let t1$39;let cls$0;t0$57=temp$26$0;if((Array.isArray(t0$57)&&((t1$39=t0$57.length),(t1$39>=1)))){cls$0=t0$57[0];Array.prototype.slice.call(t0$57,1);}else{___match_error(temp$26$0);}return cls$0;}));reassemble$0=[];new_temps$0=[];m$51=null;$36:for(m$51 of groups$0){let t0$59;let t1$41;let $targ$41;let ts$0;let new_clauses$1;let elems$1;let elems$0;let $$24114$0;let $$24115$0;let $$24116$0;let $$24117$0;let t0$58;let t1$40;t0$58=m$51;if((($$24115$0=Array.isArray(t0$58))&&((t1$40=t0$58.length),(($$24117$0=(t1$40>=1))&&(t0$58[0]==="clause"))))){elems$0=Array.prototype.slice.call(t0$58,1);$targ$41=opt_clauses$0(elems$0);t0$59=$targ$41;if((Array.isArray(t0$59)&&((t1$41=t0$59.length),(t1$41===2)))){ts$0=t0$59[0];new_clauses$1=t0$59[1];}else{___match_error($targ$41,"{ts, new_clauses}");}[ts$0,new_clauses$1];new_temps$0=new_temps$0.concat(ts$0);reassemble$0=reassemble$0.concat(new_clauses$1);}else{if(($$24117$0&&(t0$58[0]==="block"))){elems$1=Array.prototype.slice.call(t0$58,1);reassemble$0=reassemble$0.concat(elems$1);}else{___match_error(m$51);}}}helper$0=(function helper(ph$13$0){let m$52;let acc$23;let temp$27;let decls$2;let vars$4;let varsd$2;let blocks$3;let body$5;let rest$12;let body$4;let rest$11;let $$24187$0;let $$24188$0;let $$24189$0;let $$24190$0;let $$24191$0;let $$24192$0;let t0$60;let t1$42;let t2$14;let t3$9;let t4$3;let t5$3;let t6$1;t0$60=ph$13$0;t1$42=t0$60.length;if((t1$42===0)){return ["multi"];}else{if((($$24189$0=(t1$42>=1))&&((t2$14=t0$60[0]),(($$24191$0=Array.isArray(t2$14))&&((t3$9=t2$14.length),((t3$9===2)&&((t2$14[0]==="block")&&((t4$3=getProjector(Body$0)(t2$14[1])),(t4$3[0]&&((t5$3=t4$3[1]),(t6$1=t5$3.length),(t6$1>=0))))))))))){body$4=Array.prototype.slice.call(t5$3,0);rest$11=Array.prototype.slice.call(t0$60,1);return ["multi"].concat(body$4).concat([helper$0(rest$11)]);}else{if(($$24191$0&&((t3$9===5)&&(t2$14[0]==="clause")))){vars$4=t2$14[1];varsd$2=t2$14[2];blocks$3=t2$14[3];body$5=t2$14[4];rest$12=Array.prototype.slice.call(t0$60,1);acc$23=[];temp$27=null;m$52=null;$37:for(m$52 of vars$4){let bridge$$24270$0;let m$53$0;let v$10;v$10=m$52;m$53$0=v$10.declare_mode;if((m$53$0==="set")){temp$27=["splice"];}else{if((m$53$0==="let")){temp$27=["declare",__amp__(v$10,({"mutable":false}))];}else{if((m$53$0==="var")){temp$27=["declare",__amp__(v$10,({"mutable":true}))];}else{bridge$$24270$0=m$53$0;if(((bridge$$24270$0==="unqualified")||(bridge$$24270$0===(void 0)))){temp$27=["declare",__amp__(v$10,({"mutable":false}))];}else{temp$27=___match_error(m$53$0,".unqualified or undefined? ");}}}}acc$23.push(temp$27);}decls$2=acc$23;return ["tagscope","back",["multi"].concat(decls$2).concat([assemble_pattern$0(blocks$3,body$5,["use","back",helper$0(rest$12)])])];}else{return ___match_error(ph$13$0,"{#clause{vars, varsd, blocks, body}, *rest}");}}}});return ["multi"].concat(((acc$24=[]),(temp$28=null),(m$54=null),(function(){$38:for(m$54 of new_temps$0){let t$13;t$13=m$54;temp$28=["declare",t$13];acc$24.push(temp$28);}})(),acc$24)).concat([helper$0(reassemble$0)]);});$targ$42=PatternCompiler$0;(exports["PatternCompiler"]=$targ$42);$targ$43=parse_clauses$0;(exports["parse_clauses"]=$targ$43);(void 0);
//# sourceMappingURL=pattern.js.map

