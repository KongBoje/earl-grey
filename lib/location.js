var augment=function(dest,values){for(k in values){if(values.hasOwnProperty(k)){(dest[k]=send(values,k));}else{null;}}return dest;};var send=function(obj,__t94){var msg;var __t93;(msg=__t94);true;(__t93=__t94);var __t95=__t93;var other;if(((typeof(__t95)==="string")||(typeof(__t95)==="number"))){return obj[msg];}else{if(((other=__t95),true)){return obj["::send"](msg);}else{throw ["Could not find a match",__t95];}}};var patch_array=function(){var r=[];for(var i=0;(i<arguments.length);(i++)){(r=r.concat(arguments[i]));}return r;};var range=function(from,to){var rval=[];for(var i=from;(i<=to);(i++)){rval.push(i);}return rval;};var ___checker=function(type){var __t96=type["::check"];var f;if((__t96===(void 0))){return function(value){return (value instanceof type);};}else{if(((f=__t96),true)){return function(value){return f.call(type,value);};}else{throw ["Could not find a match",__t96];}}};var ___projector=function(type){return function(value){var __t97=type[":::project"];var f;if((__t97===(void 0))){var __t98=type["::project"];var f;if((__t98===(void 0))){return [true,type(value)];}else{if(((f=__t98),true)){var __t100;try{(__t100=[true,f(value)]);}catch(__t99){(__t100=[false,null]);}return __t100;}else{throw ["Could not find a match",__t98];}}}else{if(((f=__t97),true)){return f.call(type,value);}else{throw ["Could not find a match",__t97];}}};};var ___deconstructor=function(type){return function(value){var __t101=type[":::deconstruct"];var f;if((__t101===(void 0))){var __t102=type["::deconstruct"];var f;if((__t102===(void 0))){if((value instanceof Array)){return [true,value];}else{if(true){return [false,null];}else{return false;}}}else{if(((f=__t102),true)){var __t104;try{(__t104=[true,f.call(type,value)]);}catch(__t103){(__t104=[false,null]);}return __t104;}else{throw ["Could not find a match",__t102];}}}else{if(((f=__t101),true)){return f.call(type,value);}else{throw ["Could not find a match",__t101];}}};};(Array[":::project"]=function(__t106){var value;var __t105;(value=__t106);true;(__t105=__t106);var __t107=__t105;var _;if(___checker(Array)(__t107)){return [true,value];}else{if(((_=__t107),true)){return [true,[value]];}else{throw ["Could not find a match",__t107];}}});(Array.prototype["boink"]=function(){return this;});(Array.prototype["::check"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){return false;}else{null;}}return true;}else{return false;}});(Array.prototype[":::project"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){var rval=this.slice(0);rval.push(value);return [true,rval];}else{null;}}return [true,value];}else{var rval=this.slice(0);rval.push(value);return [true,rval];}});(Array.prototype[":::deconstruct"]=function(value){return value.slice(this.length);});(RegExp.prototype["::check"]=function(value){return value.match(this);});(RegExp.prototype[":::project"]=function(value){var __t108=value.match(this);var m;var m;if(((__t108===null)&&((m=__t108),true))){return [false,null];}else{if(((m=__t108),true)){return [true,m];}else{throw ["Could not find a match",__t108];}}});(RegExp.prototype[":::deconstruct"]=function(value){var __t109=value.match(this);var m;var m;if(((__t109===null)&&((m=__t109),true))){return [false,null];}else{if(((m=__t109),true)){return [true,m];}else{throw ["Could not find a match",__t109];}}});(Function.prototype["::send"]=function(args){return this.apply(this,args);});var ErrorFactory=function(tags){var __t87=function(){if((!___checker(ErrorFactory)(this))){return Object.create(ErrorFactory.prototype);}else{return this;}}();(__t87["tags"]=tags);return __t87;};augment(ErrorFactory,[]);(ErrorFactory.prototype["create"]=function(){var __t88=Array.prototype.slice.call(arguments,0);var __tp0;var message;var args;if(((__t88 instanceof Array)&&(((__tp0=__t88.length),true)&&((__tp0>=0)&&((message=function(){if((0>=__tp0)){return "";}else{return __t88[0];}}()),true,(args=__t88.slice(1)),true))))){var __t87=this;var e=Error(message);(e["::tags"]=__t87.tags);(e["args"]=args);(e["name"]=["E"].concat(__t87.tags).join("."));return e;}else{throw ["Could not find a match",__t88];}});(ErrorFactory.prototype["::check"]=function(e){var __t87=this;if(((!e)||(!___checker(Error)(e)))){return false;}else{null;}var tags=(e["::tags"]||[]);var __t89=__t87.tags;var __t90=__t89.length;for(var __t91=0;(__t91<__t90);(__t91++)){var __t92=__t89[__t91];var tag;var other;if(((tag=__t92),true,(tags.indexOf(tag)===(-1)))){return false;}else{if(((other=__t92),true)){false;}else{throw ["Could not find a match",__t92];}}}false;return true;});(ErrorFactory.prototype["::deconstruct"]=function(e){var __t87=this;return e.args;});ErrorFactory;
var __t110=require("./util");var binsearch=__t110.binsearch;var __t111=require("./pp");var Node=__t111.Node;var Source=function(){var __t113=Array.prototype.slice.call(arguments,0);var __tp0;var text;var url;if(((__t113 instanceof Array)&&(((__tp0=__t113.length),true)&&(((__tp0>=1)&&(__tp0<=2))&&((text=__t113[0]),true,(url=function(){if((1>=__tp0)){return false;}else{return __t113[1];}}()),true))))){var __t112=function(){if((!___checker(Source)(this))){return Object.create(Source.prototype);}else{return this;}}();(__t112["text"]=text);(__t112["url"]=url);(__t112["counts"]=[]);var curr=0;var __t114=text.split("\n");var __t115=__t114.length;for(var __t116=0;(__t116<__t115);(__t116++)){var __t117=__t114[__t116];var line;var other;if(((line=__t117),true)){__t112.counts.push(curr);(curr=(curr+(line.length+1)));}else{if(((other=__t117),true)){false;}else{throw ["Could not find a match",__t117];}}}false;__t112.counts.push(curr);(__t112["nlines"]=(__t112.counts.length-1));return __t112;}else{throw ["Could not find a match",__t113];}};augment(Source,[]);(Source.prototype["linecol"]=function(pos){var __t112=this;var line=binsearch(__t112.counts,pos);var col=(pos-send(__t112.counts,(line-1)));return [line,col];});(Source.prototype["highlight_lines"]=function(l1,l2,spans){var __t112=this;return highlight_lines(__t112.text,__t112.counts,[(l1-1),(l2-1)],spans);});Source;var Location=function(source,start,end){var __t118=function(){if((!___checker(Location)(this))){return Object.create(Location.prototype);}else{return this;}}();(__t118["source"]=(source||Source("",null)));(__t118["start"]=start);(__t118["end"]=end);return __t118;};augment(Location,[]);(Location.prototype["text"]=function(){var __t118=this;return __t118.source.text.slice(__t118.start,__t118.end);});(Location.prototype["linerange"]=function(){var __t118=this;var __t119=__t118.linecol();var __tp0;var __tp1;var __tp2;var l1;var _;var __t120;if(((__t119 instanceof Array)&&(((__tp0=__t119.length),true)&&((__tp0===2)&&(((__tp1=__t119[0]),(__tp1 instanceof Array))&&(((__tp2=__tp1.length),true)&&((__tp2===2)&&((l1=__tp1[0]),true,(_=__tp1[1]),true,(__t120=__t119[1]),true)))))))){var __t121=__t120;var __tp0;var l2;var _;if((__t121===null)){return [l1,l1];}else{if(((__t121 instanceof Array)&&(((__tp0=__t121.length),true)&&((__tp0===2)&&((l2=__t121[0]),true,(_=__t121[1]),true))))){return [l1,l2];}else{throw ["Could not find a match",__t121];}}}else{throw ["Could not find a match",__t119];}});(Location.prototype["linecol"]=function(){var __t118=this;var start=__t118.source.linecol(__t118.start);var end=function(){if((__t118.start===__t118.end)){return null;}else{return __t118.source.linecol((__t118.end-1));}}();return [start,end];});(Location.prototype["ref"]=function(){var __t118=this;var __t122=__t118.linecol();var __tp0;var __tp1;var __tp2;var __tp3;var __tp4;var l1;var __tp5;var __tp6;var c1;var __t123;if(((__t122 instanceof Array)&&(((__tp0=__t122.length),true)&&((__tp0===2)&&(((__tp1=__t122[0]),(__tp1 instanceof Array))&&(((__tp2=__tp1.length),true)&&((__tp2===2)&&(((__tp3=__tp1[0]),(__tp4=[true,String(__tp3)]),__tp4[0])&&(((l1=__tp4[1]),true,(__tp5=__tp1[1]),(__tp6=[true,String(__tp5)]),__tp6[0])&&((c1=__tp6[1]),true,(__t123=__t122[1]),true)))))))))){var __t124=__t123;var __tp0;var __tp1;var __tp2;var l2;var __tp3;var __tp4;var c2;if((__t124===null)){return ((l1+":")+c1);}else{if(((__t124 instanceof Array)&&(((__tp0=__t124.length),true)&&((__tp0===2)&&(((__tp1=__t124[0]),(__tp2=[true,String(__tp1)]),__tp2[0])&&(((l2=__tp2[1]),true,(__tp3=__t124[1]),(__tp4=[true,String(__tp3)]),__tp4[0])&&((c2=__tp4[1]),true))))))){var __t125=null;var otherwise;if(((l1===l2)&&(c1===c2))){return ((l1+":")+c1);}else{if((l1===l2)){return ((((l1+":")+c1)+"-")+c2);}else{if(((otherwise=__t125),true)){return ((((((l1+":")+c1)+"-")+l1)+":")+c2);}else{throw ["Could not find a match",__t125];}}}}else{throw ["Could not find a match",__t124];}}}else{throw ["Could not find a match",__t122];}});(Location.prototype["highlight"]=function(){var __t126=Array.prototype.slice.call(arguments,0);var __tp0;var cls;var context;if(((__t126 instanceof Array)&&(((__tp0=__t126.length),true)&&(((__tp0>=0)&&(__tp0<=2))&&((cls=function(){if((0>=__tp0)){return "hl1";}else{return __t126[0];}}()),true,(context=function(){if((1>=__tp0)){return 0;}else{return __t126[1];}}()),true))))){var __t118=this;return highlight_locations([[__t118,cls]],context);}else{throw ["Could not find a match",__t126];}});Location;var highlight=function(){var __t127=Array.prototype.slice.call(arguments,0);var __tp0;var text;var spans;var offset;if(((__t127 instanceof Array)&&(((__tp0=__t127.length),true)&&(((__tp0>=2)&&(__tp0<=3))&&((text=__t127[0]),true,(spans=__t127[1]),true,(offset=function(){if((2>=__tp0)){return 0;}else{return __t127[2];}}()),true))))){return Node([],function(){var __t128=[];var __t129=morsel(spans);var __t130=__t129.length;for(var __t131=0;(__t131<__t130);(__t131++)){var __t132=__t129[__t131];var __tp0;var start;var end;var attributes;var other;if(((__t132 instanceof Array)&&(((__tp0=__t132.length),true)&&((__tp0===3)&&((start=__t132[0]),true,(end=__t132[1]),true,(attributes=__t132[2]),true))))){__t128.push(function(){var xstart=Math.max((start-offset),0);var xend=Math.min((end-offset),text.length);return Node(attributes,[text.slice(xstart,xend)]);}());}else{if(((other=__t132),true)){false;}else{throw ["Could not find a match",__t132];}}}return __t128;}());}else{throw ["Could not find a match",__t127];}};var highlight_lines=function(text,linelocs,__t133,spans){var __tp0;var l1;var l2;if(((__t133 instanceof Array)&&(((__tp0=__t133.length),true)&&((__tp0===2)&&((l1=__t133[0]),true,(l2=__t133[1]),true))))){(void 0);}else{throw "a condition failed";}return Node(["+span"],function(){var __t134=[];var __t135=range(l1,l2);var __t136=__t135.length;for(var __t137=0;(__t137<__t136);(__t137++)){var __t138=__t135[__t137];var lineno;var other;if(((lineno=__t138),true)){__t134.push(function(){var start=send(linelocs,lineno);var end=send(linelocs,(lineno+1));return Node(["+span"],[Node(["lineno"],(lineno+1)),Node(["source"],highlight(text,patch_array([[start,end,[]]],clamp(spans,start,end))))]);}());}else{if(((other=__t138),true)){false;}else{throw ["Could not find a match",__t138];}}}return __t134;}());};var clamp=function(spans,bot,top){var __t139=[];var __t140=spans;var __t141=__t140.length;for(var __t142=0;(__t142<__t141);(__t142++)){var __t143=__t140[__t142];var __tp0;var start;var end;var attr;var other;if(((__t143 instanceof Array)&&(((__tp0=__t143.length),true)&&((__tp0===3)&&((start=__t143[0]),true,(end=__t143[1]),true,(attr=__t143[2]),true,((end>=bot)&&(start<=top))))))){__t139.push([Math.max(start,bot),Math.min(end,top),attr]);}else{if(((other=__t143),true)){false;}else{throw ["Could not find a match",__t143];}}}return __t139;};var morsel=function(spans){var jump=function(active,bot,top){var e=send(Math.min,patch_array([top],function(){var __t144=[];var __t145=active;var __t146=__t145.length;for(var __t147=0;(__t147<__t146);(__t147++)){var __t148=__t145[__t147];var __tp0;var _;var x;var _;var other;if(((__t148 instanceof Array)&&(((__tp0=__t148.length),true)&&((__tp0===3)&&((_=__t148[0]),true,(x=__t148[1]),true,(_=__t148[2]),true))))){__t144.push(x);}else{if(((other=__t148),true)){false;}else{throw ["Could not find a match",__t148];}}}return __t144;}()));var attributes=send(patch_array,function(){var __t149=[];var __t150=active;var __t151=__t150.length;for(var __t152=0;(__t152<__t151);(__t152++)){var __t153=__t150[__t152];var __tp0;var _;var _;var X;var other;if(((__t153 instanceof Array)&&(((__tp0=__t153.length),true)&&((__tp0===3)&&((_=__t153[0]),true,(_=__t153[1]),true,(X=__t153[2]),true))))){__t149.push(X);}else{if(((other=__t153),true)){false;}else{throw ["Could not find a match",__t153];}}}return __t149;}());return [e,[bot,e,attributes]];};var jumptill=function(active,bot,top){if((bot===top)){return [[],active];}else{if(true){var __tp0;var __tp1;var newbot;var span;if((((__tp0=jump(active,bot,top)),(__tp0 instanceof Array))&&(((__tp1=__tp0.length),true)&&((__tp1===2)&&((newbot=__tp0[0]),true,(span=__tp0[1]),true))))){(void 0);}else{throw "a condition failed";}var newactive=function(){var __t154=[];var __t155=active;var __t156=__t155.length;for(var __t157=0;(__t157<__t156);(__t157++)){var __t158=__t155[__t157];var x;var __tp0;var _;var e;var attr;var other;if((((x=__t158),true,(__t158 instanceof Array))&&(((__tp0=__t158.length),true)&&((__tp0===3)&&((_=__t158[0]),true,(e=__t158[1]),true,(attr=__t158[2]),true,(e>newbot)))))){__t154.push(x);}else{if(((other=__t158),true)){false;}else{throw ["Could not find a match",__t158];}}}return __t154;}();var __tp0;var __tp1;var spans;var remainder;if((((__tp0=jumptill(newactive,newbot,top)),(__tp0 instanceof Array))&&(((__tp1=__tp0.length),true)&&((__tp1===2)&&((spans=__tp0[0]),true,(remainder=__tp0[1]),true))))){(void 0);}else{throw "a condition failed";}return [[span].concat(spans),remainder];}else{return false;}}};var process=function(start,active,rem){var __t159=[start,active,rem];var __tp0;var _;var __tp1;var __tp2;var __tp3;var __tp4;var __tp0;var start;var active;var __tp1;var __tp2;var __tp0;var start;var active;var __tp1;var __tp2;var __tp3;var next;var __tp4;var target;var end;var attr;var rest;var __t160=false;var __t161=false;var __t162=false;var __t163=false;var __t164=false;if(((__t160=(__t159 instanceof Array))&&((__t161=((__tp0=__t159.length),true))&&((__t162=(__tp0===3))&&(((_=__t159[0]),true,(__tp1=__t159[1]),(__tp1 instanceof Array))&&(((__tp2=__tp1.length),true)&&((__tp2===0)&&(((__tp3=__t159[2]),(__tp3 instanceof Array))&&(((__tp4=__tp3.length),true)&&(__tp4===0)))))))))){return [];}else{if((__t162&&((__t163=((start=__t159[0]),true,(active=__t159[1]),true,(__tp1=__t159[2]),(__tp1 instanceof Array)))&&((__t164=((__tp2=__tp1.length),true))&&(__tp2===0))))){var top=send(Math.max,function(){var __t165=[];var __t166=active;var __t167=__t166.length;for(var __t168=0;(__t168<__t167);(__t168++)){var __t169=__t166[__t168];var __tp0;var _;var e;var _;var other;if(((__t169 instanceof Array)&&(((__tp0=__t169.length),true)&&((__tp0===3)&&((_=__t169[0]),true,(e=__t169[1]),true,(_=__t169[2]),true))))){__t165.push(e);}else{if(((other=__t169),true)){false;}else{throw ["Could not find a match",__t169];}}}return __t165;}());var bot=Math.min(start,top);var __tp0;var __tp1;var spans;var _;if((((__tp0=jumptill(active,start,top)),(__tp0 instanceof Array))&&(((__tp1=__tp0.length),true)&&((__tp1===2)&&((spans=__tp0[0]),true,(_=__tp0[1]),true))))){(void 0);}else{throw "a condition failed";}return spans;}else{if((__t164&&((__tp2>=1)&&(((__tp3=__tp1[0]),(next=__tp3),true,(__tp3 instanceof Array))&&(((__tp4=__tp3.length),true)&&((__tp4===3)&&((target=__tp3[0]),true,(end=__tp3[1]),true,(attr=__tp3[2]),true,(rest=__tp1.slice(1)),true))))))){var __tp0;var __tp1;var spans;var newactive;if((((__tp0=jumptill(active,start,target)),(__tp0 instanceof Array))&&(((__tp1=__tp0.length),true)&&((__tp1===2)&&((spans=__tp0[0]),true,(newactive=__tp0[1]),true))))){(void 0);}else{throw "a condition failed";}return spans.concat(process(target,[next].concat(newactive),rest));}else{throw ["Could not find a match",__t159];}}}};var thespans=spans.sort(function(__t170,__t171){var __tp0;var s1;var e1;var _;if(((__t170 instanceof Array)&&(((__tp0=__t170.length),true)&&((__tp0===3)&&((s1=__t170[0]),true,(e1=__t170[1]),true,(_=__t170[2]),true))))){(void 0);}else{throw "a condition failed";}var __tp0;var s2;var e2;var _;if(((__t171 instanceof Array)&&(((__tp0=__t171.length),true)&&((__tp0===3)&&((s2=__t171[0]),true,(e2=__t171[1]),true,(_=__t171[2]),true))))){(void 0);}else{throw "a condition failed";}if((s1===s2)){return (e1-e2);}else{return (s1-s2);}});return process(thespans[0][0],[],thespans);};var highlight_locations=function(){var __t172=Array.prototype.slice.call(arguments,0);var __tp0;var locations;var context;if(((__t172 instanceof Array)&&(((__tp0=__t172.length),true)&&(((__tp0>=1)&&(__tp0<=2))&&((locations=__t172[0]),true,(context=function(){if((1>=__tp0)){return 0;}else{return __t172[1];}}()),true))))){var loc=merge_locations(function(){var __t173=[];var __t174=locations;var __t175=__t174.length;for(var __t176=0;(__t176<__t175);(__t176++)){var __t177=__t174[__t176];var __tp0;var x;var cls;var other;if(((__t177 instanceof Array)&&(((__tp0=__t177.length),true)&&((__tp0===2)&&((x=__t177[0]),true,(cls=__t177[1]),true))))){__t173.push(x);}else{if(((other=__t177),true)){false;}else{throw ["Could not find a match",__t177];}}}return __t173;}());var src=loc.source;var __tp0;var __tp1;var l1;var l2;if((((__tp0=loc.linerange()),(__tp0 instanceof Array))&&(((__tp1=__tp0.length),true)&&((__tp1===2)&&((l1=__tp0[0]),true,(l2=__tp0[1]),true))))){(void 0);}else{throw "a condition failed";}var first=Math.max(1,(l1-context));var last=Math.min(src.nlines,(l2+context));return src.highlight_lines(first,last,function(){var __t178=[];var __t179=locations;var __t180=__t179.length;for(var __t181=0;(__t181<__t180);(__t181++)){var __t182=__t179[__t181];var __tp0;var loc;var cls;var other;if(((__t182 instanceof Array)&&(((__tp0=__t182.length),true)&&((__tp0===2)&&((loc=__t182[0]),true,(cls=__t182[1]),true))))){__t178.push([loc.start,loc.end,[cls]]);}else{if(((other=__t182),true)){false;}else{throw ["Could not find a match",__t182];}}}return __t178;}());}else{throw ["Could not find a match",__t172];}};var merge_locations=function(__t183){var __t184=__t183;var __tp0;var __tp0;var loc;var __tp0;var locs;var __t185=false;var __t186=false;if(((__t185=(__t184 instanceof Array))&&((__t186=((__tp0=__t184.length),true))&&(__tp0===0)))){return Location(null,0,0);}else{if((__t186&&((__tp0===1)&&((loc=__t184[0]),true)))){return loc;}else{if((__t186&&((__tp0>=0)&&((locs=__t184.slice(0)),true)))){var start=send(Math.min,function(){var __t187=[];var __t188=locs;var __t189=__t188.length;for(var __t190=0;(__t190<__t189);(__t190++)){var __t191=__t188[__t190];var loc;var other;if(((loc=__t191),true)){__t187.push(loc.start);}else{if(((other=__t191),true)){false;}else{throw ["Could not find a match",__t191];}}}return __t187;}());var end=send(Math.max,function(){var __t192=[];var __t193=locs;var __t194=__t193.length;for(var __t195=0;(__t195<__t194);(__t195++)){var __t196=__t193[__t195];var loc;var other;if(((loc=__t196),true)){__t192.push(loc.end);}else{if(((other=__t196),true)){false;}else{throw ["Could not find a match",__t196];}}}return __t192;}());return Location(locs[0].source,start,end);}else{throw ["Could not find a match",__t184];}}}};var __lt____lt____colon__=function(x,y){(x["location"]=function(){if(((!y)||___checker(Location)(y))){return y;}else{return y.location;}}());return x;};var __plus____plus____colon__=function(x,y){(x=function(){if(((!x)||___checker(Location)(x))){return x;}else{return x.location;}}());(y=function(){if(((!y)||___checker(Location)(y))){return y;}else{return y.location;}}());var __t198;try{(__t198=merge_locations([x,y]));}catch(__t197){(__t198=undefined);}return __t198;};(exports["Source"]=Source);(exports["Location"]=Location);(exports["highlight"]=highlight);(exports["highlight_locations"]=highlight_locations);(exports["merge_locations"]=merge_locations);(exports["<<:"]=__lt____lt____colon__);(exports["++:"]=__plus____plus____colon__);
