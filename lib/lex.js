var τ778=function(type){var τ779=type["::check"];var f;if((τ779===(void 0))){return function(value){return (value instanceof type);};}else{if(((f=τ779),true)){return function(value){return f.call(type,value);};}else{throw τ770(["match"]).create("Could not find a match",({"value":τ779}));}}};
var τ780=function(dest,values){for(k in values){if(values.hasOwnProperty(k)){(dest[k]=send(values,k));}else{null;}}return dest;};
var τ770=function(){var τ771=function(tags){var τ772=function(){if((!τ778(τ771)(this))){return Object.create(τ771.prototype);}else{return this;}}();(τ772["tags"]=tags);return τ772;};τ780(τ771);(τ771.prototype["create"]=function(){var τ773=Array.prototype.slice.call(arguments,0);var τp0;var message;var args;if(((τ773 instanceof Array)&&(((τp0=τ773.length),true)&&((τp0>=0)&&((message=function(){if((0>=τp0)){return "";}else{return τ773[0];}}()),true,(args=τ773.slice(1)),true))))){var τ772=this;var e=Error(message);(e["::tags"]=τ772.tags);(e["args"]=args);(e["name"]=["E"].concat(τ772.tags).join("."));return e;}else{throw τ770(["match"]).create("Could not find a match",({"value":τ773}));}});(τ771.prototype["::check"]=function(e){var τ772=this;if(((!e)||(!τ778(Error)(e)))){return false;}else{null;}var tags=(e["::tags"]||[]);var τ774=τ772.tags;var τ775=τ774.length;for(var τ776=0;(τ776<τ775);(τ776++)){var τ777=τ774[τ776];var tag;var other;if(((tag=τ777),true,(tags.indexOf(tag)===(-1)))){return false;}else{if(((other=τ777),true)){false;}else{throw τ770(["match"]).create("Could not find a match",({"value":τ777}));}}}false;return true;});(τ771.prototype["::deconstruct"]=function(e){var τ772=this;return e.args;});return τ771;}();
var τ781=function(){var r=[];for(var i=0;(i<arguments.length);(i++)){(r=r.concat(arguments[i]));}return r;};
var τ782=function(τ783){var τ784=τ783;var x;var x;var other;if((((typeof(τ784)==="string")&&((x=τ784),true))||((typeof(τ784)==="number")&&((x=τ784),true)))){return ["value",x];}else{if(((other=τ784),true)){return other["::serialize_ast"]();}else{throw τ770(["match"]).create("Could not find a match",({"value":τ784}));}}};
var send=function(obj,τ763){var msg;var τ762;(msg=τ763);true;(τ762=τ763);var τ764=τ762;var other;if(((typeof(τ764)==="string")||(typeof(τ764)==="number"))){return obj[msg];}else{if(((other=τ764),true)){return obj["::send"](msg);}else{throw τ770(["match"]).create("Could not find a match",({"value":τ764}));}}};(Array[":::project"]=function(τ766){var value;var τ765;(value=τ766);true;(τ765=τ766);var τ767=τ765;var _;if(τ778(Array)(τ767)){return [true,value];}else{if(((_=τ767),true)){return [true,[value]];}else{throw τ770(["match"]).create("Could not find a match",({"value":τ767}));}}});(Array.prototype["::check"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){return false;}else{null;}}return true;}else{return false;}});(Array.prototype[":::project"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){var rval=this.slice(0);rval.push(value);return [true,rval];}else{null;}}return [true,value];}else{var rval=this.slice(0);rval.push(value);return [true,rval];}});(Array.prototype[":::deconstruct"]=function(value){return [true,value.slice(this.length)];});(Array.prototype["::serialize_ast"]=function(){return τ781(["array"],this.map(τ782));});(RegExp.prototype["::check"]=function(value){return value.match(this);});(RegExp.prototype[":::project"]=function(value){var τ768=value.match(this);var m;var m;if(((τ768===null)&&((m=τ768),true))){return [false,null];}else{if(((m=τ768),true)){return [true,m];}else{throw τ770(["match"]).create("Could not find a match",({"value":τ768}));}}});(RegExp.prototype[":::deconstruct"]=function(value){var τ769=value.match(this);var m;var m;if(((τ769===null)&&((m=τ769),true))){return [false,null];}else{if(((m=τ769),true)){return [true,m];}else{throw τ770(["match"]).create("Could not find a match",({"value":τ769}));}}});(Function.prototype["::send"]=function(args){return this.apply(this,args);});var τ785=require("./location");var Location=τ785.Location;var __lt____lt____colon__=τ785["<<:"];var special_ops=({"(":"PFX","[":"PFX","{":"PFX",")":"SFX","]":"SFX","}":"SFX",",":"IFX",":":"IFX",".":"PFX","'":"PFX"});var regexps=function(){var id=RegExp("(?:^[a-zA-Z$_](?:[a-zA-Z$_0-9]*))","");var id_f=function(m,wsb,wsa,last_op){return ["ID","ID",m[0]];};var numr=RegExp("(?:^((?:\\d+))[rR]((?:[A-Za-z0-9_]+))(?:(?:\\.((?:[A-Za-z0-9_]+)))?))","");var numr_f=function(m,wsb,wsa,last_op){var τp0;var _;var radix;var intp;var frac;if(((m instanceof Array)&&(((τp0=m.length),true)&&((τp0===4)&&((_=m[0]),true,(radix=m[1]),true,(intp=m[2]),true,(frac=m[3]),true))))){undefined;}else{throw τ770(["match"]).create("The value failed to match");}(value=parseInt(intp.replace(RegExp("_","g"),""),radix));if(frac){(frac=frac.replace(RegExp("_","g"),""));(value=(value+(parseInt(frac,radix)/Math.pow(radix,frac.length))));}else{null;}return ["ID","NUM",value];};var num=RegExp("(?:^((?:[0-9_]+))(?:(?:\\.((?:\\d+)))?)(?:(?:[eE]((?:[+-]?)(?:[0-9_]+)))?))","");var num_f=function(m,wsb,wsa,last_op){return ["ID","NUM",parseFloat(m[0].replace(RegExp("_","g"),""))];};var str=RegExp("(?:^\"((?:(?:(?:\\\\\\\\|\\\\\")|[^\"])*))\")","");var str_f=function(m,wsb,wsa,last_op){var repl=({"\\\"":"\"","\\\\":"\\","\\n":"\n"});var r=m[1].replace(RegExp("((?:(?:\\\\\"|\\\\\\\\)|\\\\n))","g"),function(m){return send(repl,m);});return ["ID","STR",r];};var op=RegExp("(?:^(?:[+\\-*/~\\^<>=%&|?!@#.:']+))","");var op2=RegExp("(?:^[\\[\\{\\}\\],])","");var op3=RegExp("(?:^(?:(?:(?:(?:(?:(?:(?:(?:(?:(?:with|where)|when)|and)|not)|or)|in)|instanceof)|mod)|each)|as)\\b)","");var op4=RegExp("(?:^`((?:[A-Za-z0-9_]+))`)","");var op_f=function(m,wsb,wsa,last_op,column){var op=(m[1]||m[0]);var τ786=null;var _;if((op==="|")){return ["INDENT",(column-1)];}else{if((op in special_ops)){var fixity=send(special_ops,op);var width=function(){var τ787=fixity;var other;if((τ787==="IFX")){if((wsb||wsa)){return "wide";}else{return "short";}}else{if((τ787==="SFX")){if(wsb){return "wide";}else{return "short";}}else{if((τ787==="PFX")){if(wsa){return "wide";}else{return "short";}}else{if(((other=τ787),true)){throw τ770(["should_never_happen"]).create("unknown fixity");}else{throw τ770(["match"]).create("Could not find a match",({"value":τ787}));}}}}}();return ["OP",fixity,width,op];}else{if((wsa&&wsb)){return ["OP",function(){if(last_op){return "PFX";}else{return "IFX";}}(),"wide",op];}else{if(((!wsa)&&(!wsb))){return ["OP",function(){if(last_op){return "PFX";}else{return "IFX";}}(),"short",op];}else{if((wsa&&last_op)){return ["OP","PFX","wide",op];}else{if(wsa){return ["OP","SFX","short",op];}else{if(wsb){return ["OP","PFX","short",op];}else{if(((_=τ786),true)){return ["OP","PFX","short",op];}else{throw τ770(["match"]).create("Could not find a match",({"value":τ786}));}}}}}}}}};var indent=RegExp("(?:^(?:(?:\n((?: *)))+))","");var indent_f=function(m,wsb,wsa,last_op){var ilen=m[1].length;return ["INDENT",ilen];};var cmnt=RegExp("(?:^;(?:[^\n]*))","");var cmnt_f=function(m,wsb,wsa,last_op){return ["IGNORE"];};var unkn=RegExp("(?:^.)","");var unkn_f=function(m,wsb,wsa,last_op){return ["ILLEGAL",m[0]];};return [[op3,op_f],[id,id_f],[numr,numr_f],[num,num_f],[str,str_f],[op,op_f],[op2,op_f],[op4,op_f],[indent,indent_f],[cmnt,cmnt_f],[unkn,unkn_f]];}();var ws_re=RegExp("(?:^(?: *)(?:(?:\n(?: *)\\\\(?: *))*))","");var eol_re=RegExp("(?:^(?: *)(?:\n|$))","");var indent_tracker=function(){var curr=false;var stack=[];var stacks=[stack];return function(τ789){var token;var τ788;(token=τ789);true;(τ788=τ789);var τ790=τ788;var τp0;var τp1;var τp2;var new_indent;var τ791;var τp0;var τp1;var stuff;var τp0;var τp1;var fixity;var width;var τp2;var τp0;var τp1;var fixity;var width;var τp2;var other;var τ792=false;var τ793=false;var τ794=false;var τ795=false;if(((τ792=(τ790 instanceof Array))&&((τ793=((τp0=τ790.length),true))&&((τp0===2)&&(((τp1=τ790[0]),(τp1==="INDENT"))&&((τp2=τ790[1]),(new_indent=τp2),true,(τ791=τp2),true)))))){var τ796=τ791;if((curr===false)){(curr=new_indent);return [["OP","IFX","wide",","]];}else{if((τ796>curr)){send(stack.push(curr),(curr=new_indent));return [["OP","PFX","wide","["]];}else{if((τ796===curr)){return [["OP","IFX","wide",","]];}else{if((τ796<curr)){var rval=[];while(((stack.length>0)&&(new_indent<curr))){(curr=stack.pop());rval.push(["OP","SFX","wide","]"]);}rval.push(["OP","IFX","wide",","]);return rval;}else{throw τ770(["match"]).create("Could not find a match",({"value":τ796}));}}}}}else{if((τ793&&((τp0>=1)&&(((τp1=τ790[0]),(τp1==="ID"))&&((stuff=τ790.slice(1)),true))))){return [token];}else{if((τ793&&((τ794=(τp0===4))&&((τ795=((τp1=τ790[0]),(τp1==="OP")))&&((fixity=τ790[1]),true,(width=τ790[2]),true,(τp2=τ790[3]),((τp2==="[")||(τp2==="{"))))))){stack.push(curr);stacks.push(stack);(stack=[]);(curr=false);return [token];}else{if((τ795&&((fixity=τ790[1]),true,(width=τ790[2]),true,(τp2=τ790[3]),((τp2==="]")||(τp2==="}"))))){var rval=function(){var τ797=[];var τ798=stack;var τ799=τ798.length;for(var τ800=0;(τ800<τ799);(τ800++)){var τ801=τ798[τ800];var _;var other;if(((_=τ801),true)){τ797.push(["OP","SFX","short","]"]);}else{if(((other=τ801),true)){false;}else{throw τ770(["match"]).create("Could not find a match",({"value":τ801}));}}}return τ797;}();(stack=stacks.pop());(curr=stack.pop());rval.push(token);return rval;}else{if(((other=τ790),true)){return [token];}else{throw τ770(["match"]).create("Could not find a match",({"value":τ790}));}}}}}};};var process_token=function(src,token,last_op,wsa,wsb,pos,endpos,accum){var τp0;var type;var result;if(((token instanceof Array)&&(((τp0=token.length),true)&&((τp0>=1)&&((type=token[0]),true,(result=token.slice(1)),true))))){undefined;}else{throw τ770(["match"]).create("The value failed to match");}__lt____lt____colon__(result,token);var τ802=type;var other;if((τ802==="IGNORE")){return last_op;}else{if((τ802==="ID")){if((!last_op)){var w=["IFX",function(){if(wsb){return "wide";}else{return "short";}}(),"WHITE"];(w["location"]=Location(src,pos,pos));accum.push(w);}else{null;}accum.push(result);return false;}else{if((τ802==="OP")){if(last_op){var v=["VOID"];(v["location"]=Location(src,pos,pos));accum.push(v);}else{null;}var τ803=result[0];if((τ803==="IFX")){accum.push(result);return true;}else{if((τ803==="PFX")){if((!last_op)){var w=["IFX",function(){if(wsb){return "wide";}else{return "short";}}(),"WHITE"];(w["location"]=Location(src,pos,pos));var v=["VOID"];(v["location"]=Location(src,pos,pos));accum.push(w);accum.push(v);}else{null;}accum.push(result);return true;}else{if((τ803==="SFX")){accum.push(result);var v=["VOID"];(v["location"]=Location(src,endpos,endpos));accum.push(v);return false;}else{throw τ770(["match"]).create("Could not find a match",({"value":τ803}));}}}}else{if((τ802==="ILLEGAL")){throw τ770(["syntax","illegal"]).create("unknown character",({"chr":token}));}else{if(((other=τ802),true)){throw τ770(["should_never_happen"]).create("unknown token type",({"token":token}));}else{throw τ770(["match"]).create("Could not find a match",({"value":τ802}));}}}}}};var tokenize=function(src){var text=src.text;var last_op=true;var results=[];var wsb=text.match(ws_re)[0].length;(text=text.slice(wsb));(pos=wsb);(column=0);var indent=indent_tracker();while(text){for(var i=0;(i<regexps.length);(++i)){var τp0;var τp1;var re;var fn;if((((τp0=send(regexps,i)),(τp0 instanceof Array))&&(((τp1=τp0.length),true)&&((τp1===2)&&((re=τp0[0]),true,(fn=τp0[1]),true))))){undefined;}else{throw τ770(["match"]).create("The value failed to match");}var m=text.match(re);if(m){var skip=m[0].length;var endpos=(pos+skip);(column=function(){var splits=m[0].split("\n");if((splits.length>1)){return send(splits,(splits.length-1)).length;}else{return (column+skip);}}());(text=text.slice(skip));var wsa=text.match(ws_re)[0].length;var eol=(text.match(eol_re)&&true);var bwsb=(wsb>0);var bwsa=function(){if(eol){return bwsb;}else{return (wsa>0);}}();var token=fn(m,bwsb,bwsa,last_op,column);var tokens=indent(token);var τ804=tokens;var τ805=τ804.length;for(var τ806=0;(τ806<τ805);(τ806++)){var τ807=τ804[τ806];var x;var other;if(((x=τ807),true)){(x["location"]=Location(src,pos,endpos));(last_op=process_token(src,x,last_op,bwsa,bwsb,pos,endpos,results));}else{if(((other=τ807),true)){false;}else{throw τ770(["match"]).create("Could not find a match",({"value":τ807}));}}}false;(text=text.slice(wsa));(column=(column+wsa));(wsb=wsa);(pos=(endpos+wsa));break;}else{null;}}}if(last_op){var v=["VOID"];(v["location"]=[pos,pos]);results.push(v);}else{null;}return results;};(exports["tokenize"]=tokenize);
