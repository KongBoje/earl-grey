var τ135=function(type){var τ136=type["::check"];var f;if((τ136===(void 0))){return function(value){return (value instanceof type);};}else{if(((f=τ136),true)){return function(value){return f.call(type,value);};}else{throw ["Could not find a match",τ136];}}};
var τ137=function(){var r=[];for(var i=0;(i<arguments.length);(i++)){(r=r.concat(arguments[i]));}return r;};
var τ138=function(τ139){var τ140=τ139;var x;var x;var other;if((((typeof(τ140)==="string")&&((x=τ140),true))||((typeof(τ140)==="number")&&((x=τ140),true)))){return ["value",x];}else{if(((other=τ140),true)){return other["::serialize_ast"]();}else{throw ["Could not find a match",τ140];}}};
var send=function(obj,τ128){var msg;var τ127;(msg=τ128);true;(τ127=τ128);var τ129=τ127;var other;if(((typeof(τ129)==="string")||(typeof(τ129)==="number"))){return obj[msg];}else{if(((other=τ129),true)){return obj["::send"](msg);}else{throw ["Could not find a match",τ129];}}};(Array[":::project"]=function(τ131){var value;var τ130;(value=τ131);true;(τ130=τ131);var τ132=τ130;var _;if(τ135(Array)(τ132)){return [true,value];}else{if(((_=τ132),true)){return [true,[value]];}else{throw ["Could not find a match",τ132];}}});(Array.prototype["::check"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){return false;}else{null;}}return true;}else{return false;}});(Array.prototype[":::project"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){var rval=this.slice(0);rval.push(value);return [true,rval];}else{null;}}return [true,value];}else{var rval=this.slice(0);rval.push(value);return [true,rval];}});(Array.prototype[":::deconstruct"]=function(value){return [true,value.slice(this.length)];});(Array.prototype["::serialize_ast"]=function(){return τ137(["array"],this.map(τ138));});(RegExp.prototype["::check"]=function(value){return value.match(this);});(RegExp.prototype[":::project"]=function(value){var τ133=value.match(this);var m;var m;if(((τ133===null)&&((m=τ133),true))){return [false,null];}else{if(((m=τ133),true)){return [true,m];}else{throw ["Could not find a match",τ133];}}});(RegExp.prototype[":::deconstruct"]=function(value){var τ134=value.match(this);var m;var m;if(((τ134===null)&&((m=τ134),true))){return [false,null];}else{if(((m=τ134),true)){return [true,m];}else{throw ["Could not find a match",τ134];}}});(Function.prototype["::send"]=function(args){return this.apply(this,args);});
var τ164=function(dest,values){for(k in values){if(values.hasOwnProperty(k)){(dest[k]=send(values,k));}else{null;}}return dest;};
var τ165=function(){var τ166=function(tags){var τ167=function(){if((!τ135(τ166)(this))){return Object.create(τ166.prototype);}else{return this;}}();(τ167["tags"]=tags);return τ167;};τ164(τ166);(τ166.prototype["create"]=function(){var τ168=Array.prototype.slice.call(arguments,0);var τp0;var message;var args;if(((τ168 instanceof Array)&&(((τp0=τ168.length),true)&&((τp0>=0)&&((message=function(){if((0>=τp0)){return "";}else{return τ168[0];}}()),true,(args=τ168.slice(1)),true))))){var τ167=this;var e=Error(message);(e["::tags"]=τ167.tags);(e["args"]=args);(e["name"]=["E"].concat(τ167.tags).join("."));return e;}else{throw ["Could not find a match",τ168];}});(τ166.prototype["::check"]=function(e){var τ167=this;if(((!e)||(!τ135(Error)(e)))){return false;}else{null;}var tags=(e["::tags"]||[]);var τ169=τ167.tags;var τ170=τ169.length;for(var τ171=0;(τ171<τ170);(τ171++)){var τ172=τ169[τ171];var tag;var other;if(((tag=τ172),true,(tags.indexOf(tag)===(-1)))){return false;}else{if(((other=τ172),true)){false;}else{throw ["Could not find a match",τ172];}}}false;return true;});(τ166.prototype["::deconstruct"]=function(e){var τ167=this;return e.args;});return τ166;}();var τ141=require("./location");var Location=τ141.Location;var __lt____lt____colon__=τ141["<<:"];var special_ops=({"(":"PFX","[":"PFX","{":"PFX",")":"SFX","]":"SFX","}":"SFX",",":"IFX",":":"IFX",".":"PFX","'":"PFX"});var regexps=function(){var id=RegExp("(?:^[a-zA-Z$_](?:[a-zA-Z$_0-9]*))","");var id_f=function(m,wsb,wsa,last_op){return ["ID","ID",m[0]];};var numr=RegExp("(?:^((?:\\d+))[rR]((?:[A-Za-z0-9_]+))(?:(?:\\.((?:[A-Za-z0-9_]+)))?))","");var numr_f=function(m,wsb,wsa,last_op){var τp0;var _;var radix;var intp;var frac;if(((m instanceof Array)&&(((τp0=m.length),true)&&((τp0===4)&&((_=m[0]),true,(radix=m[1]),true,(intp=m[2]),true,(frac=m[3]),true))))){undefined;}else{throw τ164(τ165(["match"]).create("The value failed to match"),({"location":["location","/home/olivier/git/earl-grey/src/lex.eg",734,756]}));}(value=parseInt(intp.replace(RegExp("_","g"),""),radix));if(frac){(frac=frac.replace(RegExp("_","g"),""));(value=(value+(parseInt(frac,radix)/Math.pow(radix,frac.length))));}else{null;}return ["ID","NUM",value];};var num=RegExp("(?:^((?:[0-9_]+))(?:(?:\\.((?:\\d+)))?)(?:(?:[eE]((?:[+-]?)(?:[0-9_]+)))?))","");var num_f=function(m,wsb,wsa,last_op){return ["ID","NUM",parseFloat(m[0].replace(RegExp("_","g"),""))];};var str=RegExp("(?:^\"((?:(?:(?:\\\\\\\\|\\\\\")|[^\"])*))\")","");var str_f=function(m,wsb,wsa,last_op){var repl=({"\\\"":"\"","\\\\":"\\","\\n":"\n"});var r=m[1].replace(RegExp("((?:(?:\\\\\"|\\\\\\\\)|\\\\n))","g"),function(m){return send(repl,m);});return ["ID","STR",r];};var op=RegExp("(?:^(?:[+\\-*/~\\^<>=%&|?!@#.:']+))","");var op2=RegExp("(?:^[\\[\\{\\}\\],])","");var op3=RegExp("(?:^(?:(?:(?:(?:(?:(?:(?:(?:(?:(?:with|where)|when)|and)|not)|or)|in)|instanceof)|mod)|each)|as)\\b)","");var op4=RegExp("(?:^`((?:[A-Za-z0-9_]+))`)","");var op_f=function(m,wsb,wsa,last_op,column){var op=(m[1]||m[0]);var τ142=null;var _;if((op==="|")){return ["INDENT",(column-1)];}else{if((op in special_ops)){var fixity=send(special_ops,op);var width=function(){var τ143=fixity;var other;if((τ143==="IFX")){if((wsb||wsa)){return "wide";}else{return "short";}}else{if((τ143==="SFX")){if(wsb){return "wide";}else{return "short";}}else{if((τ143==="PFX")){if(wsa){return "wide";}else{return "short";}}else{if(((other=τ143),true)){throw τ165(["should_never_happen"]).create("unknown fixity");}else{throw ["Could not find a match",τ143];}}}}}();return ["OP",fixity,width,op];}else{if((wsa&&wsb)){return ["OP",function(){if(last_op){return "PFX";}else{return "IFX";}}(),"wide",op];}else{if(((!wsa)&&(!wsb))){return ["OP",function(){if(last_op){return "PFX";}else{return "IFX";}}(),"short",op];}else{if((wsa&&last_op)){return ["OP","PFX","wide",op];}else{if(wsa){return ["OP","SFX","short",op];}else{if(wsb){return ["OP","PFX","short",op];}else{if(((_=τ142),true)){return ["OP","PFX","short",op];}else{throw ["Could not find a match",τ142];}}}}}}}}};var indent=RegExp("(?:^(?:(?:\n((?: *)))+))","");var indent_f=function(m,wsb,wsa,last_op){var ilen=m[1].length;return ["INDENT",ilen];};var cmnt=RegExp("(?:^;(?:[^\n]*))","");var cmnt_f=function(m,wsb,wsa,last_op){return ["IGNORE"];};var unkn=RegExp("(?:^.)","");var unkn_f=function(m,wsb,wsa,last_op){return ["ILLEGAL",m[0]];};return [[op3,op_f],[id,id_f],[numr,numr_f],[num,num_f],[str,str_f],[op,op_f],[op2,op_f],[op4,op_f],[indent,indent_f],[cmnt,cmnt_f],[unkn,unkn_f]];}();var ws_re=RegExp("(?:^(?: *)(?:(?:\n(?: *)\\\\(?: *))*))","");var eol_re=RegExp("(?:^(?: *)(?:\n|$))","");var indent_tracker=function(){var curr=false;var stack=[];var stacks=[stack];return function(τ145){var token;var τ144;(token=τ145);true;(τ144=τ145);var τ146=τ144;var τp0;var τp1;var τp2;var new_indent;var τ147;var τp0;var τp1;var stuff;var τp0;var τp1;var fixity;var width;var τp2;var τp0;var τp1;var fixity;var width;var τp2;var other;var τ148=false;var τ149=false;var τ150=false;var τ151=false;if(((τ148=(τ146 instanceof Array))&&((τ149=((τp0=τ146.length),true))&&((τp0===2)&&(((τp1=τ146[0]),(τp1==="INDENT"))&&((τp2=τ146[1]),(new_indent=τp2),true,(τ147=τp2),true)))))){var τ152=τ147;if((curr===false)){(curr=new_indent);return [["OP","IFX","wide",","]];}else{if((τ152>curr)){send(stack.push(curr),(curr=new_indent));return [["OP","PFX","wide","["]];}else{if((τ152===curr)){return [["OP","IFX","wide",","]];}else{if((τ152<curr)){var rval=[];while(((stack.length>0)&&(new_indent<curr))){(curr=stack.pop());rval.push(["OP","SFX","wide","]"]);}rval.push(["OP","IFX","wide",","]);return rval;}else{throw ["Could not find a match",τ152];}}}}}else{if((τ149&&((τp0>=1)&&(((τp1=τ146[0]),(τp1==="ID"))&&((stuff=τ146.slice(1)),true))))){return [token];}else{if((τ149&&((τ150=(τp0===4))&&((τ151=((τp1=τ146[0]),(τp1==="OP")))&&((fixity=τ146[1]),true,(width=τ146[2]),true,(τp2=τ146[3]),((τp2==="[")||(τp2==="{"))))))){stack.push(curr);stacks.push(stack);(stack=[]);(curr=false);return [token];}else{if((τ151&&((fixity=τ146[1]),true,(width=τ146[2]),true,(τp2=τ146[3]),((τp2==="]")||(τp2==="}"))))){var rval=function(){var τ153=[];var τ154=stack;var τ155=τ154.length;for(var τ156=0;(τ156<τ155);(τ156++)){var τ157=τ154[τ156];var _;var other;if(((_=τ157),true)){τ153.push(["OP","SFX","short","]"]);}else{if(((other=τ157),true)){false;}else{throw ["Could not find a match",τ157];}}}return τ153;}();(stack=stacks.pop());(curr=stack.pop());rval.push(token);return rval;}else{if(((other=τ146),true)){return [token];}else{throw ["Could not find a match",τ146];}}}}}};};var process_token=function(src,token,last_op,wsa,wsb,pos,endpos,accum){var τp0;var type;var result;if(((token instanceof Array)&&(((τp0=token.length),true)&&((τp0>=1)&&((type=token[0]),true,(result=token.slice(1)),true))))){undefined;}else{throw τ164(τ165(["match"]).create("The value failed to match"),({"location":["location","/home/olivier/git/earl-grey/src/lex.eg",4306,4321]}));}__lt____lt____colon__(result,token);var τ158=type;var other;if((τ158==="IGNORE")){return last_op;}else{if((τ158==="ID")){if((!last_op)){var w=["IFX",function(){if(wsb){return "wide";}else{return "short";}}(),"WHITE"];(w["location"]=Location(src,pos,pos));accum.push(w);}else{null;}accum.push(result);return false;}else{if((τ158==="OP")){if(last_op){var v=["VOID"];(v["location"]=Location(src,pos,pos));accum.push(v);}else{null;}var τ159=result[0];if((τ159==="IFX")){accum.push(result);return true;}else{if((τ159==="PFX")){if((!last_op)){var w=["IFX",function(){if(wsb){return "wide";}else{return "short";}}(),"WHITE"];(w["location"]=Location(src,pos,pos));var v=["VOID"];(v["location"]=Location(src,pos,pos));accum.push(w);accum.push(v);}else{null;}accum.push(result);return true;}else{if((τ159==="SFX")){accum.push(result);var v=["VOID"];(v["location"]=Location(src,endpos,endpos));accum.push(v);return false;}else{throw ["Could not find a match",τ159];}}}}else{if((τ158==="ILLEGAL")){throw τ165(["syntax","illegal"]).create("unknown character",({"chr":token}));}else{if(((other=τ158),true)){throw τ165(["should_never_happen"]).create("unknown token type",({"token":token}));}else{throw ["Could not find a match",τ158];}}}}}};var tokenize=function(src){var text=src.text;var last_op=true;var results=[];var wsb=text.match(ws_re)[0].length;(text=text.slice(wsb));(pos=wsb);(column=0);var indent=indent_tracker();while(text){for(var i=0;(i<regexps.length);(++i)){var τp0;var τp1;var re;var fn;if((((τp0=send(regexps,i)),(τp0 instanceof Array))&&(((τp1=τp0.length),true)&&((τp1===2)&&((re=τp0[0]),true,(fn=τp0[1]),true))))){undefined;}else{throw τ164(τ165(["match"]).create("The value failed to match"),({"location":["location","/home/olivier/git/earl-grey/src/lex.eg",5889,5897]}));}var m=text.match(re);if(m){var skip=m[0].length;var endpos=(pos+skip);(column=function(){var splits=m[0].split("\n");if((splits.length>1)){return send(splits,(splits.length-1)).length;}else{return (column+skip);}}());(text=text.slice(skip));var wsa=text.match(ws_re)[0].length;var eol=(text.match(eol_re)&&true);var bwsb=(wsb>0);var bwsa=function(){if(eol){return bwsb;}else{return (wsa>0);}}();var token=fn(m,bwsb,bwsa,last_op,column);var tokens=indent(token);var τ160=tokens;var τ161=τ160.length;for(var τ162=0;(τ162<τ161);(τ162++)){var τ163=τ160[τ162];var x;var other;if(((x=τ163),true)){(x["location"]=Location(src,pos,endpos));(last_op=process_token(src,x,last_op,bwsa,bwsb,pos,endpos,results));}else{if(((other=τ163),true)){false;}else{throw ["Could not find a match",τ163];}}}false;(text=text.slice(wsa));(column=(column+wsa));(wsb=wsa);(pos=(endpos+wsa));break;}else{null;}}}if(last_op){var v=["VOID"];(v["location"]=[pos,pos]);results.push(v);}else{null;}return results;};(exports["tokenize"]=tokenize);
