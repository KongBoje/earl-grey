var τ298=function(type){var τ299=type["::check"];var f;if((τ299===(void 0))){return function(value){return (value instanceof type);};}else{if(((f=τ299),true)){return function(value){return f.call(type,value);};}else{throw τ290(["match"]).create("Could not find a match",({"value":τ299}));}}};
var τ300=function(dest,values){for(k in values){if(values.hasOwnProperty(k)){(dest[k]=send(values,k));}else{null;}}return dest;};
var τ290=function(){var τ291=function(tags){var τ292=function(){if((!τ298(τ291)(this))){return Object.create(τ291.prototype);}else{return this;}}();(τ292["tags"]=tags);return τ292;};τ300(τ291);(τ291.prototype["create"]=function(){var τ293=Array.prototype.slice.call(arguments,0);var τp0;var message;var args;if(((τ293 instanceof Array)&&(((τp0=τ293.length),true)&&((τp0>=0)&&((message=function(){if((0>=τp0)){return "";}else{return τ293[0];}}()),true,(args=τ293.slice(1)),true))))){var τ292=this;var e=Error(message);(e["::tags"]=τ292.tags);(e["args"]=args);(e["name"]=["E"].concat(τ292.tags).join("."));return e;}else{throw τ290(["match"]).create("Could not find a match",({"value":τ293}));}});(τ291.prototype["::check"]=function(e){var τ292=this;if(((!e)||(!τ298(Error)(e)))){return false;}else{null;}var tags=(e["::tags"]||[]);var τ294=τ292.tags;var τ295=τ294.length;for(var τ296=0;(τ296<τ295);(τ296++)){var τ297=τ294[τ296];var tag;var other;if(((tag=τ297),true,(tags.indexOf(tag)===(-1)))){return false;}else{if(((other=τ297),true)){false;}else{throw τ290(["match"]).create("Could not find a match",({"value":τ297}));}}}false;return true;});(τ291.prototype["::deconstruct"]=function(e){var τ292=this;return e.args;});return τ291;}();
var τ301=function(){var r=[];for(var i=0;(i<arguments.length);(i++)){(r=r.concat(arguments[i]));}return r;};
var τ302=function(τ303){var τ304=τ303;var x;var x;var other;if((((typeof(τ304)==="string")&&((x=τ304),true))||((typeof(τ304)==="number")&&((x=τ304),true)))){return ["value",x];}else{if(((other=τ304),true)){return other["::serialize_ast"]();}else{throw τ290(["match"]).create("Could not find a match",({"value":τ304}));}}};
var send=function(obj,τ283){var msg;var τ282;(msg=τ283);true;(τ282=τ283);var τ284=τ282;var other;if(((typeof(τ284)==="string")||(typeof(τ284)==="number"))){return obj[msg];}else{if(((other=τ284),true)){return obj["::send"](msg);}else{throw τ290(["match"]).create("Could not find a match",({"value":τ284}));}}};(Array[":::project"]=function(τ286){var value;var τ285;(value=τ286);true;(τ285=τ286);var τ287=τ285;var _;if(τ298(Array)(τ287)){return [true,value];}else{if(((_=τ287),true)){return [true,[value]];}else{throw τ290(["match"]).create("Could not find a match",({"value":τ287}));}}});(Array.prototype["::check"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){return false;}else{null;}}return true;}else{return false;}});(Array.prototype[":::project"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){var rval=this.slice(0);rval.push(value);return [true,rval];}else{null;}}return [true,value];}else{var rval=this.slice(0);rval.push(value);return [true,rval];}});(Array.prototype[":::deconstruct"]=function(value){return [true,value.slice(this.length)];});(Array.prototype["::serialize_ast"]=function(){return τ301(["array"],this.map(τ302));});(RegExp.prototype["::check"]=function(value){return value.match(this);});(RegExp.prototype[":::project"]=function(value){var τ288=value.match(this);var m;var m;if(((τ288===null)&&((m=τ288),true))){return [false,null];}else{if(((m=τ288),true)){return [true,m];}else{throw τ290(["match"]).create("Could not find a match",({"value":τ288}));}}});(RegExp.prototype[":::deconstruct"]=function(value){var τ289=value.match(this);var m;var m;if(((τ289===null)&&((m=τ289),true))){return [false,null];}else{if(((m=τ289),true)){return [true,m];}else{throw τ290(["match"]).create("Could not find a match",({"value":τ289}));}}});(Function.prototype["::send"]=function(args){return this.apply(this,args);});var τ305=require("./location");var Location=τ305.Location;var __lt____lt____colon__=τ305["<<:"];var special_ops=({"(":"PFX","[":"PFX","{":"PFX",")":"SFX","]":"SFX","}":"SFX",",":"IFX",":":"IFX",".":"PFX","'":"PFX"});var regexps=function(){var id=RegExp("(?:^[a-zA-Z$_](?:[a-zA-Z$_0-9]*))","");var id_f=function(m,wsb,wsa,last_op){return ["ID","ID",m[0]];};var numr=RegExp("(?:^((?:\\d+))[rR]((?:[A-Za-z0-9_]+))(?:(?:\\.((?:[A-Za-z0-9_]+)))?))","");var numr_f=function(m,wsb,wsa,last_op){var τp0;var _;var radix;var intp;var frac;if(((m instanceof Array)&&(((τp0=m.length),true)&&((τp0===4)&&((_=m[0]),true,(radix=m[1]),true,(intp=m[2]),true,(frac=m[3]),true))))){undefined;}else{throw τ290(["match"]).create("The value failed to match");}var value=parseInt(intp.replace(RegExp("_","g"),""),radix);if(frac){(frac=frac.replace(RegExp("_","g"),""));(value=(value+(parseInt(frac,radix)/Math.pow(radix,frac.length))));}else{null;}return ["ID","NUM",value];};var num=RegExp("(?:^((?:[0-9_]+))(?:(?:\\.((?:\\d+)))?)(?:(?:[eE]((?:[+-]?)(?:[0-9_]+)))?))","");var num_f=function(m,wsb,wsa,last_op){return ["ID","NUM",parseFloat(m[0].replace(RegExp("_","g"),""))];};var str=RegExp("(?:^\"((?:(?:(?:\\\\\\\\|\\\\\")|[^\"])*))\")","");var str_f=function(m,wsb,wsa,last_op){var repl=({"\\\"":"\"","\\\\":"\\","\\n":"\n"});var r=m[1].replace(RegExp("((?:(?:\\\\\"|\\\\\\\\)|\\\\n))","g"),function(m){return send(repl,m);});return ["ID","STR",r];};var op=RegExp("(?:^(?:[+\\-*/~\\^<>=%&|?!@#.:']+))","");var op2=RegExp("(?:^[\\[\\{\\}\\],])","");var op3=RegExp("(?:^(?:(?:(?:(?:(?:(?:(?:(?:(?:(?:with|where)|when)|and)|not)|or)|in)|instanceof)|mod)|each)|as)\\b)","");var op4=RegExp("(?:^`((?:[A-Za-z0-9_]+))`)","");var op_f=function(m,wsb,wsa,last_op,column){var op=(m[1]||m[0]);var τ306=null;var _;if((op==="|")){return ["INDENT",(column-1)];}else{if((op in special_ops)){var fixity=send(special_ops,op);var width=function(){var τ307=fixity;var other;if((τ307==="IFX")){if((wsb||wsa)){return "wide";}else{return "short";}}else{if((τ307==="SFX")){if(wsb){return "wide";}else{return "short";}}else{if((τ307==="PFX")){if(wsa){return "wide";}else{return "short";}}else{if(((other=τ307),true)){throw τ290(["should_never_happen"]).create("unknown fixity");}else{throw τ290(["match"]).create("Could not find a match",({"value":τ307}));}}}}}();return ["OP",fixity,width,op];}else{if((wsa&&wsb)){return ["OP",function(){if(last_op){return "PFX";}else{return "IFX";}}(),"wide",op];}else{if(((!wsa)&&(!wsb))){return ["OP",function(){if(last_op){return "PFX";}else{return "IFX";}}(),"short",op];}else{if((wsa&&last_op)){return ["OP","PFX","wide",op];}else{if(wsa){return ["OP","SFX","short",op];}else{if(wsb){return ["OP","PFX","short",op];}else{if(((_=τ306),true)){return ["OP","PFX","short",op];}else{throw τ290(["match"]).create("Could not find a match",({"value":τ306}));}}}}}}}}};var indent=RegExp("(?:^(?:(?:\n((?: *)))+))","");var indent_f=function(m,wsb,wsa,last_op){var ilen=m[1].length;return ["INDENT",ilen];};var cmnt=RegExp("(?:^;(?:[^\n]*))","");var cmnt_f=function(m,wsb,wsa,last_op){return ["IGNORE"];};var unkn=RegExp("(?:^.)","");var unkn_f=function(m,wsb,wsa,last_op){return ["ILLEGAL",m[0]];};return [[op3,op_f],[id,id_f],[numr,numr_f],[num,num_f],[str,str_f],[op,op_f],[op2,op_f],[op4,op_f],[indent,indent_f],[cmnt,cmnt_f],[unkn,unkn_f]];}();var ws_re=RegExp("(?:^(?: *)(?:(?:\n(?: *)\\\\(?: *))*))","");var eol_re=RegExp("(?:^(?: *)(?:\n|$))","");var indent_tracker=function(){var curr=false;var stack=[];var stacks=[stack];return function(τ309){var token;var τ308;(token=τ309);true;(τ308=τ309);var τ310=τ308;var τp0;var τp1;var τp2;var new_indent;var τ311;var τp0;var τp1;var stuff;var τp0;var τp1;var fixity;var width;var τp2;var τp0;var τp1;var fixity;var width;var τp2;var other;var τ312=false;var τ313=false;var τ314=false;var τ315=false;if(((τ312=(τ310 instanceof Array))&&((τ313=((τp0=τ310.length),true))&&((τp0===2)&&(((τp1=τ310[0]),(τp1==="INDENT"))&&((τp2=τ310[1]),(new_indent=τp2),true,(τ311=τp2),true)))))){var τ316=τ311;if((curr===false)){(curr=new_indent);return [["OP","IFX","wide",","]];}else{if((τ316>curr)){send(stack.push(curr),(curr=new_indent));return [["OP","PFX","wide","["]];}else{if((τ316===curr)){return [["OP","IFX","wide",","]];}else{if((τ316<curr)){var rval=[];while(((stack.length>0)&&(new_indent<curr))){(curr=stack.pop());rval.push(["OP","SFX","wide","]"]);}rval.push(["OP","IFX","wide",","]);return rval;}else{throw τ290(["match"]).create("Could not find a match",({"value":τ316}));}}}}}else{if((τ313&&((τp0>=1)&&(((τp1=τ310[0]),(τp1==="ID"))&&((stuff=τ310.slice(1)),true))))){return [token];}else{if((τ313&&((τ314=(τp0===4))&&((τ315=((τp1=τ310[0]),(τp1==="OP")))&&((fixity=τ310[1]),true,(width=τ310[2]),true,(τp2=τ310[3]),((τp2==="[")||(τp2==="{"))))))){stack.push(curr);stacks.push(stack);(stack=[]);(curr=false);return [token];}else{if((τ315&&((fixity=τ310[1]),true,(width=τ310[2]),true,(τp2=τ310[3]),((τp2==="]")||(τp2==="}"))))){var rval=function(){var τ317=[];var τ318=stack;var τ319=τ318.length;for(var τ320=0;(τ320<τ319);(τ320++)){var τ321=τ318[τ320];var _;var other;if(((_=τ321),true)){τ317.push(["OP","SFX","short","]"]);}else{if(((other=τ321),true)){false;}else{throw τ290(["match"]).create("Could not find a match",({"value":τ321}));}}}return τ317;}();(stack=stacks.pop());(curr=stack.pop());rval.push(token);return rval;}else{if(((other=τ310),true)){return [token];}else{throw τ290(["match"]).create("Could not find a match",({"value":τ310}));}}}}}};};var process_token=function(src,token,last_op,wsa,wsb,pos,endpos,accum){var τp0;var type;var result;if(((token instanceof Array)&&(((τp0=token.length),true)&&((τp0>=1)&&((type=token[0]),true,(result=token.slice(1)),true))))){undefined;}else{throw τ290(["match"]).create("The value failed to match");}__lt____lt____colon__(result,token);var τ322=type;var other;if((τ322==="IGNORE")){return last_op;}else{if((τ322==="ID")){if((!last_op)){var w=["IFX",function(){if(wsb){return "wide";}else{return "short";}}(),"WHITE"];(w["location"]=Location(src,pos,pos));accum.push(w);}else{null;}accum.push(result);return false;}else{if((τ322==="OP")){if(last_op){var v=["VOID"];(v["location"]=Location(src,pos,pos));accum.push(v);}else{null;}var τ323=result[0];if((τ323==="IFX")){accum.push(result);return true;}else{if((τ323==="PFX")){if((!last_op)){var w=["IFX",function(){if(wsb){return "wide";}else{return "short";}}(),"WHITE"];(w["location"]=Location(src,pos,pos));var v=["VOID"];(v["location"]=Location(src,pos,pos));accum.push(w);accum.push(v);}else{null;}accum.push(result);return true;}else{if((τ323==="SFX")){accum.push(result);var v=["VOID"];(v["location"]=Location(src,endpos,endpos));accum.push(v);return false;}else{throw τ290(["match"]).create("Could not find a match",({"value":τ323}));}}}}else{if((τ322==="ILLEGAL")){throw τ290(["syntax","illegal"]).create("unknown character",({"chr":token}));}else{if(((other=τ322),true)){throw τ290(["should_never_happen"]).create("unknown token type",({"token":token}));}else{throw τ290(["match"]).create("Could not find a match",({"value":τ322}));}}}}}};var tokenize=function(src){var text=src.text;var last_op=true;var results=[];var wsb=text.match(ws_re)[0].length;(text=text.slice(wsb));var pos=wsb;var column=0;var indent=indent_tracker();while(text){for(var i=0;(i<regexps.length);(++i)){var τp0;var τp1;var re;var fn;if((((τp0=send(regexps,i)),(τp0 instanceof Array))&&(((τp1=τp0.length),true)&&((τp1===2)&&((re=τp0[0]),true,(fn=τp0[1]),true))))){undefined;}else{throw τ290(["match"]).create("The value failed to match");}var m=text.match(re);if(m){var skip=m[0].length;var endpos=(pos+skip);(column=function(){var splits=m[0].split("\n");if((splits.length>1)){return send(splits,(splits.length-1)).length;}else{return (column+skip);}}());(text=text.slice(skip));var wsa=text.match(ws_re)[0].length;var eol=(text.match(eol_re)&&true);var bwsb=(wsb>0);var bwsa=function(){if(eol){return bwsb;}else{return (wsa>0);}}();var token=fn(m,bwsb,bwsa,last_op,column);var tokens=indent(token);var τ324=tokens;var τ325=τ324.length;for(var τ326=0;(τ326<τ325);(τ326++)){var τ327=τ324[τ326];var x;var other;if(((x=τ327),true)){(x["location"]=Location(src,pos,endpos));(last_op=process_token(src,x,last_op,bwsa,bwsb,pos,endpos,results));}else{if(((other=τ327),true)){false;}else{throw τ290(["match"]).create("Could not find a match",({"value":τ327}));}}}false;(text=text.slice(wsa));(column=(column+wsa));(wsb=wsa);(pos=(endpos+wsa));break;}else{null;}}}if(last_op){var v=["VOID"];(v["location"]=[pos,pos]);results.push(v);}else{null;}return results;};(exports["tokenize"]=tokenize);
