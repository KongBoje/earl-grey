var augment=function(dest,values){for(k in values){if(values.hasOwnProperty(k)){(dest[k]=send(values,k));}else{null;}}return dest;};var send=function(obj,__t94){var msg;var __t93;(msg=__t94);true;(__t93=__t94);var __t95=__t93;var other;if(((typeof(__t95)==="string")||(typeof(__t95)==="number"))){return obj[msg];}else{if(((other=__t95),true)){return obj["::send"](msg);}else{throw ["Could not find a match",__t95];}}};var patch_array=function(){var r=[];for(var i=0;(i<arguments.length);(i++)){(r=r.concat(arguments[i]));}return r;};var range=function(from,to){var rval=[];for(var i=from;(i<=to);(i++)){rval.push(i);}return rval;};var ___checker=function(type){var __t96=type["::check"];var f;if((__t96===(void 0))){return function(value){return (value instanceof type);};}else{if(((f=__t96),true)){return function(value){return f.call(type,value);};}else{throw ["Could not find a match",__t96];}}};var ___projector=function(type){return function(value){var __t97=type[":::project"];var f;if((__t97===(void 0))){var __t98=type["::project"];var f;if((__t98===(void 0))){return [true,type(value)];}else{if(((f=__t98),true)){var __t100;try{(__t100=[true,f(value)]);}catch(__t99){(__t100=[false,null]);}return __t100;}else{throw ["Could not find a match",__t98];}}}else{if(((f=__t97),true)){return f.call(type,value);}else{throw ["Could not find a match",__t97];}}};};var ___deconstructor=function(type){return function(value){var __t101=type[":::deconstruct"];var f;if((__t101===(void 0))){var __t102=type["::deconstruct"];var f;if((__t102===(void 0))){if((value instanceof Array)){return [true,value];}else{if(true){return [false,null];}else{return false;}}}else{if(((f=__t102),true)){var __t104;try{(__t104=[true,f.call(type,value)]);}catch(__t103){(__t104=[false,null]);}return __t104;}else{throw ["Could not find a match",__t102];}}}else{if(((f=__t101),true)){return f.call(type,value);}else{throw ["Could not find a match",__t101];}}};};(Array[":::project"]=function(__t106){var value;var __t105;(value=__t106);true;(__t105=__t106);var __t107=__t105;var _;if(___checker(Array)(__t107)){return [true,value];}else{if(((_=__t107),true)){return [true,[value]];}else{throw ["Could not find a match",__t107];}}});(Array.prototype["boink"]=function(){return this;});(Array.prototype["::check"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){return false;}else{null;}}return true;}else{return false;}});(Array.prototype[":::project"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){var rval=this.slice(0);rval.push(value);return [true,rval];}else{null;}}return [true,value];}else{var rval=this.slice(0);rval.push(value);return [true,rval];}});(Array.prototype[":::deconstruct"]=function(value){return value.slice(this.length);});(RegExp.prototype["::check"]=function(value){return value.match(this);});(RegExp.prototype[":::project"]=function(value){var __t108=value.match(this);var m;var m;if(((__t108===null)&&((m=__t108),true))){return [false,null];}else{if(((m=__t108),true)){return [true,m];}else{throw ["Could not find a match",__t108];}}});(RegExp.prototype[":::deconstruct"]=function(value){var __t109=value.match(this);var m;var m;if(((__t109===null)&&((m=__t109),true))){return [false,null];}else{if(((m=__t109),true)){return [true,m];}else{throw ["Could not find a match",__t109];}}});(Function.prototype["::send"]=function(args){return this.apply(this,args);});var ErrorFactory=function(tags){var __t87=function(){if((!___checker(ErrorFactory)(this))){return Object.create(ErrorFactory.prototype);}else{return this;}}();(__t87["tags"]=tags);return __t87;};augment(ErrorFactory,[]);(ErrorFactory.prototype["create"]=function(){var __t88=Array.prototype.slice.call(arguments,0);var __tp0;var message;var args;if(((__t88 instanceof Array)&&(((__tp0=__t88.length),true)&&((__tp0>=0)&&((message=function(){if((0>=__tp0)){return "";}else{return __t88[0];}}()),true,(args=__t88.slice(1)),true))))){var __t87=this;var e=Error(message);(e["::tags"]=__t87.tags);(e["args"]=args);(e["name"]=["E"].concat(__t87.tags).join("."));return e;}else{throw ["Could not find a match",__t88];}});(ErrorFactory.prototype["::check"]=function(e){var __t87=this;if(((!e)||(!___checker(Error)(e)))){return false;}else{null;}var tags=(e["::tags"]||[]);var __t89=__t87.tags;var __t90=__t89.length;for(var __t91=0;(__t91<__t90);(__t91++)){var __t92=__t89[__t91];var tag;var other;if(((tag=__t92),true,(tags.indexOf(tag)===(-1)))){return false;}else{if(((other=__t92),true)){false;}else{throw ["Could not find a match",__t92];}}}false;return true;});(ErrorFactory.prototype["::deconstruct"]=function(e){var __t87=this;return e.args;});ErrorFactory;
var __t64=require("./location");var Location=__t64.Location;var __lt____lt____colon__=__t64["<<:"];var special_ops=({"(":"PFX","[":"PFX","{":"PFX",")":"SFX","]":"SFX","}":"SFX",",":"IFX",":":"IFX",".":"PFX","'":"PFX"});var regexps=function(){var id=RegExp("(?:^[a-zA-Z$_](?:[a-zA-Z$_0-9]*))","");var id_f=function(m,wsb,wsa,last_op){return ["ID","ID",m[0]];};var numr=RegExp("(?:^((?:\\d+))[rR]((?:[A-Za-z0-9_]+))(?:(?:\\.((?:[A-Za-z0-9_]+)))?))","");var numr_f=function(m,wsb,wsa,last_op){var __tp0;var _;var radix;var intp;var frac;if(((m instanceof Array)&&(((__tp0=m.length),true)&&((__tp0===4)&&((_=m[0]),true,(radix=m[1]),true,(intp=m[2]),true,(frac=m[3]),true))))){(void 0);}else{throw "a condition failed";}(value=parseInt(intp.replace(RegExp("_","g"),""),radix));if(frac){(frac=frac.replace(RegExp("_","g"),""));(value=(value+(parseInt(frac,radix)/Math.pow(radix,frac.length))));}else{null;}return ["ID","NUM",value];};var num=RegExp("(?:^((?:[0-9_]+))(?:(?:\\.((?:\\d+)))?)(?:(?:[eE]((?:[+-]?)(?:[0-9_]+)))?))","");var num_f=function(m,wsb,wsa,last_op){return ["ID","NUM",parseFloat(m[0].replace(RegExp("_","g"),""))];};var str=RegExp("(?:^\"((?:(?:(?:\\\\\\\\|\\\\\")|[^\"])*))\")","");var str_f=function(m,wsb,wsa,last_op){var repl=({"\\\"":"\"","\\\\":"\\","\\n":"\n"});var r=m[1].replace(RegExp("((?:(?:\\\\\"|\\\\\\\\)|\\\\n))","g"),function(m){return send(repl,m);});return ["ID","STR",r];};var op=RegExp("(?:^(?:[+\\-*/~\\^<>=%&|?!@#.:']+))","");var op2=RegExp("(?:^[\\[\\{\\}\\],])","");var op3=RegExp("(?:^(?:(?:(?:(?:(?:(?:(?:(?:(?:(?:with|where)|when)|and)|not)|or)|in)|instanceof)|mod)|each)|as)\\b)","");var op4=RegExp("(?:^`((?:[A-Za-z0-9_]+))`)","");var op_f=function(m,wsb,wsa,last_op,column){var op=(m[1]||m[0]);var __t65=null;var _;if((op==="|")){return ["INDENT",(column-1)];}else{if((op in special_ops)){var fixity=send(special_ops,op);var width=function(){var __t66=fixity;var other;if((__t66==="IFX")){if((wsb||wsa)){return "wide";}else{return "short";}}else{if((__t66==="SFX")){if(wsb){return "wide";}else{return "short";}}else{if((__t66==="PFX")){if(wsa){return "wide";}else{return "short";}}else{if(((other=__t66),true)){throw ErrorFactory(["should_never_happen"]).create("unknown fixity");}else{throw ["Could not find a match",__t66];}}}}}();return ["OP",fixity,width,op];}else{if((wsa&&wsb)){return ["OP",function(){if(last_op){return "PFX";}else{return "IFX";}}(),"wide",op];}else{if(((!wsa)&&(!wsb))){return ["OP",function(){if(last_op){return "PFX";}else{return "IFX";}}(),"short",op];}else{if((wsa&&last_op)){return ["OP","PFX","wide",op];}else{if(wsa){return ["OP","SFX","short",op];}else{if(wsb){return ["OP","PFX","short",op];}else{if(((_=__t65),true)){return ["OP","PFX","short",op];}else{throw ["Could not find a match",__t65];}}}}}}}}};var indent=RegExp("(?:^(?:(?:\n((?: *)))+))","");var indent_f=function(m,wsb,wsa,last_op){var ilen=m[1].length;return ["INDENT",ilen];};var cmnt=RegExp("(?:^;(?:[^\n]*))","");var cmnt_f=function(m,wsb,wsa,last_op){return ["IGNORE"];};var unkn=RegExp("(?:^.)","");var unkn_f=function(m,wsb,wsa,last_op){return ["ILLEGAL",m[0]];};return [[op3,op_f],[id,id_f],[numr,numr_f],[num,num_f],[str,str_f],[op,op_f],[op2,op_f],[op4,op_f],[indent,indent_f],[cmnt,cmnt_f],[unkn,unkn_f]];}();var ws_re=RegExp("(?:^(?: *)(?:(?:\n(?: *)\\\\(?: *))*))","");var eol_re=RegExp("(?:^(?: *)(?:\n|$))","");var indent_tracker=function(){var curr=false;var stack=[];var stacks=[stack];return function(__t68){var token;var __t67;(token=__t68);true;(__t67=__t68);var __t69=__t67;var __tp0;var __tp1;var __tp2;var new_indent;var __t70;var __tp0;var __tp1;var stuff;var __tp0;var __tp1;var fixity;var width;var __tp2;var __tp0;var __tp1;var fixity;var width;var __tp2;var other;var __t71=false;var __t72=false;var __t73=false;var __t74=false;if(((__t71=(__t69 instanceof Array))&&((__t72=((__tp0=__t69.length),true))&&((__tp0===2)&&(((__tp1=__t69[0]),(__tp1==="INDENT"))&&((__tp2=__t69[1]),(new_indent=__tp2),true,(__t70=__tp2),true)))))){var __t75=__t70;if((curr===false)){(curr=new_indent);return [["OP","IFX","wide",","]];}else{if((__t75>curr)){send(stack.push(curr),(curr=new_indent));return [["OP","PFX","wide","["]];}else{if((__t75===curr)){return [["OP","IFX","wide",","]];}else{if((__t75<curr)){var rval=[];while(((stack.length>0)&&(new_indent<curr))){(curr=stack.pop());rval.push(["OP","SFX","wide","]"]);}rval.push(["OP","IFX","wide",","]);return rval;}else{throw ["Could not find a match",__t75];}}}}}else{if((__t72&&((__tp0>=1)&&(((__tp1=__t69[0]),(__tp1==="ID"))&&((stuff=__t69.slice(1)),true))))){return [token];}else{if((__t72&&((__t73=(__tp0===4))&&((__t74=((__tp1=__t69[0]),(__tp1==="OP")))&&((fixity=__t69[1]),true,(width=__t69[2]),true,(__tp2=__t69[3]),((__tp2==="[")||(__tp2==="{"))))))){stack.push(curr);stacks.push(stack);(stack=[]);(curr=false);return [token];}else{if((__t74&&((fixity=__t69[1]),true,(width=__t69[2]),true,(__tp2=__t69[3]),((__tp2==="]")||(__tp2==="}"))))){var rval=function(){var __t76=[];var __t77=stack;var __t78=__t77.length;for(var __t79=0;(__t79<__t78);(__t79++)){var __t80=__t77[__t79];var _;var other;if(((_=__t80),true)){__t76.push(["OP","SFX","short","]"]);}else{if(((other=__t80),true)){false;}else{throw ["Could not find a match",__t80];}}}return __t76;}();(stack=stacks.pop());(curr=stack.pop());rval.push(token);return rval;}else{if(((other=__t69),true)){return [token];}else{throw ["Could not find a match",__t69];}}}}}};};var process_token=function(src,token,last_op,wsa,wsb,pos,endpos,accum){var __tp0;var type;var result;if(((token instanceof Array)&&(((__tp0=token.length),true)&&((__tp0>=1)&&((type=token[0]),true,(result=token.slice(1)),true))))){(void 0);}else{throw "a condition failed";}__lt____lt____colon__(result,token);var __t81=type;var other;if((__t81==="IGNORE")){return last_op;}else{if((__t81==="ID")){if((!last_op)){var w=["IFX",function(){if(wsb){return "wide";}else{return "short";}}(),"WHITE"];(w["location"]=Location(src,pos,pos));accum.push(w);}else{null;}accum.push(result);return false;}else{if((__t81==="OP")){if(last_op){var v=["VOID"];(v["location"]=Location(src,pos,pos));accum.push(v);}else{null;}var __t82=result[0];if((__t82==="IFX")){accum.push(result);return true;}else{if((__t82==="PFX")){if((!last_op)){var w=["IFX",function(){if(wsb){return "wide";}else{return "short";}}(),"WHITE"];(w["location"]=Location(src,pos,pos));var v=["VOID"];(v["location"]=Location(src,pos,pos));accum.push(w);accum.push(v);}else{null;}accum.push(result);return true;}else{if((__t82==="SFX")){accum.push(result);var v=["VOID"];(v["location"]=Location(src,endpos,endpos));accum.push(v);return false;}else{throw ["Could not find a match",__t82];}}}}else{if((__t81==="ILLEGAL")){throw ErrorFactory(["syntax","illegal"]).create("unknown character",({"chr":token}));}else{if(((other=__t81),true)){throw ErrorFactory(["should_never_happen"]).create("unknown token type",({"token":token}));}else{throw ["Could not find a match",__t81];}}}}}};var tokenize=function(src){var text=src.text;var last_op=true;var results=[];var wsb=text.match(ws_re)[0].length;(text=text.slice(wsb));(pos=wsb);(column=0);var indent=indent_tracker();while(text){for(var i=0;(i<regexps.length);(++i)){var __tp0;var __tp1;var re;var fn;if((((__tp0=send(regexps,i)),(__tp0 instanceof Array))&&(((__tp1=__tp0.length),true)&&((__tp1===2)&&((re=__tp0[0]),true,(fn=__tp0[1]),true))))){(void 0);}else{throw "a condition failed";}var m=text.match(re);if(m){var skip=m[0].length;var endpos=(pos+skip);(column=function(){var splits=m[0].split("\n");if((splits.length>1)){return send(splits,(splits.length-1)).length;}else{return (column+skip);}}());(text=text.slice(skip));var wsa=text.match(ws_re)[0].length;var eol=(text.match(eol_re)&&true);var bwsb=(wsb>0);var bwsa=function(){if(eol){return bwsb;}else{return (wsa>0);}}();var token=fn(m,bwsb,bwsa,last_op,column);var tokens=indent(token);var __t83=tokens;var __t84=__t83.length;for(var __t85=0;(__t85<__t84);(__t85++)){var __t86=__t83[__t85];var x;var other;if(((x=__t86),true)){(x["location"]=Location(src,pos,endpos));(last_op=process_token(src,x,last_op,bwsa,bwsb,pos,endpos,results));}else{if(((other=__t86),true)){false;}else{throw ["Could not find a match",__t86];}}}false;(text=text.slice(wsa));(column=(column+wsa));(wsb=wsa);(pos=(endpos+wsa));break;}else{null;}}}if(last_op){var v=["VOID"];(v["location"]=[pos,pos]);results.push(v);}else{null;}return results;};(exports["tokenize"]=tokenize);
