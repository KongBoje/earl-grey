var augment=function(dest,values){for(k in values){if(values.hasOwnProperty(k)){(dest[k]=send(values,k));}else{null;}}return dest;};var send=function(obj,__t94){var msg;var __t93;(msg=__t94);true;(__t93=__t94);var __t95=__t93;var other;if(((typeof(__t95)==="string")||(typeof(__t95)==="number"))){return obj[msg];}else{if(((other=__t95),true)){return obj["::send"](msg);}else{throw ["Could not find a match",__t95];}}};var patch_array=function(){var r=[];for(var i=0;(i<arguments.length);(i++)){(r=r.concat(arguments[i]));}return r;};var range=function(from,to){var rval=[];for(var i=from;(i<=to);(i++)){rval.push(i);}return rval;};var ___checker=function(type){var __t96=type["::check"];var f;if((__t96===(void 0))){return function(value){return (value instanceof type);};}else{if(((f=__t96),true)){return function(value){return f.call(type,value);};}else{throw ["Could not find a match",__t96];}}};var ___projector=function(type){return function(value){var __t97=type[":::project"];var f;if((__t97===(void 0))){var __t98=type["::project"];var f;if((__t98===(void 0))){return [true,type(value)];}else{if(((f=__t98),true)){var __t100;try{(__t100=[true,f(value)]);}catch(__t99){(__t100=[false,null]);}return __t100;}else{throw ["Could not find a match",__t98];}}}else{if(((f=__t97),true)){return f.call(type,value);}else{throw ["Could not find a match",__t97];}}};};var ___deconstructor=function(type){return function(value){var __t101=type[":::deconstruct"];var f;if((__t101===(void 0))){var __t102=type["::deconstruct"];var f;if((__t102===(void 0))){if((value instanceof Array)){return [true,value];}else{if(true){return [false,null];}else{return false;}}}else{if(((f=__t102),true)){var __t104;try{(__t104=[true,f.call(type,value)]);}catch(__t103){(__t104=[false,null]);}return __t104;}else{throw ["Could not find a match",__t102];}}}else{if(((f=__t101),true)){return f.call(type,value);}else{throw ["Could not find a match",__t101];}}};};(Array[":::project"]=function(__t106){var value;var __t105;(value=__t106);true;(__t105=__t106);var __t107=__t105;var _;if(___checker(Array)(__t107)){return [true,value];}else{if(((_=__t107),true)){return [true,[value]];}else{throw ["Could not find a match",__t107];}}});(Array.prototype["boink"]=function(){return this;});(Array.prototype["::check"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){return false;}else{null;}}return true;}else{return false;}});(Array.prototype[":::project"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){var rval=this.slice(0);rval.push(value);return [true,rval];}else{null;}}return [true,value];}else{var rval=this.slice(0);rval.push(value);return [true,rval];}});(Array.prototype[":::deconstruct"]=function(value){return value.slice(this.length);});(RegExp.prototype["::check"]=function(value){return value.match(this);});(RegExp.prototype[":::project"]=function(value){var __t108=value.match(this);var m;var m;if(((__t108===null)&&((m=__t108),true))){return [false,null];}else{if(((m=__t108),true)){return [true,m];}else{throw ["Could not find a match",__t108];}}});(RegExp.prototype[":::deconstruct"]=function(value){var __t109=value.match(this);var m;var m;if(((__t109===null)&&((m=__t109),true))){return [false,null];}else{if(((m=__t109),true)){return [true,m];}else{throw ["Could not find a match",__t109];}}});(Function.prototype["::send"]=function(args){return this.apply(this,args);});var ErrorFactory=function(tags){var __t87=function(){if((!___checker(ErrorFactory)(this))){return Object.create(ErrorFactory.prototype);}else{return this;}}();(__t87["tags"]=tags);return __t87;};augment(ErrorFactory,[]);(ErrorFactory.prototype["create"]=function(){var __t88=Array.prototype.slice.call(arguments,0);var __tp0;var message;var args;if(((__t88 instanceof Array)&&(((__tp0=__t88.length),true)&&((__tp0>=0)&&((message=function(){if((0>=__tp0)){return "";}else{return __t88[0];}}()),true,(args=__t88.slice(1)),true))))){var __t87=this;var e=Error(message);(e["::tags"]=__t87.tags);(e["args"]=args);(e["name"]=["E"].concat(__t87.tags).join("."));return e;}else{throw ["Could not find a match",__t88];}});(ErrorFactory.prototype["::check"]=function(e){var __t87=this;if(((!e)||(!___checker(Error)(e)))){return false;}else{null;}var tags=(e["::tags"]||[]);var __t89=__t87.tags;var __t90=__t89.length;for(var __t91=0;(__t91<__t90);(__t91++)){var __t92=__t89[__t91];var tag;var other;if(((tag=__t92),true,(tags.indexOf(tag)===(-1)))){return false;}else{if(((other=__t92),true)){false;}else{throw ["Could not find a match",__t92];}}}false;return true;});(ErrorFactory.prototype["::deconstruct"]=function(e){var __t87=this;return e.args;});ErrorFactory;
var __t199=require("./helpers");var aslist=__t199.aslist;var transform=__t199.transform;var __t200=require("./location");var __lt____lt____colon__=__t200["<<:"];var __plus____plus____colon__=__t200["++:"];var MAX=(1/0);var order_map=({"IFX":({"wide":({",":[[15,1],[15,1]],"with":[[15,999],[15,10]],"each":[[15,11],[15,10]],"where":[[15,11],[15,10]],"!!":[[15,11],[15,10]],"|>":[[15,11],[15,10]],"->":[[15,11],[15,10]],"=>":[[15,11],[15,10]],"=":[[15,11],[15,10]],":=":[[15,11],[15,10]],"+=":[[15,11],[15,10]],"-=":[[15,11],[15,10]],"*=":[[15,11],[15,10]],"/=":[[15,11],[15,10]],"<<=":[[15,11],[15,10]],">>=":[[15,11],[15,10]],">>>=":[[15,11],[15,10]],"++=":[[15,11],[15,10]],"?=":[[15,11],[15,10]],"%":[[15,11],[15,10]],"when":[[15,100],[15,101]],"||":[[15,110],[15,111]],"&&":[[15,120],[15,121]],"or":[[15,110],[15,111]],"and":[[15,120],[15,121]],"not":[[15,130],[15,131]],"==":[[15,200],[15,201]],"!=":[[15,200],[15,201]],">=":[[15,200],[15,201]],"<=":[[15,200],[15,201]],">":[[15,200],[15,201]],"<":[[15,200],[15,201]],"^.":[[15,400],[15,401]],"|.":[[15,410],[15,411]],"&.":[[15,420],[15,421]],"<<":[[1,500],[1,501]],">>":[[1,500],[1,501]],">>>":[[1,500],[1,501]],"+":[[1,550],[1,551]],"-":[[1,550],[1,551]],"*":[[1,560],[1,561]],"/":[[1,560],[1,561]],"mod":[[1,560],[1,561]],"**":[[1,571],[1,570]],"DEFAULT":[[8,900],[4,901]],"WHITE":[[15,1002],[15,1001]],":":[[15,1001],[15,2]]}),"short":({"DEFAULT":[[15,1800],[15,1801]],"WHITE":[[15,2000],[15,2001]],",":[[15,1],[15,1]],":":[[15,1001],[15,2]]})}),"PFX":({"wide":({"DEFAULT":[[15,MAX],[15,900]],"when":[[15,MAX],[15,101]],"not":[[15,MAX],[15,131]],".":[[15,MAX],[15,3000]],"#":[[15,MAX],[15,3000]],"~":[[15,MAX],[15,3000]],"@":[[15,MAX],[15,3000]],"<>":[[15,MAX],[15,5]],"(":[[15,MAX],[15,1]],"[":[[15,MAX],[15,1]],"{":[[15,MAX],[15,1]]}),"short":({"DEFAULT":[[15,MAX],[15,1901]],".":[[15,MAX],[15,3000]],"#":[[15,MAX],[15,3000]],"~":[[15,MAX],[15,3000]],"@":[[15,MAX],[15,3000]],"(":[[15,MAX],[15,1]],"[":[[15,MAX],[15,1]],"{":[[15,MAX],[15,1]]})}),"SFX":({"wide":({"DEFAULT":[[15,901],[15,MAX]],")":[[15,1],[15,MAX]],"]":[[15,1],[15,MAX]],"}":[[15,1],[15,MAX]]}),"short":({"DEFAULT":[[15,1900],[15,MAX]],")":[[15,1],[15,MAX]],"]":[[15,1],[15,MAX]],"}":[[15,1],[15,MAX]]})})});var DONE=(-1);var NONE=0;var LEFT=1;var RIGHT=2;var BOTH=3;var oparse=function(next,order,finalize){var between=finalize(next());var right_op=next();var stack=[];var left_op=null;var current=null;while(true){var o=function(){if(((!left_op)&&(!right_op))){return DONE;}else{return ((((!left_op)&&RIGHT)||((!right_op)&&LEFT))||order(left_op,right_op));}}();var __t201=o;var other;if((__t201===DONE)){return between;}else{if((__t201===LEFT)){current.push(between);(between=finalize(current));var v=stack.pop();(left_op=v[0]);(current=v[1]);}else{if((__t201===RIGHT)){stack.push([left_op,current]);(left_op=right_op);(current=[[right_op],between]);(between=finalize(next()));(right_op=next());}else{if((__t201===BOTH)){current[0].push(right_op);current.push(between);(left_op=right_op);(between=finalize(next()));(right_op=next());}else{if(((other=__t201),true)){throw ErrorFactory(["should_never_happen"]).create("undefined priority",({"left":left_op,"right":right_op}));}else{throw ["Could not find a match",__t201];}}}}}}};var consult=function(__t202){var __tp0;var fixity;var width;var op;if(((__t202 instanceof Array)&&(((__tp0=__t202.length),true)&&((__tp0===3)&&((fixity=__t202[0]),true,(width=__t202[1]),true,(op=__t202[2]),true))))){(void 0);}else{throw "a condition failed";}var map=send(send(order_map,fixity),width);return (send(map,op)||map.DEFAULT);};var order=function(o1,o2){var __tp0;var __tp1;var code1;var ord1;if((((__tp0=consult(o1)[1]),(__tp0 instanceof Array))&&(((__tp1=__tp0.length),true)&&((__tp1===2)&&((code1=__tp0[0]),true,(ord1=__tp0[1]),true))))){(void 0);}else{throw "a condition failed";}var __tp0;var __tp1;var code2;var ord2;if((((__tp0=consult(o2)[0]),(__tp0 instanceof Array))&&(((__tp1=__tp0.length),true)&&((__tp1===2)&&((code2=__tp0[0]),true,(ord2=__tp0[1]),true))))){(void 0);}else{throw "a condition failed";}var __t203=null;if(((code1&code2)===0)){throw ErrorFactory(["syntax","order"]).create("Cannot mix operators in the given order",({"left":o1,"right":o2}));}else{if((ord1>ord2)){return LEFT;}else{if((ord1<ord2)){return RIGHT;}else{if((ord1===ord2)){return BOTH;}else{throw ["Could not find a match",__t203];}}}}};var finalize=function(__t205){var token;var __t204;(token=__t205);true;(__t204=__t205);var __t206=__t204;var __tp0;var __tp1;var value;var __tp0;var __tp1;var value;var __tp0;var __tp1;var value;var __tp0;var __tp1;var __tp0;var ops;var args;var other;var __t207=false;var __t208=false;var __t209=false;if(((__t207=(__t206 instanceof Array))&&((__t208=((__tp0=__t206.length),true))&&((__t209=(__tp0===2))&&(((__tp1=__t206[0]),(__tp1==="ID"))&&((value=__t206[1]),true)))))){return __lt____lt____colon__(["symbol",value],token);}else{if((__t209&&(((__tp1=__t206[0]),(__tp1==="NUM"))&&((value=__t206[1]),true)))){return __lt____lt____colon__(["value",value],token);}else{if((__t209&&(((__tp1=__t206[0]),(__tp1==="STR"))&&((value=__t206[1]),true)))){return __lt____lt____colon__(["value",value],token);}else{if((__t208&&((__tp0===1)&&((__tp1=__t206[0]),(__tp1==="VOID"))))){return __lt____lt____colon__(["void"],token);}else{if((__t208&&((__tp0>=1)&&((ops=__t206[0]),true,(args=__t206.slice(1)),true)))){var sumloc=ops[0].location;var __t210=ops.slice(1);var __t211=__t210.length;for(var __t212=0;(__t212<__t211);(__t212++)){var __t224=__t210[__t212];var op;var other;if(((op=__t224),true)){(sumloc=__plus____plus____colon__(sumloc,op));}else{if(((other=__t224),true)){false;}else{throw ["Could not find a match",__t224];}}}false;var __t213=args;var __t214=__t213.length;for(var __t215=0;(__t215<__t214);(__t215++)){var __t225=__t213[__t215];var arg;var other;if(((arg=__t225),true)){(sumloc=__plus____plus____colon__(sumloc,arg));}else{if(((other=__t225),true)){false;}else{throw ["Could not find a match",__t225];}}}false;var orig_ops=ops;(ops=function(){var __t226=[];var __t227=ops;var __t228=__t227.length;for(var __t229=0;(__t229<__t228);(__t229++)){var __t230=__t227[__t229];var o;var other;if(((o=__t230),true)){__t226.push(o[2]);}else{if(((other=__t230),true)){false;}else{throw ["Could not find a match",__t230];}}}return __t226;}());var op=ops[0];var __t216=[ops,args];var __tp0;var __tp1;var __tp2;var __tp3;var __tp4;var __tp5;var __tp6;var f;var arg;var body;var __tp0;var __tp1;var __tp2;var __tp3;var __tp4;var __tp5;var f;var body;var __tp0;var __tp1;var __tp2;var __tp3;var __tp4;var __tp5;var target;var __tp6;var _b;var __tp7;var body;var __tp0;var __tp1;var __tp2;var __tp3;var _;var _;var __tp0;var __tp1;var __tp2;var __tp3;var _;var _;var __tp0;var __tp1;var __tp2;var __tp3;var _;var __tp0;var __tp1;var __tp2;var _;var __t217;var other;var __t218=false;var __t219=false;var __t220=false;var __t221=false;var __t222=false;var __t223=false;if(((__t218=(__t216 instanceof Array))&&((__t219=((__tp0=__t216.length),true))&&((__t220=(__tp0===2))&&((__t221=((__tp1=__t216[0]),(__tp1 instanceof Array)))&&((__t222=((__tp2=__tp1.length),true))&&((__tp2===2)&&(((__tp3=__tp1[0]),(__tp3==="WHITE"))&&(((__tp4=__tp1[1]),(__tp4===":"))&&(((__tp5=__t216[1]),(__tp5 instanceof Array))&&(((__tp6=__tp5.length),true)&&((__tp6===3)&&((f=__tp5[0]),true,(arg=__tp5[1]),true,(body=__tp5[2]),true))))))))))))){return __lt____lt____colon__(["send",f,__lt____lt____colon__(["data",arg,body],__plus____plus____colon__(arg,body))],sumloc);}else{if((__t222&&((__t223=(__tp2===1))&&(((__tp3=__tp1[0]),(__tp3===":"))&&(((__tp4=__t216[1]),(__tp4 instanceof Array))&&(((__tp5=__tp4.length),true)&&((__tp5===2)&&((f=__tp4[0]),true,(body=__tp4[1]),true)))))))){return __lt____lt____colon__(["send",f,__lt____lt____colon__(["data",body],body)],sumloc);}else{if((__t223&&(((__tp3=__tp1[0]),(__tp3==="with"))&&(((__tp4=__t216[1]),(__tp4 instanceof Array))&&(((__tp5=__tp4.length),true)&&((__tp5===2)&&(((target=__tp4[0]),true,(__tp6=__tp4[1]),(_b=__tp6),true,(__tp7=___projector(aslist)(__tp6)),__tp7[0])&&((body=__tp7[1]),true)))))))){var inserted=false;var result=transform(target,function(__t232){var expr;var __t231;(expr=__t232);true;(__t231=__t232);var __t233=__t231;var __tp0;var __tp1;var __tp2;var x;var __tp0;var __tp1;var f;var __tp2;var __tp3;var __tp4;var a;var b;var __tp0;var __tp1;var args;if(((__t233 instanceof Array)&&(((__tp0=__t233.length),true)&&((__tp0===2)&&(((__tp1=__t233[0]),(__tp1==="symbol"))&&((__tp2=__t233[1]),(__tp2==="..."))))))){(inserted=true);return __lt____lt____colon__(patch_array(["multi"],body),_b);}else{if((((x=__t233),true,x.fromop)&&((__t233 instanceof Array)&&(((__tp0=__t233.length),true)&&((__tp0===3)&&(((__tp1=__t233[0]),(__tp1==="send"))&&(((f=__t233[1]),true,(__tp2=__t233[2]),(__tp2 instanceof Array))&&(((__tp3=__tp2.length),true)&&((__tp3===3)&&(((__tp4=__tp2[0]),(__tp4==="data"))&&((a=__tp2[1]),true,(b=__tp2[2]),true))))))))))){return ["send",this(f),__lt____lt____colon__(["data",this(a),this(b)],__plus____plus____colon__(a,b))];}else{if(((__t233 instanceof Array)&&(((__tp0=__t233.length),true)&&((__tp0>=1)&&(((__tp1=__t233[0]),(__tp1==="data"))&&((args=__t233.slice(1)),true)))))){(tr=this);var res=["data"].concat(patch_array.apply(null,function(){var __t234=[];var __t235=args;var __t236=__t235.length;for(var __t237=0;(__t237<__t236);(__t237++)){var __t238=__t235[__t237];var __tp0;var __tp1;var __tp2;var other;var other;var __t239=false;if(((__t238 instanceof Array)&&(((__tp0=__t238.length),true)&&((__tp0===2)&&(((__tp1=__t238[0]),(__tp1==="symbol"))&&((__tp2=__t238[1]),(__tp2==="..."))))))){__t234.push(((inserted=true),body));}else{if((__t239=((other=__t238),true))){__t234.push([__lt____lt____colon__(tr(other),other)]);}else{if(__t239){false;}else{throw ["Could not find a match",__t238];}}}}return __t234;}()));return __lt____lt____colon__(res,expr);}else{throw ["Could not find a match",__t233];}}}});if((!inserted)){var __t240=target;var __tp0;var __tp1;var __tp0;var __tp1;var f;var __tp2;var orig_args;var __tp3;var __tp4;var args;var __tp0;var __tp1;var args;var other;var __t241=false;var __t242=false;if(((__t240 instanceof Array)&&(((__tp0=__t240.length),true)&&((__tp0===1)&&((__tp1=__t240[0]),(__tp1==="void")))))){return __lt____lt____colon__(patch_array(["data"],body),sumloc);}else{if(target.fromop){return __lt____lt____colon__(["send",target,__lt____lt____colon__(patch_array(["data"],body),_b)],sumloc);}else{if(((__t241=(__t240 instanceof Array))&&((__t242=((__tp0=__t240.length),true))&&((__tp0===3)&&(((__tp1=__t240[0]),(__tp1==="send"))&&(((f=__t240[1]),true,(__tp2=__t240[2]),(orig_args=__tp2),true,(__tp2 instanceof Array))&&(((__tp3=__tp2.length),true)&&((__tp3>=1)&&(((__tp4=__tp2[0]),(__tp4==="data"))&&((args=__tp2.slice(1)),true)))))))))){return __lt____lt____colon__(["send",f,__lt____lt____colon__(patch_array(["data"],args,body),__plus____plus____colon__(orig_args,_b))],sumloc);}else{if((__t242&&((__tp0>=1)&&(((__tp1=__t240[0]),(__tp1==="data"))&&((args=__t240.slice(1)),true))))){return __lt____lt____colon__(target.concat(body),sumloc);}else{if(((other=__t240),true)){return __lt____lt____colon__(["send",target,__lt____lt____colon__(patch_array(["data"],body),_b)],sumloc);}else{throw ["Could not find a match",__t240];}}}}}}else{return __lt____lt____colon__(result,sumloc);}}else{if((__t222&&((__t223=(__tp2>=1))&&(((__tp3=__tp1[0]),((__tp3==="[")||(__tp3===",")))&&((_=__tp1.slice(1)),true,(_=__t216[1]),true))))){if((op==="[")){(args=args.slice(1,(-1)));}else{null;}(args=function(){var f=function(__t243){var __t244=__t243;var __tp0;var __tp1;var other;if(((__t244 instanceof Array)&&(((__tp0=__t244.length),true)&&((__tp0===1)&&((__tp1=__t244[0]),(__tp1==="void")))))){return false;}else{if(((other=__t244),true)){return true;}else{throw ["Could not find a match",__t244];}}};return args.filter(f);}());var result=function(){var __t245=args;var __tp0;var __tp0;var x;var other;var __t246=false;var __t247=false;if(((__t246=(__t245 instanceof Array))&&((__t247=((__tp0=__t245.length),true))&&(__tp0===0)))){return ["value",undefined];}else{if((__t247&&((__tp0===1)&&((x=__t245[0]),true)))){return x;}else{if(((other=__t245),true)){return patch_array(["multi"],args);}else{throw ["Could not find a match",__t245];}}}}();return __lt____lt____colon__(result,sumloc);}else{if((__t223&&(((__tp3=__tp1[0]),(__tp3==="{"))&&((_=__tp1.slice(1)),true,(_=__t216[1]),true)))){var f=function(__t248){var __t249=__t248;var __tp0;var __tp1;var other;if(((__t249 instanceof Array)&&(((__tp0=__t249.length),true)&&((__tp0===1)&&((__tp1=__t249[0]),(__tp1==="void")))))){return false;}else{if(((other=__t249),true)){return true;}else{throw ["Could not find a match",__t249];}}};return __lt____lt____colon__(patch_array(["data"],args.slice(1,(-1)).filter(f)),sumloc);}else{if((__t222&&((__t223=(__tp2===1))&&(((__tp3=__tp1[0]),(__tp3==="WHITE"))&&((_=__t216[1]),true))))){return __lt____lt____colon__(patch_array(["send"],args),sumloc);}else{if((__t223&&((_=__tp1[0]),true,(__t217=__t216[1]),true))){var __t250=__t217;var __tp0;var __tp1;var __tp2;var __tp3;var __tp4;var __tp5;var __tp6;var __tp0;var a;var b;var __t251=false;var __t252=false;var __t253=false;if(((__t251=(__t250 instanceof Array))&&((__t252=((__tp0=__t250.length),true))&&((__t253=(__tp0===2))&&(((__tp1=__t250[0]),(__tp1 instanceof Array))&&(((__tp2=__tp1.length),true)&&((__tp2===1)&&(((__tp3=__tp1[0]),(__tp3==="void"))&&(((__tp4=__t250[1]),(__tp4 instanceof Array))&&(((__tp5=__tp4.length),true)&&((__tp5===1)&&((__tp6=__tp4[0]),(__tp6==="void"))))))))))))){return __lt____lt____colon__(["symbol",op],orig_ops[0]);}else{if((__t253&&((a=__t250[0]),true,(b=__t250[1]),true))){var oloc=orig_ops[0].location;var abloc=__plus____plus____colon__(a,b);var oabloc=__plus____plus____colon__(orig_ops[0],abloc);var rval=__lt____lt____colon__(["send",__lt____lt____colon__(["symbol",op],oloc),__lt____lt____colon__(["data",a,b],abloc)],__plus____plus____colon__(oloc,abloc));(rval["fromop"]=true);return rval;}else{throw ["Could not find a match",__t250];}}}else{if(((other=__t216),true)){throw ErrorFactory(["should_never_happen"]).create("unknown node",({"node":token}));}else{throw ["Could not find a match",__t216];}}}}}}}}}else{if(((other=__t206),true)){throw ErrorFactory(["should_never_happen"]).create("unknown node (B)",({"node":token}));}else{throw ["Could not find a match",__t206];}}}}}}};var parse=function(tokens){var next=function(){return tokens.shift();};return oparse(next,order,finalize);};(exports["parse"]=parse);
