var augment=function(dest,values){for(k in values){if(values.hasOwnProperty(k)){(dest[k]=send(values,k));}else{null;}}return dest;};var send=function(obj,__t94){var msg;var __t93;(msg=__t94);true;(__t93=__t94);var __t95=__t93;var other;if(((typeof(__t95)==="string")||(typeof(__t95)==="number"))){return obj[msg];}else{if(((other=__t95),true)){return obj["::send"](msg);}else{throw ["Could not find a match",__t95];}}};var patch_array=function(){var r=[];for(var i=0;(i<arguments.length);(i++)){(r=r.concat(arguments[i]));}return r;};var range=function(from,to){var rval=[];for(var i=from;(i<=to);(i++)){rval.push(i);}return rval;};var ___checker=function(type){var __t96=type["::check"];var f;if((__t96===(void 0))){return function(value){return (value instanceof type);};}else{if(((f=__t96),true)){return function(value){return f.call(type,value);};}else{throw ["Could not find a match",__t96];}}};var ___projector=function(type){return function(value){var __t97=type[":::project"];var f;if((__t97===(void 0))){var __t98=type["::project"];var f;if((__t98===(void 0))){return [true,type(value)];}else{if(((f=__t98),true)){var __t100;try{(__t100=[true,f(value)]);}catch(__t99){(__t100=[false,null]);}return __t100;}else{throw ["Could not find a match",__t98];}}}else{if(((f=__t97),true)){return f.call(type,value);}else{throw ["Could not find a match",__t97];}}};};var ___deconstructor=function(type){return function(value){var __t101=type[":::deconstruct"];var f;if((__t101===(void 0))){var __t102=type["::deconstruct"];var f;if((__t102===(void 0))){if((value instanceof Array)){return [true,value];}else{if(true){return [false,null];}else{return false;}}}else{if(((f=__t102),true)){var __t104;try{(__t104=[true,f.call(type,value)]);}catch(__t103){(__t104=[false,null]);}return __t104;}else{throw ["Could not find a match",__t102];}}}else{if(((f=__t101),true)){return f.call(type,value);}else{throw ["Could not find a match",__t101];}}};};(Array[":::project"]=function(__t106){var value;var __t105;(value=__t106);true;(__t105=__t106);var __t107=__t105;var _;if(___checker(Array)(__t107)){return [true,value];}else{if(((_=__t107),true)){return [true,[value]];}else{throw ["Could not find a match",__t107];}}});(Array.prototype["boink"]=function(){return this;});(Array.prototype["::check"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){return false;}else{null;}}return true;}else{return false;}});(Array.prototype[":::project"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){var rval=this.slice(0);rval.push(value);return [true,rval];}else{null;}}return [true,value];}else{var rval=this.slice(0);rval.push(value);return [true,rval];}});(Array.prototype[":::deconstruct"]=function(value){return value.slice(this.length);});(RegExp.prototype["::check"]=function(value){return value.match(this);});(RegExp.prototype[":::project"]=function(value){var __t108=value.match(this);var m;var m;if(((__t108===null)&&((m=__t108),true))){return [false,null];}else{if(((m=__t108),true)){return [true,m];}else{throw ["Could not find a match",__t108];}}});(RegExp.prototype[":::deconstruct"]=function(value){var __t109=value.match(this);var m;var m;if(((__t109===null)&&((m=__t109),true))){return [false,null];}else{if(((m=__t109),true)){return [true,m];}else{throw ["Could not find a match",__t109];}}});(Function.prototype["::send"]=function(args){return this.apply(this,args);});var ErrorFactory=function(tags){var __t87=function(){if((!___checker(ErrorFactory)(this))){return Object.create(ErrorFactory.prototype);}else{return this;}}();(__t87["tags"]=tags);return __t87;};augment(ErrorFactory,[]);(ErrorFactory.prototype["create"]=function(){var __t88=Array.prototype.slice.call(arguments,0);var __tp0;var message;var args;if(((__t88 instanceof Array)&&(((__tp0=__t88.length),true)&&((__tp0>=0)&&((message=function(){if((0>=__tp0)){return "";}else{return __t88[0];}}()),true,(args=__t88.slice(1)),true))))){var __t87=this;var e=Error(message);(e["::tags"]=__t87.tags);(e["args"]=args);(e["name"]=["E"].concat(__t87.tags).join("."));return e;}else{throw ["Could not find a match",__t88];}});(ErrorFactory.prototype["::check"]=function(e){var __t87=this;if(((!e)||(!___checker(Error)(e)))){return false;}else{null;}var tags=(e["::tags"]||[]);var __t89=__t87.tags;var __t90=__t89.length;for(var __t91=0;(__t91<__t90);(__t91++)){var __t92=__t89[__t91];var tag;var other;if(((tag=__t92),true,(tags.indexOf(tag)===(-1)))){return false;}else{if(((other=__t92),true)){false;}else{throw ["Could not find a match",__t92];}}}false;return true;});(ErrorFactory.prototype["::deconstruct"]=function(e){var __t87=this;return e.args;});ErrorFactory;
var eg=require("./earl-grey");var __t311=require("./pp");var __lt____gt__=__t311["<>"];var Node=__t311.Node;var __t312=require("./util");var enumerate=__t312.enumerate;var items=__t312.items;var fs=require("fs");var path=require("path");var vm=require("vm");var usage="\nusage:\n\nearl translate <file> [outfile]\n  Translate a source file, output to outfile. Without outfile\n  specified, print to standard out.\n\nearl translate <directory> <outdir>\n  Translate all the .eg files in the specified directory.\n\nearl run [file] [arguments...]\n  Run the specified file as a script.\n";var walk=function(dir,partial,f){var stats=fs.statSync(dir);if(stats.isDirectory()){f("dir",partial);var __t313=[];var __t314=fs.readdirSync(dir);var __t315=__t314.length;for(var __t316=0;(__t316<__t315);(__t316++)){var __t317=__t314[__t316];var file;var other;if(((file=__t317),true)){__t313.push(function(){var newdir=path.join(dir,file);var newpartial=path.join(partial,file);return walk(newdir,newpartial,f);}());}else{if(((other=__t317),true)){false;}else{throw ["Could not find a match",__t317];}}}return __t313;}else{return f("file",partial);}};var copy=function(src,dest){var data=fs.readFileSync(src,"binary");return fs.writeFileSync(dest,data,"binary");};var libdata=fs.readFileSync(path.join(__dirname,"lib.raw.js"));var run=function(__t318){var __t319=__t318;var __t321;var __t322;var __t320;var __tp0;var __tp1;var file;var __tp0;var __tp1;var file;var args;var __tp0;var __tp1;var s;var __tp0;var __tp1;var s;var __tp0;var __tp1;var data;var other;var __t323=false;var __t324=false;var __t325=false;if((((__t319 instanceof Array)&&(((__t320=__t319.length),true)&&(__t320===0)))||((__t319 instanceof Array)&&(((__t321=__t319.length),true)&&((__t321===1)&&((__t322=__t319[0]),(((__t322==="i")||(__t322==="in"))||(__t322==="interactive")))))))){var repl=require("repl");vm.runInThisContext(libdata,"stdin");var settings=({"prompt":"<> ","ignoreUndefined":true,"eval":function(input,context,filename,callback){var text=eg.generate(input.slice(1,(-1)));var result=function(){var __t327;try{(__t327=vm.runInThisContext(text,"stdin"));}catch(__t326){(__t327=function(){var __t328=__t326;var e;var ___exc;if(((e=__t328),true)){return console.log(e.stack);}else{if(((___exc=__t328),true)){throw ___exc;}else{throw ["Could not find a match",__t328];}}}());}return __t327;}();return callback(null,result);}});var run=repl.start(settings);return run.on("exit",function(){return run.outputStream.write("\n");});}else{if(((__t323=(__t319 instanceof Array))&&((__t324=((__tp0=__t319.length),true))&&((__tp0===2)&&(((__tp1=__t319[0]),(__tp1==="run"))&&((file=__t319[1]),true)))))){var data=fs.readFileSync(file,"utf8");var code=eg.generate(data,libdata);return eval(code);}else{if((__t324&&((__tp0>=2)&&(((__tp1=__t319[0]),((__tp1==="tr")||(__tp1==="translate")))&&((file=__t319[1]),true,(args=__t319.slice(2)),true))))){var out=args[0];var stats=fs.statSync(file);if(stats.isDirectory()){return walk(file,"/",function(){var __t330=Array.prototype.slice.call(arguments,0);var __tp0;var __t331;if(((__t330 instanceof Array)&&(((__tp0=__t330.length),true)&&((__tp0>=0)&&((__t331=__t330.slice(0)),true))))){var __t332=__t331;var __tp0;var __tp1;var d;var __tp0;var __tp1;var __t333;var __t334=false;var __t335=false;var __t336=false;if(((__t334=(__t332 instanceof Array))&&((__t335=((__tp0=__t332.length),true))&&((__t336=(__tp0===2))&&(((__tp1=__t332[0]),(__tp1==="dir"))&&((d=__t332[1]),true)))))){var from=path.join(file,d);var to=path.join(out,d);var __t338;try{(__t338=fs.mkdirSync(to));}catch(__t337){(__t338="ignore error");}return __t338;}else{if((__t336&&(((__tp1=__t332[0]),(__tp1==="file"))&&((__t333=__t332[1]),true)))){var __t339=__t333;var __tp0;var __tp1;var __tp2;var x;var name;var f;if((((__tp0=___projector(RegExp("(?:^((?:.*))\\.eg$)",""))(__t339)),__tp0[0])&&(((__tp1=__tp0[1]),(__tp1 instanceof Array))&&(((__tp2=__tp1.length),true)&&((__tp2===2)&&((x=__tp1[0]),true,(name=__tp1[1]),true)))))){var from=path.join(file,x);var to=path.join(out,(name+".js"));var data=fs.readFileSync(from,"utf8");return fs.writeFileSync(to,(eg.generate(data,function(){if(___checker(RegExp("(?:\\.raw\\.eg$)",""))(x)){return "";}else{return libdata;}}())+"\n"));}else{if(((f=__t339),true)){var from=path.join(file,f);var to=path.join(out,f);return copy(from,to);}else{throw ["Could not find a match",__t339];}}}else{throw ["Could not find a match",__t332];}}}else{throw ["Could not find a match",__t330];}});}else{if(out){var data=fs.readFileSync(file,"utf8");return fs.writeFileSync(out,(eg.generate(data,libdata)+"\n"));}else{if(true){var data=fs.readFileSync(file,"utf8");return console.log(eg.generate(data,""));}else{return false;}}}}else{if((__t324&&((__t325=(__tp0===2))&&(((__tp1=__t319[0]),(__tp1==="tok"))&&((s=__t319[1]),true))))){var __t340=[];var __t341=eg.tokenize(eg.Source(s,null));var __t342=__t341.length;for(var __t343=0;(__t343<__t342);(__t343++)){var __t344=__t341[__t343];var token;var other;if(((token=__t344),true)){__t340.push((__lt____gt__(null,token),__lt____gt__(null,token.location.ref()),__lt____gt__(null,token.location.highlight())));}else{if(((other=__t344),true)){false;}else{throw ["Could not find a match",__t344];}}}return __t340;}else{if((__t325&&(((__tp1=__t319[0]),(__tp1==="pa"))&&((s=__t319[1]),true)))){var walkloc=function(__t346){var node;var __t345;(node=__t346);true;(__t345=__t346);var __t347=__t345;var __tp0;var __tp1;var x;var __tp0;var __tp1;var x;var __tp0;var type;var args;var __t348=false;var __t349=false;var __t350=false;if(((__t348=(__t347 instanceof Array))&&((__t349=((__tp0=__t347.length),true))&&((__t350=(__tp0===2))&&(((__tp1=__t347[0]),(__tp1==="symbol"))&&((x=__t347[1]),true)))))){__lt____gt__(null,node);return __lt____gt__(null,(node.location&&node.location.highlight()));}else{if((__t350&&(((__tp1=__t347[0]),(__tp1==="value"))&&((x=__t347[1]),true)))){__lt____gt__(null,node);return __lt____gt__(null,(node.location&&node.location.highlight()));}else{if((__t349&&((__tp0>=1)&&((type=__t347[0]),true,(args=__t347.slice(1)),true)))){__lt____gt__(null,node);__lt____gt__(null,(node.location&&node.location.highlight()));var __t351=[];var __t352=args;var __t353=__t352.length;for(var __t354=0;(__t354<__t353);(__t354++)){var __t355=__t352[__t354];var arg;var other;if(((arg=__t355),true)){__t351.push(walkloc(arg));}else{if(((other=__t355),true)){false;}else{throw ["Could not find a match",__t355];}}}return __t351;}else{throw ["Could not find a match",__t347];}}}};return walkloc(function(){var tokens=eg.tokenize(eg.Source(s,null));return eg.parse(tokens);}());}else{if((__t325&&(((__tp1=__t319[0]),(__tp1==="runs"))&&((data=__t319[1]),true)))){var code=function(){var __t357;try{(__t357=eg.generate(data,libdata));}catch(__t356){(__t357=function(){var __t358=__t356;var e;var __tp0;var __tp1;var __tp2;var args;var ___exc;if((((e=__t358),true,___checker(ErrorFactory(["syntax"]))(__t358))&&(((__tp0=___deconstructor(ErrorFactory(["syntax"]))(__t358)),__tp0[0])&&(((__tp1=__tp0[1]),true,(__tp2=__tp1.length),true)&&((__tp2===1)&&((args=__tp1[0]),true)))))){__lt____gt__(null,Node(["+div"],[Node(["error_type"],e.name),Node(["error_message"],e.message)]));var hls=["hl1","hl2","hl3","hl4"];var locs=function(){var __t359=[];var __t360=enumerate(items(args));var __t361=__t360.length;for(var __t362=0;(__t362<__t361);(__t362++)){var __t363=__t360[__t362];var __tp0;var i;var __tp1;var __tp2;var key;var arg;var other;if(((__t363 instanceof Array)&&(((__tp0=__t363.length),true)&&((__tp0===2)&&(((i=__t363[0]),true,(__tp1=__t363[1]),(__tp1 instanceof Array))&&(((__tp2=__tp1.length),true)&&((__tp2===2)&&((key=__tp1[0]),true,(arg=__tp1[1]),true,arg.location)))))))){__t359.push([arg.location,send(hls,(i%4))]);}else{if(((other=__t363),true)){false;}else{throw ["Could not find a match",__t363];}}}return __t359;}();__lt____gt__(null,args);__lt____gt__(null,eg.highlight_locations(locs));return null;}else{if(((___exc=__t358),true)){throw ___exc;}else{throw ["Could not find a match",__t358];}}}());}return __t357;}();return (code&&__lt____gt__(null,eval(code)));}else{if(((other=__t319),true)){return console.log(usage);}else{throw ["Could not find a match",__t319];}}}}}}}};(exports["run"]=run);
