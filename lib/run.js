var patch_array=function(){var r=[];for(var i=0;(i<arguments.length);(i++)){(r=r.concat(arguments[i]));}return r;};var StructFactory=function(name){var make=function(){var r=Array.prototype.slice.call(arguments,0);(r["#"]=name);return r;};(make["___project"]=function(value){if(((value instanceof Array)&&(value["#"]===name))){return [true,value];}else{if(true){return [true,make(value)];}else{return false;}}});(make["___check"]=function(value){if(((value instanceof Array)&&(value["#"]===name))){return true;}else{if(true){return false;}else{return false;}}});(make["___deconstruct"]=function(value){if(((value instanceof Array)&&(value["#"]===name))){return [true,value.slice(0)];}else{if(true){return [false,false];}else{return false;}}});return make;};var Struct=function(name){var r=Array.prototype.slice.call(arguments,1);(r["#"]=name);return r;};(Struct["___check"]=function(value){if((value instanceof Array)){return (value["#"]!==undefined);}else{if(true){return false;}else{return false;}}});(Struct["___deconstruct"]=function(value){if(((value instanceof Array)&&(value["#"]!==undefined))){return [value["#"]].concat(value.slice(0));}else{if(true){throw "cannot deconstruct";}else{return false;}}});var pr=function(x){var r=repr(x);var pre=(String.fromCharCode(27)+"[?0;7y+h <div class=\"ug\">");var post=("</div>"+String.fromCharCode(7));return console.log(((pre+r)+post));};var __slash____slash____slash__=function(cls,contents){var τ357=contents;var other;if((typeof(τ357)==="string")){return (((("<span class=\""+cls)+"\">")+contents)+"</span>");}else{if(((other=τ357),true)){return (((("<span class=\""+cls)+"\">")+contents.join(""))+"</span>");}else{throw ["Could not find a match",τ357];}}};var repr=function(x){var τ358=x;var entries;if((τ358===true)){return __slash____slash____slash__("special",__slash____slash____slash__("true","true"));}else{if((τ358===false)){return __slash____slash____slash__("special",__slash____slash____slash__("false","false"));}else{if((τ358===null)){return __slash____slash____slash__("special",__slash____slash____slash__("nil","null"));}else{if((τ358===(void 0))){return __slash____slash____slash__("special",__slash____slash____slash__("nil","undefined"));}else{if((typeof(τ358)==="number")){return __slash____slash____slash__("num",String(x));}else{if((typeof(τ358)==="string")){return __slash____slash____slash__("str",x);}else{if(((entries=τ358),true)){var tag=entries["#"];var τ359=tag;var other;if((τ359===(void 0))){return __slash____slash____slash__("sequence",entries.map(function(x){return repr(x);}));}else{if(((other=τ359),true)){return __slash____slash____slash__("struct",[__slash____slash____slash__("sym",tag),__slash____slash____slash__("sequence",entries.map(function(x){return repr(x);}))]);}else{throw ["Could not find a match",τ359];}}}else{throw ["Could not find a match",τ358];}}}}}}}};var send=function(obj,msg){var τ360=msg;var other;if(((typeof(τ360)==="string")||(typeof(τ360)==="number"))){return obj[msg];}else{if(((other=τ360),true)){return obj.___send(msg);}else{throw ["Could not find a match",τ360];}}};(Function.prototype["___send"]=function(args){return this.apply(this,args);});var checker=function(type){var τ361=type.___check;var f;if((τ361===(void 0))){return function(value){return (value instanceof type);};}else{if(((f=τ361),true)){return function(value){return f.call(type,value);};}else{throw ["Could not find a match",τ361];}}};var projector=function(type){return function(value){var τ362=type.___project;var f;if((τ362===(void 0))){if((value instanceof type)){return [true,value];}else{if(true){return [false,null];}else{return false;}}}else{if(((f=τ362),true)){return f.call(type,value);}else{throw ["Could not find a match",τ362];}}};};var deconstructor=function(type){return function(value){var τ363=type.___deconstruct;var f;if((τ363===(void 0))){if((value instanceof Array)){return [true,value];}else{if(true){return [false,null];}else{return false;}}}else{if(((f=τ363),true)){return f.call(this,value);}else{throw ["Could not find a match",τ363];}}};};(Array["___project"]=function(value){var τ364=value;if(checker(Array)(τ364)){return [true,value];}else{if(true){return [true,[value]];}else{throw ["Could not find a match",τ364];}}});(RegExp.prototype["___check"]=function(value){return value.match(this);});(RegExp.prototype["___project"]=function(value){var τ365=value.match(this);var m;var m;if(((τ365===null)&&((m=τ365),true))){return [false,null];}else{if(((m=τ365),true)){return [true,m];}else{throw ["Could not find a match",τ365];}}});
var eg=require("./earl-grey");var fs=require("fs");var path=require("path");var vm=require("vm");var usage="\nusage:\n\nearl translate <file> [outfile]\n  Translate a source file, output to outfile. Without outfile\n  specified, print to standard out.\n\nearl translate <directory> <outdir>\n  Translate all the .eg files in the specified directory.\n\nearl run [file] [arguments...]\n  Run the specified file as a script.\n";var libdata=fs.readFileSync(path.join(__dirname,"lib.raw.js"));var run=function(τ366){var τ367=τ366;var τ369;var τ370;var τ368;var τp0;var τp1;var file;var τp0;var τp1;var file;var args;var other;var τ371;var τ372;var τ373;if((((τ367 instanceof Array)&&((τ367["#"]===(void 0))&&(((τ368=τ367.length),true)&&(τ368===0))))||((τ367 instanceof Array)&&((τ367["#"]===(void 0))&&(((τ369=τ367.length),true)&&((τ369===1)&&((τ370=τ367[0]),(((τ370==="i")||(τ370==="in"))||(τ370==="interactive"))))))))){var repl=require("repl");var ctx=vm.createContext(global);vm.runInContext(libdata,ctx,"stdin");var settings=({"prompt":"<> ","ignoreUndefined":true,"eval":function(input,context,filename,callback){var text=eg.generate(input.slice(1,(-1)));var result=function(){var τ375;try{(τ375=vm.runInContext(text,ctx,"stdin"));}catch(τ374){(τ375=function(){var τ376=τ374;var e;var ___exc;if(((e=τ376),true)){return console.log(e.stack);}else{if(((___exc=τ376),true)){throw ___exc;}else{throw ["Could not find a match",τ376];}}}());}return τ375;}();return callback(null,result);}});var run=repl.start(settings);return run.on("exit",function(){return run.outputStream.write("\n");});}else{if(((τ371=(τ367 instanceof Array))&&((τ372=(τ367["#"]===(void 0)))&&((τ373=((τp0=τ367.length),true))&&((τp0===2)&&(((τp1=τ367[0]),(τp1==="run"))&&((file=τ367[1]),true))))))){var data=fs.readFileSync(file,"utf8");var code=eg.generate(data,libdata);return eval(code);}else{if((τ373&&((τp0>=2)&&(((τp1=τ367[0]),((τp1==="tr")||(τp1==="translate")))&&((file=τ367[1]),true,(args=τ367.slice(2)),true))))){var out=args[0];var stats=fs.statSync(file);if(stats.isDirectory()){var d=fs.readdirSync(file);if((!fs.existsSync(out))){fs.mkdirSync(out);}else{false;}return d.forEach(function(x){if(x.match(RegExp("(?:\\.eg$)"))){var data=fs.readFileSync(path.join(file,x),"utf8");var outfile=path.join(out,x.replace(".eg",".js"));return fs.writeFileSync(outfile,function(){var prelude=function(){if(x.match(RegExp("(?:\\.raw\\.eg$)"))){return "";}else{if(true){return libdata;}else{return false;}}}();return (eg.generate(data,prelude)+"\n");}());}else{return false;}});}else{if(out){var data=fs.readFileSync(file,"utf8");return fs.writeFileSync(out,(eg.generate(data,libdata)+"\n"));}else{if(true){var data=fs.readFileSync(file,"utf8");return console.log(eg.generate(data,""));}else{return false;}}}}else{if(((other=τ367),true)){return console.log(usage);}else{throw ["Could not find a match",τ367];}}}}};(exports["run"]=run);
