var τ1149=function(type){var τ1150=type["::check"];var f;if((τ1150===(void 0))){return function(value){return (value instanceof type);};}else{if(((f=τ1150),true)){return function(value){return f.call(type,value);};}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1150}));}}};
var τ1151=function(dest,values){for(k in values){if(values.hasOwnProperty(k)){(dest[k]=send(values,k));}else{null;}}return dest;};
var τ1141=function(){var τ1142=function(tags){var τ1143=function(){if((!τ1149(τ1142)(this))){return Object.create(τ1142.prototype);}else{return this;}}();(τ1143["tags"]=tags);return τ1143;};τ1151(τ1142);(τ1142.prototype["create"]=function(){var τ1144=Array.prototype.slice.call(arguments,0);var τp0;var message;var args;if(((τ1144 instanceof Array)&&(((τp0=τ1144.length),true)&&((τp0>=0)&&((message=function(){if((0>=τp0)){return "";}else{return τ1144[0];}}()),true,(args=τ1144.slice(1)),true))))){var τ1143=this;var e=Error(message);(e["::tags"]=τ1143.tags);(e["args"]=args);(e["name"]=["E"].concat(τ1143.tags).join("."));return e;}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1144}));}});(τ1142.prototype["::check"]=function(e){var τ1143=this;if(((!e)||(!τ1149(Error)(e)))){return false;}else{null;}var tags=(e["::tags"]||[]);var τ1145=τ1143.tags;var τ1146=τ1145.length;for(var τ1147=0;(τ1147<τ1146);(τ1147++)){var τ1148=τ1145[τ1147];var tag;var other;if(((tag=τ1148),true,(tags.indexOf(tag)===(-1)))){return false;}else{if(((other=τ1148),true)){false;}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1148}));}}}false;return true;});(τ1142.prototype["::deconstruct"]=function(e){var τ1143=this;return e.args;});return τ1142;}();
var τ1152=function(){var r=[];for(var i=0;(i<arguments.length);(i++)){(r=r.concat(arguments[i]));}return r;};
var τ1153=function(τ1154){var τ1155=τ1154;var x;var x;var other;if((((typeof(τ1155)==="string")&&((x=τ1155),true))||((typeof(τ1155)==="number")&&((x=τ1155),true)))){return ["value",x];}else{if(((other=τ1155),true)){return other["::serialize_ast"]();}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1155}));}}};
var send=function(obj,τ1134){var msg;var τ1133;(msg=τ1134);true;(τ1133=τ1134);var τ1135=τ1133;var other;if(((typeof(τ1135)==="string")||(typeof(τ1135)==="number"))){return obj[msg];}else{if(((other=τ1135),true)){return obj["::send"](msg);}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1135}));}}};(Array[":::project"]=function(τ1137){var value;var τ1136;(value=τ1137);true;(τ1136=τ1137);var τ1138=τ1136;var _;if(τ1149(Array)(τ1138)){return [true,value];}else{if(((_=τ1138),true)){return [true,[value]];}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1138}));}}});(Array.prototype["::check"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){return false;}else{null;}}return true;}else{return false;}});(Array.prototype[":::project"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){var rval=this.slice(0);rval.push(value);return [true,rval];}else{null;}}return [true,value];}else{var rval=this.slice(0);rval.push(value);return [true,rval];}});(Array.prototype[":::deconstruct"]=function(value){return [true,value.slice(this.length)];});(Array.prototype["::serialize_ast"]=function(){return τ1152(["array"],this.map(τ1153));});(RegExp.prototype["::check"]=function(value){return value.match(this);});(RegExp.prototype[":::project"]=function(value){var τ1139=value.match(this);var m;var m;if(((τ1139===null)&&((m=τ1139),true))){return [false,null];}else{if(((m=τ1139),true)){return [true,m];}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1139}));}}});(RegExp.prototype[":::deconstruct"]=function(value){var τ1140=value.match(this);var m;var m;if(((τ1140===null)&&((m=τ1140),true))){return [false,null];}else{if(((m=τ1140),true)){return [true,m];}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1140}));}}});(Function.prototype["::send"]=function(args){return this.apply(this,args);});
var τ1207=function(type){return function(value){var τ1208=type[":::deconstruct"];var f;if((τ1208===(void 0))){var τ1209=type["::deconstruct"];var f;if((τ1209===(void 0))){if((value instanceof Array)){return [true,value];}else{if(true){return [false,null];}else{return false;}}}else{if(((f=τ1209),true)){var τ1211;try{(τ1211=[true,f.call(type,value)]);}catch(τ1210){(τ1211=[false,null]);}return τ1211;}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1209}));}}}else{if(((f=τ1208),true)){return f.call(type,value);}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1208}));}}};};var eg=require("./earl-grey");var τ1156=require("./pp");var __lt____gt__=τ1156["<>"];var Node=τ1156.Node;var τ1157=require("./util");var enumerate=τ1157.enumerate;var items=τ1157.items;var τ1158=require("./location");var Source=τ1158.Source;var display_error=τ1158.display_error;var fs=require("fs");var path=require("path");var vm=require("vm");var usage="\nusage:\n\nearl translate <file> [outfile]\n  Translate a source file, output to outfile. Without outfile\n  specified, print to standard out.\n\nearl translate <directory> <outdir>\n  Translate all the .eg files in the specified directory.\n\nearl run [file] [arguments...]\n  Run the specified file as a script.\n";var walk=function(dir,partial,f){var stats=fs.statSync(dir);if(stats.isDirectory()){f("dir",partial);var τ1159=[];var τ1160=fs.readdirSync(dir);var τ1161=τ1160.length;for(var τ1162=0;(τ1162<τ1161);(τ1162++)){var τ1163=τ1160[τ1162];var file;var other;if(((file=τ1163),true)){τ1159.push(function(){var newdir=path.join(dir,file);var newpartial=path.join(partial,file);return walk(newdir,newpartial,f);}());}else{if(((other=τ1163),true)){false;}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1163}));}}}return τ1159;}else{return f("file",partial);}};var copy=function(src,dest){var data=fs.readFileSync(src,"binary");return fs.writeFileSync(dest,data,"binary");};var gen=function(text,file){var g=eg.Generator();return g.generate(Source(text,path.resolve(file)));};var run=function(cmd){var τ1165;try{(τ1165=_run(cmd));}catch(τ1164){(τ1165=function(){var τ1166=τ1164;var e;var ___exc;if(((e=τ1166),true)){display_error(e);return process.exit(1);}else{if(((___exc=τ1166),true)){throw ___exc;}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1166}));}}}());}return τ1165;};var _run=function(τ1167){var τ1168=τ1167;var τ1170;var τ1171;var τ1169;var τp0;var τp1;var file;var τp0;var τp1;var file;var args;var τp0;var τp1;var s;var τp0;var τp1;var s;var τp0;var τp1;var file;var τp0;var τp1;var s;var τp0;var τp1;var data;var other;var τ1172=false;var τ1173=false;var τ1174=false;if((((τ1168 instanceof Array)&&(((τ1169=τ1168.length),true)&&(τ1169===0)))||((τ1168 instanceof Array)&&(((τ1170=τ1168.length),true)&&((τ1170===1)&&((τ1171=τ1168[0]),(((τ1171==="i")||(τ1171==="in"))||(τ1171==="interactive")))))))){var repl=require("repl");var settings=({"prompt":"<> ","ignoreUndefined":true,"eval":function(input,context,filename,callback){var g=eg.Generator();var result=function(){var execute=function(){var text=g.generate(Source(input.slice(1,(-1)),"<interactive>"));return vm.runInThisContext(text,"stdin");};var handle=function(e){display_error(e);return undefined;};var τ1176;try{(τ1176=execute());}catch(τ1175){(τ1176=function(){var τ1177=τ1175;var e;var ___exc;if(((e=τ1177),true)){return handle(e);}else{if(((___exc=τ1177),true)){throw ___exc;}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1177}));}}}());}return τ1176;}();return callback(null,result);}});var run=repl.start(settings);return run.on("exit",function(){return run.outputStream.write("\n");});}else{if(((τ1172=(τ1168 instanceof Array))&&((τ1173=((τp0=τ1168.length),true))&&((τp0===2)&&(((τp1=τ1168[0]),(τp1==="run"))&&((file=τ1168[1]),true)))))){var data=fs.readFileSync(file,"utf8");return eval(gen(data,file));}else{if((τ1173&&((τp0>=2)&&(((τp1=τ1168[0]),((τp1==="tr")||(τp1==="translate")))&&((file=τ1168[1]),true,(args=τ1168.slice(2)),true))))){var out=args[0];var stats=fs.statSync(file);var τ1178=null;var otherwise;if(stats.isDirectory()){return walk(file,"/",function(){var τ1180=Array.prototype.slice.call(arguments,0);var τp0;var τ1181;if(((τ1180 instanceof Array)&&(((τp0=τ1180.length),true)&&((τp0>=0)&&((τ1181=τ1180.slice(0)),true))))){var τ1182=τ1181;var τp0;var τp1;var d;var τp0;var τp1;var τ1183;var τ1184=false;var τ1185=false;var τ1186=false;if(((τ1184=(τ1182 instanceof Array))&&((τ1185=((τp0=τ1182.length),true))&&((τ1186=(τp0===2))&&(((τp1=τ1182[0]),(τp1==="dir"))&&((d=τ1182[1]),true)))))){var from=path.join(file,d);var to=path.join(out,d);var τ1188;try{(τ1188=fs.mkdirSync(to));}catch(τ1187){(τ1188="ignore error");}return τ1188;}else{if((τ1186&&(((τp1=τ1182[0]),(τp1==="file"))&&((τ1183=τ1182[1]),true)))){var τ1189=τ1183;var τp0;var τp1;var τp2;var x;var name;var f;if((τ1149(RegExp("(?:^((?:.*))\\.eg$)",""))(τ1189)&&(((τp0=τ1207(RegExp("(?:^((?:.*))\\.eg$)",""))(τ1189)),τp0[0])&&(((τp1=τp0[1]),true,(τp2=τp1.length),true)&&((τp2===2)&&((x=τp1[0]),true,(name=τp1[1]),true)))))){var from=path.join(file,x);var to=path.join(out,(name+".js"));var data=fs.readFileSync(from,"utf8");return fs.writeFileSync(to,(gen(data,from)+"\n"));}else{if(((f=τ1189),true)){var from=path.join(file,f);var to=path.join(out,f);return copy(from,to);}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1189}));}}}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1182}));}}}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1180}));}});}else{if(out){var data=fs.readFileSync(file,"utf8");return fs.writeFileSync(out,(gen(data,file)+"\n"));}else{if(((otherwise=τ1178),true)){var data=fs.readFileSync(file,"utf8");return console.log(gen(data,file));}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1178}));}}}}else{if((τ1173&&((τ1174=(τp0===2))&&(((τp1=τ1168[0]),(τp1==="tok"))&&((s=τ1168[1]),true))))){var τ1190=[];var τ1191=eg.tokenize(Source(s,null));var τ1192=τ1191.length;for(var τ1193=0;(τ1193<τ1192);(τ1193++)){var τ1194=τ1191[τ1193];var token;var other;if(((token=τ1194),true)){τ1190.push((__lt____gt__(null,token),__lt____gt__(null,token.location.ref()),__lt____gt__(null,token.location.highlight())));}else{if(((other=τ1194),true)){false;}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1194}));}}}return τ1190;}else{if((τ1174&&(((τp1=τ1168[0]),(τp1==="pa"))&&((s=τ1168[1]),true)))){var walkloc=function(τ1196){var node;var τ1195;(node=τ1196);true;(τ1195=τ1196);var τ1197=τ1195;var τp0;var τp1;var x;var τp0;var τp1;var x;var τp0;var type;var args;var τ1198=false;var τ1199=false;var τ1200=false;if(((τ1198=(τ1197 instanceof Array))&&((τ1199=((τp0=τ1197.length),true))&&((τ1200=(τp0===2))&&(((τp1=τ1197[0]),(τp1==="symbol"))&&((x=τ1197[1]),true)))))){__lt____gt__(null,node);return __lt____gt__(null,(node.location&&node.location.highlight()));}else{if((τ1200&&(((τp1=τ1197[0]),(τp1==="value"))&&((x=τ1197[1]),true)))){__lt____gt__(null,node);return __lt____gt__(null,(node.location&&node.location.highlight()));}else{if((τ1199&&((τp0>=1)&&((type=τ1197[0]),true,(args=τ1197.slice(1)),true)))){__lt____gt__(null,node);__lt____gt__(null,(node.location&&node.location.highlight()));var τ1201=[];var τ1202=args;var τ1203=τ1202.length;for(var τ1204=0;(τ1204<τ1203);(τ1204++)){var τ1205=τ1202[τ1204];var arg;var other;if(((arg=τ1205),true)){τ1201.push(walkloc(arg));}else{if(((other=τ1205),true)){false;}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1205}));}}}return τ1201;}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1197}));}}}};return walkloc(function(){var tokens=eg.tokenize(Source(s,null));return eg.parse(tokens);}());}else{if((τ1174&&(((τp1=τ1168[0]),(τp1==="test"))&&((file=τ1168[1]),true)))){var τ1206=require("js-beautify");var beaut=τ1206.js;var data=fs.readFileSync(file,"utf8");var code=eg["generate2"](Source(data,"<test>"));console.log(beaut(code));return __lt____gt__(null,eval(code));}else{if((τ1174&&(((τp1=τ1168[0]),(τp1==="tests"))&&((s=τ1168[1]),true)))){var code=eg["generate2"](Source(s,"<test>"));console.log(code);return __lt____gt__(null,eval(code));}else{if((τ1174&&(((τp1=τ1168[0]),(τp1==="runs"))&&((data=τ1168[1]),true)))){return __lt____gt__(null,eval(gen(data,"<command>")));}else{if(((other=τ1168),true)){return console.log(usage);}else{throw τ1141(["match"]).create("Could not find a match",({"value":τ1168}));}}}}}}}}}};(exports["run"]=run);
