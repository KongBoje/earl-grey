var τ990=function(type){var τ991=type["::check"];var f;if((τ991===(void 0))){return function(value){return (value instanceof type);};}else{if(((f=τ991),true)){return function(value){return f.call(type,value);};}else{throw τ982(["match"]).create("Could not find a match",({"value":τ991}));}}};
var τ992=function(dest,values){for(k in values){if(values.hasOwnProperty(k)){(dest[k]=send(values,k));}else{null;}}return dest;};
var τ982=function(){var τ983=function(tags){var τ984=function(){if((!τ990(τ983)(this))){return Object.create(τ983.prototype);}else{return this;}}();(τ984["tags"]=tags);return τ984;};τ992(τ983);(τ983.prototype["create"]=function(){var τ985=Array.prototype.slice.call(arguments,0);var τp0;var message;var args;if(((τ985 instanceof Array)&&(((τp0=τ985.length),true)&&((τp0>=0)&&((message=function(){if((0>=τp0)){return "";}else{return τ985[0];}}()),true,(args=τ985.slice(1)),true))))){var τ984=this;var e=Error(message);(e["::tags"]=τ984.tags);(e["args"]=args);(e["name"]=["E"].concat(τ984.tags).join("."));return e;}else{throw τ982(["match"]).create("Could not find a match",({"value":τ985}));}});(τ983.prototype["::check"]=function(e){var τ984=this;if(((!e)||(!τ990(Error)(e)))){return false;}else{null;}var tags=(e["::tags"]||[]);var τ986=τ984.tags;var τ987=τ986.length;for(var τ988=0;(τ988<τ987);(τ988++)){var τ989=τ986[τ988];var tag;var other;if(((tag=τ989),true,(tags.indexOf(tag)===(-1)))){return false;}else{if(((other=τ989),true)){false;}else{throw τ982(["match"]).create("Could not find a match",({"value":τ989}));}}}false;return true;});(τ983.prototype["::deconstruct"]=function(e){var τ984=this;return e.args;});return τ983;}();
var τ993=function(){var r=[];for(var i=0;(i<arguments.length);(i++)){(r=r.concat(arguments[i]));}return r;};
var τ994=function(τ995){var τ996=τ995;var x;var x;var other;if((((typeof(τ996)==="string")&&((x=τ996),true))||((typeof(τ996)==="number")&&((x=τ996),true)))){return ["value",x];}else{if(((other=τ996),true)){return other["::serialize_ast"]();}else{throw τ982(["match"]).create("Could not find a match",({"value":τ996}));}}};
var send=function(obj,τ975){var msg;var τ974;(msg=τ975);true;(τ974=τ975);var τ976=τ974;var other;if(((typeof(τ976)==="string")||(typeof(τ976)==="number"))){return obj[msg];}else{if(((other=τ976),true)){return obj["::send"](msg);}else{throw τ982(["match"]).create("Could not find a match",({"value":τ976}));}}};(Array[":::project"]=function(τ978){var value;var τ977;(value=τ978);true;(τ977=τ978);var τ979=τ977;var _;if(τ990(Array)(τ979)){return [true,value];}else{if(((_=τ979),true)){return [true,[value]];}else{throw τ982(["match"]).create("Could not find a match",({"value":τ979}));}}});(Array.prototype["::check"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){return false;}else{null;}}return true;}else{return false;}});(Array.prototype[":::project"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){var rval=this.slice(0);rval.push(value);return [true,rval];}else{null;}}return [true,value];}else{var rval=this.slice(0);rval.push(value);return [true,rval];}});(Array.prototype[":::deconstruct"]=function(value){return [true,value.slice(this.length)];});(Array.prototype["::serialize_ast"]=function(){return τ993(["array"],this.map(τ994));});(RegExp.prototype["::check"]=function(value){return value.match(this);});(RegExp.prototype[":::project"]=function(value){var τ980=value.match(this);var m;var m;if(((τ980===null)&&((m=τ980),true))){return [false,null];}else{if(((m=τ980),true)){return [true,m];}else{throw τ982(["match"]).create("Could not find a match",({"value":τ980}));}}});(RegExp.prototype[":::deconstruct"]=function(value){var τ981=value.match(this);var m;var m;if(((τ981===null)&&((m=τ981),true))){return [false,null];}else{if(((m=τ981),true)){return [true,m];}else{throw τ982(["match"]).create("Could not find a match",({"value":τ981}));}}});(Function.prototype["::send"]=function(args){return this.apply(this,args);});
var τ1064=function(type){return function(value){var τ1065=type[":::deconstruct"];var f;if((τ1065===(void 0))){var τ1066=type["::deconstruct"];var f;if((τ1066===(void 0))){if((value instanceof Array)){return [true,value];}else{if(true){return [false,null];}else{return false;}}}else{if(((f=τ1066),true)){var τ1068;try{(τ1068=[true,f.call(type,value)]);}catch(τ1067){(τ1068=[false,null]);}return τ1068;}else{throw τ982(["match"]).create("Could not find a match",({"value":τ1066}));}}}else{if(((f=τ1065),true)){return f.call(type,value);}else{throw τ982(["match"]).create("Could not find a match",({"value":τ1065}));}}};};var eg=require("./earl-grey");var τ997=require("./pp");var __lt____gt__=τ997["<>"];var Node=τ997.Node;var τ998=require("./util");var enumerate=τ998.enumerate;var items=τ998.items;var τ999=require("./location");var Source=τ999.Source;var display_error=τ999.display_error;var fs=require("fs");var path=require("path");var vm=require("vm");var usage="\nusage:\n\nearl translate <file> [outfile]\n  Translate a source file, output to outfile. Without outfile\n  specified, print to standard out.\n\nearl translate <directory> <outdir>\n  Translate all the .eg files in the specified directory.\n\nearl run [file] [arguments...]\n  Run the specified file as a script.\n";var walk=function(dir,partial,f){var stats=fs.statSync(dir);if(stats.isDirectory()){f("dir",partial);var τ1000=[];var τ1001=fs.readdirSync(dir);var τ1002=τ1001.length;for(var τ1003=0;(τ1003<τ1002);(τ1003++)){var τ1004=τ1001[τ1003];var file;var other;if(((file=τ1004),true)){τ1000.push(function(){var newdir=path.join(dir,file);var newpartial=path.join(partial,file);return walk(newdir,newpartial,f);}());}else{if(((other=τ1004),true)){false;}else{throw τ982(["match"]).create("Could not find a match",({"value":τ1004}));}}}return τ1000;}else{return f("file",partial);}};var copy=function(src,dest){var data=fs.readFileSync(src,"binary");return fs.writeFileSync(dest,data,"binary");};var gen=function(text,file){var g=eg.Generator();return g.generate(Source(text,path.resolve(file)));};var gen2=function(text,file){var g=eg["Generator2"]();return g.generate(Source(text,path.resolve(file)));};var run=function(cmd){var τ1006;try{(τ1006=_run(cmd));}catch(τ1005){(τ1006=function(){var τ1007=τ1005;var e;var ___exc;if(((e=τ1007),true)){display_error(e);return process.exit(1);}else{if(((___exc=τ1007),true)){throw ___exc;}else{throw τ982(["match"]).create("Could not find a match",({"value":τ1007}));}}}());}return τ1006;};var _run=function(τ1008){var τ1009=τ1008;var τ1011;var τ1012;var τ1010;var τp0;var τp1;var file;var τp0;var τp1;var file;var args;var τp0;var τp1;var file;var args;var τp0;var τp1;var s;var τp0;var τp1;var s;var τp0;var τp1;var file;var τp0;var τp1;var file;var τp0;var τp1;var s;var τp0;var τp1;var data;var other;var τ1013=false;var τ1014=false;var τ1015=false;if((((τ1009 instanceof Array)&&(((τ1010=τ1009.length),true)&&(τ1010===0)))||((τ1009 instanceof Array)&&(((τ1011=τ1009.length),true)&&((τ1011===1)&&((τ1012=τ1009[0]),(((τ1012==="i")||(τ1012==="in"))||(τ1012==="interactive")))))))){var repl=require("repl");var settings=({"prompt":"<> ","ignoreUndefined":true,"eval":function(input,context,filename,callback){var g=eg.Generator();var result=function(){var execute=function(){var text=g.generate(Source(input.slice(1,(-1)),"<interactive>"));return vm.runInThisContext(text,"stdin");};var handle=function(e){display_error(e);return undefined;};var τ1017;try{(τ1017=execute());}catch(τ1016){(τ1017=function(){var τ1018=τ1016;var e;var ___exc;if(((e=τ1018),true)){return handle(e);}else{if(((___exc=τ1018),true)){throw ___exc;}else{throw τ982(["match"]).create("Could not find a match",({"value":τ1018}));}}}());}return τ1017;}();return callback(null,result);}});var run=repl.start(settings);return run.on("exit",function(){return run.outputStream.write("\n");});}else{if(((τ1013=(τ1009 instanceof Array))&&((τ1014=((τp0=τ1009.length),true))&&((τp0===2)&&(((τp1=τ1009[0]),(τp1==="run"))&&((file=τ1009[1]),true)))))){var data=fs.readFileSync(file,"utf8");return eval(gen(data,file));}else{if((τ1014&&((τ1015=(τp0>=2))&&(((τp1=τ1009[0]),((τp1==="tr")||(τp1==="translate")))&&((file=τ1009[1]),true,(args=τ1009.slice(2)),true))))){var out=args[0];var stats=fs.statSync(file);var τ1019=null;var otherwise;if(stats.isDirectory()){return walk(file,"/",function(){var τ1021=Array.prototype.slice.call(arguments,0);var τp0;var τ1022;if(((τ1021 instanceof Array)&&(((τp0=τ1021.length),true)&&((τp0>=0)&&((τ1022=τ1021.slice(0)),true))))){var τ1023=τ1022;var τp0;var τp1;var d;var τp0;var τp1;var τ1024;var τ1025=false;var τ1026=false;var τ1027=false;if(((τ1025=(τ1023 instanceof Array))&&((τ1026=((τp0=τ1023.length),true))&&((τ1027=(τp0===2))&&(((τp1=τ1023[0]),(τp1==="dir"))&&((d=τ1023[1]),true)))))){var from=path.join(file,d);var to=path.join(out,d);var τ1029;try{(τ1029=fs.mkdirSync(to));}catch(τ1028){(τ1029=function(){var τ1030=τ1028;var e;var ___exc;if(((e=τ1030),true)){return "ignore error";}else{if(((___exc=τ1030),true)){throw ___exc;}else{throw τ982(["match"]).create("Could not find a match",({"value":τ1030}));}}}());}return τ1029;}else{if((τ1027&&(((τp1=τ1023[0]),(τp1==="file"))&&((τ1024=τ1023[1]),true)))){var τ1031=τ1024;var τp0;var τp1;var τp2;var x;var name;var f;if((τ990(RegExp("(?:^((?:.*))\\.eg$)",""))(τ1031)&&(((τp0=τ1064(RegExp("(?:^((?:.*))\\.eg$)",""))(τ1031)),τp0[0])&&(((τp1=τp0[1]),true,(τp2=τp1.length),true)&&((τp2===2)&&((x=τp1[0]),true,(name=τp1[1]),true)))))){var from=path.join(file,x);var to=path.join(out,(name+".js"));var data=fs.readFileSync(from,"utf8");return fs.writeFileSync(to,(gen(data,from)+"\n"));}else{if(((f=τ1031),true)){var from=path.join(file,f);var to=path.join(out,f);return copy(from,to);}else{throw τ982(["match"]).create("Could not find a match",({"value":τ1031}));}}}else{throw τ982(["match"]).create("Could not find a match",({"value":τ1023}));}}}else{throw τ982(["match"]).create("Could not find a match",({"value":τ1021}));}});}else{if(out){var data=fs.readFileSync(file,"utf8");return fs.writeFileSync(out,(gen(data,file)+"\n"));}else{if(((otherwise=τ1019),true)){var data=fs.readFileSync(file,"utf8");return console.log(gen(data,file));}else{throw τ982(["match"]).create("Could not find a match",({"value":τ1019}));}}}}else{if((τ1015&&(((τp1=τ1009[0]),((τp1==="tr2")||(τp1==="translate2")))&&((file=τ1009[1]),true,(args=τ1009.slice(2)),true)))){var out=args[0];var stats=fs.statSync(file);var τ1032=null;var otherwise;if(stats.isDirectory()){return walk(file,"/",function(){var τ1034=Array.prototype.slice.call(arguments,0);var τp0;var τ1035;if(((τ1034 instanceof Array)&&(((τp0=τ1034.length),true)&&((τp0>=0)&&((τ1035=τ1034.slice(0)),true))))){var τ1036=τ1035;var τp0;var τp1;var d;var τp0;var τp1;var τ1037;var τ1038=false;var τ1039=false;var τ1040=false;if(((τ1038=(τ1036 instanceof Array))&&((τ1039=((τp0=τ1036.length),true))&&((τ1040=(τp0===2))&&(((τp1=τ1036[0]),(τp1==="dir"))&&((d=τ1036[1]),true)))))){var from=path.join(file,d);var to=path.join(out,d);var τ1042;try{(τ1042=fs.mkdirSync(to));}catch(τ1041){(τ1042=function(){var τ1043=τ1041;var e;var ___exc;if(((e=τ1043),true)){return "ignore error";}else{if(((___exc=τ1043),true)){throw ___exc;}else{throw τ982(["match"]).create("Could not find a match",({"value":τ1043}));}}}());}return τ1042;}else{if((τ1040&&(((τp1=τ1036[0]),(τp1==="file"))&&((τ1037=τ1036[1]),true)))){var τ1044=τ1037;var τp0;var τp1;var τp2;var x;var name;var f;if((τ990(RegExp("(?:^((?:.*))\\.eg$)",""))(τ1044)&&(((τp0=τ1064(RegExp("(?:^((?:.*))\\.eg$)",""))(τ1044)),τp0[0])&&(((τp1=τp0[1]),true,(τp2=τp1.length),true)&&((τp2===2)&&((x=τp1[0]),true,(name=τp1[1]),true)))))){var from=path.join(file,x);var to=path.join(out,(name+".js"));var data=fs.readFileSync(from,"utf8");return fs.writeFileSync(to,(gen2(data,from)+"\n"));}else{if(((f=τ1044),true)){var from=path.join(file,f);var to=path.join(out,f);return copy(from,to);}else{throw τ982(["match"]).create("Could not find a match",({"value":τ1044}));}}}else{throw τ982(["match"]).create("Could not find a match",({"value":τ1036}));}}}else{throw τ982(["match"]).create("Could not find a match",({"value":τ1034}));}});}else{if(out){var data=fs.readFileSync(file,"utf8");return fs.writeFileSync(out,(gen2(data,file)+"\n"));}else{if(((otherwise=τ1032),true)){var data=fs.readFileSync(file,"utf8");return console.log(gen2(data,file));}else{throw τ982(["match"]).create("Could not find a match",({"value":τ1032}));}}}}else{if((τ1014&&((τ1015=(τp0===2))&&(((τp1=τ1009[0]),(τp1==="tok"))&&((s=τ1009[1]),true))))){var τ1045=[];var τ1046=eg.tokenize(Source(s,null));var τ1047=τ1046.length;for(var τ1048=0;(τ1048<τ1047);(τ1048++)){var τ1049=τ1046[τ1048];var token;var other;if(((token=τ1049),true)){τ1045.push((__lt____gt__(null,token),__lt____gt__(null,token.location.ref()),__lt____gt__(null,token.location.highlight())));}else{if(((other=τ1049),true)){false;}else{throw τ982(["match"]).create("Could not find a match",({"value":τ1049}));}}}return τ1045;}else{if((τ1015&&(((τp1=τ1009[0]),(τp1==="pa"))&&((s=τ1009[1]),true)))){var walkloc=function(τ1051){var node;var τ1050;(node=τ1051);true;(τ1050=τ1051);var τ1052=τ1050;var τp0;var τp1;var x;var τp0;var τp1;var x;var τp0;var type;var args;var τ1053=false;var τ1054=false;var τ1055=false;if(((τ1053=(τ1052 instanceof Array))&&((τ1054=((τp0=τ1052.length),true))&&((τ1055=(τp0===2))&&(((τp1=τ1052[0]),(τp1==="symbol"))&&((x=τ1052[1]),true)))))){__lt____gt__(null,node);return __lt____gt__(null,(node.location&&node.location.highlight()));}else{if((τ1055&&(((τp1=τ1052[0]),(τp1==="value"))&&((x=τ1052[1]),true)))){__lt____gt__(null,node);return __lt____gt__(null,(node.location&&node.location.highlight()));}else{if((τ1054&&((τp0>=1)&&((type=τ1052[0]),true,(args=τ1052.slice(1)),true)))){__lt____gt__(null,node);__lt____gt__(null,(node.location&&node.location.highlight()));var τ1056=[];var τ1057=args;var τ1058=τ1057.length;for(var τ1059=0;(τ1059<τ1058);(τ1059++)){var τ1060=τ1057[τ1059];var arg;var other;if(((arg=τ1060),true)){τ1056.push(walkloc(arg));}else{if(((other=τ1060),true)){false;}else{throw τ982(["match"]).create("Could not find a match",({"value":τ1060}));}}}return τ1056;}else{throw τ982(["match"]).create("Could not find a match",({"value":τ1052}));}}}};return walkloc(function(){var tokens=eg.tokenize(Source(s,null));return eg.parse(tokens);}());}else{if((τ1015&&(((τp1=τ1009[0]),(τp1==="test"))&&((file=τ1009[1]),true)))){var τ1061=require("js-beautify");var beaut=τ1061.js;var data=fs.readFileSync(file,"utf8");var code=eg["generate2"](Source(data,"<test>"));return __lt____gt__(null,eval(code));}else{if((τ1015&&(((τp1=τ1009[0]),(τp1==="inspect"))&&((file=τ1009[1]),true)))){var τ1062=require("js-beautify");var beaut=τ1062.js;var data=fs.readFileSync(file,"utf8");var code=eg["generate2"](Source(data,"<test>"));return console.log(beaut(code));}else{if((τ1015&&(((τp1=τ1009[0]),(τp1==="tests"))&&((s=τ1009[1]),true)))){var τ1063=require("js-beautify");var beaut=τ1063.js;var code=eg["generate2"](Source(s,"<test>"));console.log(beaut(code));return __lt____gt__(null,eval(code));}else{if((τ1015&&(((τp1=τ1009[0]),(τp1==="runs"))&&((data=τ1009[1]),true)))){return __lt____gt__(null,eval(gen(data,"<command>")));}else{if(((other=τ1009),true)){return console.log(usage);}else{throw τ982(["match"]).create("Could not find a match",({"value":τ1009}));}}}}}}}}}}}};(exports["run"]=run);
