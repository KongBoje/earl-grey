var τ519=function(type){var τ520=type["::check"];var f;if((τ520===(void 0))){return function(value){return (value instanceof type);};}else{if(((f=τ520),true)){return function(value){return f.call(type,value);};}else{throw ["Could not find a match",τ520];}}};
var τ521=function(){var r=[];for(var i=0;(i<arguments.length);(i++)){(r=r.concat(arguments[i]));}return r;};
var τ522=function(τ523){var τ524=τ523;var x;var x;var other;if((((typeof(τ524)==="string")&&((x=τ524),true))||((typeof(τ524)==="number")&&((x=τ524),true)))){return ["value",x];}else{if(((other=τ524),true)){return other["::serialize_ast"]();}else{throw ["Could not find a match",τ524];}}};
var send=function(obj,τ512){var msg;var τ511;(msg=τ512);true;(τ511=τ512);var τ513=τ511;var other;if(((typeof(τ513)==="string")||(typeof(τ513)==="number"))){return obj[msg];}else{if(((other=τ513),true)){return obj["::send"](msg);}else{throw ["Could not find a match",τ513];}}};(Array[":::project"]=function(τ515){var value;var τ514;(value=τ515);true;(τ514=τ515);var τ516=τ514;var _;if(τ519(Array)(τ516)){return [true,value];}else{if(((_=τ516),true)){return [true,[value]];}else{throw ["Could not find a match",τ516];}}});(Array.prototype["::check"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){return false;}else{null;}}return true;}else{return false;}});(Array.prototype[":::project"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){var rval=this.slice(0);rval.push(value);return [true,rval];}else{null;}}return [true,value];}else{var rval=this.slice(0);rval.push(value);return [true,rval];}});(Array.prototype[":::deconstruct"]=function(value){return [true,value.slice(this.length)];});(Array.prototype["::serialize_ast"]=function(){return τ521(["array"],this.map(τ522));});(RegExp.prototype["::check"]=function(value){return value.match(this);});(RegExp.prototype[":::project"]=function(value){var τ517=value.match(this);var m;var m;if(((τ517===null)&&((m=τ517),true))){return [false,null];}else{if(((m=τ517),true)){return [true,m];}else{throw ["Could not find a match",τ517];}}});(RegExp.prototype[":::deconstruct"]=function(value){var τ518=value.match(this);var m;var m;if(((τ518===null)&&((m=τ518),true))){return [false,null];}else{if(((m=τ518),true)){return [true,m];}else{throw ["Could not find a match",τ518];}}});(Function.prototype["::send"]=function(args){return this.apply(this,args);});
var τ575=function(type){return function(value){var τ576=type[":::deconstruct"];var f;if((τ576===(void 0))){var τ577=type["::deconstruct"];var f;if((τ577===(void 0))){if((value instanceof Array)){return [true,value];}else{if(true){return [false,null];}else{return false;}}}else{if(((f=τ577),true)){var τ579;try{(τ579=[true,f.call(type,value)]);}catch(τ578){(τ579=[false,null]);}return τ579;}else{throw ["Could not find a match",τ577];}}}else{if(((f=τ576),true)){return f.call(type,value);}else{throw ["Could not find a match",τ576];}}};};var eg=require("./earl-grey");var τ525=require("./pp");var __lt____gt__=τ525["<>"];var Node=τ525.Node;var τ526=require("./util");var enumerate=τ526.enumerate;var items=τ526.items;var τ527=require("./location");var Source=τ527.Source;var display_error=τ527.display_error;var fs=require("fs");var path=require("path");var vm=require("vm");var usage="\nusage:\n\nearl translate <file> [outfile]\n  Translate a source file, output to outfile. Without outfile\n  specified, print to standard out.\n\nearl translate <directory> <outdir>\n  Translate all the .eg files in the specified directory.\n\nearl run [file] [arguments...]\n  Run the specified file as a script.\n";var walk=function(dir,partial,f){var stats=fs.statSync(dir);if(stats.isDirectory()){f("dir",partial);var τ528=[];var τ529=fs.readdirSync(dir);var τ530=τ529.length;for(var τ531=0;(τ531<τ530);(τ531++)){var τ532=τ529[τ531];var file;var other;if(((file=τ532),true)){τ528.push(function(){var newdir=path.join(dir,file);var newpartial=path.join(partial,file);return walk(newdir,newpartial,f);}());}else{if(((other=τ532),true)){false;}else{throw ["Could not find a match",τ532];}}}return τ528;}else{return f("file",partial);}};var copy=function(src,dest){var data=fs.readFileSync(src,"binary");return fs.writeFileSync(dest,data,"binary");};var gen=function(text,file){var g=eg.Generator();return g.generate(Source(text,path.resolve(file)));};var run=function(cmd){var τ534;try{(τ534=_run(cmd));}catch(τ533){(τ534=function(){var τ535=τ533;var e;var ___exc;if(((e=τ535),true)){return display_error(e);}else{if(((___exc=τ535),true)){throw ___exc;}else{throw ["Could not find a match",τ535];}}}());}return τ534;};var _run=function(τ536){var τ537=τ536;var τ539;var τ540;var τ538;var τp0;var τp1;var file;var τp0;var τp1;var file;var args;var τp0;var τp1;var s;var τp0;var τp1;var s;var τp0;var τp1;var data;var other;var τ541=false;var τ542=false;var τ543=false;if((((τ537 instanceof Array)&&(((τ538=τ537.length),true)&&(τ538===0)))||((τ537 instanceof Array)&&(((τ539=τ537.length),true)&&((τ539===1)&&((τ540=τ537[0]),(((τ540==="i")||(τ540==="in"))||(τ540==="interactive")))))))){var repl=require("repl");var settings=({"prompt":"<> ","ignoreUndefined":true,"eval":function(input,context,filename,callback){var g=eg.Generator();var result=function(){var execute=function(){var text=g.generate(Source(input.slice(1,(-1)),"<interactive>"));return vm.runInThisContext(text,"stdin");};var handle=function(e){display_error(e);return undefined;};var τ545;try{(τ545=execute());}catch(τ544){(τ545=function(){var τ546=τ544;var e;var ___exc;if(((e=τ546),true)){return handle(e);}else{if(((___exc=τ546),true)){throw ___exc;}else{throw ["Could not find a match",τ546];}}}());}return τ545;}();return callback(null,result);}});var run=repl.start(settings);return run.on("exit",function(){return run.outputStream.write("\n");});}else{if(((τ541=(τ537 instanceof Array))&&((τ542=((τp0=τ537.length),true))&&((τp0===2)&&(((τp1=τ537[0]),(τp1==="run"))&&((file=τ537[1]),true)))))){var data=fs.readFileSync(file,"utf8");return eval(gen(data,file));}else{if((τ542&&((τp0>=2)&&(((τp1=τ537[0]),((τp1==="tr")||(τp1==="translate")))&&((file=τ537[1]),true,(args=τ537.slice(2)),true))))){var out=args[0];var stats=fs.statSync(file);var τ547=null;var otherwise;if(stats.isDirectory()){return walk(file,"/",function(){var τ549=Array.prototype.slice.call(arguments,0);var τp0;var τ550;if(((τ549 instanceof Array)&&(((τp0=τ549.length),true)&&((τp0>=0)&&((τ550=τ549.slice(0)),true))))){var τ551=τ550;var τp0;var τp1;var d;var τp0;var τp1;var τ552;var τ553=false;var τ554=false;var τ555=false;if(((τ553=(τ551 instanceof Array))&&((τ554=((τp0=τ551.length),true))&&((τ555=(τp0===2))&&(((τp1=τ551[0]),(τp1==="dir"))&&((d=τ551[1]),true)))))){var from=path.join(file,d);var to=path.join(out,d);var τ557;try{(τ557=fs.mkdirSync(to));}catch(τ556){(τ557="ignore error");}return τ557;}else{if((τ555&&(((τp1=τ551[0]),(τp1==="file"))&&((τ552=τ551[1]),true)))){var τ558=τ552;var τp0;var τp1;var τp2;var x;var name;var f;if((τ519(RegExp("(?:^((?:.*))\\.eg$)",""))(τ558)&&(((τp0=τ575(RegExp("(?:^((?:.*))\\.eg$)",""))(τ558)),τp0[0])&&(((τp1=τp0[1]),true,(τp2=τp1.length),true)&&((τp2===2)&&((x=τp1[0]),true,(name=τp1[1]),true)))))){var from=path.join(file,x);var to=path.join(out,(name+".js"));var data=fs.readFileSync(from,"utf8");return fs.writeFileSync(to,(gen(data,from)+"\n"));}else{if(((f=τ558),true)){var from=path.join(file,f);var to=path.join(out,f);return copy(from,to);}else{throw ["Could not find a match",τ558];}}}else{throw ["Could not find a match",τ551];}}}else{throw ["Could not find a match",τ549];}});}else{if(out){var data=fs.readFileSync(file,"utf8");return fs.writeFileSync(out,(gen(data,file)+"\n"));}else{if(((otherwise=τ547),true)){var data=fs.readFileSync(file,"utf8");return console.log(gen(data,file));}else{throw ["Could not find a match",τ547];}}}}else{if((τ542&&((τ543=(τp0===2))&&(((τp1=τ537[0]),(τp1==="tok"))&&((s=τ537[1]),true))))){var τ559=[];var τ560=eg.tokenize(Source(s,null));var τ561=τ560.length;for(var τ562=0;(τ562<τ561);(τ562++)){var τ563=τ560[τ562];var token;var other;if(((token=τ563),true)){τ559.push((__lt____gt__(null,token),__lt____gt__(null,token.location.ref()),__lt____gt__(null,token.location.highlight())));}else{if(((other=τ563),true)){false;}else{throw ["Could not find a match",τ563];}}}return τ559;}else{if((τ543&&(((τp1=τ537[0]),(τp1==="pa"))&&((s=τ537[1]),true)))){var walkloc=function(τ565){var node;var τ564;(node=τ565);true;(τ564=τ565);var τ566=τ564;var τp0;var τp1;var x;var τp0;var τp1;var x;var τp0;var type;var args;var τ567=false;var τ568=false;var τ569=false;if(((τ567=(τ566 instanceof Array))&&((τ568=((τp0=τ566.length),true))&&((τ569=(τp0===2))&&(((τp1=τ566[0]),(τp1==="symbol"))&&((x=τ566[1]),true)))))){__lt____gt__(null,node);return __lt____gt__(null,(node.location&&node.location.highlight()));}else{if((τ569&&(((τp1=τ566[0]),(τp1==="value"))&&((x=τ566[1]),true)))){__lt____gt__(null,node);return __lt____gt__(null,(node.location&&node.location.highlight()));}else{if((τ568&&((τp0>=1)&&((type=τ566[0]),true,(args=τ566.slice(1)),true)))){__lt____gt__(null,node);__lt____gt__(null,(node.location&&node.location.highlight()));var τ570=[];var τ571=args;var τ572=τ571.length;for(var τ573=0;(τ573<τ572);(τ573++)){var τ574=τ571[τ573];var arg;var other;if(((arg=τ574),true)){τ570.push(walkloc(arg));}else{if(((other=τ574),true)){false;}else{throw ["Could not find a match",τ574];}}}return τ570;}else{throw ["Could not find a match",τ566];}}}};return walkloc(function(){var tokens=eg.tokenize(Source(s,null));return eg.parse(tokens);}());}else{if((τ543&&(((τp1=τ537[0]),(τp1==="runs"))&&((data=τ537[1]),true)))){return __lt____gt__(null,eval(gen(data,"<command>")));}else{if(((other=τ537),true)){return console.log(usage);}else{throw ["Could not find a match",τ537];}}}}}}}};(exports["run"]=run);
