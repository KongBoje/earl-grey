var τ524=function(type){var τ525=type["::check"];var f;if((τ525===(void 0))){return function(value){return (value instanceof type);};}else{if(((f=τ525),true)){return function(value){return f.call(type,value);};}else{throw ["Could not find a match",τ525];}}};
var τ526=function(){var r=[];for(var i=0;(i<arguments.length);(i++)){(r=r.concat(arguments[i]));}return r;};
var τ527=function(τ528){var τ529=τ528;var x;var x;var other;if((((typeof(τ529)==="string")&&((x=τ529),true))||((typeof(τ529)==="number")&&((x=τ529),true)))){return ["value",x];}else{if(((other=τ529),true)){return other["::serialize_ast"]();}else{throw ["Could not find a match",τ529];}}};
var send=function(obj,τ517){var msg;var τ516;(msg=τ517);true;(τ516=τ517);var τ518=τ516;var other;if(((typeof(τ518)==="string")||(typeof(τ518)==="number"))){return obj[msg];}else{if(((other=τ518),true)){return obj["::send"](msg);}else{throw ["Could not find a match",τ518];}}};(Array[":::project"]=function(τ520){var value;var τ519;(value=τ520);true;(τ519=τ520);var τ521=τ519;var _;if(τ524(Array)(τ521)){return [true,value];}else{if(((_=τ521),true)){return [true,[value]];}else{throw ["Could not find a match",τ521];}}});(Array.prototype["::check"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){return false;}else{null;}}return true;}else{return false;}});(Array.prototype[":::project"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){var rval=this.slice(0);rval.push(value);return [true,rval];}else{null;}}return [true,value];}else{var rval=this.slice(0);rval.push(value);return [true,rval];}});(Array.prototype[":::deconstruct"]=function(value){return [true,value.slice(this.length)];});(Array.prototype["::serialize_ast"]=function(){return τ526(["array"],this.map(τ527));});(RegExp.prototype["::check"]=function(value){return value.match(this);});(RegExp.prototype[":::project"]=function(value){var τ522=value.match(this);var m;var m;if(((τ522===null)&&((m=τ522),true))){return [false,null];}else{if(((m=τ522),true)){return [true,m];}else{throw ["Could not find a match",τ522];}}});(RegExp.prototype[":::deconstruct"]=function(value){var τ523=value.match(this);var m;var m;if(((τ523===null)&&((m=τ523),true))){return [false,null];}else{if(((m=τ523),true)){return [true,m];}else{throw ["Could not find a match",τ523];}}});(Function.prototype["::send"]=function(args){return this.apply(this,args);});
var τ580=function(type){return function(value){var τ581=type[":::deconstruct"];var f;if((τ581===(void 0))){var τ582=type["::deconstruct"];var f;if((τ582===(void 0))){if((value instanceof Array)){return [true,value];}else{if(true){return [false,null];}else{return false;}}}else{if(((f=τ582),true)){var τ584;try{(τ584=[true,f.call(type,value)]);}catch(τ583){(τ584=[false,null]);}return τ584;}else{throw ["Could not find a match",τ582];}}}else{if(((f=τ581),true)){return f.call(type,value);}else{throw ["Could not find a match",τ581];}}};};var eg=require("./earl-grey");var τ530=require("./pp");var __lt____gt__=τ530["<>"];var Node=τ530.Node;var τ531=require("./util");var enumerate=τ531.enumerate;var items=τ531.items;var τ532=require("./location");var Source=τ532.Source;var display_error=τ532.display_error;var fs=require("fs");var path=require("path");var vm=require("vm");var usage="\nusage:\n\nearl translate <file> [outfile]\n  Translate a source file, output to outfile. Without outfile\n  specified, print to standard out.\n\nearl translate <directory> <outdir>\n  Translate all the .eg files in the specified directory.\n\nearl run [file] [arguments...]\n  Run the specified file as a script.\n";var walk=function(dir,partial,f){var stats=fs.statSync(dir);if(stats.isDirectory()){f("dir",partial);var τ533=[];var τ534=fs.readdirSync(dir);var τ535=τ534.length;for(var τ536=0;(τ536<τ535);(τ536++)){var τ537=τ534[τ536];var file;var other;if(((file=τ537),true)){τ533.push(function(){var newdir=path.join(dir,file);var newpartial=path.join(partial,file);return walk(newdir,newpartial,f);}());}else{if(((other=τ537),true)){false;}else{throw ["Could not find a match",τ537];}}}return τ533;}else{return f("file",partial);}};var copy=function(src,dest){var data=fs.readFileSync(src,"binary");return fs.writeFileSync(dest,data,"binary");};var gen=function(text,file){var g=eg.Generator();return g.generate(Source(text,path.resolve(file)));};var run=function(cmd){var τ539;try{(τ539=_run(cmd));}catch(τ538){(τ539=function(){var τ540=τ538;var e;var ___exc;if(((e=τ540),true)){display_error(e);return process.exit(1);}else{if(((___exc=τ540),true)){throw ___exc;}else{throw ["Could not find a match",τ540];}}}());}return τ539;};var _run=function(τ541){var τ542=τ541;var τ544;var τ545;var τ543;var τp0;var τp1;var file;var τp0;var τp1;var file;var args;var τp0;var τp1;var s;var τp0;var τp1;var s;var τp0;var τp1;var data;var other;var τ546=false;var τ547=false;var τ548=false;if((((τ542 instanceof Array)&&(((τ543=τ542.length),true)&&(τ543===0)))||((τ542 instanceof Array)&&(((τ544=τ542.length),true)&&((τ544===1)&&((τ545=τ542[0]),(((τ545==="i")||(τ545==="in"))||(τ545==="interactive")))))))){var repl=require("repl");var settings=({"prompt":"<> ","ignoreUndefined":true,"eval":function(input,context,filename,callback){var g=eg.Generator();var result=function(){var execute=function(){var text=g.generate(Source(input.slice(1,(-1)),"<interactive>"));return vm.runInThisContext(text,"stdin");};var handle=function(e){display_error(e);return undefined;};var τ550;try{(τ550=execute());}catch(τ549){(τ550=function(){var τ551=τ549;var e;var ___exc;if(((e=τ551),true)){return handle(e);}else{if(((___exc=τ551),true)){throw ___exc;}else{throw ["Could not find a match",τ551];}}}());}return τ550;}();return callback(null,result);}});var run=repl.start(settings);return run.on("exit",function(){return run.outputStream.write("\n");});}else{if(((τ546=(τ542 instanceof Array))&&((τ547=((τp0=τ542.length),true))&&((τp0===2)&&(((τp1=τ542[0]),(τp1==="run"))&&((file=τ542[1]),true)))))){var data=fs.readFileSync(file,"utf8");return eval(gen(data,file));}else{if((τ547&&((τp0>=2)&&(((τp1=τ542[0]),((τp1==="tr")||(τp1==="translate")))&&((file=τ542[1]),true,(args=τ542.slice(2)),true))))){var out=args[0];var stats=fs.statSync(file);var τ552=null;var otherwise;if(stats.isDirectory()){return walk(file,"/",function(){var τ554=Array.prototype.slice.call(arguments,0);var τp0;var τ555;if(((τ554 instanceof Array)&&(((τp0=τ554.length),true)&&((τp0>=0)&&((τ555=τ554.slice(0)),true))))){var τ556=τ555;var τp0;var τp1;var d;var τp0;var τp1;var τ557;var τ558=false;var τ559=false;var τ560=false;if(((τ558=(τ556 instanceof Array))&&((τ559=((τp0=τ556.length),true))&&((τ560=(τp0===2))&&(((τp1=τ556[0]),(τp1==="dir"))&&((d=τ556[1]),true)))))){var from=path.join(file,d);var to=path.join(out,d);var τ562;try{(τ562=fs.mkdirSync(to));}catch(τ561){(τ562="ignore error");}return τ562;}else{if((τ560&&(((τp1=τ556[0]),(τp1==="file"))&&((τ557=τ556[1]),true)))){var τ563=τ557;var τp0;var τp1;var τp2;var x;var name;var f;if((τ524(RegExp("(?:^((?:.*))\\.eg$)",""))(τ563)&&(((τp0=τ580(RegExp("(?:^((?:.*))\\.eg$)",""))(τ563)),τp0[0])&&(((τp1=τp0[1]),true,(τp2=τp1.length),true)&&((τp2===2)&&((x=τp1[0]),true,(name=τp1[1]),true)))))){var from=path.join(file,x);var to=path.join(out,(name+".js"));var data=fs.readFileSync(from,"utf8");return fs.writeFileSync(to,(gen(data,from)+"\n"));}else{if(((f=τ563),true)){var from=path.join(file,f);var to=path.join(out,f);return copy(from,to);}else{throw ["Could not find a match",τ563];}}}else{throw ["Could not find a match",τ556];}}}else{throw ["Could not find a match",τ554];}});}else{if(out){var data=fs.readFileSync(file,"utf8");return fs.writeFileSync(out,(gen(data,file)+"\n"));}else{if(((otherwise=τ552),true)){var data=fs.readFileSync(file,"utf8");return console.log(gen(data,file));}else{throw ["Could not find a match",τ552];}}}}else{if((τ547&&((τ548=(τp0===2))&&(((τp1=τ542[0]),(τp1==="tok"))&&((s=τ542[1]),true))))){var τ564=[];var τ565=eg.tokenize(Source(s,null));var τ566=τ565.length;for(var τ567=0;(τ567<τ566);(τ567++)){var τ568=τ565[τ567];var token;var other;if(((token=τ568),true)){τ564.push((__lt____gt__(null,token),__lt____gt__(null,token.location.ref()),__lt____gt__(null,token.location.highlight())));}else{if(((other=τ568),true)){false;}else{throw ["Could not find a match",τ568];}}}return τ564;}else{if((τ548&&(((τp1=τ542[0]),(τp1==="pa"))&&((s=τ542[1]),true)))){var walkloc=function(τ570){var node;var τ569;(node=τ570);true;(τ569=τ570);var τ571=τ569;var τp0;var τp1;var x;var τp0;var τp1;var x;var τp0;var type;var args;var τ572=false;var τ573=false;var τ574=false;if(((τ572=(τ571 instanceof Array))&&((τ573=((τp0=τ571.length),true))&&((τ574=(τp0===2))&&(((τp1=τ571[0]),(τp1==="symbol"))&&((x=τ571[1]),true)))))){__lt____gt__(null,node);return __lt____gt__(null,(node.location&&node.location.highlight()));}else{if((τ574&&(((τp1=τ571[0]),(τp1==="value"))&&((x=τ571[1]),true)))){__lt____gt__(null,node);return __lt____gt__(null,(node.location&&node.location.highlight()));}else{if((τ573&&((τp0>=1)&&((type=τ571[0]),true,(args=τ571.slice(1)),true)))){__lt____gt__(null,node);__lt____gt__(null,(node.location&&node.location.highlight()));var τ575=[];var τ576=args;var τ577=τ576.length;for(var τ578=0;(τ578<τ577);(τ578++)){var τ579=τ576[τ578];var arg;var other;if(((arg=τ579),true)){τ575.push(walkloc(arg));}else{if(((other=τ579),true)){false;}else{throw ["Could not find a match",τ579];}}}return τ575;}else{throw ["Could not find a match",τ571];}}}};return walkloc(function(){var tokens=eg.tokenize(Source(s,null));return eg.parse(tokens);}());}else{if((τ548&&(((τp1=τ542[0]),(τp1==="runs"))&&((data=τ542[1]),true)))){return __lt____gt__(null,eval(gen(data,"<command>")));}else{if(((other=τ542),true)){return console.log(usage);}else{throw ["Could not find a match",τ542];}}}}}}}};(exports["run"]=run);
