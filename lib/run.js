var create_node=function(tag,id,classes,kv,τ501){var τp0;var contents;if((((τp0=projector(Array)(τ501)),τp0[0])&&((contents=τp0[1]),true))){false;}else{throw "a condition failed";}(classes=function(){var τ502=[];var τ503=classes;var τ504=τ503.length;for(var τ505=0;(τ505<τ504);(τ505++)){var τ506=τ503[τ505];var x;var other;if((checker(RegExp("(?:.+)",""))(τ506)&&((x=τ506),true))){τ502.push(x);}else{if(((other=τ506),true)){false;}else{throw ["Could not find a match",τ506];}}}return τ502;}());var accum=["<",tag];if(id){(accum=accum.concat(" id=\"",id,"\""));}else{false;}if(classes.length){(accum=accum.concat(" class=\"",classes.join(" "),"\""));}else{false;}if(kv){var τ507=[];var τ508=kv;var τ509=τ508.length;for(var τ510=0;(τ510<τ509);(τ510++)){var τ511=τ508[τ510];var τp0;var k;var v;var other;if(((τ511 instanceof Array)&&((τ511["#"]===undefined)&&(((τp0=τ511.length),true)&&((τp0===2)&&((k=τ511[0]),true,(v=τ511[1]),true)))))){τ507.push((accum=accum.concat([" ",k,"=\"",v,"\""])));}else{if(((other=τ511),true)){false;}else{throw ["Could not find a match",τ511];}}}τ507;}else{false;}var x=patch_array([">"],contents,["</",tag,">"]);return accum.concat(x).join("");};var patch_array=function(){var r=[];for(var i=0;(i<arguments.length);(i++)){(r=r.concat(arguments[i]));}return r;};var range=function(from,to){var rval=[];for(var i=from;(i<=to);(i++)){rval.push(i);}return rval;};var StructFactory=function(name){var make=function(){var r=Array.prototype.slice.call(arguments,0);(r["#"]=name);return r;};(make["___project"]=function(value){if(((value instanceof Array)&&(value["#"]===name))){return [true,value];}else{if(true){return [true,make(value)];}else{return false;}}});(make["___check"]=function(value){if(((value instanceof Array)&&(value["#"]===name))){return true;}else{if(true){return false;}else{return false;}}});(make["___deconstruct"]=function(value){if(((value instanceof Array)&&(value["#"]===name))){return [true,value.slice(0)];}else{if(true){return [false,false];}else{return false;}}});return make;};var Struct=function(name){var r=Array.prototype.slice.call(arguments,1);(r["#"]=name);return r;};(Struct["___check"]=function(value){if((value instanceof Array)){return (value["#"]!==undefined);}else{if(true){return false;}else{return false;}}});(Struct["___deconstruct"]=function(value){if(((value instanceof Array)&&(value["#"]!==undefined))){return [true,[value["#"]].concat(value.slice(0))];}else{if(true){return [false,null];}else{return false;}}});var pr=function(x){var r=repr(x);var pre=(String.fromCharCode(27)+"[?0;7y+h <div class=\"ug\">");var post=("</div>"+String.fromCharCode(7));return console.log(((pre+r)+post));};var __slash____slash____slash__=function(cls,contents){var τ512=contents;var other;if((typeof(τ512)==="string")){return (((("<span class=\""+cls)+"\">")+contents)+"</span>");}else{if(((other=τ512),true)){return (((("<span class=\""+cls)+"\">")+contents.join(""))+"</span>");}else{throw ["Could not find a match",τ512];}}};var repr=function(x){var τ513=x;var τp0;var τp1;var τp2;var tag;var entries;var entries;var other;if((τ513===true)){return __slash____slash____slash__("special",__slash____slash____slash__("true","true"));}else{if((τ513===false)){return __slash____slash____slash__("special",__slash____slash____slash__("false","false"));}else{if((τ513===null)){return __slash____slash____slash__("special",__slash____slash____slash__("nil","null"));}else{if((τ513===(void 0))){return __slash____slash____slash__("special",__slash____slash____slash__("nil","undefined"));}else{if((typeof(τ513)==="number")){return __slash____slash____slash__("num",String(x));}else{if((typeof(τ513)==="string")){return __slash____slash____slash__("str",x);}else{if((checker(Struct)(τ513)&&(((τp0=deconstructor(Struct)(τ513)),τp0[0])&&(((τp1=τp0[1]),(τp1 instanceof Array))&&((τp1["#"]===undefined)&&(((τp2=τp1.length),true)&&((τp2>=1)&&((tag=τp1[0]),true,(entries=τp1.slice(1)),true)))))))){return __slash____slash____slash__("struct",[__slash____slash____slash__("sym",tag),__slash____slash____slash__("sequence",entries.map(function(x){return repr(x);}))]);}else{if((checker(Array)(τ513)&&((entries=τ513),true))){return __slash____slash____slash__("sequence",entries.map(function(x){return repr(x);}));}else{if(((other=τ513),true)){return __slash____slash____slash__("unknown",other.toString());}else{throw ["Could not find a match",τ513];}}}}}}}}}};var send=function(obj,msg){var τ514=msg;var other;if(((typeof(τ514)==="string")||(typeof(τ514)==="number"))){return obj[msg];}else{if(((other=τ514),true)){return obj.___send(msg);}else{throw ["Could not find a match",τ514];}}};(Function.prototype["___send"]=function(args){return this.apply(this,args);});var checker=function(type){var τ515=type.___check;var f;if((τ515===(void 0))){return function(value){return (value instanceof type);};}else{if(((f=τ515),true)){return function(value){return f.call(type,value);};}else{throw ["Could not find a match",τ515];}}};var projector=function(type){return function(value){var τ516=type.___project;var f;if((τ516===(void 0))){return [true,type(value)];}else{if(((f=τ516),true)){return f.call(type,value);}else{throw ["Could not find a match",τ516];}}};};var deconstructor=function(type){return function(value){var τ517=type.___deconstruct;var f;if((τ517===(void 0))){if((value instanceof Array)){return [true,value];}else{if(true){return [false,null];}else{return false;}}}else{if(((f=τ517),true)){return f.call(this,value);}else{throw ["Could not find a match",τ517];}}};};(Array["___project"]=function(value){var τ518=value;if(checker(Array)(τ518)){return [true,value];}else{if(true){return [true,[value]];}else{throw ["Could not find a match",τ518];}}});(RegExp.prototype["___check"]=function(value){return value.match(this);});(RegExp.prototype["___project"]=function(value){var τ519=value.match(this);var m;var m;if(((τ519===null)&&((m=τ519),true))){return [false,null];}else{if(((m=τ519),true)){return [true,m];}else{throw ["Could not find a match",τ519];}}});
var eg=require("./earl-grey");var fs=require("fs");var path=require("path");var vm=require("vm");var usage="\nusage:\n\nearl translate <file> [outfile]\n  Translate a source file, output to outfile. Without outfile\n  specified, print to standard out.\n\nearl translate <directory> <outdir>\n  Translate all the .eg files in the specified directory.\n\nearl run [file] [arguments...]\n  Run the specified file as a script.\n";var libdata=fs.readFileSync(path.join(__dirname,"lib.raw.js"));var run=function(τ520){var τ521=τ520;var τ523;var τ524;var τ522;var τp0;var τp1;var file;var τp0;var τp1;var file;var args;var other;var τ525;var τ526;var τ527;if((((τ521 instanceof Array)&&((τ521["#"]===undefined)&&(((τ522=τ521.length),true)&&(τ522===0))))||((τ521 instanceof Array)&&((τ521["#"]===undefined)&&(((τ523=τ521.length),true)&&((τ523===1)&&((τ524=τ521[0]),(((τ524==="i")||(τ524==="in"))||(τ524==="interactive"))))))))){var repl=require("repl");vm.runInThisContext(libdata,"stdin");var settings=({"prompt":"<> ","ignoreUndefined":true,"eval":function(input,context,filename,callback){var text=eg.generate(input.slice(1,(-1)));var result=function(){var τ529;try{(τ529=vm.runInThisContext(text,"stdin"));}catch(τ528){(τ529=function(){var τ530=τ528;var e;var ___exc;if(((e=τ530),true)){return console.log(e.stack);}else{if(((___exc=τ530),true)){throw ___exc;}else{throw ["Could not find a match",τ530];}}}());}return τ529;}();return callback(null,result);}});var run=repl.start(settings);return run.on("exit",function(){return run.outputStream.write("\n");});}else{if(((τ525=(τ521 instanceof Array))&&((τ526=(τ521["#"]===undefined))&&((τ527=((τp0=τ521.length),true))&&((τp0===2)&&(((τp1=τ521[0]),(τp1==="run"))&&((file=τ521[1]),true))))))){var data=fs.readFileSync(file,"utf8");var code=eg.generate(data,libdata);return eval(code);}else{if((τ527&&((τp0>=2)&&(((τp1=τ521[0]),((τp1==="tr")||(τp1==="translate")))&&((file=τ521[1]),true,(args=τ521.slice(2)),true))))){var out=args[0];var stats=fs.statSync(file);if(stats.isDirectory()){try{fs.mkdirSync(out);}catch(τ531){"ignore error";}var d=fs.readdirSync(file);var τ532=[];var τ533=d;var τ534=τ533.length;for(var τ535=0;(τ535<τ534);(τ535++)){var τ536=τ533[τ535];var τp0;var τp1;var τp2;var x;var name;var other;if((((τp0=projector(RegExp("(?:^((?:.*))\\.eg$)",""))(τ536)),τp0[0])&&(((τp1=τp0[1]),(τp1 instanceof Array))&&((τp1["#"]===undefined)&&(((τp2=τp1.length),true)&&((τp2===2)&&((x=τp1[0]),true,(name=τp1[1]),true))))))){τ532.push(function(){var data=fs.readFileSync(path.join(file,x),"utf8");var outfile=path.join(out,(name+".js"));return fs.writeFileSync(outfile,(eg.generate(data,function(){if(checker(RegExp("(?:\\.raw\\.eg$)",""))(x)){return "";}else{return libdata;}}())+"\n"));}());}else{if(((other=τ536),true)){false;}else{throw ["Could not find a match",τ536];}}}return τ532;}else{if(out){var data=fs.readFileSync(file,"utf8");return fs.writeFileSync(out,(eg.generate(data,libdata)+"\n"));}else{if(true){var data=fs.readFileSync(file,"utf8");return console.log(eg.generate(data,""));}else{return false;}}}}else{if(((other=τ521),true)){return console.log(usage);}else{throw ["Could not find a match",τ521];}}}}};(exports["run"]=run);
