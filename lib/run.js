var create_node=function(tag,id,classes,kv,τ458){var τp0;var contents;if((((τp0=projector(Array)(τ458)),τp0[0])&&((contents=τp0[1]),true))){false;}else{throw "a condition failed";}(classes=function(){var τ459=[];var τ460=classes;var τ461=τ460.length;for(var τ462=0;(τ462<τ461);(τ462++)){var τ463=τ460[τ462];var x;var other;if((checker(RegExp("(?:.+)"))(τ463)&&((x=τ463),true))){τ459.push(x);}else{if(((other=τ463),true)){false;}else{throw ["Could not find a match",τ463];}}}return τ459;}());var accum=["<",tag];if(id){(accum=accum.concat(" id=\"",id,"\""));}else{false;}if(classes.length){(accum=accum.concat(" class=\"",classes.join(" "),"\""));}else{false;}if(kv){var τ464=[];var τ465=kv;var τ466=τ465.length;for(var τ467=0;(τ467<τ466);(τ467++)){var τ468=τ465[τ467];var τp0;var k;var v;var other;if(((τ468 instanceof Array)&&((τ468["#"]===(void 0))&&(((τp0=τ468.length),true)&&((τp0===2)&&((k=τ468[0]),true,(v=τ468[1]),true)))))){τ464.push((accum=accum.concat([" ",k,"=\"",v,"\""])));}else{if(((other=τ468),true)){false;}else{throw ["Could not find a match",τ468];}}}τ464;}else{false;}var x=patch_array([">"],contents,["</",tag,">"]);return accum.concat(x).join("");};var patch_array=function(){var r=[];for(var i=0;(i<arguments.length);(i++)){(r=r.concat(arguments[i]));}return r;};var range=function(from,to){var rval=[];for(var i=from;(i<=to);(i++)){rval.push(i);}return rval;};var StructFactory=function(name){var make=function(){var r=Array.prototype.slice.call(arguments,0);(r["#"]=name);return r;};(make["___project"]=function(value){if(((value instanceof Array)&&(value["#"]===name))){return [true,value];}else{if(true){return [true,make(value)];}else{return false;}}});(make["___check"]=function(value){if(((value instanceof Array)&&(value["#"]===name))){return true;}else{if(true){return false;}else{return false;}}});(make["___deconstruct"]=function(value){if(((value instanceof Array)&&(value["#"]===name))){return [true,value.slice(0)];}else{if(true){return [false,false];}else{return false;}}});return make;};var Struct=function(name){var r=Array.prototype.slice.call(arguments,1);(r["#"]=name);return r;};(Struct["___check"]=function(value){if((value instanceof Array)){return (value["#"]!==undefined);}else{if(true){return false;}else{return false;}}});(Struct["___deconstruct"]=function(value){if(((value instanceof Array)&&(value["#"]!==undefined))){return [value["#"]].concat(value.slice(0));}else{if(true){throw "cannot deconstruct";}else{return false;}}});var pr=function(x){var r=repr(x);var pre=(String.fromCharCode(27)+"[?0;7y+h <div class=\"ug\">");var post=("</div>"+String.fromCharCode(7));return console.log(((pre+r)+post));};var __slash____slash____slash__=function(cls,contents){var τ469=contents;var other;if((typeof(τ469)==="string")){return (((("<span class=\""+cls)+"\">")+contents)+"</span>");}else{if(((other=τ469),true)){return (((("<span class=\""+cls)+"\">")+contents.join(""))+"</span>");}else{throw ["Could not find a match",τ469];}}};var repr=function(x){var τ470=x;var entries;if((τ470===true)){return __slash____slash____slash__("special",__slash____slash____slash__("true","true"));}else{if((τ470===false)){return __slash____slash____slash__("special",__slash____slash____slash__("false","false"));}else{if((τ470===null)){return __slash____slash____slash__("special",__slash____slash____slash__("nil","null"));}else{if((τ470===(void 0))){return __slash____slash____slash__("special",__slash____slash____slash__("nil","undefined"));}else{if((typeof(τ470)==="number")){return __slash____slash____slash__("num",String(x));}else{if((typeof(τ470)==="string")){return __slash____slash____slash__("str",x);}else{if(((entries=τ470),true)){var tag=entries["#"];var τ471=tag;var other;if((τ471===(void 0))){return __slash____slash____slash__("sequence",entries.map(function(x){return repr(x);}));}else{if(((other=τ471),true)){return __slash____slash____slash__("struct",[__slash____slash____slash__("sym",tag),__slash____slash____slash__("sequence",entries.map(function(x){return repr(x);}))]);}else{throw ["Could not find a match",τ471];}}}else{throw ["Could not find a match",τ470];}}}}}}}};var send=function(obj,msg){var τ472=msg;var other;if(((typeof(τ472)==="string")||(typeof(τ472)==="number"))){return obj[msg];}else{if(((other=τ472),true)){return obj.___send(msg);}else{throw ["Could not find a match",τ472];}}};(Function.prototype["___send"]=function(args){return this.apply(this,args);});var checker=function(type){var τ473=type.___check;var f;if((τ473===(void 0))){return function(value){return (value instanceof type);};}else{if(((f=τ473),true)){return function(value){return f.call(type,value);};}else{throw ["Could not find a match",τ473];}}};var projector=function(type){return function(value){var τ474=type.___project;var f;if((τ474===(void 0))){return [true,type(value)];}else{if(((f=τ474),true)){return f.call(type,value);}else{throw ["Could not find a match",τ474];}}};};var deconstructor=function(type){return function(value){var τ475=type.___deconstruct;var f;if((τ475===(void 0))){if((value instanceof Array)){return [true,value];}else{if(true){return [false,null];}else{return false;}}}else{if(((f=τ475),true)){return f.call(this,value);}else{throw ["Could not find a match",τ475];}}};};(Array["___project"]=function(value){var τ476=value;if(checker(Array)(τ476)){return [true,value];}else{if(true){return [true,[value]];}else{throw ["Could not find a match",τ476];}}});(RegExp.prototype["___check"]=function(value){return value.match(this);});(RegExp.prototype["___project"]=function(value){var τ477=value.match(this);var m;var m;if(((τ477===null)&&((m=τ477),true))){return [false,null];}else{if(((m=τ477),true)){return [true,m];}else{throw ["Could not find a match",τ477];}}});
var eg=require("./earl-grey");var fs=require("fs");var path=require("path");var vm=require("vm");var usage="\nusage:\n\nearl translate <file> [outfile]\n  Translate a source file, output to outfile. Without outfile\n  specified, print to standard out.\n\nearl translate <directory> <outdir>\n  Translate all the .eg files in the specified directory.\n\nearl run [file] [arguments...]\n  Run the specified file as a script.\n";var libdata=fs.readFileSync(path.join(__dirname,"lib.raw.js"));var run=function(τ478){var τ479=τ478;var τ481;var τ482;var τ480;var τp0;var τp1;var file;var τp0;var τp1;var file;var args;var other;var τ483;var τ484;var τ485;if((((τ479 instanceof Array)&&((τ479["#"]===(void 0))&&(((τ480=τ479.length),true)&&(τ480===0))))||((τ479 instanceof Array)&&((τ479["#"]===(void 0))&&(((τ481=τ479.length),true)&&((τ481===1)&&((τ482=τ479[0]),(((τ482==="i")||(τ482==="in"))||(τ482==="interactive"))))))))){var repl=require("repl");vm.runInThisContext(libdata,"stdin");var settings=({"prompt":"<> ","ignoreUndefined":true,"eval":function(input,context,filename,callback){var text=eg.generate(input.slice(1,(-1)));var result=function(){var τ487;try{(τ487=vm.runInThisContext(text,"stdin"));}catch(τ486){(τ487=function(){var τ488=τ486;var e;var ___exc;if(((e=τ488),true)){return console.log(e.stack);}else{if(((___exc=τ488),true)){throw ___exc;}else{throw ["Could not find a match",τ488];}}}());}return τ487;}();return callback(null,result);}});var run=repl.start(settings);return run.on("exit",function(){return run.outputStream.write("\n");});}else{if(((τ483=(τ479 instanceof Array))&&((τ484=(τ479["#"]===(void 0)))&&((τ485=((τp0=τ479.length),true))&&((τp0===2)&&(((τp1=τ479[0]),(τp1==="run"))&&((file=τ479[1]),true))))))){var data=fs.readFileSync(file,"utf8");var code=eg.generate(data,libdata);return eval(code);}else{if((τ485&&((τp0>=2)&&(((τp1=τ479[0]),((τp1==="tr")||(τp1==="translate")))&&((file=τ479[1]),true,(args=τ479.slice(2)),true))))){var out=args[0];var stats=fs.statSync(file);if(stats.isDirectory()){var d=fs.readdirSync(file);if((!fs.existsSync(out))){fs.mkdirSync(out);}else{false;}return d.forEach(function(x){if(x.match(RegExp("(?:\\.eg$)"))){var data=fs.readFileSync(path.join(file,x),"utf8");var outfile=path.join(out,x.replace(".eg",".js"));return fs.writeFileSync(outfile,function(){var prelude=function(){if(x.match(RegExp("(?:\\.raw\\.eg$)"))){return "";}else{if(true){return libdata;}else{return false;}}}();return (eg.generate(data,prelude)+"\n");}());}else{return false;}});}else{if(out){var data=fs.readFileSync(file,"utf8");return fs.writeFileSync(out,(eg.generate(data,libdata)+"\n"));}else{if(true){var data=fs.readFileSync(file,"utf8");return console.log(eg.generate(data,""));}else{return false;}}}}else{if(((other=τ479),true)){return console.log(usage);}else{throw ["Could not find a match",τ479];}}}}};(exports["run"]=run);
