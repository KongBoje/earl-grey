var augment=function(dest,values){for(k in values){if(values.hasOwnProperty(k)){(dest[k]=send(values,k));}else{null;}}return dest;};var send=function(obj,__t94){var msg;var __t93;(msg=__t94);true;(__t93=__t94);var __t95=__t93;var other;if(((typeof(__t95)==="string")||(typeof(__t95)==="number"))){return obj[msg];}else{if(((other=__t95),true)){return obj["::send"](msg);}else{throw ["Could not find a match",__t95];}}};var patch_array=function(){var r=[];for(var i=0;(i<arguments.length);(i++)){(r=r.concat(arguments[i]));}return r;};var range=function(from,to){var rval=[];for(var i=from;(i<=to);(i++)){rval.push(i);}return rval;};var ___checker=function(type){var __t96=type["::check"];var f;if((__t96===(void 0))){return function(value){return (value instanceof type);};}else{if(((f=__t96),true)){return function(value){return f.call(type,value);};}else{throw ["Could not find a match",__t96];}}};var ___projector=function(type){return function(value){var __t97=type[":::project"];var f;if((__t97===(void 0))){var __t98=type["::project"];var f;if((__t98===(void 0))){return [true,type(value)];}else{if(((f=__t98),true)){var __t100;try{(__t100=[true,f(value)]);}catch(__t99){(__t100=[false,null]);}return __t100;}else{throw ["Could not find a match",__t98];}}}else{if(((f=__t97),true)){return f.call(type,value);}else{throw ["Could not find a match",__t97];}}};};var ___deconstructor=function(type){return function(value){var __t101=type[":::deconstruct"];var f;if((__t101===(void 0))){var __t102=type["::deconstruct"];var f;if((__t102===(void 0))){if((value instanceof Array)){return [true,value];}else{if(true){return [false,null];}else{return false;}}}else{if(((f=__t102),true)){var __t104;try{(__t104=[true,f.call(type,value)]);}catch(__t103){(__t104=[false,null]);}return __t104;}else{throw ["Could not find a match",__t102];}}}else{if(((f=__t101),true)){return f.call(type,value);}else{throw ["Could not find a match",__t101];}}};};(Array[":::project"]=function(__t106){var value;var __t105;(value=__t106);true;(__t105=__t106);var __t107=__t105;var _;if(___checker(Array)(__t107)){return [true,value];}else{if(((_=__t107),true)){return [true,[value]];}else{throw ["Could not find a match",__t107];}}});(Array.prototype["boink"]=function(){return this;});(Array.prototype["::check"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){return false;}else{null;}}return true;}else{return false;}});(Array.prototype[":::project"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){var rval=this.slice(0);rval.push(value);return [true,rval];}else{null;}}return [true,value];}else{var rval=this.slice(0);rval.push(value);return [true,rval];}});(Array.prototype[":::deconstruct"]=function(value){return value.slice(this.length);});(RegExp.prototype["::check"]=function(value){return value.match(this);});(RegExp.prototype[":::project"]=function(value){var __t108=value.match(this);var m;var m;if(((__t108===null)&&((m=__t108),true))){return [false,null];}else{if(((m=__t108),true)){return [true,m];}else{throw ["Could not find a match",__t108];}}});(RegExp.prototype[":::deconstruct"]=function(value){var __t109=value.match(this);var m;var m;if(((__t109===null)&&((m=__t109),true))){return [false,null];}else{if(((m=__t109),true)){return [true,m];}else{throw ["Could not find a match",__t109];}}});(Function.prototype["::send"]=function(args){return this.apply(this,args);});var ErrorFactory=function(tags){var __t87=function(){if((!___checker(ErrorFactory)(this))){return Object.create(ErrorFactory.prototype);}else{return this;}}();(__t87["tags"]=tags);return __t87;};augment(ErrorFactory,[]);(ErrorFactory.prototype["create"]=function(){var __t88=Array.prototype.slice.call(arguments,0);var __tp0;var message;var args;if(((__t88 instanceof Array)&&(((__tp0=__t88.length),true)&&((__tp0>=0)&&((message=function(){if((0>=__tp0)){return "";}else{return __t88[0];}}()),true,(args=__t88.slice(1)),true))))){var __t87=this;var e=Error(message);(e["::tags"]=__t87.tags);(e["args"]=args);(e["name"]=["E"].concat(__t87.tags).join("."));return e;}else{throw ["Could not find a match",__t88];}});(ErrorFactory.prototype["::check"]=function(e){var __t87=this;if(((!e)||(!___checker(Error)(e)))){return false;}else{null;}var tags=(e["::tags"]||[]);var __t89=__t87.tags;var __t90=__t89.length;for(var __t91=0;(__t91<__t90);(__t91++)){var __t92=__t89[__t91];var tag;var other;if(((tag=__t92),true,(tags.indexOf(tag)===(-1)))){return false;}else{if(((other=__t92),true)){false;}else{throw ["Could not find a match",__t92];}}}false;return true;});(ErrorFactory.prototype["::deconstruct"]=function(e){var __t87=this;return e.args;});ErrorFactory;
var Env=function(parent){var store=Object();var self=function(expr){return ["bind_env",self,expr];};(self["resolve"]=function(name){var attempt=send(store,name);if(attempt){return attempt;}else{return self.parent.resolve(name);}});(self["register"]=function(name,value){return (store[name]=value);});(self["register_macro"]=function(name,m){return (store[name]=["macro",m]);});(self["fork"]=function(){return Env(self);});(self["parent"]=parent);(self["store"]=store);return self;};var nullenv=({"resolve":function(x){return undefined;}});var js_contexts=({"js_for":["multi","multi","multi","multi"]});var expand=function(__t6,expr){var __tp0;var context;var env;if(((__t6 instanceof Array)&&(((__tp0=__t6.length),true)&&((__tp0===2)&&((context=__t6[0]),true,(env=__t6[1]),true))))){(void 0);}else{throw "a condition failed";}(expr=expand.step([context,env],expr));var __t7=expr;var __tp0;var __tp1;var s;var __tp0;var __tp1;var __tp0;var __tp1;var f;var arg;var __tp0;var __tp1;var v;var __tp0;var __tp1;var type;var args;var __tp0;var __tp1;var args;var __tp0;var __tp1;var args;var __tp0;var __tp1;var bindings;var body;var __tp0;var __tp1;var binding;var value;var __tp0;var __tp1;var lhs;var rhs;var __tp0;var __tp1;var type;var args;var __tp0;var __tp1;var expr;var other;var __t8=false;var __t9=false;var __t10=false;if(((__t8=(__t7 instanceof Array))&&((__t9=((__tp0=__t7.length),true))&&((__tp0===2)&&(((__tp1=__t7[0]),(__tp1==="symbol"))&&((s=__t7[1]),true)))))){return expr;}else{if((__t9&&((__tp0===1)&&((__tp1=__t7[0]),(__tp1==="void"))))){return ["void"];}else{if((__t9&&((__tp0===3)&&(((__tp1=__t7[0]),(__tp1==="send"))&&((f=__t7[1]),true,(arg=__t7[2]),true))))){(f=expand(["head",env],f));return ["send",f,expand(["tail",env],arg)];}else{if((__t9&&((__tp0===2)&&(((__tp1=__t7[0]),(__tp1==="value"))&&((v=__t7[1]),true))))){return expr;}else{if((__t9&&((__t10=(__tp0>=1))&&(((__tp1=__t7[0]),(type=__tp1),true,((__tp1==="array")||(__tp1==="object")))&&((args=__t7.slice(1)),true))))){var arr=[];while((args.length>0)){var __t11=expand.step([type,env],args.shift());var __tp0;var __tp1;var stmts;var other;if(((__t11 instanceof Array)&&(((__tp0=__t11.length),true)&&((__tp0>=1)&&(((__tp1=__t11[0]),(__tp1==="splice"))&&((stmts=__t11.slice(1)),true)))))){(args=stmts.concat(args));}else{if(((other=__t11),true)){arr.push(other);}else{throw ["Could not find a match",__t11];}}}return [type].concat(function(){var __t12=[];var __t13=arr;var __t14=__t13.length;for(var __t15=0;(__t15<__t14);(__t15++)){var __t16=__t13[__t15];var x;var other;if(((x=__t16),true)){__t12.push(expand([type,env],x));}else{if(((other=__t16),true)){false;}else{throw ["Could not find a match",__t16];}}}return __t12;}());}else{if((__t10&&(((__tp1=__t7[0]),(__tp1==="multi"))&&((args=__t7.slice(1)),true)))){var arr=[];while((args.length>0)){var type=function(){if((args.length===1)){return "expr";}else{return "multi";}}();var __t17=expand.step([type,env],args.shift());var __tp0;var __tp1;var stmts;var __tp0;var __tp1;var stmt;var other;var __t18=false;var __t19=false;if(((__t18=(__t17 instanceof Array))&&((__t19=((__tp0=__t17.length),true))&&((__tp0>=1)&&(((__tp1=__t17[0]),(__tp1==="splice"))&&((stmts=__t17.slice(1)),true)))))){(args=stmts.concat(args));}else{if((__t19&&((__tp0===2)&&(((__tp1=__t17[0]),(__tp1==="sink"))&&((stmt=__t17[1]),true))))){args.push(stmt);}else{if(((other=__t17),true)){arr.push([other,type]);}else{throw ["Could not find a match",__t17];}}}}return ["multi"].concat(function(){var __t20=[];var __t21=arr;var __t22=__t21.length;for(var __t23=0;(__t23<__t22);(__t23++)){var __t24=__t21[__t23];var __tp0;var x;var type;var other;if(((__t24 instanceof Array)&&(((__tp0=__t24.length),true)&&((__tp0===2)&&((x=__t24[0]),true,(type=__t24[1]),true))))){__t20.push(expand([type,env],x));}else{if(((other=__t24),true)){false;}else{throw ["Could not find a match",__t24];}}}return __t20;}());}else{if((__t10&&(((__tp1=__t7[0]),(__tp1==="data"))&&((args=__t7.slice(1)),true)))){var is_obj=false;var obj=["object"];var arr=["array"];var parts=[];var newpart=function(){var __t25=arr;var __tp0;var __tp1;var other;if(((__t25 instanceof Array)&&(((__tp0=__t25.length),true)&&((__tp0===1)&&((__tp1=__t25[0]),(__tp1==="array")))))){return false;}else{if(((other=__t25),true)){parts.push(arr);return (arr=["array"]);}else{throw ["Could not find a match",__t25];}}};while((args.length>0)){var __t26=expand.step([type,env],args.shift());var __tp0;var __tp1;var __tp0;var __tp1;var k;var v;var __tp0;var __tp1;var exprs;var __tp0;var __tp1;var expr;var other;var __t27=false;var __t28=false;if(((__t27=(__t26 instanceof Array))&&((__t28=((__tp0=__t26.length),true))&&((__tp0===1)&&((__tp1=__t26[0]),(__tp1==="assoc")))))){(is_obj=true);}else{if((__t28&&((__tp0===3)&&(((__tp1=__t26[0]),(__tp1==="assoc"))&&((k=__t26[1]),true,(v=__t26[2]),true))))){(is_obj=true);obj.push(["array",k,v]);}else{if((__t28&&((__tp0>=1)&&(((__tp1=__t26[0]),(__tp1==="splice"))&&((exprs=__t26.slice(1)),true))))){(args=exprs.concat(args));}else{if((__t28&&((__tp0===2)&&(((__tp1=__t26[0]),(__tp1==="dynsplice"))&&((expr=__t26[1]),true))))){newpart();parts.push(expr);}else{if(((other=__t26),true)){arr.push(other);}else{throw ["Could not find a match",__t26];}}}}}}newpart();var r=function(){var __t29=parts;var __tp0;var __tp0;var __tp0;var __tp1;var arr;var __tp2;var __tp3;var things;var other;var __t30=false;var __t31=false;var __t32=false;if(((__t30=(__t29 instanceof Array))&&((__t31=((__tp0=__t29.length),true))&&((__t32=(__tp0===0))&&is_obj)))){return obj;}else{if(__t32){return ["array"];}else{if((__t31&&((__tp0===1)&&(((__tp1=__t29[0]),(arr=__tp1),true,(__tp1 instanceof Array))&&(((__tp2=__tp1.length),true)&&((__tp2>=1)&&(((__tp3=__tp1[0]),(__tp3==="array"))&&((things=__tp1.slice(1)),true)))))))){if(is_obj){arr.push(obj);}else{null;}return arr;}else{if(((other=__t29),true)){if(is_obj){parts.push(["array",obj]);}else{null;}var patch=["symbol","patch_array"];return ["send",patch,patch_array(["array"],parts)];}else{throw ["Could not find a match",__t29];}}}}}();return expand([context,env],r);}else{if((__t9&&((__t10=(__tp0===3))&&(((__tp1=__t7[0]),(__tp1==="lambda"))&&((bindings=__t7[1]),true,(body=__t7[2]),true))))){return ["lambda",function(){var __t33=[];var __t34=bindings;var __t35=__t34.length;for(var __t36=0;(__t36<__t35);(__t36++)){var __t37=__t34[__t36];var x;var other;if(((x=__t37),true)){__t33.push(expand(["decl",env],x));}else{if(((other=__t37),true)){false;}else{throw ["Could not find a match",__t37];}}}return __t33;}(),expand(["expr",env],body)];}else{if((__t10&&(((__tp1=__t7[0]),(__tp1==="declare"))&&((binding=__t7[1]),true,(value=__t7[2]),true)))){return ["declare",expand(["decl",env],binding),expand(["expr",env],value)];}else{if((__t10&&(((__tp1=__t7[0]),(__tp1==="assign"))&&((lhs=__t7[1]),true,(rhs=__t7[2]),true)))){return ["assign",expand(["decl",env],lhs),expand(["expr",env],rhs)];}else{if((__t9&&((__tp0>=1)&&(((__tp1=__t7[0]),(type=__tp1),true,(((((((((((__tp1==="js_while")||(__tp1==="js_for"))||(__tp1==="js_for_in"))||(__tp1==="js_break"))||(__tp1==="js_continue"))||(__tp1==="js_return"))||(__tp1==="js_delete"))||(__tp1==="js_throw"))||(__tp1==="js_try"))||(__tp1==="js_new"))||(__tp1==="if")))&&((args=__t7.slice(1)),true))))){var ctxs=(send(js_contexts,type)||[]);var f=function(x,i){return expand([(send(ctxs,i)||"expr"),env],x);};return patch_array([type],args.map(f));}else{if((__t9&&((__tp0===2)&&(((__tp1=__t7[0]),(__tp1==="done"))&&((expr=__t7[1]),true))))){return expr;}else{if(((other=__t7),true)){throw ErrorFactory(["syntax","illegal_node"]).create("An illegal node was found in expand",({"node":other}));}else{throw ["Could not find a match",__t7];}}}}}}}}}}}}}};(expand["step"]=function(__t39,__t40){var __tp0;var context;var env;if(((__t39 instanceof Array)&&(((__tp0=__t39.length),true)&&((__tp0===2)&&((context=__t39[0]),true,(env=__t39[1]),true))))){(void 0);}else{throw "a condition failed";}var expr;var __t38;(expr=__t40);true;(__t38=__t40);var __t41=__t38;var __tp0;var __tp1;var s;var __tp0;var __tp1;var __tp0;var __tp1;var m;var __tp0;var __tp1;var m;var __tp0;var __tp1;var f;var arg;var __tp0;var type;var args;var other;var __t42=false;var __t43=false;var __t44=false;var __t45=false;if(((__t42=(__t41 instanceof Array))&&((__t43=((__tp0=__t41.length),true))&&((__tp0===2)&&(((__tp1=__t41[0]),(__tp1==="symbol"))&&((s=__t41[1]),true)))))){var v=env.resolve(s);var __t46=[v,context];var __tp0;var __tp1;var _;var __tp0;var __tp1;var __tp2;var __tp3;var m;var __tp4;var __tp0;var __tp1;var __tp2;var __tp3;var m;var _;var other;var __t47=false;var __t48=false;var __t49=false;var __t50=false;var __t51=false;var __t52=false;var __t53=false;if(((__t47=(__t46 instanceof Array))&&((__t48=((__tp0=__t46.length),true))&&((__t49=(__tp0===2))&&(((__tp1=__t46[0]),(__tp1===(void 0)))&&((_=__t46[1]),true)))))){return ["symbol",s];}else{if((__t49&&((__t50=((__tp1=__t46[0]),(__tp1 instanceof Array)))&&((__t51=((__tp2=__tp1.length),true))&&((__t52=(__tp2===2))&&((__t53=((__tp3=__tp1[0]),(__tp3==="macro")))&&((m=__tp1[1]),true,(__tp4=__t46[1]),(__tp4==="head")))))))){return v;}else{if((__t53&&((m=__tp1[1]),true,(_=__t46[1]),true))){return expand.step([context,env],m([context,env],["void"]));}else{if(((other=__t46),true)){return v;}else{throw ["Could not find a match",__t46];}}}}}else{if((__t43&&((__tp0===1)&&((__tp1=__t41[0]),(__tp1==="void"))))){return ["void"];}else{if((__t43&&((__t44=(__tp0===2))&&((__t45=((__tp1=__t41[0]),(__tp1==="macro")))&&((m=__t41[1]),true,(context==="head")))))){return expr;}else{if((__t45&&((m=__t41[1]),true,true))){return expand.step([context,env],m([context,env],["void"]));}else{if((__t43&&((__tp0===3)&&(((__tp1=__t41[0]),(__tp1==="send"))&&((f=__t41[1]),true,(arg=__t41[2]),true))))){var __t54=expand.step(["head",env],f);var __tp0;var __tp1;var m;var other;if(((__t54 instanceof Array)&&(((__tp0=__t54.length),true)&&((__tp0===2)&&(((__tp1=__t54[0]),(__tp1==="macro"))&&((m=__t54[1]),true)))))){return expand.step([context,env],m([context,env],arg));}else{if(((other=__t54),true)){return expr;}else{throw ["Could not find a match",__t54];}}}else{if((__t43&&((__tp0>=1)&&((type=__t41[0]),true,(args=__t41.slice(1)),true)))){return expr;}else{if(((other=__t41),true)){throw ErrorFactory(["syntax","illegal_node"]).create("An illegal node was found in expand.step",({"node":other}));}else{throw ["Could not find a match",__t41];}}}}}}}});(exports["expand"]=expand);(exports["Env"]=Env);(exports["nullenv"]=nullenv);
