var τ40=function(type){var τ41=type["::check"];var f;if((τ41===(void 0))){return function(value){return (value instanceof type);};}else{if(((f=τ41),true)){return function(value){return f.call(type,value);};}else{throw ["Could not find a match",τ41];}}};
var τ42=function(){var r=[];for(var i=0;(i<arguments.length);(i++)){(r=r.concat(arguments[i]));}return r;};
var τ43=function(τ44){var τ45=τ44;var x;var x;var other;if((((typeof(τ45)==="string")&&((x=τ45),true))||((typeof(τ45)==="number")&&((x=τ45),true)))){return ["value",x];}else{if(((other=τ45),true)){return other["::serialize_ast"]();}else{throw ["Could not find a match",τ45];}}};
var send=function(obj,τ33){var msg;var τ32;(msg=τ33);true;(τ32=τ33);var τ34=τ32;var other;if(((typeof(τ34)==="string")||(typeof(τ34)==="number"))){return obj[msg];}else{if(((other=τ34),true)){return obj["::send"](msg);}else{throw ["Could not find a match",τ34];}}};(Array[":::project"]=function(τ36){var value;var τ35;(value=τ36);true;(τ35=τ36);var τ37=τ35;var _;if(τ40(Array)(τ37)){return [true,value];}else{if(((_=τ37),true)){return [true,[value]];}else{throw ["Could not find a match",τ37];}}});(Array.prototype["::check"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){return false;}else{null;}}return true;}else{return false;}});(Array.prototype[":::project"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){var rval=this.slice(0);rval.push(value);return [true,rval];}else{null;}}return [true,value];}else{var rval=this.slice(0);rval.push(value);return [true,rval];}});(Array.prototype[":::deconstruct"]=function(value){return [true,value.slice(this.length)];});(Array.prototype["::serialize_ast"]=function(){return τ42(["array"],this.map(τ43));});(RegExp.prototype["::check"]=function(value){return value.match(this);});(RegExp.prototype[":::project"]=function(value){var τ38=value.match(this);var m;var m;if(((τ38===null)&&((m=τ38),true))){return [false,null];}else{if(((m=τ38),true)){return [true,m];}else{throw ["Could not find a match",τ38];}}});(RegExp.prototype[":::deconstruct"]=function(value){var τ39=value.match(this);var m;var m;if(((τ39===null)&&((m=τ39),true))){return [false,null];}else{if(((m=τ39),true)){return [true,m];}else{throw ["Could not find a match",τ39];}}});(Function.prototype["::send"]=function(args){return this.apply(this,args);});
var τ95=function(dest,values){for(k in values){if(values.hasOwnProperty(k)){(dest[k]=send(values,k));}else{null;}}return dest;};
var τ96=function(){var τ97=function(tags){var τ98=function(){if((!τ40(τ97)(this))){return Object.create(τ97.prototype);}else{return this;}}();(τ98["tags"]=tags);return τ98;};τ95(τ97);(τ97.prototype["create"]=function(){var τ99=Array.prototype.slice.call(arguments,0);var τp0;var message;var args;if(((τ99 instanceof Array)&&(((τp0=τ99.length),true)&&((τp0>=0)&&((message=function(){if((0>=τp0)){return "";}else{return τ99[0];}}()),true,(args=τ99.slice(1)),true))))){var τ98=this;var e=Error(message);(e["::tags"]=τ98.tags);(e["args"]=args);(e["name"]=["E"].concat(τ98.tags).join("."));return e;}else{throw ["Could not find a match",τ99];}});(τ97.prototype["::check"]=function(e){var τ98=this;if(((!e)||(!τ40(Error)(e)))){return false;}else{null;}var tags=(e["::tags"]||[]);var τ100=τ98.tags;var τ101=τ100.length;for(var τ102=0;(τ102<τ101);(τ102++)){var τ103=τ100[τ102];var tag;var other;if(((tag=τ103),true,(tags.indexOf(tag)===(-1)))){return false;}else{if(((other=τ103),true)){false;}else{throw ["Could not find a match",τ103];}}}false;return true;});(τ97.prototype["::deconstruct"]=function(e){var τ98=this;return e.args;});return τ97;}();var Env=function(parent){var store=Object();var self=function(expr){return ["bind_env",self,expr];};(self["resolve"]=function(name){var attempt=send(store,name);if(attempt){return attempt;}else{return self.parent.resolve(name);}});(self["register"]=function(name,value){return (store[name]=value);});(self["register_macro"]=function(name,m){return (store[name]=["macro",m]);});(self["fork"]=function(){return Env(self);});(self["parent"]=parent);(self["store"]=store);return self;};var nullenv=({"resolve":function(x){return undefined;}});var js_contexts=({"js_for":["multi","multi","multi","multi"]});var expand=function(τ46,expr){var τp0;var context;var env;if(((τ46 instanceof Array)&&(((τp0=τ46.length),true)&&((τp0===2)&&((context=τ46[0]),true,(env=τ46[1]),true))))){undefined;}else{throw τ95(τ96(["match"]).create("The value failed to match"),({"location":["location",(void 0),(void 0),(void 0)]}));}(expr=expand.step([context,env],expr));var τ47=expr;var τp0;var τp1;var s;var τp0;var τp1;var τp0;var τp1;var f;var arg;var τp0;var τp1;var v;var τp0;var τp1;var type;var args;var τp0;var τp1;var args;var τp0;var τp1;var args;var τp0;var τp1;var bindings;var body;var τp0;var τp1;var binding;var value;var τp0;var τp1;var lhs;var rhs;var τp0;var τp1;var type;var args;var τp0;var τp1;var expr;var other;var τ48=false;var τ49=false;var τ50=false;if(((τ48=(τ47 instanceof Array))&&((τ49=((τp0=τ47.length),true))&&((τp0===2)&&(((τp1=τ47[0]),(τp1==="symbol"))&&((s=τ47[1]),true)))))){return expr;}else{if((τ49&&((τp0===1)&&((τp1=τ47[0]),(τp1==="void"))))){return ["void"];}else{if((τ49&&((τp0===3)&&(((τp1=τ47[0]),(τp1==="send"))&&((f=τ47[1]),true,(arg=τ47[2]),true))))){(f=expand(["head",env],f));return ["send",f,expand(["tail",env],arg)];}else{if((τ49&&((τp0===2)&&(((τp1=τ47[0]),(τp1==="value"))&&((v=τ47[1]),true))))){return expr;}else{if((τ49&&((τ50=(τp0>=1))&&(((τp1=τ47[0]),(type=τp1),true,((τp1==="array")||(τp1==="object")))&&((args=τ47.slice(1)),true))))){var arr=[];while((args.length>0)){var τ51=expand.step([type,env],args.shift());var τp0;var τp1;var stmts;var other;if(((τ51 instanceof Array)&&(((τp0=τ51.length),true)&&((τp0>=1)&&(((τp1=τ51[0]),(τp1==="splice"))&&((stmts=τ51.slice(1)),true)))))){(args=stmts.concat(args));}else{if(((other=τ51),true)){arr.push(other);}else{throw ["Could not find a match",τ51];}}}return [type].concat(function(){var τ52=[];var τ53=arr;var τ54=τ53.length;for(var τ55=0;(τ55<τ54);(τ55++)){var τ56=τ53[τ55];var x;var other;if(((x=τ56),true)){τ52.push(expand([type,env],x));}else{if(((other=τ56),true)){false;}else{throw ["Could not find a match",τ56];}}}return τ52;}());}else{if((τ50&&(((τp1=τ47[0]),(τp1==="multi"))&&((args=τ47.slice(1)),true)))){var arr=[];while((args.length>0)){var type=function(){if((args.length===1)){return "expr";}else{return "multi";}}();var τ57=expand.step([type,env],args.shift());var τp0;var τp1;var stmts;var τp0;var τp1;var stmt;var other;var τ58=false;var τ59=false;if(((τ58=(τ57 instanceof Array))&&((τ59=((τp0=τ57.length),true))&&((τp0>=1)&&(((τp1=τ57[0]),(τp1==="splice"))&&((stmts=τ57.slice(1)),true)))))){(args=stmts.concat(args));}else{if((τ59&&((τp0===2)&&(((τp1=τ57[0]),(τp1==="sink"))&&((stmt=τ57[1]),true))))){args.push(stmt);}else{if(((other=τ57),true)){arr.push([other,type]);}else{throw ["Could not find a match",τ57];}}}}return ["multi"].concat(function(){var τ60=[];var τ61=arr;var τ62=τ61.length;for(var τ63=0;(τ63<τ62);(τ63++)){var τ64=τ61[τ63];var τp0;var x;var type;var other;if(((τ64 instanceof Array)&&(((τp0=τ64.length),true)&&((τp0===2)&&((x=τ64[0]),true,(type=τ64[1]),true))))){τ60.push(expand([type,env],x));}else{if(((other=τ64),true)){false;}else{throw ["Could not find a match",τ64];}}}return τ60;}());}else{if((τ50&&(((τp1=τ47[0]),(τp1==="data"))&&((args=τ47.slice(1)),true)))){var is_obj=false;var obj=["object"];var arr=["array"];var parts=[];var newpart=function(){var τ65=arr;var τp0;var τp1;var other;if(((τ65 instanceof Array)&&(((τp0=τ65.length),true)&&((τp0===1)&&((τp1=τ65[0]),(τp1==="array")))))){return false;}else{if(((other=τ65),true)){parts.push(arr);return (arr=["array"]);}else{throw ["Could not find a match",τ65];}}};while((args.length>0)){var τ66=expand.step([type,env],args.shift());var τp0;var τp1;var τp0;var τp1;var k;var v;var τp0;var τp1;var exprs;var τp0;var τp1;var expr;var other;var τ67=false;var τ68=false;if(((τ67=(τ66 instanceof Array))&&((τ68=((τp0=τ66.length),true))&&((τp0===1)&&((τp1=τ66[0]),(τp1==="assoc")))))){(is_obj=true);}else{if((τ68&&((τp0===3)&&(((τp1=τ66[0]),(τp1==="assoc"))&&((k=τ66[1]),true,(v=τ66[2]),true))))){(is_obj=true);obj.push(["array",k,v]);}else{if((τ68&&((τp0>=1)&&(((τp1=τ66[0]),(τp1==="splice"))&&((exprs=τ66.slice(1)),true))))){(args=exprs.concat(args));}else{if((τ68&&((τp0===2)&&(((τp1=τ66[0]),(τp1==="dynsplice"))&&((expr=τ66[1]),true))))){newpart();parts.push(expr);}else{if(((other=τ66),true)){arr.push(other);}else{throw ["Could not find a match",τ66];}}}}}}newpart();var r=function(){var τ69=parts;var τp0;var τp0;var τp0;var τp1;var arr;var τp2;var τp3;var things;var other;var τ70=false;var τ71=false;var τ72=false;if(((τ70=(τ69 instanceof Array))&&((τ71=((τp0=τ69.length),true))&&((τ72=(τp0===0))&&is_obj)))){return obj;}else{if(τ72){return ["array"];}else{if((τ71&&((τp0===1)&&(((τp1=τ69[0]),(arr=τp1),true,(τp1 instanceof Array))&&(((τp2=τp1.length),true)&&((τp2>=1)&&(((τp3=τp1[0]),(τp3==="array"))&&((things=τp1.slice(1)),true)))))))){if(is_obj){arr.push(obj);}else{null;}return arr;}else{if(((other=τ69),true)){if(is_obj){parts.push(["array",obj]);}else{null;}var patch=["symbol","patch_array"];return ["send",patch,τ42(["array"],parts)];}else{throw ["Could not find a match",τ69];}}}}}();return expand([context,env],r);}else{if((τ49&&((τ50=(τp0===3))&&(((τp1=τ47[0]),(τp1==="lambda"))&&((bindings=τ47[1]),true,(body=τ47[2]),true))))){return ["lambda",function(){var τ73=[];var τ74=bindings;var τ75=τ74.length;for(var τ76=0;(τ76<τ75);(τ76++)){var τ77=τ74[τ76];var x;var other;if(((x=τ77),true)){τ73.push(expand(["decl",env],x));}else{if(((other=τ77),true)){false;}else{throw ["Could not find a match",τ77];}}}return τ73;}(),expand(["expr",env],body)];}else{if((τ50&&(((τp1=τ47[0]),(τp1==="declare"))&&((binding=τ47[1]),true,(value=τ47[2]),true)))){return ["declare",expand(["decl",env],binding),expand(["expr",env],value)];}else{if((τ50&&(((τp1=τ47[0]),(τp1==="assign"))&&((lhs=τ47[1]),true,(rhs=τ47[2]),true)))){return ["assign",expand(["decl",env],lhs),expand(["expr",env],rhs)];}else{if((τ49&&((τp0>=1)&&(((τp1=τ47[0]),(type=τp1),true,(((((((((((τp1==="js_while")||(τp1==="js_for"))||(τp1==="js_for_in"))||(τp1==="js_break"))||(τp1==="js_continue"))||(τp1==="js_return"))||(τp1==="js_delete"))||(τp1==="js_throw"))||(τp1==="js_try"))||(τp1==="js_new"))||(τp1==="if")))&&((args=τ47.slice(1)),true))))){var ctxs=(send(js_contexts,type)||[]);var f=function(x,i){return expand([(send(ctxs,i)||"expr"),env],x);};return τ42([type],args.map(f));}else{if((τ49&&((τp0===2)&&(((τp1=τ47[0]),(τp1==="done"))&&((expr=τ47[1]),true))))){return expr;}else{if(((other=τ47),true)){throw τ96(["syntax","illegal_node"]).create("An illegal node was found in expand",({"node":other}));}else{throw ["Could not find a match",τ47];}}}}}}}}}}}}}};(expand["step"]=function(τ79,τ80){var τp0;var context;var env;if(((τ79 instanceof Array)&&(((τp0=τ79.length),true)&&((τp0===2)&&((context=τ79[0]),true,(env=τ79[1]),true))))){undefined;}else{throw τ95(τ96(["match"]).create("The value failed to match"),({"location":["location",(void 0),(void 0),(void 0)]}));}var expr;var τ78;(expr=τ80);true;(τ78=τ80);var τ81=τ78;var τp0;var τp1;var s;var τp0;var τp1;var τp0;var τp1;var m;var τp0;var τp1;var m;var τp0;var τp1;var f;var arg;var τp0;var type;var args;var other;var τ82=false;var τ83=false;var τ84=false;var τ85=false;if(((τ82=(τ81 instanceof Array))&&((τ83=((τp0=τ81.length),true))&&((τp0===2)&&(((τp1=τ81[0]),(τp1==="symbol"))&&((s=τ81[1]),true)))))){var v=env.resolve(s);var τ86=[v,context];var τp0;var τp1;var _;var τp0;var τp1;var τp2;var τp3;var m;var τp4;var τp0;var τp1;var τp2;var τp3;var m;var _;var other;var τ87=false;var τ88=false;var τ89=false;var τ90=false;var τ91=false;var τ92=false;var τ93=false;if(((τ87=(τ86 instanceof Array))&&((τ88=((τp0=τ86.length),true))&&((τ89=(τp0===2))&&(((τp1=τ86[0]),(τp1===(void 0)))&&((_=τ86[1]),true)))))){return ["symbol",s];}else{if((τ89&&((τ90=((τp1=τ86[0]),(τp1 instanceof Array)))&&((τ91=((τp2=τp1.length),true))&&((τ92=(τp2===2))&&((τ93=((τp3=τp1[0]),(τp3==="macro")))&&((m=τp1[1]),true,(τp4=τ86[1]),(τp4==="head")))))))){return v;}else{if((τ93&&((m=τp1[1]),true,(_=τ86[1]),true))){return expand.step([context,env],m([context,env],["void"]));}else{if(((other=τ86),true)){return v;}else{throw ["Could not find a match",τ86];}}}}}else{if((τ83&&((τp0===1)&&((τp1=τ81[0]),(τp1==="void"))))){return ["void"];}else{if((τ83&&((τ84=(τp0===2))&&((τ85=((τp1=τ81[0]),(τp1==="macro")))&&((m=τ81[1]),true,(context==="head")))))){return expr;}else{if((τ85&&((m=τ81[1]),true,true))){return expand.step([context,env],m([context,env],["void"]));}else{if((τ83&&((τp0===3)&&(((τp1=τ81[0]),(τp1==="send"))&&((f=τ81[1]),true,(arg=τ81[2]),true))))){var τ94=expand.step(["head",env],f);var τp0;var τp1;var m;var other;if(((τ94 instanceof Array)&&(((τp0=τ94.length),true)&&((τp0===2)&&(((τp1=τ94[0]),(τp1==="macro"))&&((m=τ94[1]),true)))))){return expand.step([context,env],m([context,env],arg));}else{if(((other=τ94),true)){return expr;}else{throw ["Could not find a match",τ94];}}}else{if((τ83&&((τp0>=1)&&((type=τ81[0]),true,(args=τ81.slice(1)),true)))){return expr;}else{if(((other=τ81),true)){throw τ96(["syntax","illegal_node"]).create("An illegal node was found in expand.step",({"node":other}));}else{throw ["Could not find a match",τ81];}}}}}}}});(exports["expand"]=expand);(exports["Env"]=Env);(exports["nullenv"]=nullenv);
