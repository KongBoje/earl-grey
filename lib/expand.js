var τ63=function(type){var τ64=type["::check"];var f;if((τ64===(void 0))){return function(value){return (value instanceof type);};}else{if(((f=τ64),true)){return function(value){return f.call(type,value);};}else{throw τ55(["match"]).create("Could not find a match",({"value":τ64}));}}};
var τ65=function(dest,values){for(k in values){if(values.hasOwnProperty(k)){(dest[k]=send(values,k));}else{null;}}return dest;};
var τ55=function(){var τ56=function(tags){var τ57=function(){if((!τ63(τ56)(this))){return Object.create(τ56.prototype);}else{return this;}}();(τ57["tags"]=tags);return τ57;};τ65(τ56);(τ56.prototype["create"]=function(){var τ58=Array.prototype.slice.call(arguments,0);var τp0;var message;var args;if(((τ58 instanceof Array)&&(((τp0=τ58.length),true)&&((τp0>=0)&&((message=function(){if((0>=τp0)){return "";}else{return τ58[0];}}()),true,(args=τ58.slice(1)),true))))){var τ57=this;var e=Error(message);(e["::tags"]=τ57.tags);(e["args"]=args);(e["name"]=["E"].concat(τ57.tags).join("."));return e;}else{throw τ55(["match"]).create("Could not find a match",({"value":τ58}));}});(τ56.prototype["::check"]=function(e){var τ57=this;if(((!e)||(!τ63(Error)(e)))){return false;}else{null;}var tags=(e["::tags"]||[]);var τ59=τ57.tags;var τ60=τ59.length;for(var τ61=0;(τ61<τ60);(τ61++)){var τ62=τ59[τ61];var tag;var other;if(((tag=τ62),true,(tags.indexOf(tag)===(-1)))){return false;}else{if(((other=τ62),true)){false;}else{throw τ55(["match"]).create("Could not find a match",({"value":τ62}));}}}false;return true;});(τ56.prototype["::deconstruct"]=function(e){var τ57=this;return e.args;});return τ56;}();
var τ66=function(){var r=[];for(var i=0;(i<arguments.length);(i++)){(r=r.concat(arguments[i]));}return r;};
var τ67=function(τ68){var τ69=τ68;var x;var x;var other;if((((typeof(τ69)==="string")&&((x=τ69),true))||((typeof(τ69)==="number")&&((x=τ69),true)))){return ["value",x];}else{if(((other=τ69),true)){return other["::serialize_ast"]();}else{throw τ55(["match"]).create("Could not find a match",({"value":τ69}));}}};
var send=function(obj,τ48){var msg;var τ47;(msg=τ48);true;(τ47=τ48);var τ49=τ47;var other;if(((typeof(τ49)==="string")||(typeof(τ49)==="number"))){return obj[msg];}else{if(((other=τ49),true)){return obj["::send"](msg);}else{throw τ55(["match"]).create("Could not find a match",({"value":τ49}));}}};(Array[":::project"]=function(τ51){var value;var τ50;(value=τ51);true;(τ50=τ51);var τ52=τ50;var _;if(τ63(Array)(τ52)){return [true,value];}else{if(((_=τ52),true)){return [true,[value]];}else{throw τ55(["match"]).create("Could not find a match",({"value":τ52}));}}});(Array.prototype["::check"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){return false;}else{null;}}return true;}else{return false;}});(Array.prototype[":::project"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){var rval=this.slice(0);rval.push(value);return [true,rval];}else{null;}}return [true,value];}else{var rval=this.slice(0);rval.push(value);return [true,rval];}});(Array.prototype[":::deconstruct"]=function(value){return [true,value.slice(this.length)];});(Array.prototype["::serialize_ast"]=function(){return τ66(["array"],this.map(τ67));});(RegExp.prototype["::check"]=function(value){return value.match(this);});(RegExp.prototype[":::project"]=function(value){var τ53=value.match(this);var m;var m;if(((τ53===null)&&((m=τ53),true))){return [false,null];}else{if(((m=τ53),true)){return [true,m];}else{throw τ55(["match"]).create("Could not find a match",({"value":τ53}));}}});(RegExp.prototype[":::deconstruct"]=function(value){var τ54=value.match(this);var m;var m;if(((τ54===null)&&((m=τ54),true))){return [false,null];}else{if(((m=τ54),true)){return [true,m];}else{throw τ55(["match"]).create("Could not find a match",({"value":τ54}));}}});(Function.prototype["::send"]=function(args){return this.apply(this,args);});var Env=function(parent){var store=Object();var self=function(expr){return ["bind_env",self,expr];};(self["resolve"]=function(name){var attempt=send(store,name);if(attempt){return attempt;}else{return self.parent.resolve(name);}});(self["register"]=function(name,value){return (store[name]=value);});(self["register_macro"]=function(name,m){return (store[name]=["macro",m]);});(self["fork"]=function(){return Env(self);});(self["parent"]=parent);(self["store"]=store);return self;};var nullenv=({"resolve":function(x){return undefined;}});var js_contexts=({"js_for":["multi","multi","multi","multi"]});var expand=function(τ70,expr){var τp0;var context;var env;if(((τ70 instanceof Array)&&(((τp0=τ70.length),true)&&((τp0===2)&&((context=τ70[0]),true,(env=τ70[1]),true))))){undefined;}else{throw τ55(["match"]).create("The value failed to match");}(expr=expand.step([context,env],expr));var τ71=expr;var τp0;var τp1;var s;var τp0;var τp1;var τp0;var τp1;var f;var arg;var τp0;var τp1;var v;var τp0;var τp1;var type;var args;var τp0;var τp1;var args;var τp0;var τp1;var args;var τp0;var τp1;var bindings;var body;var τp0;var τp1;var binding;var value;var τp0;var τp1;var lhs;var rhs;var τp0;var τp1;var type;var args;var τp0;var τp1;var expr;var other;var τ72=false;var τ73=false;var τ74=false;if(((τ72=(τ71 instanceof Array))&&((τ73=((τp0=τ71.length),true))&&((τp0===2)&&(((τp1=τ71[0]),(τp1==="symbol"))&&((s=τ71[1]),true)))))){return expr;}else{if((τ73&&((τp0===1)&&((τp1=τ71[0]),(τp1==="void"))))){return ["void"];}else{if((τ73&&((τp0===3)&&(((τp1=τ71[0]),(τp1==="send"))&&((f=τ71[1]),true,(arg=τ71[2]),true))))){(f=expand(["head",env],f));return ["send",f,expand(["tail",env],arg)];}else{if((τ73&&((τp0===2)&&(((τp1=τ71[0]),(τp1==="value"))&&((v=τ71[1]),true))))){return expr;}else{if((τ73&&((τ74=(τp0>=1))&&(((τp1=τ71[0]),(type=τp1),true,((τp1==="array")||(τp1==="object")))&&((args=τ71.slice(1)),true))))){var arr=[];while((args.length>0)){var τ75=expand.step([type,env],args.shift());var τp0;var τp1;var stmts;var other;if(((τ75 instanceof Array)&&(((τp0=τ75.length),true)&&((τp0>=1)&&(((τp1=τ75[0]),(τp1==="splice"))&&((stmts=τ75.slice(1)),true)))))){(args=stmts.concat(args));}else{if(((other=τ75),true)){arr.push(other);}else{throw τ55(["match"]).create("Could not find a match",({"value":τ75}));}}}return [type].concat(function(){var τ76=[];var τ77=arr;var τ78=τ77.length;for(var τ79=0;(τ79<τ78);(τ79++)){var τ80=τ77[τ79];var x;var other;if(((x=τ80),true)){τ76.push(expand([type,env],x));}else{if(((other=τ80),true)){false;}else{throw τ55(["match"]).create("Could not find a match",({"value":τ80}));}}}return τ76;}());}else{if((τ74&&(((τp1=τ71[0]),(τp1==="multi"))&&((args=τ71.slice(1)),true)))){var arr=[];while((args.length>0)){var type=function(){if((args.length===1)){return "expr";}else{return "multi";}}();var τ81=expand.step([type,env],args.shift());var τp0;var τp1;var stmts;var τp0;var τp1;var stmt;var other;var τ82=false;var τ83=false;if(((τ82=(τ81 instanceof Array))&&((τ83=((τp0=τ81.length),true))&&((τp0>=1)&&(((τp1=τ81[0]),(τp1==="splice"))&&((stmts=τ81.slice(1)),true)))))){(args=stmts.concat(args));}else{if((τ83&&((τp0===2)&&(((τp1=τ81[0]),(τp1==="sink"))&&((stmt=τ81[1]),true))))){args.push(stmt);}else{if(((other=τ81),true)){arr.push([other,type]);}else{throw τ55(["match"]).create("Could not find a match",({"value":τ81}));}}}}return ["multi"].concat(function(){var τ84=[];var τ85=arr;var τ86=τ85.length;for(var τ87=0;(τ87<τ86);(τ87++)){var τ88=τ85[τ87];var τp0;var x;var type;var other;if(((τ88 instanceof Array)&&(((τp0=τ88.length),true)&&((τp0===2)&&((x=τ88[0]),true,(type=τ88[1]),true))))){τ84.push(expand([type,env],x));}else{if(((other=τ88),true)){false;}else{throw τ55(["match"]).create("Could not find a match",({"value":τ88}));}}}return τ84;}());}else{if((τ74&&(((τp1=τ71[0]),(τp1==="data"))&&((args=τ71.slice(1)),true)))){var is_obj=false;var obj=["object"];var arr=["array"];var parts=[];var newpart=function(){var τ89=arr;var τp0;var τp1;var other;if(((τ89 instanceof Array)&&(((τp0=τ89.length),true)&&((τp0===1)&&((τp1=τ89[0]),(τp1==="array")))))){return false;}else{if(((other=τ89),true)){parts.push(arr);return (arr=["array"]);}else{throw τ55(["match"]).create("Could not find a match",({"value":τ89}));}}};while((args.length>0)){var τ90=expand.step(["data",env],args.shift());var τp0;var τp1;var τp0;var τp1;var k;var v;var τp0;var τp1;var exprs;var τp0;var τp1;var expr;var other;var τ91=false;var τ92=false;if(((τ91=(τ90 instanceof Array))&&((τ92=((τp0=τ90.length),true))&&((τp0===1)&&((τp1=τ90[0]),(τp1==="assoc")))))){(is_obj=true);}else{if((τ92&&((τp0===3)&&(((τp1=τ90[0]),(τp1==="assoc"))&&((k=τ90[1]),true,(v=τ90[2]),true))))){(is_obj=true);obj.push(["array",k,v]);}else{if((τ92&&((τp0>=1)&&(((τp1=τ90[0]),(τp1==="splice"))&&((exprs=τ90.slice(1)),true))))){(args=exprs.concat(args));}else{if((τ92&&((τp0===2)&&(((τp1=τ90[0]),(τp1==="dynsplice"))&&((expr=τ90[1]),true))))){newpart();parts.push(expr);}else{if(((other=τ90),true)){arr.push(other);}else{throw τ55(["match"]).create("Could not find a match",({"value":τ90}));}}}}}}newpart();var r=function(){var τ93=parts;var τp0;var τp0;var τp0;var τp1;var arr;var τp2;var τp3;var things;var other;var τ94=false;var τ95=false;var τ96=false;if(((τ94=(τ93 instanceof Array))&&((τ95=((τp0=τ93.length),true))&&((τ96=(τp0===0))&&is_obj)))){return obj;}else{if(τ96){return ["array"];}else{if((τ95&&((τp0===1)&&(((τp1=τ93[0]),(arr=τp1),true,(τp1 instanceof Array))&&(((τp2=τp1.length),true)&&((τp2>=1)&&(((τp3=τp1[0]),(τp3==="array"))&&((things=τp1.slice(1)),true)))))))){if(is_obj){arr.push(obj);}else{null;}return arr;}else{if(((other=τ93),true)){if(is_obj){parts.push(["array",obj]);}else{null;}var patch=["symbol","patch_array"];return ["send",patch,τ66(["array"],parts)];}else{throw τ55(["match"]).create("Could not find a match",({"value":τ93}));}}}}}();return expand([context,env],r);}else{if((τ73&&((τ74=(τp0===3))&&(((τp1=τ71[0]),(τp1==="lambda"))&&((bindings=τ71[1]),true,(body=τ71[2]),true))))){return ["lambda",function(){var τ97=[];var τ98=bindings;var τ99=τ98.length;for(var τ100=0;(τ100<τ99);(τ100++)){var τ101=τ98[τ100];var x;var other;if(((x=τ101),true)){τ97.push(expand(["decl",env],x));}else{if(((other=τ101),true)){false;}else{throw τ55(["match"]).create("Could not find a match",({"value":τ101}));}}}return τ97;}(),expand(["expr",env],body)];}else{if((τ74&&(((τp1=τ71[0]),(τp1==="declare"))&&((binding=τ71[1]),true,(value=τ71[2]),true)))){return ["declare",expand(["decl",env],binding),expand(["expr",env],value)];}else{if((τ74&&(((τp1=τ71[0]),(τp1==="assign"))&&((lhs=τ71[1]),true,(rhs=τ71[2]),true)))){return ["assign",expand(["decl",env],lhs),expand(["expr",env],rhs)];}else{if((τ73&&((τp0>=1)&&(((τp1=τ71[0]),(type=τp1),true,(((((((((((τp1==="js_while")||(τp1==="js_for"))||(τp1==="js_for_in"))||(τp1==="js_break"))||(τp1==="js_continue"))||(τp1==="js_return"))||(τp1==="js_delete"))||(τp1==="js_throw"))||(τp1==="js_try"))||(τp1==="js_new"))||(τp1==="if")))&&((args=τ71.slice(1)),true))))){var ctxs=(send(js_contexts,type)||[]);var f=function(x,i){return expand([(send(ctxs,i)||"expr"),env],x);};return τ66([type],args.map(f));}else{if((τ73&&((τp0===2)&&(((τp1=τ71[0]),(τp1==="done"))&&((expr=τ71[1]),true))))){return expr;}else{if(((other=τ71),true)){throw τ55(["syntax","illegal_node"]).create("An illegal node was found in expand",({"node":other}));}else{throw τ55(["match"]).create("Could not find a match",({"value":τ71}));}}}}}}}}}}}}}};(expand["step"]=function(τ103,τ104){var τp0;var context;var env;if(((τ103 instanceof Array)&&(((τp0=τ103.length),true)&&((τp0===2)&&((context=τ103[0]),true,(env=τ103[1]),true))))){undefined;}else{throw τ55(["match"]).create("The value failed to match");}var expr;var τ102;(expr=τ104);true;(τ102=τ104);var τ105=τ102;var τp0;var τp1;var s;var τp0;var τp1;var τp0;var τp1;var m;var τp0;var τp1;var m;var τp0;var τp1;var f;var arg;var τp0;var type;var args;var other;var τ106=false;var τ107=false;var τ108=false;var τ109=false;if(((τ106=(τ105 instanceof Array))&&((τ107=((τp0=τ105.length),true))&&((τp0===2)&&(((τp1=τ105[0]),(τp1==="symbol"))&&((s=τ105[1]),true)))))){var v=env.resolve(s);var τ110=[v,context];var τp0;var τp1;var _;var τp0;var τp1;var τp2;var τp3;var m;var τp4;var τp0;var τp1;var τp2;var τp3;var m;var _;var other;var τ111=false;var τ112=false;var τ113=false;var τ114=false;var τ115=false;var τ116=false;var τ117=false;if(((τ111=(τ110 instanceof Array))&&((τ112=((τp0=τ110.length),true))&&((τ113=(τp0===2))&&(((τp1=τ110[0]),(τp1===(void 0)))&&((_=τ110[1]),true)))))){return ["symbol",s];}else{if((τ113&&((τ114=((τp1=τ110[0]),(τp1 instanceof Array)))&&((τ115=((τp2=τp1.length),true))&&((τ116=(τp2===2))&&((τ117=((τp3=τp1[0]),(τp3==="macro")))&&((m=τp1[1]),true,(τp4=τ110[1]),(τp4==="head")))))))){return v;}else{if((τ117&&((m=τp1[1]),true,(_=τ110[1]),true))){return expand.step([context,env],m([context,env],["void"]));}else{if(((other=τ110),true)){return v;}else{throw τ55(["match"]).create("Could not find a match",({"value":τ110}));}}}}}else{if((τ107&&((τp0===1)&&((τp1=τ105[0]),(τp1==="void"))))){return ["void"];}else{if((τ107&&((τ108=(τp0===2))&&((τ109=((τp1=τ105[0]),(τp1==="macro")))&&((m=τ105[1]),true,(context==="head")))))){return expr;}else{if((τ109&&((m=τ105[1]),true))){return expand.step([context,env],m([context,env],["void"]));}else{if((τ107&&((τp0===3)&&(((τp1=τ105[0]),(τp1==="send"))&&((f=τ105[1]),true,(arg=τ105[2]),true))))){var τ118=expand.step(["head",env],f);var τp0;var τp1;var m;var other;if(((τ118 instanceof Array)&&(((τp0=τ118.length),true)&&((τp0===2)&&(((τp1=τ118[0]),(τp1==="macro"))&&((m=τ118[1]),true)))))){return expand.step([context,env],m([context,env],arg));}else{if(((other=τ118),true)){return expr;}else{throw τ55(["match"]).create("Could not find a match",({"value":τ118}));}}}else{if((τ107&&((τp0>=1)&&((type=τ105[0]),true,(args=τ105.slice(1)),true)))){return expr;}else{if(((other=τ105),true)){throw τ55(["syntax","illegal_node"]).create("An illegal node was found in expand.step",({"node":other}));}else{throw τ55(["match"]).create("Could not find a match",({"value":τ105}));}}}}}}}});(expand["step_all"]=function(context,τ119){var τp0;var stmts;if(((τ119 instanceof Array)&&(((τp0=τ119.length),true)&&((τp0>=0)&&((stmts=τ119.slice(0)),true))))){undefined;}else{throw τ55(["match"]).create("The value failed to match");}var pre=[];var bulk=[];var post=[];while(stmts.length){var τ120=expand.step(context,stmts.shift());var τp0;var τp1;var prepend;var τp0;var τp1;var stmt;var τp0;var τp1;var stmt;var τp0;var τp1;var m;var x;var τ121=false;var τ122=false;var τ123=false;if(((τ121=(τ120 instanceof Array))&&((τ122=((τp0=τ120.length),true))&&((τp0>=1)&&(((τp1=τ120[0]),(τp1==="splice"))&&((prepend=τ120.slice(1)),true)))))){(stmts=prepend.concat(stmts));}else{if((τ122&&((τ123=(τp0===2))&&(((τp1=τ120[0]),(τp1==="float"))&&((stmt=τ120[1]),true))))){(pre=pre.concat(expand.step_all(context,[stmt])));}else{if((τ123&&(((τp1=τ120[0]),(τp1==="sink"))&&((stmt=τ120[1]),true)))){(post=post.concat(expand.step_all(context,[stmt])));}else{if((τ123&&(((τp1=τ120[0]),(τp1==="multimacro"))&&((m=τ120[1]),true)))){(stmts=m(context,stmts));}else{if(((x=τ120),true)){bulk.push(x);}else{throw τ55(["match"]).create("Could not find a match",({"value":τ120}));}}}}}}return pre.concat(bulk).concat(post);});(exports["expand"]=expand);(exports["Env"]=Env);(exports["nullenv"]=nullenv);
