var τ61=function(type){var τ62=type["::check"];var f;if((τ62===(void 0))){return function(value){return (value instanceof type);};}else{if(((f=τ62),true)){return function(value){return f.call(type,value);};}else{throw τ53(["match"]).create("Could not find a match",({"value":τ62}));}}};
var τ63=function(dest,values){for(k in values){if(values.hasOwnProperty(k)){(dest[k]=send(values,k));}else{null;}}return dest;};
var τ53=function(){var τ54=function(tags){var τ55=function(){if((!τ61(τ54)(this))){return Object.create(τ54.prototype);}else{return this;}}();(τ55["tags"]=tags);return τ55;};τ63(τ54);(τ54.prototype["create"]=function(){var τ56=Array.prototype.slice.call(arguments,0);var τp0;var message;var args;if(((τ56 instanceof Array)&&(((τp0=τ56.length),true)&&((τp0>=0)&&((message=function(){if((0>=τp0)){return "";}else{return τ56[0];}}()),true,(args=τ56.slice(1)),true))))){var τ55=this;var e=Error(message);(e["::tags"]=τ55.tags);(e["args"]=args);(e["name"]=["E"].concat(τ55.tags).join("."));return e;}else{throw τ53(["match"]).create("Could not find a match",({"value":τ56}));}});(τ54.prototype["::check"]=function(e){var τ55=this;if(((!e)||(!τ61(Error)(e)))){return false;}else{null;}var tags=(e["::tags"]||[]);var τ57=τ55.tags;var τ58=τ57.length;for(var τ59=0;(τ59<τ58);(τ59++)){var τ60=τ57[τ59];var tag;var other;if(((tag=τ60),true,(tags.indexOf(tag)===(-1)))){return false;}else{if(((other=τ60),true)){false;}else{throw τ53(["match"]).create("Could not find a match",({"value":τ60}));}}}false;return true;});(τ54.prototype["::deconstruct"]=function(e){var τ55=this;return e.args;});return τ54;}();
var τ64=function(){var r=[];for(var i=0;(i<arguments.length);(i++)){(r=r.concat(arguments[i]));}return r;};
var τ65=function(τ66){var τ67=τ66;var x;var x;var other;if((((typeof(τ67)==="string")&&((x=τ67),true))||((typeof(τ67)==="number")&&((x=τ67),true)))){return ["value",x];}else{if(((other=τ67),true)){return other["::serialize_ast"]();}else{throw τ53(["match"]).create("Could not find a match",({"value":τ67}));}}};
var send=function(obj,τ46){var msg;var τ45;(msg=τ46);true;(τ45=τ46);var τ47=τ45;var other;if(((typeof(τ47)==="string")||(typeof(τ47)==="number"))){return obj[msg];}else{if(((other=τ47),true)){return obj["::send"](msg);}else{throw τ53(["match"]).create("Could not find a match",({"value":τ47}));}}};(Array[":::project"]=function(τ49){var value;var τ48;(value=τ49);true;(τ48=τ49);var τ50=τ48;var _;if(τ61(Array)(τ50)){return [true,value];}else{if(((_=τ50),true)){return [true,[value]];}else{throw τ53(["match"]).create("Could not find a match",({"value":τ50}));}}});(Array.prototype["::check"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){return false;}else{null;}}return true;}else{return false;}});(Array.prototype[":::project"]=function(value){if((value instanceof Array)){for(var i=0;(i<this.length);(i++)){if((send(this,i)!==send(value,i))){var rval=this.slice(0);rval.push(value);return [true,rval];}else{null;}}return [true,value];}else{var rval=this.slice(0);rval.push(value);return [true,rval];}});(Array.prototype[":::deconstruct"]=function(value){return [true,value.slice(this.length)];});(Array.prototype["::serialize_ast"]=function(){return τ64(["array"],this.map(τ65));});(RegExp.prototype["::check"]=function(value){return value.match(this);});(RegExp.prototype[":::project"]=function(value){var τ51=value.match(this);var m;var m;if(((τ51===null)&&((m=τ51),true))){return [false,null];}else{if(((m=τ51),true)){return [true,m];}else{throw τ53(["match"]).create("Could not find a match",({"value":τ51}));}}});(RegExp.prototype[":::deconstruct"]=function(value){var τ52=value.match(this);var m;var m;if(((τ52===null)&&((m=τ52),true))){return [false,null];}else{if(((m=τ52),true)){return [true,m];}else{throw τ53(["match"]).create("Could not find a match",({"value":τ52}));}}});(Function.prototype["::send"]=function(args){return this.apply(this,args);});var Env=function(parent){var store=Object();var self=function(expr){return ["bind_env",self,expr];};(self["resolve"]=function(name){var attempt=send(store,name);if(attempt){return attempt;}else{return self.parent.resolve(name);}});(self["register"]=function(name,value){return (store[name]=value);});(self["register_macro"]=function(name,m){return (store[name]=["macro",m]);});(self["fork"]=function(){return Env(self);});(self["parent"]=parent);(self["store"]=store);return self;};var nullenv=({"resolve":function(x){return undefined;}});var js_contexts=({"js_for":["multi","multi","multi","multi"]});var expand=function(τ68,expr){var τp0;var context;var env;if(((τ68 instanceof Array)&&(((τp0=τ68.length),true)&&((τp0===2)&&((context=τ68[0]),true,(env=τ68[1]),true))))){undefined;}else{throw τ53(["match"]).create("The value failed to match");}(expr=expand.step([context,env],expr));var τ69=expr;var τp0;var τp1;var s;var τp0;var τp1;var τp0;var τp1;var f;var arg;var τp0;var τp1;var v;var τp0;var τp1;var type;var args;var τp0;var τp1;var args;var τp0;var τp1;var args;var τp0;var τp1;var bindings;var body;var τp0;var τp1;var binding;var value;var τp0;var τp1;var lhs;var rhs;var τp0;var τp1;var type;var args;var τp0;var τp1;var expr;var other;var τ70=false;var τ71=false;var τ72=false;if(((τ70=(τ69 instanceof Array))&&((τ71=((τp0=τ69.length),true))&&((τp0===2)&&(((τp1=τ69[0]),(τp1==="symbol"))&&((s=τ69[1]),true)))))){return expr;}else{if((τ71&&((τp0===1)&&((τp1=τ69[0]),(τp1==="void"))))){return ["void"];}else{if((τ71&&((τp0===3)&&(((τp1=τ69[0]),(τp1==="send"))&&((f=τ69[1]),true,(arg=τ69[2]),true))))){(f=expand(["head",env],f));return ["send",f,expand(["tail",env],arg)];}else{if((τ71&&((τp0===2)&&(((τp1=τ69[0]),(τp1==="value"))&&((v=τ69[1]),true))))){return expr;}else{if((τ71&&((τ72=(τp0>=1))&&(((τp1=τ69[0]),(type=τp1),true,((τp1==="array")||(τp1==="object")))&&((args=τ69.slice(1)),true))))){var arr=[];while((args.length>0)){var τ73=expand.step([type,env],args.shift());var τp0;var τp1;var stmts;var other;if(((τ73 instanceof Array)&&(((τp0=τ73.length),true)&&((τp0>=1)&&(((τp1=τ73[0]),(τp1==="splice"))&&((stmts=τ73.slice(1)),true)))))){(args=stmts.concat(args));}else{if(((other=τ73),true)){arr.push(other);}else{throw τ53(["match"]).create("Could not find a match",({"value":τ73}));}}}return [type].concat(function(){var τ74=[];var τ75=arr;var τ76=τ75.length;for(var τ77=0;(τ77<τ76);(τ77++)){var τ78=τ75[τ77];var x;var other;if(((x=τ78),true)){τ74.push(expand([type,env],x));}else{if(((other=τ78),true)){false;}else{throw τ53(["match"]).create("Could not find a match",({"value":τ78}));}}}return τ74;}());}else{if((τ72&&(((τp1=τ69[0]),(τp1==="multi"))&&((args=τ69.slice(1)),true)))){var arr=[];while((args.length>0)){var type=function(){if((args.length===1)){return "expr";}else{return "multi";}}();var τ79=expand.step([type,env],args.shift());var τp0;var τp1;var stmts;var τp0;var τp1;var stmt;var other;var τ80=false;var τ81=false;if(((τ80=(τ79 instanceof Array))&&((τ81=((τp0=τ79.length),true))&&((τp0>=1)&&(((τp1=τ79[0]),(τp1==="splice"))&&((stmts=τ79.slice(1)),true)))))){(args=stmts.concat(args));}else{if((τ81&&((τp0===2)&&(((τp1=τ79[0]),(τp1==="sink"))&&((stmt=τ79[1]),true))))){args.push(stmt);}else{if(((other=τ79),true)){arr.push([other,type]);}else{throw τ53(["match"]).create("Could not find a match",({"value":τ79}));}}}}return ["multi"].concat(function(){var τ82=[];var τ83=arr;var τ84=τ83.length;for(var τ85=0;(τ85<τ84);(τ85++)){var τ86=τ83[τ85];var τp0;var x;var type;var other;if(((τ86 instanceof Array)&&(((τp0=τ86.length),true)&&((τp0===2)&&((x=τ86[0]),true,(type=τ86[1]),true))))){τ82.push(expand([type,env],x));}else{if(((other=τ86),true)){false;}else{throw τ53(["match"]).create("Could not find a match",({"value":τ86}));}}}return τ82;}());}else{if((τ72&&(((τp1=τ69[0]),(τp1==="data"))&&((args=τ69.slice(1)),true)))){var is_obj=false;var obj=["object"];var arr=["array"];var parts=[];var newpart=function(){var τ87=arr;var τp0;var τp1;var other;if(((τ87 instanceof Array)&&(((τp0=τ87.length),true)&&((τp0===1)&&((τp1=τ87[0]),(τp1==="array")))))){return false;}else{if(((other=τ87),true)){parts.push(arr);return (arr=["array"]);}else{throw τ53(["match"]).create("Could not find a match",({"value":τ87}));}}};while((args.length>0)){var τ88=expand.step([type,env],args.shift());var τp0;var τp1;var τp0;var τp1;var k;var v;var τp0;var τp1;var exprs;var τp0;var τp1;var expr;var other;var τ89=false;var τ90=false;if(((τ89=(τ88 instanceof Array))&&((τ90=((τp0=τ88.length),true))&&((τp0===1)&&((τp1=τ88[0]),(τp1==="assoc")))))){(is_obj=true);}else{if((τ90&&((τp0===3)&&(((τp1=τ88[0]),(τp1==="assoc"))&&((k=τ88[1]),true,(v=τ88[2]),true))))){(is_obj=true);obj.push(["array",k,v]);}else{if((τ90&&((τp0>=1)&&(((τp1=τ88[0]),(τp1==="splice"))&&((exprs=τ88.slice(1)),true))))){(args=exprs.concat(args));}else{if((τ90&&((τp0===2)&&(((τp1=τ88[0]),(τp1==="dynsplice"))&&((expr=τ88[1]),true))))){newpart();parts.push(expr);}else{if(((other=τ88),true)){arr.push(other);}else{throw τ53(["match"]).create("Could not find a match",({"value":τ88}));}}}}}}newpart();var r=function(){var τ91=parts;var τp0;var τp0;var τp0;var τp1;var arr;var τp2;var τp3;var things;var other;var τ92=false;var τ93=false;var τ94=false;if(((τ92=(τ91 instanceof Array))&&((τ93=((τp0=τ91.length),true))&&((τ94=(τp0===0))&&is_obj)))){return obj;}else{if(τ94){return ["array"];}else{if((τ93&&((τp0===1)&&(((τp1=τ91[0]),(arr=τp1),true,(τp1 instanceof Array))&&(((τp2=τp1.length),true)&&((τp2>=1)&&(((τp3=τp1[0]),(τp3==="array"))&&((things=τp1.slice(1)),true)))))))){if(is_obj){arr.push(obj);}else{null;}return arr;}else{if(((other=τ91),true)){if(is_obj){parts.push(["array",obj]);}else{null;}var patch=["symbol","patch_array"];return ["send",patch,τ64(["array"],parts)];}else{throw τ53(["match"]).create("Could not find a match",({"value":τ91}));}}}}}();return expand([context,env],r);}else{if((τ71&&((τ72=(τp0===3))&&(((τp1=τ69[0]),(τp1==="lambda"))&&((bindings=τ69[1]),true,(body=τ69[2]),true))))){return ["lambda",function(){var τ95=[];var τ96=bindings;var τ97=τ96.length;for(var τ98=0;(τ98<τ97);(τ98++)){var τ99=τ96[τ98];var x;var other;if(((x=τ99),true)){τ95.push(expand(["decl",env],x));}else{if(((other=τ99),true)){false;}else{throw τ53(["match"]).create("Could not find a match",({"value":τ99}));}}}return τ95;}(),expand(["expr",env],body)];}else{if((τ72&&(((τp1=τ69[0]),(τp1==="declare"))&&((binding=τ69[1]),true,(value=τ69[2]),true)))){return ["declare",expand(["decl",env],binding),expand(["expr",env],value)];}else{if((τ72&&(((τp1=τ69[0]),(τp1==="assign"))&&((lhs=τ69[1]),true,(rhs=τ69[2]),true)))){return ["assign",expand(["decl",env],lhs),expand(["expr",env],rhs)];}else{if((τ71&&((τp0>=1)&&(((τp1=τ69[0]),(type=τp1),true,(((((((((((τp1==="js_while")||(τp1==="js_for"))||(τp1==="js_for_in"))||(τp1==="js_break"))||(τp1==="js_continue"))||(τp1==="js_return"))||(τp1==="js_delete"))||(τp1==="js_throw"))||(τp1==="js_try"))||(τp1==="js_new"))||(τp1==="if")))&&((args=τ69.slice(1)),true))))){var ctxs=(send(js_contexts,type)||[]);var f=function(x,i){return expand([(send(ctxs,i)||"expr"),env],x);};return τ64([type],args.map(f));}else{if((τ71&&((τp0===2)&&(((τp1=τ69[0]),(τp1==="done"))&&((expr=τ69[1]),true))))){return expr;}else{if(((other=τ69),true)){throw τ53(["syntax","illegal_node"]).create("An illegal node was found in expand",({"node":other}));}else{throw τ53(["match"]).create("Could not find a match",({"value":τ69}));}}}}}}}}}}}}}};(expand["step"]=function(τ101,τ102){var τp0;var context;var env;if(((τ101 instanceof Array)&&(((τp0=τ101.length),true)&&((τp0===2)&&((context=τ101[0]),true,(env=τ101[1]),true))))){undefined;}else{throw τ53(["match"]).create("The value failed to match");}var expr;var τ100;(expr=τ102);true;(τ100=τ102);var τ103=τ100;var τp0;var τp1;var s;var τp0;var τp1;var τp0;var τp1;var m;var τp0;var τp1;var m;var τp0;var τp1;var f;var arg;var τp0;var type;var args;var other;var τ104=false;var τ105=false;var τ106=false;var τ107=false;if(((τ104=(τ103 instanceof Array))&&((τ105=((τp0=τ103.length),true))&&((τp0===2)&&(((τp1=τ103[0]),(τp1==="symbol"))&&((s=τ103[1]),true)))))){var v=env.resolve(s);var τ108=[v,context];var τp0;var τp1;var _;var τp0;var τp1;var τp2;var τp3;var m;var τp4;var τp0;var τp1;var τp2;var τp3;var m;var _;var other;var τ109=false;var τ110=false;var τ111=false;var τ112=false;var τ113=false;var τ114=false;var τ115=false;if(((τ109=(τ108 instanceof Array))&&((τ110=((τp0=τ108.length),true))&&((τ111=(τp0===2))&&(((τp1=τ108[0]),(τp1===(void 0)))&&((_=τ108[1]),true)))))){return ["symbol",s];}else{if((τ111&&((τ112=((τp1=τ108[0]),(τp1 instanceof Array)))&&((τ113=((τp2=τp1.length),true))&&((τ114=(τp2===2))&&((τ115=((τp3=τp1[0]),(τp3==="macro")))&&((m=τp1[1]),true,(τp4=τ108[1]),(τp4==="head")))))))){return v;}else{if((τ115&&((m=τp1[1]),true,(_=τ108[1]),true))){return expand.step([context,env],m([context,env],["void"]));}else{if(((other=τ108),true)){return v;}else{throw τ53(["match"]).create("Could not find a match",({"value":τ108}));}}}}}else{if((τ105&&((τp0===1)&&((τp1=τ103[0]),(τp1==="void"))))){return ["void"];}else{if((τ105&&((τ106=(τp0===2))&&((τ107=((τp1=τ103[0]),(τp1==="macro")))&&((m=τ103[1]),true,(context==="head")))))){return expr;}else{if((τ107&&((m=τ103[1]),true))){return expand.step([context,env],m([context,env],["void"]));}else{if((τ105&&((τp0===3)&&(((τp1=τ103[0]),(τp1==="send"))&&((f=τ103[1]),true,(arg=τ103[2]),true))))){var τ116=expand.step(["head",env],f);var τp0;var τp1;var m;var other;if(((τ116 instanceof Array)&&(((τp0=τ116.length),true)&&((τp0===2)&&(((τp1=τ116[0]),(τp1==="macro"))&&((m=τ116[1]),true)))))){return expand.step([context,env],m([context,env],arg));}else{if(((other=τ116),true)){return expr;}else{throw τ53(["match"]).create("Could not find a match",({"value":τ116}));}}}else{if((τ105&&((τp0>=1)&&((type=τ103[0]),true,(args=τ103.slice(1)),true)))){return expr;}else{if(((other=τ103),true)){throw τ53(["syntax","illegal_node"]).create("An illegal node was found in expand.step",({"node":other}));}else{throw τ53(["match"]).create("Could not find a match",({"value":τ103}));}}}}}}}});(expand["step_all"]=function(context,τ117){var τp0;var stmts;if(((τ117 instanceof Array)&&(((τp0=τ117.length),true)&&((τp0>=0)&&((stmts=τ117.slice(0)),true))))){undefined;}else{throw τ53(["match"]).create("The value failed to match");}var pre=[];var bulk=[];var post=[];while(stmts.length){var τ118=expand.step(context,stmts.shift());var τp0;var τp1;var prepend;var τp0;var τp1;var stmt;var τp0;var τp1;var stmt;var τp0;var τp1;var m;var x;var τ119=false;var τ120=false;var τ121=false;if(((τ119=(τ118 instanceof Array))&&((τ120=((τp0=τ118.length),true))&&((τp0>=1)&&(((τp1=τ118[0]),(τp1==="splice"))&&((prepend=τ118.slice(1)),true)))))){(stmts=prepend.concat(stmts));}else{if((τ120&&((τ121=(τp0===2))&&(((τp1=τ118[0]),(τp1==="float"))&&((stmt=τ118[1]),true))))){(pre=pre.concat(expand.step_all(context,[stmt])));}else{if((τ121&&(((τp1=τ118[0]),(τp1==="sink"))&&((stmt=τ118[1]),true)))){(post=post.concat(expand.step_all(context,[stmt])));}else{if((τ121&&(((τp1=τ118[0]),(τp1==="multimacro"))&&((m=τ118[1]),true)))){(stmts=m(context,stmts));}else{if(((x=τ118),true)){bulk.push(x);}else{throw τ53(["match"]).create("Could not find a match",({"value":τ118}));}}}}}}return pre.concat(bulk).concat(post);});(exports["expand"]=expand);(exports["Env"]=Env);(exports["nullenv"]=nullenv);
