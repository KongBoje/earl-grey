var ___lib=require("./lib");var special_ops=({"(":"PFX","[":"PFX","{":"PFX",")":"SFX","]":"SFX","}":"SFX",",":"IFX",":":"IFX",".":"PFX"});var regexps=function(){var id=RegExp("(?:^[a-zA-Z$_](?:[a-zA-Z$_0-9]*))");var id_f=function(m,wsb,wsa,last_op){return ["ID","ID",m[0]];};var num=RegExp("(?:^((?:\\d+))(?:(?:\\.((?:\\d+)))?)(?:(?:[eE]((?:[+-]?)(?:\\d+)))?))");var num_f=function(m,wsb,wsa,last_op){return ["ID","NUM",m[0]];};var str=RegExp("(?:^\"((?:(?:(?:\\\\\\\\|\\\\\")|[^\"])*))\")");var str_f=function(m,wsb,wsa,last_op){var repl=({"\\\"":"\"","\\\\":"\\","\\n":"\n"});var r=m[1].replace(RegExp("((?:(?:\\\\\"|\\\\\\\\)|\\\\n))","g"),function(m){return repl[m];});return ["ID","STR",r];};var op=RegExp("(?:^(?:[+\\-*/~\\^<>=%&|?!#.:]+))");var op2=RegExp("(?:^[\\(\\[\\{\\}\\]\\),])");var op3=RegExp("(?:^(?:(?:(?:(?:(?:with|where)|and)|or)|in)|instanceof)\\b)");var op_f=function(m,wsb,wsa,last_op){var op=m[0];if((op in special_ops)){var fixity=special_ops[op];var width=function(){if((fixity=="IFX")){if((wsb||wsa)){return "wide";}else{return "short";}}else{if((fixity=="SFX")){if(wsb){return "wide";}else{return "short";}}else{if((fixity=="PFX")){if(wsa){return "wide";}else{return "short";}}else{return false;}}}}();return ["OP",fixity,width,op];}else{if((wsa&&wsb)){return ["OP",function(){if(last_op){return "PFX";}else{if(true){return "IFX";}else{return false;}}}(),"wide",op];}else{if(((!wsa)&&(!wsb))){return ["OP",function(){if(last_op){return "PFX";}else{if(true){return "IFX";}else{return false;}}}(),"short",op];}else{if(wsa){return ["OP",function(){if(last_op){return "PFX";}else{if(true){return "SFX";}else{return false;}}}(),"short",op];}else{if(wsb){return ["OP","PFX","short",op];}else{if(true){return ["OP","PFX","short",op];}else{return false;}}}}}}};var indent=RegExp("(?:^(?:(?:\n(?: *))+))");var indent_f=function(m,wsb,wsa,last_op){return ["OP","IFX","wide",","];};var cmnt=RegExp("(?:^;(?:[^\n]*))");var cmnt_f=function(m,wsb,wsa,last_op){return ["IGNORE"];};var unkn=RegExp("(?:^.)");var unkn_f=function(m,wsb,wsa,last_op){throw ("unknown character: "+m[0]);};return [[op3,op_f],[id,id_f],[num,num_f],[str,str_f],[op,op_f],[op2,op_f],[indent,indent_f],[cmnt,cmnt_f],[unkn,unkn_f]];}();var ws_re=RegExp("(?:(?: *)(?:(?:\n(?: *)\\\\(?: *))*))");var tokenize=function(text){var last_op=true;var results=[];var wsb=text.match(ws_re)[0].length;(text=text.slice(wsb));(pos=wsb);while(text){for(var i=0;(i<regexps.length);(++i)){var spec=regexps[i];var re=spec[0];var m=text.match(re);if(m){var fn=spec[1];var skip=m[0].length;(text=text.slice(skip));var wsa=text.match(ws_re)[0].length;var r=fn(m,(wsb>0),(wsa>0),last_op);var type=r[0];var result=r.slice(1);(result.location=[pos,(pos+skip)]);if((type=="IGNORE")){null;}else{if((type=="ID")){if((!last_op)){var w=["IFX",function(){if((wsa||wsb)){return "wide";}else{return "short";}}(),"WHITE"];(w.location=[pos,pos]);results.push(w);}else{false;}results.push(result);(last_op=false);}else{if((type=="OP")){if(last_op){var v=["VOID"];(v.location=[pos,pos]);results.push(v);}else{false;}if((result[0]=="IFX")){results.push(result);(last_op=true);}else{if((result[0]=="PFX")){if((!last_op)){var w=["IFX",function(){if((wsa||wsb)){return "wide";}else{return "short";}}(),"WHITE"];(w.location=[pos,pos]);var v=["VOID"];(v.location=[pos,pos]);results.push(w);results.push(v);}else{false;}results.push(result);(last_op=true);}else{if((result[0]=="SFX")){results.push(result);var v=["VOID"];(v.location=[(pos+skip),(pos+skip)]);results.push(v);(last_op=false);}else{false;}}}}else{false;}}}(text=text.slice(wsa));(wsb=wsa);(pos=((pos+skip)+wsa));break;}else{false;}}}if(last_op){var v=["VOID"];(v.location=[pos,pos]);results.push(v);}else{false;}return results;};var MAX=(1/0);var order_map=({"IFX":({"wide":({"default":[900,901],"WHITE":[1000,1001],",":[1,1],"with":[11,10],"where":[11,10],"->":[11,10],"=>":[11,10],"=":[11,10],":=":[11,10],"+":[300,301],"*":[400,401],"**":[501,500],":":[1001,2]}),"short":({"default":[1900,1901],"WHITE":[2000,2001],",":[1,1],":":[1001,2]})}),"PFX":({"wide":({"default":[MAX,900],".":[MAX,3000],"#":[MAX,3000],"(":[MAX,1],"[":[MAX,1],"{":[MAX,1]}),"short":({"default":[MAX,1900],".":[MAX,3000],"#":[MAX,3000],"(":[MAX,1],"[":[MAX,1],"{":[MAX,1]})}),"SFX":({"wide":({"default":[901,MAX],")":[1,MAX],"]":[1,MAX],"}":[1,MAX]}),"short":({"default":[1901,MAX],")":[1,MAX],"]":[1,MAX],"}":[1,MAX]})})});var DONE=(-1);var NONE=0;var LEFT=1;var RIGHT=2;var BOTH=3;var oparse=function(next,order,finalize){var between=finalize(next());var right_op=next();var stack=[];var left_op=null;var current=null;while(true){var o=function(){if(((!left_op)&&(!right_op))){return DONE;}else{if(true){return ((((!left_op)&&RIGHT)||((!right_op)&&LEFT))||order(left_op,right_op));}else{return false;}}}();var _tmp0=undefined;var _tmp1=undefined;var _tmp2=undefined;var _tmp3=undefined;var _tmp4=undefined;if(((_tmp4=o),(_tmp4==DONE))){return between;}else{if(((_tmp3=o),(_tmp3==LEFT))){current.push(between);(between=finalize(current));var v=stack.pop();(left_op=v[0]);(current=v[1]);}else{if(((_tmp2=o),(_tmp2==RIGHT))){stack.push([left_op,current]);(left_op=right_op);(current=[[right_op],between]);(between=finalize(next()));(right_op=next());}else{if(((_tmp1=o),(_tmp1==BOTH))){current[0].push(right_op);current.push(between);(left_op=right_op);(between=finalize(next()));(right_op=next());}else{if(((_tmp0=o),(_tmp0==NONE))){throw ((("Undefined priority between "+left_op)+" and ")+right_op);}else{throw "Could not find a match";}}}}}}};var consult=function(o){var map=order_map[o[0]][o[1]];return (map[o[2]]||map.default);};var order=function(o1,o2){var ord1=consult(o1)[1];var ord2=consult(o2)[0];if((ord1>ord2)){return LEFT;}else{if((ord1<ord2)){return RIGHT;}else{if((ord1==ord2)){return BOTH;}else{return false;}}}};var finalize=function(x){var _tmp5=undefined;var _tmp6=undefined;var ops=undefined;var args=undefined;var _tmp7=undefined;var _tmp8=undefined;var _tmp9=undefined;var _tmp10=undefined;var _tmp11=undefined;var _tmp12=undefined;var value=undefined;var _tmp13=undefined;var _tmp14=undefined;var _tmp15=undefined;var value=undefined;var _tmp16=undefined;var _tmp17=undefined;var _tmp18=undefined;var value=undefined;if((((_tmp16=x),(_tmp17=_tmp16.length),(_tmp17==2))&&(((_tmp18=_tmp16[0]),(_tmp18=="ID"))&&((value=_tmp16[1]),true)))){return value;}else{if((((_tmp13=x),(_tmp14=_tmp13.length),(_tmp14==2))&&(((_tmp15=_tmp13[0]),(_tmp15=="NUM"))&&((value=_tmp13[1]),true)))){return ["value",parseFloat(value)];}else{if((((_tmp10=x),(_tmp11=_tmp10.length),(_tmp11==2))&&(((_tmp12=_tmp10[0]),(_tmp12=="STR"))&&((value=_tmp10[1]),true)))){return ["value",value];}else{if((((_tmp7=x),(_tmp8=_tmp7.length),(_tmp8==1))&&((_tmp9=_tmp7[0]),(_tmp9=="VOID")))){return null;}else{if((((_tmp5=x),(_tmp6=_tmp5.length),(_tmp6>=1))&&((ops=_tmp5[0]),true,(args=_tmp5.slice(1)),true))){var opcat=ops.map(function(o){return o[2];}).join("");var op=ops[0][2];var other=undefined;var _tmp19=undefined;var _tmp20=undefined;var _tmp21=undefined;var _tmp22=undefined;var _tmp23=undefined;var target=undefined;var body=undefined;var _tmp24=undefined;var _tmp25=undefined;var _tmp26=undefined;var _tmp27=undefined;var _tmp28=undefined;var f=undefined;var body=undefined;var _tmp29=undefined;var _tmp30=undefined;var _tmp31=undefined;var _tmp32=undefined;var _tmp33=undefined;var f=undefined;var arg=undefined;var body=undefined;if((((_tmp29=[opcat,args]),(_tmp30=_tmp29.length),(_tmp30==2))&&(((_tmp31=_tmp29[0]),(_tmp31=="WHITE:"))&&(((_tmp32=_tmp29[1]),(_tmp33=_tmp32.length),(_tmp33==3))&&((f=_tmp32[0]),true,(arg=_tmp32[1]),true,(body=_tmp32[2]),true))))){return ["send",f,["data",["code",arg],["code",body]]];}else{if((((_tmp24=[opcat,args]),(_tmp25=_tmp24.length),(_tmp25==2))&&(((_tmp26=_tmp24[0]),(_tmp26==":"))&&(((_tmp27=_tmp24[1]),(_tmp28=_tmp27.length),(_tmp28==2))&&((f=_tmp27[0]),true,(body=_tmp27[1]),true))))){return ["send",f,["data",["code",body]]];}else{if((((_tmp19=[opcat,args]),(_tmp20=_tmp19.length),(_tmp20==2))&&(((_tmp21=_tmp19[0]),(_tmp21=="with"))&&(((_tmp22=_tmp19[1]),(_tmp23=_tmp22.length),(_tmp23==2))&&((target=_tmp22[0]),true,(body=_tmp22[1]),true))))){(body=function(){var other=undefined;var _tmp43=undefined;var _tmp44=undefined;var _tmp45=undefined;var rest=undefined;if((((_tmp43=body),(_tmp44=_tmp43.length),(_tmp44>=1))&&(((_tmp45=_tmp43[0]),(_tmp45=="multi"))&&((rest=_tmp43.slice(1)),true)))){return rest;}else{if(((other=body),true)){return [body];}else{throw "Could not find a match";}}}());var other=undefined;var _tmp34=undefined;var _tmp35=undefined;var _tmp36=undefined;var args=undefined;var _tmp37=undefined;var _tmp38=undefined;var _tmp39=undefined;var f=undefined;var _tmp40=undefined;var _tmp41=undefined;var _tmp42=undefined;var args=undefined;if((((_tmp37=target),(_tmp38=_tmp37.length),(_tmp38==3))&&(((_tmp39=_tmp37[0]),(_tmp39=="send"))&&(((f=_tmp37[1]),true,(_tmp40=_tmp37[2]),(_tmp41=_tmp40.length),(_tmp41>=1))&&(((_tmp42=_tmp40[0]),(_tmp42=="data"))&&((args=_tmp40.slice(1)),true)))))){return ["send",f,["data"].concat(args).concat(body)];}else{if((((_tmp34=target),(_tmp35=_tmp34.length),(_tmp35>=1))&&(((_tmp36=_tmp34[0]),(_tmp36=="data"))&&((args=_tmp34.slice(1)),true)))){return target.concat(body);}else{if(((other=target),true)){return ["send",target,["data"].concat(body)];}else{throw "Could not find a match";}}}}else{if(((other=[opcat,args]),true)){if(((op=="[")||(op==","))){if((op=="[")){(args=args.slice(1,(-1)));}else{false;}(args=function(){var f=function(x){return (x!==null);};return args.filter(f);}());var other=undefined;var _tmp46=undefined;var _tmp47=undefined;var x=undefined;var _tmp48=undefined;var _tmp49=undefined;if(((_tmp48=args),(_tmp49=_tmp48.length),(_tmp49==0))){throw "At least one expression must be enclosed in []";}else{if((((_tmp46=args),(_tmp47=_tmp46.length),(_tmp47==1))&&((x=_tmp46[0]),true))){return x;}else{if(((other=args),true)){return ["multi"].concat(args);}else{throw "Could not find a match";}}}}else{if((op=="{")){var f=function(x){return (x!==null);};return ["data"].concat(args.slice(1,(-1)).filter(f));}else{if((op=="WHITE")){return ["send"].concat(args);}else{if((((args.length==2)&&(args[0]===null))&&(args[1]===null))){return op;}else{if(true){return ["send",op,["data"].concat(args)];}else{return false;}}}}}}else{throw "Could not find a match";}}}}}else{throw "Could not find a match";}}}}}};var parse=function(text){var results=tokenize(text);var next=function(){return results.shift();};return oparse(next,order,finalize);};var Env=function(parent){var store=Object();var self=function(expr){return ["bind_env",self,expr];};(self.resolve=function(name){var attempt=store[name];if(attempt){return attempt;}else{if(true){return self.parent.resolve(name);}else{return false;}}});(self.register=function(name,value){return (store[name]=value);});(self.register_macro=function(name,m){return (store[name]=["macro",m]);});(self.fork=function(){return Env(self);});(self.parent=parent);(self.store=store);return self;};var js_contexts=({"js_for":["multi","multi","multi","multi"]});var expand=function(env,context,expr){(expr=expand.step(env,context,expr));if((typeof(expr)=="string")){return expr;}else{if((expr===null)){return null;}else{if((expr instanceof Array)){var type=expr[0];if((type=="send")){var f=expand(env,"head",expr[1]);var arg=expr[2];return ["send",f,expand(env,"tail",arg)];}else{if((type=="value")){return expr;}else{if((((((type=="multi")||(type=="code"))||(type=="array"))||(type=="object"))||(type=="splice"))){var args=expr.slice(1);var arr=[];while((args.length>0)){var x=expand.step(env,type,args.shift());if(((x instanceof Array)&&(x[0]=="splice"))){(args=x.slice(1).concat(args));}else{if(true){arr.push(x);}else{false;}}}var f=function(x){return expand(env,type,x);};return [type].concat(arr.map(f));}else{if((type=="data")){var args=expr.slice(1);var is_obj=false;var obj=["object"];var arr=["array"];while((args.length>0)){var x=expand.step(env,type,args.shift());if((((x instanceof Array)&&(x[0]=="assoc"))&&(x.length==1))){(is_obj=true);}else{if(((x instanceof Array)&&(x[0]=="assoc"))){(is_obj=true);obj.push(["array",x[1],x[2]]);}else{if(((x instanceof Array)&&(x[0]=="splice"))){(args=x.slice(1).concat(args));}else{if(true){arr.push(x);}else{false;}}}}}var r=function(){if(((arr.length>1)&&is_obj)){arr.push(obj);return arr;}else{if(is_obj){return obj;}else{if(true){return arr;}else{return false;}}}}();return expand(env,context,r);}else{if((type=="lambda")){return ["lambda",expr[1].map(function(x){return expand(env,"decl",x);}),expand(env,"multi",expr[2])];}else{if((type=="declare")){return ["declare",expand(env,"decl",expr[1]),expand(env,"multi",expr[2])];}else{if((type=="assign")){return ["assign",expand(env,"decl",expr[1]),expand(env,"multi",expr[2])];}else{if((((((((type=="js_while")||(type=="js_for"))||(type=="js_break"))||(type=="js_continue"))||(type=="js_return"))||(type=="js_throw"))||(type=="if"))){var ctxs=(js_contexts[type]||[]);var f=function(x,i){return expand(env,(ctxs[i]||"expr"),x);};return [type].concat(expr.slice(1).map(f));}else{if(true){throw ["Oops",type,context];}else{return false;}}}}}}}}}}else{return false;}}}};(expand.step=function(env,context,expr){if((typeof(expr)=="string")){var v=env.resolve(expr);if((!v)){return expr;}else{if(((v instanceof Array)&&(v[0]=="macro"))){if((context=="head")){return v;}else{if(true){return expand.step(env,context,v[1](env,context,null));}else{return false;}}}else{if(true){return v;}else{return false;}}}}else{if((expr instanceof Array)){var type=expr[0];if((type=="macro")){if((context=="head")){return expr;}else{if(true){return expand.step(env,context,expr[1](env,context,null));}else{return false;}}}else{if((type=="send")){var f=expand.step(env,"head",expr[1]);var arg=expr[2];if(((f instanceof Array)&&(f[0]=="macro"))){return expand.step(env,context,f[1](env,context,arg));}else{if(true){return expr;}else{return false;}}}else{if(true){return expr;}else{return false;}}}}else{if((expr===null)){return null;}else{if(true){return console.log(("Oops2: "+expr));}else{return false;}}}}});var aslist=function(expr){if(((expr instanceof Array)&&(expr[0]=="multi"))){return expr.slice(1);}else{if(true){return [expr];}else{return false;}}};var nullenv=({"resolve":function(x){return undefined;}});var stdenv=Env(nullenv);stdenv.register("+","___plus");stdenv.register("-","___minus");stdenv.register("*","___times");stdenv.register("/","___div");stdenv.register("%","___mod");stdenv.register("^","___binxor");stdenv.register("&","___binand");stdenv.register("|","___binor");stdenv.register("~","___binnot");stdenv.register("&&","___and");stdenv.register("||","___or");stdenv.register("!","___not");stdenv.register("===","___is");stdenv.register("!==","___isnt");stdenv.register("!=","___neq");stdenv.register("<","___lt");stdenv.register(">","___gt");stdenv.register("<=","___lte");stdenv.register(">=","___gte");stdenv.register("in","___in");stdenv.register("instanceof","___instanceof");stdenv.register("++","___plusplus");stdenv.register("--","___minusminus");var make_checker=function(value){return function(env,context,expr){return ["send","___eq",["data",expr[1],value]];};};var make_exact_checker=function(value){return function(env,context,expr){return ["send","___is",["data",expr[1],value]];};};stdenv.register_macro("#",function(env,context,expr){var tag=["value",expr[2]];var f=function(env,context,expr){if((context=="pattern")){var f=function(env,context,expr){return ["send","___eq",["data",["send",expr[1],["value","#"]],tag]];};return ["check",["macro",f],expr];}else{if(true){var d=["data",tag].concat(expr.slice(1));return ["send",["send","___lib",["value","Struct"]],d];}else{return false;}}};return ["macro",f];});stdenv.register_macro("&&",function(env,context,expr){if((context=="pattern")){return ["all",expr[1],expr[2]];}else{if((expr===null)){return "___and";}else{if(true){return ["send","___and",expr];}else{return false;}}}});stdenv.register_macro("||",function(env,context,expr){if((context=="pattern")){return ["any",expr[1],expr[2]];}else{if((expr===null)){return "___or";}else{if(true){return ["send","___or",expr];}else{return false;}}}});stdenv.register_macro("==",function(env,context,expr){if((context=="pattern")){return ["check",["macro",make_checker(expr[2])],null];}else{if((expr===null)){return "___eq";}else{if(true){return ["send","___eq",expr];}else{return false;}}}});stdenv.register_macro("*",function(env,context,expr){if((context=="pattern")){return ["dynsplice",expr[1]];}else{if((expr===null)){return "___times";}else{if(true){return ["send","___times",expr];}else{return false;}}}});stdenv.register_macro(".",function(env,context,expr){if((typeof(expr[2])=="string")){return ["value",expr[2]];}else{if(true){throw ["invalid",expr];}else{return false;}}});stdenv.register_macro("where",function(env,context,expr){return ["send","let",["data",["code",expr[2]],["code",expr[1]]]];});stdenv.register_macro("let",function(env,context,expr){var bindings=aslist(expr[1][1]);var body=aslist(expr[2][1]);return ["multi"].concat(bindings).concat(body);});stdenv.register_macro("->",function(env,context,expr){var body=["multi"];(args=expr[1].slice(1).map(function(x){if((typeof(x)=="string")){return x;}else{if(true){var t=gensym();body.push(["send","=",["data",x,t]]);return t;}else{return false;}}}));body.push(expr[2]);return ["lambda",args,body];});stdenv.register_macro("=>",function(env,context,expr){if((context=="data")){var binding=expr[1];var value=expr[2];return ["assoc",binding,value];}else{if(true){throw (("Illegal context for '=>' ("+context)+")");}else{return false;}}});stdenv.register_macro("=",function(env,context,expr){if((context=="multi")){var lhs=expr[1];var rhs=expr[2];var p=parse_lhs(env,lhs,rhs);var vars=make_declarations(p[0]);var r=["splice"].concat(vars);var clauses=p[1];var mkif=function(x){return ["if",x,["value",false],["js_throw",["value","a condition failed"]]];};if((clauses.length==1)){var clause=clauses[0];var last=clause[(clause.length-1)];if((((last instanceof Array)&&(last[0]=="value"))&&(last[1]===true))){if(((vars.length==1)&&(clause.length==3))){(r=["declare"].concat(clause[1].slice(1)));}else{if(true){(r=r.concat(clause.slice(1,(-1))));}else{false;}}}else{if(true){r.push(mkif(clause));}else{false;}}}else{if(true){var ands=make_pattern_test(clauses);r.push(mkif(ands));}else{false;}}return r;}else{if((context=="data")){if((expr===null)){return ["assoc"];}else{if(true){var binding=expr[1];var value=expr[2];if(((binding instanceof Array)&&(binding[0]=="send"))){return ["assoc",["value",binding[1]],["lambda",binding[2].slice(1),value]];}else{if(true){return ["assoc",["value",binding],value];}else{return false;}}}else{return false;}}}else{if(true){throw (("Illegal context for '=' ("+context)+")");}else{return false;}}}});stdenv.register_macro(":=",function(env,context,expr){return ["assign",expr[1],expr[2]];});stdenv.register_macro("if",function(env,context,expr){return ["if",expr[1],expr[2],expr[3]];});stdenv.register_macro("cond",function(env,context,expr){var handle=function(xs){if((xs.length==0)){return ["value",false];}else{if(true){var first=xs[0][2];var rest=xs.slice(1);return ["if",first[1],first[2],handle(rest)];}else{return false;}}};return handle(aslist(expr[1][1]));});stdenv.register_macro("while",function(env,context,expr){return ["js_while",expr[1][1],expr[2][1]];});stdenv.register_macro("for",function(env,context,expr){return ["js_for",expr[1][1][1],expr[1][1][2],expr[1][1][3],expr[2][1]];});stdenv.register_macro("return",function(env,context,expr){return ["js_return",expr];});stdenv.register_macro("throw",function(env,context,expr){return ["js_throw",expr];});stdenv.register_macro("break",function(env,context,expr){return ["js_break"];});stdenv.register_macro("continue",function(env,context,expr){return ["js_continue"];});var rx_wrap=function(x){return (("(?:"+x)+")");};var rx_quote=function(x){return x.replace(RegExp("([.?*+\\^$\\[\\]\\(\\)\\{\\}|\\\\])","g"),"\\$1");};var rx_quote2=function(x){return x.replace(RegExp("([\\[\\]\\(\\)\\{\\}\\^])","g"),"\\$1");};var rx_build=function(expr){if((expr=="any")){return ".";}else{if((expr=="start")){return "^";}else{if((expr=="end")){return "$";}else{if((expr=="alpha")){return "\\a";}else{if((expr=="digit")){return "\\d";}else{if((expr=="word")){return "\\w";}else{if((expr=="space")){return "\\s";}else{if((expr=="boundary")){return "\\b";}else{if((expr=="a")){return "\\a";}else{if((expr=="d")){return "\\d";}else{if((expr=="w")){return "\\w";}else{if((expr=="s")){return "\\s";}else{if((expr=="b")){return "\\b";}else{if(((expr instanceof Array)&&(expr[0]=="value"))){return rx_quote(expr[1]);}else{if(((expr instanceof Array)&&(expr[0]=="send"))){var f=expr[1];var a=expr[2][1];var b=expr[2][2];if((f=="||")){return rx_wrap(((rx_build(a)+"|")+rx_build(b)));}else{if((f=="*")){if((b===null)){return rx_wrap((rx_build(a)+"*"));}else{if(true){throw "unsupported";}else{return false;}}}else{if((f=="+")){return rx_wrap((rx_build(a)+"+"));}else{if((f=="?")){return rx_wrap((rx_build(a)+"?"));}else{if((f==">>")){var x=rx_quote2(b[1]);return (("["+x)+"]");}else{if((f==">>!")){var x=rx_quote2(b[1]);return (("[^"+x)+"]");}else{return false;}}}}}}}else{if(((expr instanceof Array)&&(expr[0]=="data"))){return (("("+expr.slice(1).map(rx_build).join(""))+")");}else{if(((expr instanceof Array)&&(expr[0]=="multi"))){return (("(?:"+expr.slice(1).map(rx_build).join(""))+")");}else{return false;}}}}}}}}}}}}}}}}}};stdenv.register_macro("Rx",function(env,context,expr){return ["send","RegExp",["array",["value",rx_build(expr)]]];});stdenv.register_macro("Rxg",function(env,context,expr){return ["send","RegExp",["array",["value",rx_build(expr)],["value","g"]]];});stdenv.register_macro("?",function(env,context,expr){var checker=function(){if((expr[1]=="String")){var f=function(env,context,expr){return ["send","___eq",["data",["send","typeof",["data",expr[1]]],["value","string"]]];};return ["macro",f];}else{if((expr[1]=="Number")){var f=function(env,context,expr){return ["send","___eq",["data",["send","typeof",["data",expr[1]]],["value","number"]]];};return ["macro",f];}else{if((expr[1]=="true")){return ["macro",make_exact_checker(["value",true])];}else{if((expr[1]=="false")){return ["macro",make_exact_checker(["value",false])];}else{if((expr[1]=="null")){return ["macro",make_exact_checker(["value",null])];}else{if((expr[1]=="undefined")){return ["macro",make_exact_checker(["value",undefined])];}else{if(true){return ["send",expr[1],["value","__check__"]];}else{return false;}}}}}}}}();var mac=function(env,context,expr){if((context=="pattern")){return ["check",checker,expr];}else{if(true){return ["send",checker,["data",expr]];}else{return false;}}};return ["macro",mac];});var tempnum=0;var gensym=function(){var name=("_tmp"+tempnum);(tempnum=(tempnum+1));return name;};var parse_lhs=function(env,lhs,rhs){var vars=[];var clauses=[];var current=["multi"];var mktemp=function(){var t=gensym();vars.push(t);return t;};var newclause=function(){if((current.length>1)){clauses.push(current);}else{false;}return (current=["multi"]);};var helper=function(lhs,curr){return helper_noexpand(expand.step(env,"pattern",lhs),curr);};var helper_noexpand=function(lhs,curr){if((lhs===null)){return false;}else{if((typeof(lhs)=="string")){vars.push(lhs);current.push(["assign",lhs,curr]);return current.push(["value",true]);}else{if(((lhs instanceof Array)&&(lhs[0]=="value"))){var x=["check",["macro",make_checker(lhs)],null];return helper_noexpand(x,curr);}else{if(((lhs instanceof Array)&&(lhs[0]=="all"))){var temp=mktemp();(current=current.concat([["assign",temp,curr]]));return lhs.slice(1).forEach(function(x){return helper(x,temp);});}else{if(((lhs instanceof Array)&&(lhs[0]=="any"))){var normalize=function(vars){return vars.filter(function(x){return (x.slice(0,4)!=="_tmp");}).sort().join(",");};var temp=mktemp();(current=current.concat([["assign",temp,curr]]));var myvars=undefined;var clauses=[];lhs.slice(1).forEach(function(x){var p=parse_lhs(env,x,temp);if((myvars===undefined)){(myvars=p[0]);}else{if((normalize(p[0])!==normalize(myvars))){throw [["Must have the same set of variables in both branches!",myvars]];}else{if(true){(vars=vars.concat(p[0]));}else{false;}}}return clauses.push(make_pattern_test(p[1]));});current.push(make_or_pattern(clauses));(vars=vars.concat(myvars));return newclause();}else{if(((lhs instanceof Array)&&(lhs[0]=="check"))){var checker=lhs[1];var expr=lhs[2];var temp=mktemp();(current=current.concat([["assign",temp,curr],["send",checker,["data",temp]]]));newclause();return helper(expr,temp);}else{if(((lhs instanceof Array)&&(lhs[0]=="send"))){var fname=lhs[1];var spec=lhs[2];return helper(fname,["send","->",["data",spec,curr]]);}else{if(((lhs instanceof Array)&&(lhs[0]=="data"))){var fw=0;var bw=0;var rest=undefined;var members=lhs.slice(1).map(function(x){var v=expand.step(env,"pattern",x);if(((v instanceof Array)&&(v[0]=="dynsplice"))){(rest=v[1]);}else{if((rest===undefined)){(fw=(fw+1));}else{if(true){(bw=(bw+1));}else{false;}}}return v;});var cmp=function(){if((rest===undefined)){return "___eq";}else{if(true){return "___gte";}else{return false;}}}();var temp=mktemp();var len=mktemp();(current=current.concat([["assign",temp,curr],["assign",len,["send",temp,["value","length"]]],["send",cmp,["data",len,["value",(fw+bw)]]]]));newclause();for(var j=0;(j<fw);(++j)){helper_noexpand(members[j],["send",temp,["value",j]]);}if((rest!==undefined)){var slice=function(){if((bw>0)){return ["data",["value",fw],["value",(-bw)]];}else{if(true){return ["data",["value",fw]];}else{return false;}}}();helper_noexpand(members[fw][1],["send",["send",temp,["value","slice"]],slice]);}else{false;}for(var j=0;(j<bw);(++j)){helper_noexpand(members[((fw+j)+1)],["send",temp,["send","___minus",["data",len,["value",(bw-j)]]]]);}}else{if(true){return console.log(["oops_lhs",lhs,curr]);}else{return false;}}}}}}}}}};helper(lhs,rhs);if((current.length>1)){clauses.push(current);}else{false;}return [vars,clauses];};var make_declarations=function(vars){return vars.map(function(name){return ["declare",name,["value",undefined]];});};var make_pattern_test=function(clauses){var ands=clauses.pop();while((clauses.length>0)){(ands=["send","___and",["data",clauses.pop(),ands]]);}return ands;};var make_or_pattern=function(clauses){var ors=clauses.pop();while((clauses.length>0)){(ors=["send","___or",["data",clauses.pop(),ors]]);}return ors;};stdenv.register_macro("|>",function(env,context,expr){var to_match=expr[1];var clauses=function(){if((expr[2][0]=="multi")){return expr[2].slice(1);}else{if(true){return [expr[2]];}else{return false;}}}();var decls=["multi"];var r=["js_throw",["value","Could not find a match"]];while((clauses.length>0)){var clause=clauses.pop();var lhs=clause[2][1];var body=clause[2][2];var p=parse_lhs(env,lhs,to_match);var test=make_pattern_test(p[1]);(r=["if",test,body,r]);(decls=decls.concat(make_declarations(p[0])));}decls.push(r);return decls;});var js_op_table=({"___plus":"+","___minus":"-","___times":"*","___div":"/","___mod":"%","___binxor":"^","___binand":"&","___binor":"|","___binnot":"~","___and":"&&","___or":"||","___not":"!","___is":"===","___isnt":"!==","___eq":"==","___neq":"!=","___lt":"<","___gt":">","___lte":"<=","___gte":">=","___in":" in ","___instanceof":" instanceof ","___plusplus":"++","___minusminus":"--"});var translate=function(expr,mode){if((typeof(expr)=="string")){return translate.expr(translate.mangle(expr),mode);}else{if((expr===null)){return translate.expr("null",mode);}else{if((expr instanceof Array)){var type=expr[0];var args=expr.slice(1);if((type=="value")){var v=args[0];var r=function(){if((typeof(v)=="string")){var repl=({"\"":"\\\"","\n":"\\n","\\":"\\\\"});(v=v.replace(RegExp("((?:(?:\"|\\\\)|\n))","g"),function(m){return repl[m];}));return (("\""+v)+"\"");}else{if((typeof(v)=="number")){return String(v);}else{if(((((v===true)||(v===false))||(v===null))||(v===undefined))){return String(v);}else{if(true){console.log(expr);return (("?!?["+v)+"]?!?");}else{return false;}}}}}();return translate.expr(r,mode);}else{if((type=="lambda")){var bindings=args[0];var body=args[1];var a=bindings.join(",");var b=translate.body(body,"return");return translate.expr((((("function("+a)+"){")+b)+"}"),mode);}else{if((type=="if")){if((mode=="expr")){return translate.body(expr,"expr");}else{if(true){var a=translate(args[0],"expr");var b=translate(args[1],mode);var c=translate(args[2],mode);return (((((("if("+a)+"){")+b)+"}else{")+c)+"}");}else{return false;}}}else{if((type=="js_while")){if((mode=="expr")){return translate.body(expr,"expr");}else{if(true){var a=translate(args[0],"expr");var b=translate(args[1],"stmt");return (((("while("+a)+"){")+b)+"}");}else{return false;}}}else{if((type=="js_for")){if((mode=="expr")){return translate.body(expr,"expr");}else{if(true){var a=translate(args[0],"stmt");var b=translate(args[1],"stmt");var c=translate(args[2],"expr");var d=translate(args[3],"stmt");return (((((("for("+a)+b)+c)+"){")+d)+"}");}else{return false;}}}else{if((type=="declare")){if(((mode=="expr")||(mode=="return"))){throw "Invalid in expr ctx";}else{if(true){var a=translate(args[0],"expr");var b=translate(args[1],"expr");return (((("var "+a)+"=")+b)+";");}else{return false;}}}else{if((type=="assign")){var a=translate(args[0],"expr");var b=translate(args[1],"expr");return translate.expr((((("("+a)+"=")+b)+")"),mode);}else{if((type=="multi")){var isdecl=function(x){return ((x instanceof Array)&&(x[0]=="declare"));};if((args.length==1)){return translate(args[0],mode);}else{if(((mode=="expr")&&(args.filter(isdecl).length==0))){var xs=args.map(function(x){return translate(x,"expr");});return (("("+xs.join(","))+")");}else{if(true){return translate.body(expr,mode);}else{return false;}}}}else{if((type=="splice")){return translate(["multi"].concat(args),mode);}else{if((type=="js_break")){if((mode=="expr")){throw "Invalid break in ctx";}else{if(true){return "break;";}else{return false;}}}else{if((type=="js_continue")){if((mode=="expr")){throw "Invalid continue in ctx";}else{if(true){return "continue;";}else{return false;}}}else{if((type=="js_return")){if((mode=="expr")){throw "Invalid return in ctx";}else{if(true){return (("return "+translate(args[0],"expr"))+";");}else{return false;}}}else{if((type=="js_throw")){if(true){return (("throw "+translate(args[0],"expr"))+";");}else{return false;}}else{if((type=="array")){var r=function(){var f=function(x){return translate(x,"expr");};return (("["+args.map(f).join(","))+"]");}();return translate.expr(r,mode);}else{if((type=="object")){var r=function(){var f=function(x){var a=translate(x[1],"expr");var b=translate(x[2],"expr");return ((a+":")+b);};return (("({"+args.map(f).join(","))+"})");}();return translate.expr(r,mode);}else{if((type=="send")){var f=args[0];var msg=args[1];if(((msg instanceof Array)&&(msg[0]=="value"))){var s=msg[1];if(((typeof(s)=="string")&&s.match(RegExp("(?:^(?:[a-zA-Z_$]+)$)")))){var trf=translate(f,"expr");var trmsg=translate(msg[1],"expr");return translate.expr(((trf+".")+trmsg),mode);}else{if(true){var trf=translate(f,"expr");var trmsg=translate(msg,"expr");return translate.expr((((trf+"[")+trmsg)+"]"),mode);}else{return false;}}}else{if(((msg instanceof Array)&&(msg[0]=="array"))){var op=((typeof(f)=="string")&&js_op_table[f]);if(op){return translate.expr(translate.op(op,msg[1],msg[2]),mode);}else{if(true){var trf=translate(f,"expr");var trargs=msg.slice(1).map(function(x){return translate(x,"expr");});return translate.expr((((trf+"(")+trargs.join(","))+")"),mode);}else{return false;}}}else{if(true){var trf=translate(f,"expr");var trmsg=translate(msg,"expr");return translate.expr((((trf+"[")+trmsg)+"]"),mode);}else{return false;}}}}else{return false;}}}}}}}}}}}}}}}}}else{return false;}}}};(translate.mangle=function(name){var tr=({"+":"__plus__","-":"__minus__","*":"__asterisk__","/":"__slash__","%":"__percent__","^":"__caret__","#":"__hash__","&":"__amp__","|":"__pipe__","@":"__at__","!":"__bang__","?":"__qmark__","=":"__equal__","<":"__lt__",">":"__gt__","~":"__tilde__"});var r=[];for(var i=0;(i<name.length);(++i)){var c=name[i];r.push((tr[c]||c));}return r.join("");});(translate.body=function(b,mode){(orig=b);(b=aslist(b));var trst=function(stmt){return translate(stmt,"stmt");};if((mode=="expr")){var x=["send",["lambda",[],orig],["array"]];return translate(x,mode);}else{if((mode=="return")){var stmts=b.slice(0,(-1));var ret=b[(b.length-1)];return (stmts.map(trst).join("")+translate(ret,"return"));}else{if((mode=="stmt")){return b.map(trst).join("");}else{return false;}}}});(translate.expr=function(x,mode){if((mode=="expr")){return x;}else{if((mode=="stmt")){return (x+";");}else{if((mode=="return")){return (("return "+x)+";");}else{return false;}}}});(translate.op=function(op,a,b){(e=function(){if((a===null)){return (op+translate(b,"expr"));}else{if((b===null)){return (translate(a,"expr")+op);}else{if(true){return ((translate(a,"expr")+op)+translate(b,"expr"));}else{return false;}}}}());return (("("+e)+")");});var fs=require("fs");var file=process.argv[2];var f=function(err,data){var p=parse(data);var ex=expand(stdenv,"top",["multi",p]);var prelude="var ___lib=require(\"./lib\");";return console.log((prelude+translate(ex,"stmt")));};fs.readFile(file,"utf8",f);
